!function(){"use strict";var e=class{constructor(e,t={}){this.dialog=document.getElementById(e),this.closeButtons=this.dialog?.querySelectorAll('[data-action*="close"]'),this.options={closeOnBackdrop:!1!==t.closeOnBackdrop,closeOnEscape:!1!==t.closeOnEscape,onOpen:t.onOpen||(()=>{}),onClose:t.onClose||(()=>{}),...t},this.dialog&&this.init()}init(){this.setupEventListeners()}setupEventListeners(){this.closeButtons?.forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.close()})}),this.options.closeOnBackdrop&&this.dialog&&this.dialog.addEventListener("click",e=>{e.target===this.dialog&&this.close()}),this.options.closeOnEscape&&this.dialog&&this.dialog.addEventListener("cancel",e=>{e.preventDefault(),this.close()})}open(){if(this.dialog)try{this.dialog.showModal(),document.body.style.overflow="hidden",this.options.onOpen()}catch(e){console.error("Error opening dialog:",e),this.dialog.setAttribute("open",""),this.dialog.style.display="block",document.body.style.overflow="hidden",this.options.onOpen()}}close(){if(this.dialog)try{this.dialog.close(),document.body.style.overflow="",this.dialog.style.display="",this.options.onClose()}catch(e){console.error("Error closing dialog:",e),this.dialog.removeAttribute("open"),this.dialog.style.display="none",document.body.style.overflow="",this.options.onClose()}}isOpen(){return this.dialog?.open||this.dialog?.hasAttribute("open")}},t=class{constructor(e,t={}){this.container=e,this.filterHeaders=e?.querySelectorAll(".brag-book-gallery-nav-button"),this.activeFilters=new Map,this.categories=new Map,this.procedures=new Map,this.originalTitle=document.title,this.originalDescription=document.querySelector('meta[name="description"]')?.content||"",this.options={mode:t.mode||"javascript",baseUrl:t.baseUrl||"/gallery",closeOthersOnOpen:!0===t.closeOthersOnOpen,onFilterChange:t.onFilterChange||(()=>{}),onNavigate:t.onNavigate||(e=>{window.location.href=e}),...t},this.container&&this.init()}init(){this.indexFilters(),this.setupEventListeners(),this.loadStateFromUrl()}indexFilters(){const e=this.container?.querySelectorAll("[data-category]");e?.forEach(e=>{const t=e.dataset.category;this.categories.has(t)||this.categories.set(t,{name:t,procedures:new Set,element:e}),e.querySelectorAll(".brag-book-gallery-nav-link").forEach(e=>{const t=e.dataset.procedure,a=e.dataset.category;if(t&&a){const o={id:t,category:a,count:parseInt(e.dataset.procedureCount||"0"),element:e.parentElement,link:e};this.procedures.set(`${a}:${t}`,o),this.categories.get(a).procedures.add(t)}})})}setupEventListeners(){}handleFilterClick(e){const t=e.dataset.category,a=e.dataset.procedure,o=e.dataset.procedureIds,r=parseInt(e.dataset.procedureCount||"0"),s="true"===e.dataset.nudity;this.activeFilters.clear(),this.container?.querySelectorAll(".brag-book-gallery-nav-link").forEach(e=>{e.classList.remove("brag-book-gallery-active")}),e.classList.add("brag-book-gallery-active");const i=e.closest(".brag-book-gallery-nav-list-submenu__item");i&&i.classList.add("brag-book-gallery-active"),this.activeFilters.set(`${t}:${a}`,{category:t,procedure:a,procedureIds:o,count:r,hasNudity:s});const l=document.querySelector(".brag-book-gallery-wrapper");let n=l?.dataset.baseUrl||window.location.pathname;!l?.dataset.baseUrl&&n.match(/\/[^\/]+\/?$/)&&(n=n.replace(/\/[^\/]+\/?$/,""));const c=`${n}/${a}/`.replace(/\/+/g,"/");window.history.pushState({category:t,procedure:a,procedureIds:o,basePath:n,hasNudity:s},"",c),this.loadFilteredContent(t,a,o,s)}navigateToFilteredPage(){if(this.activeFilters.size>0){const e=`/${Array.from(this.activeFilters.values())[0].procedure}`;this.options.onNavigate(e)}else this.options.onNavigate(this.options.baseUrl)}updateUrlState(){if(window.history&&window.history.replaceState){const e=new URLSearchParams,t=new Map;this.activeFilters.forEach(e=>{t.has(e.category)||t.set(e.category,[]),t.get(e.category).push(e.procedure)}),t.forEach((t,a)=>{e.append(a,t.join(","))});const a=e.toString()?`?${e.toString()}`:window.location.pathname;window.history.replaceState({},"",a)}}reactivateFilter(e,t){this.activeFilters.clear(),this.container?.querySelectorAll(".brag-book-gallery-nav-link").forEach(e=>{e.classList.remove("brag-book-gallery-active")});const a=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${t}"]`);a&&(a.classList.add("brag-book-gallery-active"),this.activeFilters.set(`${e}:${t}`,{category:e,procedure:t,procedureIds:a.dataset.procedureIds,count:parseInt(a.dataset.procedureCount||"0")}))}loadStateFromUrl(){const e=document.querySelector(".brag-book-gallery-wrapper"),t=e?.dataset.baseUrl||"",a=e?.dataset.initialProcedure;if(a){const e=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${a}"]`);if(e){const t=e.dataset.category||"",o="true"===e.dataset.nudity;return this.reactivateFilter(t,a),void this.loadFilteredContent(t,a,e.dataset.procedureIds,o)}}const o=window.location.pathname;let r=o;t&&o.startsWith(t)&&(r=o.substring(t.length));const s=r.match(/^\/([^\/]+)\/(\d+)\/?$/);if(s){const[,e,t]=s;return}const i=r.match(/^\/([^\/]+)\/?$/);if(i){const[,e]=i,t=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${e}"]`);if(t){const a=t.dataset.category||"",o="true"===t.dataset.nudity;this.reactivateFilter(a,e),this.loadFilteredContent(a,e,t.dataset.procedureIds,o)}}}getActiveFilters(){return this.activeFilters}getFiltersByCategory(e){const t=[];return this.activeFilters.forEach(a=>{a.category===e&&t.push(a)}),t}getFiltersByProcedure(e){const t=[];return this.activeFilters.forEach(a=>{a.procedure===e&&t.push(a)}),t}clearCategory(e){const t=[];this.activeFilters.forEach((a,o)=>{a.category===e&&t.push(o)}),t.forEach(e=>{const t=this.procedures.get(e);t&&t.link&&t.link.classList.remove("brag-book-gallery-active")}),t.forEach(e=>this.activeFilters.delete(e))}clearAll(){const e=this.container?.querySelectorAll(".brag-book-gallery-nav-link");e?.forEach(e=>{e.classList.remove("brag-book-gallery-active")}),this.activeFilters.clear(),window.history.pushState({},"",window.location.pathname)}setMode(e){this.options.mode=e}loadFilteredContent(e,t,a,o=!1){const r=document.getElementById("gallery-content");if(!r)return;r.innerHTML='<div class="brag-book-gallery-loading">Loading filtered results...</div>';let s=t;const i=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${t}"]`);if(i){const e=i.querySelector(".brag-book-gallery-filter-option-label");e&&(s=e.textContent.trim())}this.loadFilteredContentDirectly(t,a,o,s).then(i=>{if(i.success){if(this.updateGalleryContent(i.html),i.seo&&(i.seo.title&&(document.title=i.seo.title),i.seo.description)){let e=document.querySelector('meta[name="description"]');e||(e=document.createElement("meta"),e.name="description",document.head.appendChild(e)),e.content=i.seo.description}setTimeout(function(){regenerateProcedureFilters()},100),"procedure"===e&&t&&this.updateUrlForProcedure(t),r.scrollIntoView({behavior:"smooth",block:"start"})}else this.loadFilteredContentViaAjax(e,t,a,o,s,r)}).catch(i=>{this.loadFilteredContentViaAjax(e,t,a,o,s,r)})}async loadFilteredContentDirectly(e,t,a,o){try{const a=window.bragBookGalleryConfig?.apiToken||"",r=window.bragBookGalleryConfig?.websitePropertyId||"",s=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",i=window.bragBookGalleryConfig?.nonce||"";if(!(a&&r&&s&&i))return{success:!1,error:"Missing API configuration"};const l={apiTokens:[a],websitePropertyIds:[parseInt(r)],count:1};if(t){const e=t.split(",").map(e=>parseInt(e)).filter(e=>!isNaN(e));e.length>0&&(l.procedureIds=e)}let n=[],c=1;const d=20;for(;c<=d;){l.count=c;const e=new FormData;e.append("action","brag_book_api_proxy"),e.append("nonce",i),e.append("endpoint","/api/plugin/combine/cases"),e.append("method","POST"),e.append("body",JSON.stringify(l)),e.append("timeout","8");const t=new AbortController,a=setTimeout(()=>t.abort(),1e4),o=await fetch(s,{method:"POST",body:e,signal:t.signal});if(clearTimeout(a),!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const r=await o.json();if(!r.success||!r.data||!r.data.data)throw new Error(r.data?.message||"API proxy request failed");const d=r.data.data;if(!(d&&d.data&&Array.isArray(d.data)&&d.data.length>0))break;if(n=n.concat(d.data),d.data.length<10)break;c++}const g=this.generateFilteredGalleryHTML(n,o,e,t),u=this.generateSEOData(o);return{success:!0,html:g,totalCount:n.length,procedureName:o,seo:u}}catch(e){return console.error("Direct API error:",e),{success:!1,error:e.message}}}loadFilteredContentViaAjax(e,t,a,o,r,s){const i=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",l=window.bragBookGalleryConfig?.nonce||"",n=new FormData;n.append("action","brag_book_gallery_load_filtered_gallery"),n.append("nonce",l),n.append("procedure_name",r),n.append("procedure_slug",t),n.append("procedure_ids",a||""),n.append("procedure_id",a?.split(",")[0]||""),n.append("has_nudity",o?"1":"0"),fetch(i,{method:"POST",body:n}).then(e=>e.json()).then(a=>{if(a.success&&a.data?.html){if(this.updateGalleryContent(a.data.html),a.data.seo&&(a.data.seo.title&&(document.title=a.data.seo.title),a.data.seo.description)){let e=document.querySelector('meta[name="description"]');e||(e=document.createElement("meta"),e.name="description",document.head.appendChild(e)),e.content=a.data.seo.description}setTimeout(function(){regenerateProcedureFilters()},100),"procedure"===e&&t&&this.updateUrlForProcedure(t),s.scrollIntoView({behavior:"smooth",block:"start"})}else s.innerHTML='<div class="brag-book-gallery-error">No results found for the selected filter.</div>'}).catch(e=>{console.error("AJAX fallback error:",e),s.innerHTML='<div class="brag-book-gallery-error">Failed to load filtered content. Please try again.</div>'})}generateFilteredGalleryHTML(e,t,a,o){"undefined"!=typeof allCasesData&&(allCasesData=e,currentDisplayedCases=Math.min(10,e.length));const r=e.map(e=>{const t={...e};if(t.mainImageUrl="",e.photoSets&&Array.isArray(e.photoSets)&&e.photoSets.length>0){const a=e.photoSets[0];t.mainImageUrl=a.postProcessedImageLocation||a.beforeLocationUrl||a.afterLocationUrl1||""}return t.procedureTitle="Unknown Procedure",e.procedures&&Array.isArray(e.procedures)&&e.procedures.length>0&&(t.procedureTitle=e.procedures[0].name||"Unknown Procedure"),t}).filter(e=>e.mainImageUrl||e.id);let s="";const i=this.formatProcedureDisplayName(t);s+=`<h1 class="brag-book-gallery-content-title"><strong>${this.escapeHtml(i)}</strong> Before &amp; After Gallery</h1>`,s+='<div class="brag-book-gallery-controls">',s+='<div class="brag-book-gallery-controls-left">',s+='<details class="brag-book-gallery-filter-dropdown" id="procedure-filters-details" data-initialized="true">',s+='<summary class="brag-book-gallery-filter-dropdown__toggle">',s+='<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">',s+='<path d="M400-240v-80h160v80H400ZM240-440v-80h480v80H240ZM120-640v-80h720v80H120Z"></path>',s+="</svg>",s+="<span>Filters</span>",s+="</summary>",s+='<div class="brag-book-gallery-filter-dropdown__panel">',s+='<div class="brag-book-gallery-filter-content">',s+='<div class="brag-book-gallery-filter-section">',s+='<div id="brag-book-gallery-filters">',s+=this.generateProcedureFilterSections(r),s+="</div>",s+="</div>",s+="</div>",s+='<div class="brag-book-gallery-filter-actions">',s+='<button class="brag-book-gallery-button brag-book-gallery-button--apply" onclick="applyProcedureFilters()">Apply Filters</button>',s+='<button class="brag-book-gallery-button brag-book-gallery-button--clear" onclick="clearProcedureFilters()">Clear All</button>',s+="</div>",s+="</div>",s+="</details>",s+='<div class="brag-book-gallery-active-filters" style="display: none;"></div>',s+="</div>",s+='<div class="brag-book-gallery-grid-selector">',s+='<span class="brag-book-gallery-grid-label">View:</span>',s+='<div class="brag-book-gallery-grid-buttons">',s+='<button class="brag-book-gallery-grid-btn" data-columns="2" onclick="updateGridLayout(2)" aria-label="View in 2 columns">',s+='<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">',s+='<rect x="1" y="1" width="6" height="6"></rect><rect x="9" y="1" width="6" height="6"></rect>',s+='<rect x="1" y="9" width="6" height="6"></rect><rect x="9" y="9" width="6" height="6"></rect>',s+="</svg>",s+='<span class="sr-only">2 Columns</span>',s+="</button>",s+='<button class="brag-book-gallery-grid-btn active" data-columns="3" onclick="updateGridLayout(3)" aria-label="View in 3 columns">',s+='<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">',s+='<rect x="1" y="1" width="4" height="4"></rect><rect x="6" y="1" width="4" height="4"></rect><rect x="11" y="1" width="4" height="4"></rect>',s+='<rect x="1" y="6" width="4" height="4"></rect><rect x="6" y="6" width="4" height="4"></rect><rect x="11" y="6" width="4" height="4"></rect>',s+='<rect x="1" y="11" width="4" height="4"></rect><rect x="6" y="11" width="4" height="4"></rect><rect x="11" y="11" width="4" height="4"></rect>',s+="</svg>",s+='<span class="sr-only">3 Columns</span>',s+="</button>",s+="</div>",s+="</div>",s+="</div>",s+='<div class="brag-book-gallery-sections" id="gallery-sections">',s+='<div class="brag-book-gallery-section" aria-label="Filtered Gallery Results">';const l=r.length,n=Math.min(10,l);return s+=`<div class="brag-book-gallery-filter-results" style="display: block;">Filter applied: Showing ${n} of ${l} matching procedure${1!==l?"s":""}</div>`,s+='<div class="brag-book-gallery-filter-badges" data-action="filter-badges"></div>',s+='<div class="brag-book-gallery-case-grid masonry-layout" data-columns="3">',r.slice(0,10).forEach(e=>{s+=this.generateCaseHTML(e)}),s+="</div>",r.length>10&&(s+='<div class="brag-book-gallery-load-more-container">',s+='<button type="button" class="brag-book-gallery-button brag-book-gallery-button--load-more" ',s+=`data-procedure-name="${this.escapeHtml(t)}" `,s+=`data-start-page="2" data-procedure-ids="${this.escapeHtml(o)}" `,s+='onclick="loadMoreCasesFromCache(this)">Load More</button>',s+="</div>"),s+="</div>",s+="</div>",s}updateGalleryContent(e){const t=document.getElementById("gallery-content");if(t){t.innerHTML=e;const a=t.querySelector(".brag-book-gallery-filter-results");a&&(a.style.display="none"),this.setupFilterEventListeners(),this.scrollToGalleryWrapper()}}setupFilterEventListeners(){const e=document.querySelectorAll('.brag-book-gallery-filter-option input[type="checkbox"]'),t=document.querySelector(".brag-book-gallery-active-filters");t&&(t.style.display="none",t.innerHTML=""),e.forEach(e=>{e.removeEventListener("change",this.handleFilterChange),e.addEventListener("change",this.handleFilterChange.bind(this))})}handleFilterChange(e){"function"==typeof window.applyProcedureFilters?window.applyProcedureFilters():console.error("window.applyProcedureFilters is not available")}generateCaseHTML(e){const t=e.id||"",a=e.procedureTitle||"Unknown Procedure";let o='data-card="true"';o+=` data-case-id="${this.escapeHtml(t)}"`,e.age&&(o+=` data-age="${this.escapeHtml(e.age)}"`),e.gender&&(o+=` data-gender="${this.escapeHtml(e.gender.toLowerCase())}"`),e.ethnicity&&(o+=` data-ethnicity="${this.escapeHtml(e.ethnicity.toLowerCase())}"`);const r=e.procedureIds?e.procedureIds.join(","):"";r&&(o+=` data-procedure-ids="${this.escapeHtml(r)}"`);const s=document.querySelector(".brag-book-gallery-nav-link.brag-book-gallery-active"),i=s?.dataset.procedureId||"",l=s?.dataset.termId||"";i&&(o+=` data-current-procedure-id="${this.escapeHtml(i)}"`),l&&(o+=` data-current-term-id="${this.escapeHtml(l)}"`);const n=`/${window.bragBookGalleryConfig?.gallerySlug||"gallery"}/${this.extractProcedureSlugFromUrl()||"case"}/${e.caseDetails&&e.caseDetails[0]&&e.caseDetails[0].seoSuffixUrl||t}/`;let c="";if(e.photoSets&&Array.isArray(e.photoSets)&&e.photoSets.length>0){const t=e.photoSets[0];c=t.postProcessedImageLocation||t.afterLocationUrl1||t.beforeLocationUrl||t.afterPhoto||t.beforePhoto||""}let d=`<article class="brag-book-gallery-case-card" ${o}>`;d+='<div class="brag-book-gallery-case-images single-image">',d+='<div class="brag-book-gallery-image-container">',d+='<div class="brag-book-gallery-skeleton-loader" style="display: none;"></div>',d+='<div class="brag-book-gallery-item-actions">',d+=`<button class="brag-book-gallery-favorite-button" data-favorited="false" data-item-id="case-${this.escapeHtml(t)}" aria-label="Add to favorites">`,d+='<svg fill="rgba(255, 255, 255, 0.5)" stroke="white" stroke-width="2" viewBox="0 0 24 24">',d+='<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>',d+="</svg>",d+="</button>",d+="</div>",d+=`<a href="${this.escapeHtml(n)}" class="brag-book-gallery-case-card-link" data-case-id="${this.escapeHtml(t)}" data-procedure-ids="${this.escapeHtml(r)}">`,c&&(d+='<picture class="brag-book-gallery-picture">',d+=`<img src="${this.escapeHtml(c)}" alt="${this.escapeHtml(a)} - Case ${this.escapeHtml(t)}" loading="lazy" data-image-type="single" data-image-url="${this.escapeHtml(c)}" onload="this.closest('.brag-book-gallery-image-container').querySelector('.brag-book-gallery-skeleton-loader').style.display='none';">`,d+="</picture>"),d+="</a>";const g=document.querySelector(".brag-book-gallery-nav-link.brag-book-gallery-active");return g&&"true"===g.dataset.nudity&&(d+='<div class="brag-book-gallery-nudity-warning">',d+='<div class="brag-book-gallery-nudity-warning-content">',d+='<h4 class="brag-book-gallery-nudity-warning-title">Nudity Warning</h4>',d+='<p class="brag-book-gallery-nudity-warning-caption">This procedure may contain nudity or sensitive content. Click to proceed if you wish to view.</p>',d+='<button class="brag-book-gallery-nudity-warning-button" type="button">Proceed</button>',d+="</div>",d+="</div>"),d+="</div>",d+="</div>",d+='<details class="brag-book-gallery-case-card-details">',d+='<summary class="brag-book-gallery-case-card-summary">',d+='<div class="brag-book-gallery-case-card-summary-info">',d+=`<span class="brag-book-gallery-case-card-summary-info__name">${this.escapeHtml(a)}</span>`,d+=`<span class="brag-book-gallery-case-card-summary-info__case-number">Case #${this.escapeHtml(t)}</span>`,d+="</div>",d+='<div class="brag-book-gallery-case-card-summary-details">',d+='<p class="brag-book-gallery-case-card-summary-details__more">',d+="<strong>More Details</strong>",d+='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">',d+='<path d="M444-288h72v-156h156v-72H516v-156h-72v156H288v72h156v156Zm36.28 192Q401-96 331-126t-122.5-82.5Q156-261 126-330.96t-30-149.5Q96-560 126-629.5q30-69.5 82.5-122T330.96-834q69.96-30 149.5-30t149.04 30q69.5 30 122 82.5T834-629.28q30 69.73 30 149Q864-401 834-331t-82.5 122.5Q699-156 629.28-126q-69.73 30-149 30Z"></path>',d+="</svg>",d+="</p>",d+="</div>",d+="</summary>",d+='<div class="brag-book-gallery-case-card-details-content">',d+='<p class="brag-book-gallery-case-card-details-content__title">Procedures Performed:</p>',d+='<ul class="brag-book-gallery-case-card-procedures-list">',e.procedures&&Array.isArray(e.procedures)&&e.procedures.length>0?e.procedures.forEach(e=>{d+=`<li class="brag-book-gallery-case-card-procedures-list__item">${this.escapeHtml(e.name||"Unknown Procedure")}</li>`}):d+=`<li class="brag-book-gallery-case-card-procedures-list__item">${this.escapeHtml(a)}</li>`,d+="</ul>",d+="</div>",d+="</details>",d+="</article>",d}extractProcedureSlugFromUrl(){const e=window.location.pathname.split("/").filter(e=>e),t=window.bragBookGalleryConfig?.gallerySlug||"gallery",a=e.indexOf(t.replace(/^\/+/,""));if(a>=0&&a+1<e.length){const t=e[a+1];if(!/^\d+$/.test(t))return t}return null}generateFiltersFromDOMCards(){const e=document.querySelectorAll(".brag-book-gallery-case-card");if(0===e.length)return"";const t={age:new Set,gender:new Set,ethnicity:new Set,height:new Set,weight:new Set,procedureDetails:new Map};e.forEach(e=>{const a=e.dataset.age;if(a){const e=parseInt(a);e>=18&&e<25?t.age.add("18-24"):e>=25&&e<35?t.age.add("25-34"):e>=35&&e<45?t.age.add("35-44"):e>=45&&e<55?t.age.add("45-54"):e>=55&&e<65?t.age.add("55-64"):e>=65&&t.age.add("65+")}const o=e.dataset.gender;o&&t.gender.add(o.toLowerCase());const r=e.dataset.ethnicity;r&&t.ethnicity.add(r);const s=e.dataset.height;if(s){const e=parseFloat(s);e<60?t.height.add("Under 5'0\""):e>=60&&e<64?t.height.add("5'0\" - 5'3\""):e>=64&&e<68?t.height.add("5'4\" - 5'7\""):e>=68&&e<72?t.height.add("5'8\" - 5'11\""):e>=72&&t.height.add("6'0\" and above")}const i=e.dataset.weight;if(i){const e=parseFloat(i);e<120?t.weight.add("Under 120 lbs"):e>=120&&e<150?t.weight.add("120-149 lbs"):e>=150&&e<180?t.weight.add("150-179 lbs"):e>=180&&e<210?t.weight.add("180-209 lbs"):e>=210&&t.weight.add("210+ lbs")}Object.keys(e.dataset).forEach(a=>{if(a.startsWith("procedureDetail")){const o=a.replace("procedureDetail","").replace(/([A-Z])/g," $1").trim(),r=e.dataset[a];r&&r.split(",").map(e=>e.trim()).filter(e=>e).forEach(e=>{t.procedureDetails.has(o)||t.procedureDetails.set(o,new Set);const a=e.split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ");t.procedureDetails.get(o).add(a)})}})});let a="";if(t.age.size>0&&(a+=this.generateFilterSection("Age","age",Array.from(t.age).sort())),t.gender.size>0){const e=Array.from(t.gender).map(e=>"male"===e?"Male":"female"===e?"Female":e);a+=this.generateFilterSection("Gender","gender",e)}return t.ethnicity.size>0&&(a+=this.generateFilterSection("Ethnicity","ethnicity",Array.from(t.ethnicity).sort())),t.height.size>0&&(a+=this.generateFilterSection("Height","height",Array.from(t.height))),t.weight.size>0&&(a+=this.generateFilterSection("Weight","weight",Array.from(t.weight))),t.procedureDetails.size>0&&t.procedureDetails.forEach((e,t)=>{if(e.size>0){const o="procedure_detail_"+t.toLowerCase().replace(/\s+/g,"_");a+=this.generateFilterSection(t,o,Array.from(e).sort())}}),a}generateProcedureFilterSections(e){const t={age:new Set,gender:new Set,ethnicity:new Set,height:new Set,weight:new Set,procedureDetails:new Map};e.forEach(e=>{if(e.age){const a=parseInt(e.age);a>=18&&a<25?t.age.add("18-24"):a>=25&&a<35?t.age.add("25-34"):a>=35&&a<45?t.age.add("35-44"):a>=45&&a<55?t.age.add("45-54"):a>=55&&a<65?t.age.add("55-64"):a>=65&&t.age.add("65+")}if(e.gender&&t.gender.add(e.gender.toLowerCase()),e.ethnicity&&t.ethnicity.add(e.ethnicity),e.height){const a=parseFloat(e.height);a<60?t.height.add("Under 5'0\""):a>=60&&a<64?t.height.add("5'0\" - 5'3\""):a>=64&&a<68?t.height.add("5'4\" - 5'7\""):a>=68&&a<72?t.height.add("5'8\" - 5'11\""):a>=72&&t.height.add("6'0\" and above")}if(e.weight){const a=parseFloat(e.weight);a<120?t.weight.add("Under 120 lbs"):a>=120&&a<150?t.weight.add("120-149 lbs"):a>=150&&a<180?t.weight.add("150-179 lbs"):a>=180&&a<210?t.weight.add("180-209 lbs"):a>=210&&t.weight.add("210+ lbs")}}),document.querySelectorAll(".brag-book-gallery-case-card").forEach(e=>{Object.keys(e.dataset).forEach(a=>{if(a.startsWith("procedureDetail")){const o=a.replace("procedureDetail","").replace(/([A-Z])/g," $1").trim(),r=e.dataset[a];r&&r.split(",").map(e=>e.trim()).filter(e=>e).forEach(e=>{t.procedureDetails.has(o)||t.procedureDetails.set(o,new Set);const a=e.split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ");t.procedureDetails.get(o).add(a)})}})});let a="";if(t.age.size>0&&(a+=this.generateFilterSection("Age","age",Array.from(t.age).sort())),t.gender.size>0){const e=Array.from(t.gender).map(e=>"male"===e?"Male":"female"===e?"Female":e);a+=this.generateFilterSection("Gender","gender",e)}return t.ethnicity.size>0&&(a+=this.generateFilterSection("Ethnicity","ethnicity",Array.from(t.ethnicity).sort())),t.height.size>0&&(a+=this.generateFilterSection("Height","height",Array.from(t.height))),t.weight.size>0&&(a+=this.generateFilterSection("Weight","weight",Array.from(t.weight))),t.procedureDetails.size>0&&t.procedureDetails.forEach((e,t)=>{if(e.size>0){const o="procedure_detail_"+t.toLowerCase().replace(/\s+/g,"_");a+=this.generateFilterSection(t,o,Array.from(e).sort())}}),a}generateFilterSection(e,t,a){let o='<details class="brag-book-gallery-filter">';return o+='<summary class="brag-book-gallery-filter-label">',o+=`<span class="brag-book-gallery-filter-label__name">${this.escapeHtml(e)}</span>`,o+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>',o+="</svg>",o+="</summary>",o+='<ul class="brag-book-gallery-filter-options">',a.forEach(e=>{const a=`procedure-filter-${t}-${e.replace(/[^a-zA-Z0-9]/g,"-")}`,r="gender"===t||"ethnicity"===t?e.toLowerCase():e;o+='<li class="brag-book-gallery-filter-option">',o+=`<input type="checkbox" id="${a}" value="${this.escapeHtml(r)}" data-filter-type="${t}">`,o+=`<label for="${a}">${this.escapeHtml(e)}</label>`,o+="</li>"}),o+="</ul>",o+="</details>",o}generateSEOData(e){const t={};if(e){const a=this.formatProcedureDisplayName(e),o=document.title.split(" | ").pop()||"BRAGBook Gallery";t.title=`${a} Before & After Gallery | ${o}`,t.description=`View before and after photos of ${a} procedures. Browse our gallery to see real patient results.`}return t}formatProcedureDisplayName(e){return e?e.split(/[\s-_]+/).map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" "):""}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML.replace(/"/g,"&quot;").replace(/'/g,"&#39;")}updateFilterBadges(){}createFilterBadge(e,t,a){const o=document.createElement("div");o.className="brag-book-gallery-filter-badge",o.setAttribute("data-filter-key",a);let r="";switch(e){case"age":r=`Age: ${t}`;break;case"gender":r=`Gender: ${t}`;break;case"ethnicity":r=`Ethnicity: ${t}`;break;case"procedure":r=t;break;default:r=`${e}: ${t}`}return o.innerHTML=`\n\t\t\t<span class="brag-book-gallery-badge-text">${r}</span>\n\t\t\t<button class="brag-book-gallery-badge-remove" aria-label="Remove ${r} filter">\n\t\t\t\t<svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">\n\t\t\t\t\t<path d="M13 1L1 13M1 1l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n\t\t\t\t</svg>\n\t\t\t</button>\n\t\t`,o.querySelector(".brag-book-gallery-badge-remove").addEventListener("click",e=>{e.preventDefault(),this.removeFilterBadge(a)}),o}removeFilterBadge(e){const t=this.activeFilters.get(e);if(t){this.activeFilters.delete(e);const a=document.querySelector(`[data-category="${t.category}"][data-procedure="${t.procedure}"]`);a&&a.classList.remove("brag-book-gallery-active"),this.options.onFilterChange(this.activeFilters)}}clearAllFilters(){const e=this.container?.querySelectorAll(".brag-book-gallery-nav-list-submenu-link");e?.forEach(e=>{e.classList.remove("brag-book-gallery-active")}),this.activeFilters.clear(),this.options.onFilterChange(this.activeFilters),window.history.pushState({},"",window.location.pathname)}scrollToGalleryWrapper(){const e=document.querySelector(".brag-book-gallery-wrapper");if(e){const t=e.getBoundingClientRect().top+window.pageYOffset-20;window.scrollTo({top:t,behavior:"smooth"})}}},a=class{constructor(e={}){this.sidebar=document.querySelector(".brag-book-gallery-sidebar"),this.overlay=document.querySelector(".brag-book-gallery-mobile-overlay"),this.menuToggle=document.querySelector(".brag-book-gallery-mobile-menu-toggle"),this.closeButton=document.querySelector('[data-action="close-menu"]'),this.options={breakpoint:e.breakpoint||1024,swipeToClose:!1!==e.swipeToClose,...e},this.touchStartX=0,this.touchEndX=0,this.sidebar&&this.menuToggle&&this.init()}init(){let e;this.setupEventListeners(),this.checkMobileView(),window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{this.checkMobileView()},250)})}setupEventListeners(){this.menuToggle?.addEventListener("click",()=>this.toggle()),this.overlay?.addEventListener("click",()=>this.close()),this.closeButton?.addEventListener("click",()=>this.close()),this.sidebar&&this.sidebar.addEventListener("click",e=>{e.target.closest(".brag-book-gallery-nav-link")&&window.innerWidth<this.options.breakpoint&&setTimeout(()=>{this.close()},100)}),this.options.swipeToClose&&this.setupSwipeGestures(),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isOpen()&&this.close()})}setupSwipeGestures(){this.sidebar?.addEventListener("touchstart",e=>{this.touchStartX=e.changedTouches[0].screenX},{passive:!0}),this.sidebar?.addEventListener("touchend",e=>{this.touchEndX=e.changedTouches[0].screenX,this.handleSwipeGesture()},{passive:!0})}handleSwipeGesture(){this.touchStartX-this.touchEndX>50&&this.isOpen()&&this.close()}checkMobileView(){const e=window.innerWidth<=this.options.breakpoint,t=document.querySelector(".brag-book-gallery-sidebar-header"),a=document.querySelector(".brag-book-gallery-mobile-header");t&&(t.style.display=e?"flex":"none"),a&&(a.style.display=e?"flex":"none"),e||(this.close(),document.body.classList.remove("brag-book-gallery-mobile-menu-open"))}toggle(){this.isOpen()?this.close():this.open()}open(){if(!this.sidebar||!this.menuToggle)return;this.menuToggle.dataset.menuOpen="true",this.menuToggle.setAttribute("aria-expanded","true"),this.menuToggle.setAttribute("aria-label","Close navigation menu"),this.sidebar.classList.add("brag-book-gallery-active"),this.overlay?.classList.add("brag-book-gallery-active"),document.body.classList.add("brag-book-gallery-mobile-menu-open");const e=document.querySelector(".brag-book-gallery-wrapper");e&&(e.style.zIndex="9999");const t=this.menuToggle.querySelector("svg");t&&(t.innerHTML='<path d="M256-213.85 213.85-256l224-224-224-224L256-746.15l224 224 224-224L746.15-704l-224 224 224 224L704-213.85l-224-224-224 224Z"/>'),document.body.style.overflow="hidden",this.previousFocus=document.activeElement,setTimeout(()=>{const e=this.sidebar.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');e&&e.focus()},300)}close(){if(!this.sidebar||!this.menuToggle)return;this.menuToggle.dataset.menuOpen="false",this.menuToggle.setAttribute("aria-expanded","false"),this.menuToggle.setAttribute("aria-label","Open navigation menu"),this.sidebar.classList.remove("brag-book-gallery-active"),this.overlay?.classList.remove("brag-book-gallery-active"),document.body.classList.remove("brag-book-gallery-mobile-menu-open");const e=document.querySelector(".brag-book-gallery-wrapper");e&&(e.style.zIndex="");const t=this.menuToggle.querySelector("svg");t&&(t.innerHTML='<path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"/>'),document.body.style.overflow="",this.previousFocus&&this.previousFocus.focus&&this.previousFocus.focus()}isOpen(){return"true"===this.menuToggle?.dataset.menuOpen}},o=class{constructor(e={}){this.favorites=new Set,this.userInfo=null,this.hasShownDialog=!1,this.options={storageKey:e.storageKey||"brag-book-favorites",userInfoKey:e.userInfoKey||"brag-book-user-info",persistToStorage:!1!==e.persistToStorage,onUpdate:e.onUpdate||(()=>{}),...e},this.init()}init(){this.favoritesDialog=new e("favoritesDialog",{onClose:()=>{!this.userInfo&&this.lastAddedFavorite&&(this.removeFavorite(this.lastAddedFavorite),this.lastAddedFavorite=null)}}),this.options.persistToStorage&&(this.loadFromStorage(),this.loadUserInfo()),this.setupEventListeners(),this.updateUI()}setupEventListeners(){document.addEventListener("click",e=>{const t=e.target.closest("[data-favorited]");t&&(e.preventDefault(),this.toggleFavorite(t)),e.target.closest('[data-action="close-favorites-dialog"]')&&this.favoritesDialog.close()});const e=document.querySelector('[data-form="favorites"], [data-form="favorites-email"]');e&&e.addEventListener("submit",e=>{e.preventDefault(),this.handleFavoritesFormSubmit(e.target)});const t=document.querySelector(".brag-book-gallery-favorites-lookup-form, #favorites-email-form");t&&t.addEventListener("submit",e=>{e.preventDefault(),this.handleFavoritesLookupSubmit(e.target)})}toggleFavorite(e){let t="";const a="true"===e.dataset.favorited,o=e.closest(".brag-book-gallery-case-card");if(o&&o.dataset.postId)t=o.dataset.postId;else if(t=e.dataset.itemId||e.dataset.caseId||"",t){const e=t.match(/(\d+)/);e&&(t=e[1])}this.updateHiddenCaseIdField(t),a?this.removeFavorite(t,e):t?(this.userInfo&&this.userInfo.email||this.loadUserInfo(),this.userInfo&&this.userInfo.email?(this.addFavorite(t,e),this.submitFavoriteToAPI(t)):(this.lastAddedFavorite=t,this.lastAddedButton=e,this.addFavorite(t,e),this.favoritesDialog.open(),this.hasShownDialog=!0)):console.error("No item ID found on button:",e)}updateHiddenCaseIdField(e){const t=document.querySelector('input[name="fav-case-id"]');t&&e&&(t.value=e)}addFavorite(e,t){t&&(t.dataset.favorited="true"),document.querySelectorAll(`[data-item-id="${e}"], [data-case-id="${e}"]`).forEach(e=>{void 0!==e.dataset.favorited&&(e.dataset.favorited="true")}),this.favorites.add(e),this.options.persistToStorage&&this.saveToStorage(),this.updateUI(),this.options.onUpdate(this.favorites),window.dispatchEvent(new CustomEvent("favoritesUpdated",{detail:{favorites:this.favorites}}))}removeFavorite(e,t){t?(t.dataset.favorited="false",document.querySelectorAll(`[data-item-id="${e}"], [data-case-id="${e}"]`).forEach(e=>{e!==t&&void 0!==e.dataset.favorited&&(e.dataset.favorited="false")})):document.querySelectorAll(`[data-item-id="${e}"][data-favorited="true"], [data-case-id="${e}"][data-favorited="true"]`).forEach(e=>{e.dataset.favorited="false"}),this.favorites.delete(e),this.options.persistToStorage&&this.saveToStorage(),this.updateUI(),this.options.onUpdate(this.favorites),window.dispatchEvent(new CustomEvent("favoritesUpdated",{detail:{favorites:this.favorites}}))}submitFavoriteToAPI(e){const t=new FormData;t.append("action","brag_book_add_favorite"),t.append("nonce",window.bragBookGalleryConfig?.nonce||""),t.append("case_id",e),t.append("email",this.userInfo.email||""),t.append("phone",this.userInfo.phone||""),t.append("name",this.userInfo.name||""),fetch(window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",body:t}).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(t=>{t.success?this.showSuccessNotification("Added to favorites!"):(console.error("Failed to save favorite:",t.data?.message),this.removeFavorite(e),this.showErrorNotification("Failed to save favorite. Please try again."))}).catch(t=>{console.error("Error submitting favorite:",t),this.removeFavorite(e),this.showErrorNotification("Error saving favorite. Please try again.")})}handleFavoritesFormSubmit(e){const t=new FormData(e);let a=t.get("fav-case-id")||this.lastAddedFavorite;if(!a){const e=document.querySelector(".brag-book-gallery-case-card");e&&(a=e.dataset.postId||e.dataset.caseId)}if(!a)return void this.showFormError(e,"Unable to determine case ID. Please try clicking the favorite button again.");const o=t.get("fav-email")||"",r=t.get("fav-name")||"",s=t.get("fav-phone")||"";if(!o||!r||!s)return void this.showFormError(e,"Please fill in all required fields.");const i=e.querySelector('button[type="submit"]'),l=i?i.textContent:"";i&&(i.disabled=!0,i.textContent="Submitting...");const n=e.querySelector(".brag-book-gallery-form-error"),c=e.querySelector(".brag-book-gallery-form-success");n&&n.remove(),c&&c.remove(),t.append("action","brag_book_add_favorite"),t.append("nonce",window.bragBookGalleryConfig?.nonce||""),t.append("case_id",a),t.append("email",o),t.append("phone",s),t.append("name",r),fetch(window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",body:t}).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(t=>{if(t.success){const a={email:o,name:r,phone:s};this.userInfo=a;try{localStorage.setItem(this.options.userInfoKey,JSON.stringify(a))}catch(e){console.error("Failed to save user info to localStorage:",e)}const i=document.createElement("div");i.className="brag-book-gallery-form-success",i.textContent=t.data.message||"Your information has been saved. Keep adding favorites!",e.appendChild(i),setTimeout(()=>{this.favoritesDialog.close(),e.reset(),i&&i.remove()},2e3),this.showSuccessNotification(t.data.message||"Your information has been saved. Keep adding favorites!"),this.lastAddedFavorite=null,this.lastAddedButton=null}else{const a=document.createElement("div");a.className="brag-book-gallery-form-error",a.textContent=t.data.message||"Failed to save. Please try again.",e.appendChild(a),this.lastAddedFavorite&&this.lastAddedButton&&this.removeFavorite(this.lastAddedFavorite,this.lastAddedButton)}}).catch(t=>{console.error("Error submitting favorites form:",t);const a=document.createElement("div");a.className="brag-book-gallery-form-error",a.textContent="An error occurred. Please try again.",e.appendChild(a),this.lastAddedFavorite&&this.lastAddedButton&&this.removeFavorite(this.lastAddedFavorite,this.lastAddedButton)}).finally(()=>{i&&(i.disabled=!1,i.textContent=l)})}handleFavoritesLookupSubmit(e){const t=new FormData(e),a=t.get("email");if(!a)return void this.showLookupError(e,"Please enter an email address.");const o=e.querySelector('button[type="submit"]'),r=o?o.textContent:"";o&&(o.disabled=!0,o.textContent="Checking..."),this.clearLookupMessages(e);const s=this.getUserInfo();s&&s.email===a?this.showLookupSuccess(e,a):(t.append("action","brag_book_lookup_favorites"),t.append("nonce",window.bragBookGalleryConfig?.nonce||""),fetch(window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",body:t}).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(t=>{if(t.success)if(t.data&&t.data.user){const o=t.data.user,r=t.data.favorites||{};if(o.email&&o.name&&o.phone){const t={email:o.email,name:o.name,first_name:o.first_name||"",last_name:o.last_name||"",phone:o.phone,id:o.id};if(localStorage.setItem("brag-book-user-info",JSON.stringify(t)),this.userInfo=t,r.cases_data&&Object.keys(r.cases_data).length>0){const e=(r.case_ids||[]).map(e=>String(e));localStorage.setItem("brag-book-favorites",JSON.stringify(e)),this.favorites=new Set(e),e.forEach(e=>{document.querySelectorAll(`[data-item-id="${e}"], [data-case-id="${e}"]`).forEach(e=>{void 0!==e.dataset.favorited&&(e.dataset.favorited="true")})})}this.showLookupSuccess(e,a,t,r)}else this.showLookupError(e,"Account found but missing required information. Please contact support.")}else this.showLookupError(e,"Account found but no details available. Please contact support.");else this.showLookupError(e,t.data?.message||"We were unable to locate account details for this email address.")}).catch(t=>{console.error("Error looking up favorites:",t),this.showLookupError(e,"An error occurred while looking up your favorites. Please try again.")}).finally(()=>{o&&(o.disabled=!1,o.textContent=r)}))}showLookupSuccess(e,t,a=null,o=null){if(a&&a.email&&a.name&&a.phone)this.userInfo=a,this.saveUserInfo();else{const t=this.getUserInfo();if(!(t&&t.email&&t.name&&t.phone))return void this.showLookupError(e,"Unable to load complete account information. Please try again or contact support.");this.userInfo=t}o&&o.total_count>0&&this.updateUI();const r=document.createElement("div");r.className="brag-book-gallery-form-success";const s=o?.total_count||0;r.textContent=`Account found! Loading ${s} favorite${1!==s?"s":""}...`,e.appendChild(r),setTimeout(()=>{window.bragBookGalleryApp&&"function"==typeof window.bragBookGalleryApp.initializeFavoritesPage&&window.bragBookGalleryApp.initializeFavoritesPage()},1e3)}showLookupError(e,t){const a=document.createElement("div");a.className="brag-book-gallery-form-error",a.textContent=t,e.appendChild(a)}clearLookupMessages(e){const t=e.querySelector(".brag-book-gallery-form-error"),a=e.querySelector(".brag-book-gallery-form-success");t&&t.remove(),a&&a.remove()}showFormError(e,t){this.clearLookupMessages(e);const a=document.createElement("div");a.className="brag-book-gallery-form-error",a.textContent=t,e.appendChild(a);const o=e.querySelector('button[type="submit"]');o&&(o.disabled=!1)}showSuccessNotification(e){this.showNotification(e,"success")}showErrorNotification(e){this.showNotification(e,"error")}showNotification(e,t="success"){let a=document.getElementById("favoritesNotification");a||(a=document.createElement("div"),a.id="favoritesNotification",a.className="brag-book-gallery-favorites-notification",document.body.appendChild(a)),a.textContent=e,a.classList.remove("success","error"),a.classList.add("active",t),setTimeout(()=>{a.classList.remove("active","success","error")},"error"===t?5e3:3e3)}updateFavoritesDisplay(){const e=document.getElementById("favorites-grid"),t=document.getElementById("favorites-empty");e&&t&&(e.innerHTML="",0===this.favorites.size?(e.style.display="none",t.style.display="block"):(e.style.display="grid",t.style.display="none",this.favorites.forEach(t=>{const a=document.querySelector(`[data-item-id="${t}"]`);if(!a)return;const o=a.closest(".brag-book-gallery-carousel-item");if(!o)return;const r=o.querySelector("img");if(!r)return;const s=document.createElement("div");s.className="brag-book-gallery-favorites-item",s.dataset.itemId=t;const i=r.cloneNode(!0);s.appendChild(i);const l=document.createElement("button");l.className="brag-book-gallery-favorites-item-remove",l.innerHTML="Ã—",l.title="Remove from favorites",l.onclick=e=>{e.stopPropagation(),this.removeFavorite(t)},s.appendChild(l),e.appendChild(s)})))}updateUI(){const e=document.querySelectorAll("[data-favorites-count]"),t=this.favorites.size;e.forEach(e=>{const a=e.closest(".brag-book-gallery-favorites-link--tiles");e.textContent=a?t:`(${t})`}),this.updateAllButtonStates(),this.updateFavoritesDisplay()}updateAllButtonStates(){document.querySelectorAll("[data-favorited]").forEach(e=>{let t="";const a=e.closest(".brag-book-gallery-case-card, .brag-book-gallery-carousel-item");if(a&&a.dataset.postId)t=a.dataset.postId;else if(t=e.dataset.itemId||e.dataset.caseId||"",t){const e=t.match(/(\d+)/);e&&(t=e[1])}t&&this.favorites.has(t)?e.dataset.favorited="true":t&&(e.dataset.favorited="false")})}loadFromStorage(){try{const e=localStorage.getItem(this.options.storageKey);if(e){const t=JSON.parse(e);this.favorites=new Set(t),t.forEach(e=>{document.querySelectorAll(`[data-item-id="${e}"], [data-case-id="${e}"]`).forEach(e=>{void 0!==e.dataset.favorited&&(e.dataset.favorited="true")})})}}catch(e){console.error("Failed to load favorites from storage:",e)}}saveToStorage(){try{localStorage.setItem(this.options.storageKey,JSON.stringify([...this.favorites]))}catch(e){console.error("Failed to save favorites to storage:",e)}}loadUserInfo(){try{const e=localStorage.getItem(this.options.userInfoKey);e&&(this.userInfo=JSON.parse(e),this.hasShownDialog=!0)}catch(e){console.error("Failed to load user info from storage:",e)}}saveUserInfo(){if(this.userInfo&&this.userInfo.email&&this.userInfo.name&&this.userInfo.phone)try{localStorage.setItem(this.options.userInfoKey,JSON.stringify(this.userInfo))}catch(e){console.error("Failed to save user info to storage:",e)}else console.warn("Cannot save incomplete user info to localStorage:",this.userInfo)}getFavorites(){return this.favorites}clear(){this.favorites.clear(),this.options.persistToStorage&&this.saveToStorage(),this.updateUI()}getUserInfo(){if(this.userInfo)return this.userInfo;try{const e=localStorage.getItem(this.options.userInfoKey);if(e)return this.userInfo=JSON.parse(e),this.userInfo}catch(e){console.error("Failed to retrieve user info from localStorage:",e)}return null}getFavorites(){return this.favorites}saveUserInfo(){if(this.userInfo&&this.userInfo.email&&this.userInfo.name&&this.userInfo.phone)try{localStorage.setItem(this.options.userInfoKey,JSON.stringify(this.userInfo))}catch(e){console.error("Failed to save user info to localStorage:",e)}else console.warn("Cannot save incomplete user info to localStorage:",this.userInfo)}refreshEventListeners(){document.querySelectorAll(".brag-book-gallery-favorite-button").forEach(e=>{e.removeEventListener("click",this.handleFavoriteClick),e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.toggleFavorite(e)})})}},r=class{constructor(e={}){this.options={shareMenuId:e.shareMenuId||"shareMenu",onShare:e.onShare||(()=>{}),...e},this.shareMenu=document.getElementById(this.options.shareMenuId),this.activeButton=null,this.activeItem=null,this.init()}init(){this.setupEventListeners(),this.createShareMenu()}createShareMenu(){}setupEventListeners(){document.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-share-button");t&&(e.preventDefault(),e.stopPropagation(),this.toggleShareDropdown(t));const a=e.target.closest(".brag-book-gallery-share-dropdown-item");if(a){e.preventDefault();const t=a.dataset.shareType;t&&(this.handleShare(t),this.hideShareDropdown())}document.querySelectorAll(".brag-book-gallery-share-dropdown.active").forEach(t=>{if(!t.contains(e.target)&&!e.target.closest(".brag-book-gallery-share-button")){t.classList.remove("active");const e=t.closest(".brag-book-gallery-share-button");e&&e.classList.remove("active")}})}),document.addEventListener("keydown",e=>{"Escape"===e.key&&document.querySelectorAll(".brag-book-gallery-share-dropdown.active").forEach(e=>{e.classList.remove("active");const t=e.closest(".brag-book-gallery-share-button");t&&t.classList.remove("active")})})}toggleShareDropdown(e){this.activeButton===e&&this.shareMenu?.classList.contains("active")?this.hideShareDropdown():this.showShareDropdown(e)}showShareDropdown(e){this.activeItem=e.closest(".brag-book-gallery-carousel-item"),this.activeButton=e;let t=e.querySelector(".brag-book-gallery-share-dropdown");if(!t){const a='\n                <div class="brag-book-gallery-share-dropdown" role="menu">\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="link" role="menuitem">Copy Link</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="email" role="menuitem">Email</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="facebook" role="menuitem">Facebook</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="twitter" role="menuitem">Twitter</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="pinterest" role="menuitem">Pinterest</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="whatsapp" role="menuitem">WhatsApp</button>\n                </div>\n            ';e.insertAdjacentHTML("beforeend",a),t=e.querySelector(".brag-book-gallery-share-dropdown")}this.shareMenu=t,e.classList.add("active"),this.shareMenu.classList.add("active")}hideShareDropdown(){this.shareMenu&&(this.activeButton&&this.activeButton.classList.remove("active"),this.shareMenu.classList.remove("active"),this.activeButton=null,this.activeItem=null)}handleShare(e){if(!this.activeItem)return;const t=this.activeItem.querySelector("img"),a=t?.src||"",o=t?.alt||"Medical procedure result",r=this.activeItem.dataset.slide||"",s=`${window.location.origin+window.location.pathname}#${r}`,i=`Check out this ${o}`;switch(e){case"link":this.copyToClipboard(s);break;case"email":this.shareViaEmail(s,i);break;case"facebook":this.shareViaFacebook(s);break;case"twitter":this.shareViaTwitter(s,i);break;case"pinterest":this.shareViaPinterest(s,a,i);break;case"whatsapp":this.shareViaWhatsApp(s,i)}this.options.onShare({type:e,url:s,text:i})}copyToClipboard(e){navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{this.showNotification("Link copied to clipboard!")}).catch(()=>{this.fallbackCopyToClipboard(e)}):this.fallbackCopyToClipboard(e)}fallbackCopyToClipboard(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-999999px",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),this.showNotification("Link copied to clipboard!")}catch(e){this.showNotification("Failed to copy link")}document.body.removeChild(t)}shareViaEmail(e,t){const a=encodeURIComponent("Check out this medical procedure result"),o=encodeURIComponent(`${t}\n\n${e}`);window.location.href=`mailto:?subject=${a}&body=${o}`}shareViaFacebook(e){const t=`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(e)}`;this.openShareWindow(t,"facebook")}shareViaTwitter(e,t){const a=`https://twitter.com/intent/tweet?url=${encodeURIComponent(e)}&text=${encodeURIComponent(t)}`;this.openShareWindow(a,"twitter")}shareViaPinterest(e,t,a){const o=`https://pinterest.com/pin/create/button/?url=${encodeURIComponent(e)}&media=${encodeURIComponent(t)}&description=${encodeURIComponent(a)}`;this.openShareWindow(o,"pinterest")}shareViaWhatsApp(e,t){const a=`https://wa.me/?text=${encodeURIComponent(`${t} ${e}`)}`;this.openShareWindow(a,"whatsapp")}openShareWindow(e,t){const a=(window.innerWidth-600)/2,o=(window.innerHeight-400)/2;window.open(e,`share-${t}`,`width=600,height=400,left=${a},top=${o},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`)}showNotification(e){let t=document.getElementById("shareNotification");t||(t=document.createElement("div"),t.id="shareNotification",t.className="brag-book-gallery-share-notification",document.body.appendChild(t)),t.textContent=e,t.classList.add("active"),setTimeout(()=>{t.classList.remove("active")},3e3)}async shareNative(e){if(navigator.share)try{return await navigator.share({title:e.title||"Medical Procedure Result",text:e.text,url:e.url}),!0}catch(e){return"AbortError"!==e.name&&console.error("Share failed:",e),!1}return!1}},s=class{constructor(e,t={}){this.wrapper=e,this.input=e.querySelector(".brag-book-gallery-search-input"),this.dropdown=e.querySelector(".brag-book-gallery-search-dropdown"),this.searchIcon=e.querySelector(".brag-book-gallery-search-icon"),this.options={minChars:t.minChars||1,debounceDelay:t.debounceDelay||200,maxResults:t.maxResults||10,onSelect:t.onSelect||(()=>{}),...t},this.procedures=[],this.filteredResults=[],this.selectedIndex=-1,this.isOpen=!1,this.debounceTimer=null,this.input&&this.dropdown&&this.init()}init(){this.collectProcedures(),this.setupEventListeners()}collectProcedures(){const e=new Map,t=document.querySelector(".brag-book-gallery-nav"),a=document.querySelector(".brag-book-gallery-tiles-view");if(!t&&!a)return console.warn("BRAGBook Gallery: No navigation found for search autocomplete"),void(this.procedures=[]);t&&t.querySelectorAll(".brag-book-gallery-nav-link[data-procedure-slug]").forEach(t=>{const a=t.getAttribute("data-procedure-slug"),o=t.getAttribute("data-procedure-id"),r=t.getAttribute("data-category"),s="true"===t.getAttribute("data-nudity"),i=t.href,l=t.textContent.trim(),n=l.match(/\((\d+)\)$/),c=n?parseInt(n[1],10):0,d=l.replace(/\s*\(\d+\)$/,"").trim(),g=t.closest("details[data-category]"),u=g&&g.querySelector(".brag-book-gallery-nav-button__label span")?.textContent?.trim()||r;if(a&&d){const t=`${r}:${a}`;e.has(t)||e.set(t,{id:a,procedureId:o,name:d,category:u,categorySlug:r,count:c,searchText:d.toLowerCase(),url:i,nudity:s,fullName:`${d} (${c})`})}}),a&&a.querySelectorAll(".brag-book-gallery-procedure-link").forEach(t=>{const a=t.href,o=a.split("/"),r=o[o.length-2]||"",s=t.querySelector(".brag-book-gallery-procedure-name"),i=t.querySelector(".brag-book-gallery-procedure-count");if(!s)return;const l=s.textContent.trim(),n=(i?i.textContent.trim():"").match(/\((\d+)\)/),c=n?parseInt(n[1],10):0,d=t.closest(".brag-book-gallery-subcategory-panel"),g=d?d.getAttribute("data-category-id"):"",u=g?document.querySelector(`.brag-book-gallery-category-link[data-category-id="${g}"]`):null,h=u&&u.querySelector(".brag-book-gallery-category-name")?.textContent?.replace(/\s*\(\d+\)$/,"").trim()||"";if(r&&l){const t=`${g}:${r}`;e.has(t)||e.set(t,{id:r,procedureId:"",name:l,category:h,categorySlug:g,count:c,searchText:l.toLowerCase(),url:a,nudity:!1,fullName:`${l} (${c})`})}}),this.procedures=Array.from(e.values()),this.procedures.length>0?console.log("BRAGBook Gallery: First 3 procedures:",this.procedures.slice(0,3)):console.warn("BRAGBook Gallery: No procedures loaded from sidebar DOM")}setupEventListeners(){this.input.addEventListener("input",e=>this.handleInput(e)),this.input.addEventListener("focus",()=>this.handleFocus()),this.input.addEventListener("blur",e=>this.handleBlur(e)),this.input.addEventListener("keydown",e=>this.handleKeydown(e)),document.addEventListener("click",e=>{this.wrapper.contains(e.target)||this.close()}),this.dropdown.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-search-item");t&&this.selectItem(t)})}handleInput(e){const t=e.target.value.trim();this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{t.length>=this.options.minChars?this.search(t):this.close()},this.options.debounceDelay)}handleFocus(){const e=this.input.value.trim();e.length>=this.options.minChars&&this.search(e)}handleBlur(e){setTimeout(()=>{this.wrapper.contains(document.activeElement)||this.close()},200)}handleKeydown(e){if(this.isOpen)switch(e.key){case"ArrowDown":e.preventDefault(),this.moveSelection(1);break;case"ArrowUp":e.preventDefault(),this.moveSelection(-1);break;case"Enter":if(e.preventDefault(),this.selectedIndex>=0){const e=this.dropdown.querySelector(`[data-index="${this.selectedIndex}"]`);e&&this.selectItem(e)}break;case"Escape":this.close(),this.input.blur()}else"ArrowDown"===e.key&&this.input.value.trim().length>=this.options.minChars&&(e.preventDefault(),this.search(this.input.value.trim()))}search(e){const t=e.toLowerCase();this.filteredResults=this.procedures.filter(e=>e.searchText.includes(t)||e.category.includes(t)).slice(0,this.options.maxResults),this.filteredResults.sort((e,a)=>{const o=e.searchText===t,r=a.searchText===t;if(o&&!r)return-1;if(!o&&r)return 1;const s=e.searchText.startsWith(t),i=a.searchText.startsWith(t);return s&&!i?-1:!s&&i?1:0}),this.renderResults(e),this.open()}renderResults(e){if(0===this.filteredResults.length)return void(this.dropdown.innerHTML=`\n                <div class="brag-book-gallery-search-no-results">\n                    No procedures found for "${this.escapeHtml(e)}"\n                </div>\n            `);const t=this.filteredResults.map((t,a)=>{const o=this.highlightMatch(t.name,e),r=1===t.count?"case":"cases";return`\n                <div class="brag-book-gallery-search-item"\n                     role="option"\n                     data-index="${a}"\n                     data-procedure="${t.id}"\n                     data-category="${t.categorySlug}"\n                     aria-selected="${a===this.selectedIndex}">\n                    <div class="brag-book-gallery-search-item-content">\n                        <span class="brag-book-gallery-search-item-name">${o}</span>\n                        <span class="brag-book-gallery-search-item-count">${t.count} ${r}</span>\n                    </div>\n                    <span class="brag-book-gallery-search-item-category">${t.category}</span>\n                </div>\n            `}).join("");this.dropdown.innerHTML=t,this.selectedIndex=-1}highlightMatch(e,t){const a=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp(`(${a})`,"gi");return e.replace(o,"<mark>$1</mark>")}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}moveSelection(e){const t=this.dropdown.querySelectorAll(".brag-book-gallery-search-item");0!==t.length&&(this.selectedIndex+=e,this.selectedIndex<0?this.selectedIndex=t.length-1:this.selectedIndex>=t.length&&(this.selectedIndex=0),t.forEach((e,t)=>{const a=t===this.selectedIndex;e.setAttribute("aria-selected",a),a&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}))}selectItem(e){const t=e.dataset.procedure,a=e.dataset.category,o=e.querySelector(".brag-book-gallery-search-item-name"),r=o?o.textContent.replace(/<mark>/g,"").replace(/<\/mark>/g,""):"";this.input.value=r,this.close();const s=this.procedures.find(e=>e.id===t&&(e.categorySlug===a||e.category===a));if(this.options.onSelect({procedure:t,category:a,name:r,url:s?.url||"",data:s}),s&&s.url)window.location.href=s.url;else{const e=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${t}"]`);e&&e.href?window.location.href=e.href:console.warn(`BRAGBook Gallery: No URL found for procedure ${t} in category ${a}`)}}open(){this.isOpen||(this.isOpen=!0,this.dropdown.classList.add("active"),this.wrapper.classList.add("active"),this.input.setAttribute("aria-expanded","true"))}close(){this.isOpen&&(this.isOpen=!1,this.dropdown.classList.remove("active"),this.wrapper.classList.remove("active"),this.input.setAttribute("aria-expanded","false"),this.selectedIndex=-1)}refresh(){this.collectProcedures()}};class i{constructor(){this.nudityAccepted=!1,this.storageKey="brag-book-gallery-nudity-accepted",this.checkInitialAcceptance(),this.init()}checkInitialAcceptance(){try{const e=localStorage.getItem(this.storageKey);this.nudityAccepted="true"===e,this.nudityAccepted&&document.body.classList.add("nudity-accepted")}catch(e){console.warn("Could not load nudity acceptance status from localStorage:",e),this.nudityAccepted=!1}}init(){this.setupEventListeners()}saveAcceptanceStatus(){try{localStorage.setItem(this.storageKey,"true")}catch(e){console.warn("Could not save nudity acceptance status to localStorage:",e)}}setupEventListeners(){document.addEventListener("click",e=>{e.target.matches(".brag-book-gallery-nudity-warning-button")?this.handleProceedButtonClick(e.target):(e.target.matches(".brag-book-gallery-nudity-warning")||e.target.closest(".brag-book-gallery-nudity-warning"))&&(e.target.matches(".brag-book-gallery-nudity-warning-button")||e.target.closest(".brag-book-gallery-nudity-warning-button")||(e.stopPropagation(),e.preventDefault()))})}handleProceedButtonClick(e){this.nudityAccepted=!0,this.saveAcceptanceStatus(),document.body.classList.add("nudity-accepted"),this.animateRemoval()}animateRemoval(){const e=document.querySelectorAll(".brag-book-gallery-nudity-warning"),t=document.querySelectorAll(".brag-book-gallery-nudity-blur");e.forEach(e=>{e.style.transition="opacity 0.5s ease-out",e.style.opacity="0",setTimeout(()=>{e.style.display="none"},500)}),t.forEach(e=>{e.style.transition="filter 0.5s ease-out",e.style.filter="blur(0px)"})}resetAcceptance(){this.nudityAccepted=!1;try{localStorage.removeItem(this.storageKey),document.body.classList.remove("nudity-accepted")}catch(e){console.warn("Could not remove nudity acceptance status from localStorage:",e)}}}class l{constructor(){this.init()}init(){document.querySelectorAll('[data-phone-format="true"]').forEach(e=>{this.setupPhoneInput(e)})}setupPhoneInput(e){e.addEventListener("input",e=>{this.formatPhoneNumber(e.target)}),e.addEventListener("paste",e=>{setTimeout(()=>{this.formatPhoneNumber(e.target)},0)}),e.addEventListener("keypress",e=>{const t=String.fromCharCode(e.which);/[0-9]/.test(t)||8===e.which||46===e.which||e.preventDefault()})}formatPhoneNumber(e){let t=e.value.replace(/\D/g,"");t=t.substring(0,10);let a="";t.length>0&&(a=t.length<=3?`(${t}`:t.length<=6?`(${t.substring(0,3)}) ${t.substring(3)}`:`(${t.substring(0,3)}) ${t.substring(3,6)}-${t.substring(6,10)}`),e.value=a,10===t.length?e.setCustomValidity(""):e.hasAttribute("required")&&t.length>0&&e.setCustomValidity("Please enter a complete 10-digit phone number")}}window.initializeFavoritesPage=function(){if(window.bragBookGalleryApp&&"function"==typeof window.bragBookGalleryApp.initializeFavoritesPage)window.bragBookGalleryApp.initializeFavoritesPage();else{console.warn("BRAGbook Gallery App not yet initialized, retrying...");let e=0;const t=10,a=()=>{e++,window.bragBookGalleryApp&&"function"==typeof window.bragBookGalleryApp.initializeFavoritesPage?window.bragBookGalleryApp.initializeFavoritesPage():e<t?setTimeout(a,100*e):console.error("Failed to initialize favorites page after",t,"attempts")};setTimeout(a,100)}};var n=class{constructor(){this.components={},window.bragBookGalleryApp=this,this.init()}async init(){if(await this.handleDirectCaseUrl())return this.initializeDialogs(),this.initializeMobileMenu(),this.initializeCaseLinks(),this.initializeNudityWarning(),this.initializeShareManager(),this.initializeFavorites(),void this.initializeCasePreloading();this.initializeDialogs(),this.initializeFilters(),this.initializeMobileMenu(),this.initializeGallerySelector(),this.initializeFavorites(),this.initializeSearch(),this.initializeShareManager(),this.initializeConsultationForm(),this.initializeCaseLinks(),this.initializeNudityWarning(),this.initializeCasePreloading();const e=document.getElementById("gallery-content");e&&"true"===e.dataset.favoritesPage&&setTimeout(()=>{this.showFavoritesOnly()},100)}initializeDialogs(){this.components.consultationDialog=new e("consultationDialog",{onOpen:()=>{},onClose:()=>{}}),document.addEventListener("click",e=>{e.target.closest('[data-action="request-consultation"]')&&this.components.consultationDialog&&(e.preventDefault(),this.components.consultationDialog.open())})}initializeFilters(){const e=document.querySelector(".brag-book-gallery-nav"),a=e?.dataset.filterMode||"javascript";this.components.filterSystem=new t(e,{mode:a,baseUrl:"/gallery",onFilterChange:e=>{this.applyFilters(e)},onNavigate:e=>{window.location.href=e}}),this.initializeProcedureFilters(),this.initializeClearAllButton(),this.initializeDemographicFilterBadges()}initializeProcedureFilters(){const e=this.components.filterSystem;if(!e)return;const t=document.getElementById("brag-book-gallery-filters");if(!t)return;const a=e.generateFiltersFromDOMCards();if(a){t.innerHTML=a;const e=document.getElementById("procedure-filters-details");e&&(e.style.display="",e.setAttribute("data-initialized","true")),this.bindProcedureFilterEvents()}}bindProcedureFilterEvents(){document.querySelectorAll('#brag-book-gallery-filters input[type="checkbox"]').forEach(e=>{e.addEventListener("change",e=>{this.applyProcedureFilters()})})}applyProcedureFilters(){const e={age:[],gender:[],ethnicity:[],height:[],weight:[]};document.querySelectorAll('#brag-book-gallery-filters input[type="checkbox"]:checked').forEach(t=>{const a=t.dataset.filterType,o=t.value;e[a]&&e[a].push(o)}),document.querySelectorAll(".brag-book-gallery-case-card").forEach(t=>{let a=!0;if(e.age.length>0){const o=parseInt(t.dataset.age);let r=!1;e.age.forEach(e=>{("18-24"===e&&o>=18&&o<25||"25-34"===e&&o>=25&&o<35||"35-44"===e&&o>=35&&o<45||"45-54"===e&&o>=45&&o<55||"55-64"===e&&o>=55&&o<65||"65+"===e&&o>=65)&&(r=!0)}),r||(a=!1)}if(e.gender.length>0){const o=(t.dataset.gender||"").toLowerCase();e.gender.includes(o)||(a=!1)}if(e.ethnicity.length>0){const o=(t.dataset.ethnicity||"").toLowerCase();e.ethnicity.some(e=>e.toLowerCase()===o)||(a=!1)}if(e.height.length>0){const o=parseFloat(t.dataset.height);let r=!1;e.height.forEach(e=>{("Under 5'0\""===e&&o<60||"5'0\" - 5'3\""===e&&o>=60&&o<64||"5'4\" - 5'7\""===e&&o>=64&&o<68||"5'8\" - 5'11\""===e&&o>=68&&o<72||"6'0\" and above"===e&&o>=72)&&(r=!0)}),r||(a=!1)}if(e.weight.length>0){const o=parseFloat(t.dataset.weight);let r=!1;e.weight.forEach(e=>{("Under 120 lbs"===e&&o<120||"120-149 lbs"===e&&o>=120&&o<150||"150-179 lbs"===e&&o>=150&&o<180||"180-209 lbs"===e&&o>=180&&o<210||"210+ lbs"===e&&o>=210)&&(r=!0)}),r||(a=!1)}t.style.display=a?"":"none"})}initializeMobileMenu(){this.components.mobileMenu=new a}initializeGallerySelector(){document.addEventListener("click",e=>{const t=e.target.closest('[data-action="show-subcategories"]');t&&(e.preventDefault(),function(e){const t=e.dataset.categoryId;if(!t)return;const a=e.closest(".brag-book-gallery-category-nav-wrapper");if(!a)return;const o=a.querySelector('[data-level="parent"]');o&&(o.style.display="none");const r=a.querySelector(`.brag-book-gallery-subcategory-panel[data-category-id="${t}"]`);r&&(r.style.display="block")}(t));const a=e.target.closest('[data-action="back-to-categories"]');a&&(e.preventDefault(),function(e){const t=e.closest(".brag-book-gallery-category-nav-wrapper");if(!t)return;t.querySelectorAll(".brag-book-gallery-subcategory-panel").forEach(e=>{e.style.display="none"});const a=t.querySelector('[data-level="parent"]');a&&(a.style.display="block")}(a))})}initializeFavorites(){if(this.components.favoritesManager=new o({onUpdate:e=>{this.updateFavoritesCount(e.size)}}),this.components.favoritesManager){const e=this.components.favoritesManager.getFavorites().size;this.updateFavoritesCount(e),this.updateFavoriteHeartStates()}this.initializeFavoritesButton(),window.addEventListener("favoritesUpdated",e=>{const t=window.location.pathname;(t===`/${window.bragBookGalleryConfig?.gallerySlug||"before-after"}/myfavorites/`||t.includes("myfavorites"))&&setTimeout(()=>{this.showFavoritesOnly()},100)})}updateFavoriteHeartStates(){let e=[];try{const t=localStorage.getItem("brag-book-favorites");t&&(e=JSON.parse(t))}catch(e){return void console.error("Failed to load favorites from localStorage:",e)}Array.isArray(e)&&0!==e.length&&document.querySelectorAll(".brag-book-gallery-favorite-button").forEach(t=>{let a=[];const o=t.closest(".brag-book-gallery-case-card");if(o&&o.dataset.postId&&a.push(o.dataset.postId),o&&o.dataset.caseId&&a.push(o.dataset.caseId),t.dataset.itemId){a.push(t.dataset.itemId);const e=t.dataset.itemId.match(/(\d+)/);e&&a.push(e[1])}t.dataset.caseId&&a.push(t.dataset.caseId),0!==a.length&&(a.some(t=>e.includes(String(t))||e.includes(t)||e.includes(`case-${t}`))?(t.dataset.favorited="true",t.setAttribute("aria-label","Remove from favorites")):(t.dataset.favorited="false",t.setAttribute("aria-label","Add to favorites")))})}initializeSearch(){const e=document.querySelectorAll(".brag-book-gallery-search-wrapper");this.components.searchAutocompletes=[],e.forEach(e=>{const t=new s(e,{minChars:1,debounceDelay:200,maxResults:10,onSelect:e=>{}});this.components.searchAutocompletes.push(t)})}initializeShareManager(){"undefined"!=typeof bragBookGalleryConfig&&"yes"===bragBookGalleryConfig.enableSharing&&(this.components.shareManager=new r({onShare:e=>{}}))}initializeConsultationForm(){const e=document.querySelector('[data-form="consultation"]');e&&e.addEventListener("submit",e=>{e.preventDefault(),this.handleFormSubmit(e.target)});const t=document.getElementById("consultationDialog");t&&new MutationObserver(e=>{e.forEach(e=>{"attributes"===e.type&&"open"===e.attributeName&&t.hasAttribute("open")&&this.hideModalMessage()})}).observe(t,{attributes:!0})}storeProcedureReferrerFromCard(e){if(!e||"function"!=typeof window.storeProcedureReferrer)return;const t=e.dataset.currentTermId,a=e.dataset.currentProcedureId,o=e.dataset.caseId,r=e.dataset.postId;if(!t)return void console.warn("storeProcedureReferrerFromCard - No termId found");const s=window.location.pathname.split("/").filter(e=>e),i=s.length>=2?s[1]:null,l=document.querySelector("h1.entry-title, h1.page-title, .brag-book-gallery-title"),n=l?l.textContent.trim():i,c=window.location.href;console.log("storeProcedureReferrerFromCard - Data:",{caseId:o,caseWpId:r,termId:t,procedureId:a,procedureSlug:i,procedureName:n}),window.storeProcedureReferrer(i,n,c,a,t,o,r)}storeProcedureReferrerFromCarousel(e){if(!e||"function"!=typeof window.storeProcedureReferrer)return;const t=e.dataset.currentTermId;if(!t)return;const a=e.dataset.caseId,o=e.dataset.postId,r=document.querySelector(".brag-book-gallery-nav-link.brag-book-gallery-active");let s=null,i=null,l=null;if(r)s=r.dataset.procedure,i=r.querySelector(".brag-book-gallery-filter-option-label")?.textContent?.trim(),l=r.dataset.procedureId;else{const t=e.closest(".brag-book-gallery-carousel-wrapper");if(t&&(s=t.dataset.procedure,l=t.dataset.currentProcedureId),!s){const e=window.location.pathname.match(/\/([^\/]+)\/?$/);e&&(s=e[1])}}const n=window.location.href;window.storeProcedureReferrer(s,i,n,l,t,a,o)}initializeCaseLinks(){document.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-carousel-link");if(t){const e=t.closest(".brag-book-gallery-carousel-item");return void this.storeProcedureReferrerFromCarousel(e)}const a=e.target.closest(".brag-book-gallery-case-card-link, .brag-book-gallery-case-permalink");if(a){const e=a.closest(".brag-book-gallery-case-card");return void this.storeProcedureReferrerFromCard(e)}const o=e.target.closest(".brag-book-gallery-case-card");if(o&&!e.target.closest("button")&&!e.target.closest("details")){const e=o.querySelector(".brag-book-gallery-case-card-link, .brag-book-gallery-case-permalink");e&&e.href&&(this.storeProcedureReferrerFromCard(o),window.location.href=e.href)}const r=e.target.closest(".brag-book-gallery-nav-button");!r||r.closest("summary")}),this.initializeCaseDetailThumbnails(),window.addEventListener("popstate",e=>{console.log("Browser navigation handled by server-side rendering")})}async handleDirectCaseUrl(){const e=window.location.pathname.split("/").filter(e=>e);if(e.length>=3){const t=e[e.length-1];if(/^\d+$/.test(t)){const e=document.getElementById("gallery-content"),t=e?.querySelector(".brag-book-gallery-case-detail-view");return!!t}}return!1}async loadCaseDetails(e,t,a=!0,o=null){const r=document.getElementById("gallery-content");if(r&&!this.currentCaseLoad){if(this.currentCaseLoad=e,!o){const t=document.querySelector(`.brag-book-gallery-case-card[data-case-id="${e}"]`);t&&t.dataset.procedureIds&&(o=t.dataset.procedureIds)}a&&window.history&&window.history.pushState&&window.history.pushState({caseId:e},"",t),this.showCaseDetailSkeleton(),window.scrollTo({top:0,behavior:"smooth"});try{if("undefined"==typeof bragBookGalleryConfig)throw new Error("Configuration not loaded");if(this.casePreloadCache&&this.casePreloadCache.has(e)){const t=this.casePreloadCache.get(e);if(t&&"loading"!==t){r.innerHTML=t,this.setActiveSidebarForCase(e);const a=document.querySelector(".brag-book-gallery-wrapper");return a?a.scrollIntoView({behavior:"smooth",block:"start"}):r.scrollIntoView({behavior:"smooth",block:"start"}),void(this.currentCaseLoad=null)}}await this.loadCaseDetailsViaAjax(e,t,o)}catch(e){let t="Failed to load case details. Please try again.";e.message&&(t+="<br><small>"+e.message+"</small>"),r.innerHTML='<div class="brag-book-gallery-error">'+t+"</div>"}finally{this.currentCaseLoad=null}}}async loadCaseDetailsViaAjax(e,t,a){const o=document.getElementById("gallery-content");if(o)try{const t=window.location.pathname.split("/").filter(e=>e),r=t.length>2?t[t.length-2]:"";let s="";const i=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${r}"]`);if(i){const e=i.querySelector(".brag-book-gallery-filter-option-label");e&&(s=e.textContent.trim())}if(!s&&window.bragBookGalleryConfig&&window.bragBookGalleryConfig.sidebarData){const e=window.bragBookGalleryConfig.sidebarData;for(const t of Object.values(e)){if(t.procedures)for(const e of t.procedures)if(e.slug===r){s=e.name;break}if(s)break}}const l={action:"brag_book_gallery_load_case_details_html",case_id:e,procedure_slug:r,procedure_name:s,nonce:bragBookGalleryConfig.nonce||""};a?l.procedure_ids=a:console.warn(`âš ï¸ AJAX call WITHOUT procedure context: case ${e} (no procedure IDs provided)`);const n=await fetch(bragBookGalleryConfig.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(l)});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const c=await n.json();if(!(c.success&&c.data&&c.data.html))throw new Error(c.data?.message||c.data||c.message||"Failed to load case details");{o.innerHTML=c.data.html,this.setActiveSidebarForCase(e);const t=document.querySelector(".brag-book-gallery-wrapper");if(t?t.scrollIntoView({behavior:"smooth",block:"start"}):o.scrollIntoView({behavior:"smooth",block:"start"}),c.data.seo&&(c.data.seo.title&&(document.title=c.data.seo.title),c.data.seo.description)){let e=document.querySelector('meta[name="description"]');e||(e=document.createElement("meta"),e.name="description",document.head.appendChild(e)),e.content=c.data.seo.description}c.data.view_tracked?console.log(`Case view tracked successfully for Case ID: ${c.data.case_id}`):!1===c.data.view_tracked&&(console.warn(`Case view tracking failed for Case ID: ${c.data.case_id}`),c.data.debug&&(console.group("View Tracking Debug Info:"),c.data.debug.tracking_error&&console.error("Tracking error:",c.data.debug.tracking_error),console.groupEnd())),this.casePreloadCache&&e&&this.casePreloadCache.set(e,c.data.html),this.initializeCaseDetailThumbnails()}}catch(e){let t="Failed to load case details via AJAX. Please try again.";e.message&&(t+="<br><small>"+e.message+"</small>"),o.innerHTML='<div class="brag-book-gallery-error">'+t+"</div>"}finally{this.currentCaseLoad=null}}showCaseDetailSkeleton(){const e=document.getElementById("gallery-content");e?(e.innerHTML='\n\t\t\t<div class="brag-book-gallery-case-detail-view brag-book-gallery-case-detail-skeleton" data-case-id="loading">\n\t\t\t\t\x3c!-- Progress Bar --\x3e\n\t\t\t\t<div class="skeleton-progress-bar">\n\t\t\t\t\t<div class="skeleton-progress-fill"></div>\n\t\t\t\t\t<div class="skeleton-progress-text">Loading... 0%</div>\n\t\t\t\t</div>\n\n\t\t\t\t\x3c!-- Case Header Section (matches render_case_header) --\x3e\n\t\t\t\t<div class="brag-book-gallery-brag-book-gallery-case-header-section">\n\t\t\t\t\t<div class="brag-book-gallery-case-navigation">\n\t\t\t\t\t\t<div class="skeleton-back-link"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="brag-book-gallery-brag-book-gallery-case-header">\n\t\t\t\t\t\t<div class="skeleton-case-title"></div>\n\t\t\t\t\t\t<div class="skeleton-case-navigation-buttons">\n\t\t\t\t\t\t\t<div class="skeleton-nav-btn"></div>\n\t\t\t\t\t\t\t<div class="skeleton-nav-btn"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t\x3c!-- Case Images Section (matches render_case_images) --\x3e\n\t\t\t\t<div class="brag-book-gallery-brag-book-gallery-case-content">\n\t\t\t\t\t<div class="brag-book-gallery-case-images-section">\n\t\t\t\t\t\t<div class="brag-book-gallery-case-images-layout">\n\t\t\t\t\t\t\t\x3c!-- Main Image Viewer --\x3e\n\t\t\t\t\t\t\t<div class="brag-book-gallery-case-main-viewer">\n\t\t\t\t\t\t\t\t<div class="brag-book-gallery-main-image-container">\n\t\t\t\t\t\t\t\t\t<div class="skeleton-main-image"></div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\x3c!-- Thumbnails --\x3e\n\t\t\t\t\t\t\t<div class="brag-book-gallery-case-thumbnails">\n\t\t\t\t\t\t\t\t<div class="skeleton-thumbnail"></div>\n\t\t\t\t\t\t\t\t<div class="skeleton-thumbnail"></div>\n\t\t\t\t\t\t\t\t<div class="skeleton-thumbnail"></div>\n\t\t\t\t\t\t\t\t<div class="skeleton-thumbnail"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t\x3c!-- Case Details Cards Section (matches render_case_details_cards) --\x3e\n\t\t\t\t<div class="brag-book-gallery-case-card-details-section">\n\t\t\t\t\t<div class="brag-book-gallery-case-card-details-grid">\n\t\t\t\t\t\t\x3c!-- Procedures Card --\x3e\n\t\t\t\t\t\t<div class="case-detail-card procedures-performed-card">\n\t\t\t\t\t\t\t<div class="card-header">\n\t\t\t\t\t\t\t\t<div class="skeleton-card-title"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="card-content">\n\t\t\t\t\t\t\t\t<div class="skeleton-procedure-badges">\n\t\t\t\t\t\t\t\t\t<div class="skeleton-badge"></div>\n\t\t\t\t\t\t\t\t\t<div class="skeleton-badge"></div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\x3c!-- Patient Details Card --\x3e\n\t\t\t\t\t\t<div class="case-detail-card patient-details-card">\n\t\t\t\t\t\t\t<div class="card-header">\n\t\t\t\t\t\t\t\t<div class="skeleton-card-title"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="card-content">\n\t\t\t\t\t\t\t\t<div class="skeleton-patient-info">\n\t\t\t\t\t\t\t\t\t<div class="skeleton-info-item"></div>\n\t\t\t\t\t\t\t\t\t<div class="skeleton-info-item"></div>\n\t\t\t\t\t\t\t\t\t<div class="skeleton-info-item"></div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\x3c!-- Procedure Details Card --\x3e\n\t\t\t\t\t\t<div class="case-detail-card procedure-details-card">\n\t\t\t\t\t\t\t<div class="card-header">\n\t\t\t\t\t\t\t\t<div class="skeleton-card-title"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="card-content">\n\t\t\t\t\t\t\t\t<div class="skeleton-procedure-details">\n\t\t\t\t\t\t\t\t\t<div class="skeleton-detail-row"></div>\n\t\t\t\t\t\t\t\t\t<div class="skeleton-detail-row"></div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\x3c!-- Case Notes Card (full width) --\x3e\n\t\t\t\t\t\t<div class="case-detail-card case-notes-card">\n\t\t\t\t\t\t\t<div class="card-header">\n\t\t\t\t\t\t\t\t<div class="skeleton-card-title"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="card-content">\n\t\t\t\t\t\t\t\t<div class="skeleton-case-notes">\n\t\t\t\t\t\t\t\t\t<div class="skeleton-text-line"></div>\n\t\t\t\t\t\t\t\t\t<div class="skeleton-text-line short"></div>\n\t\t\t\t\t\t\t\t\t<div class="skeleton-text-line medium"></div>\n\t\t\t\t\t\t\t\t\t<div class="skeleton-text-line"></div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t',this.animateProgressBar()):console.warn("Gallery content container not found for skeleton")}animateProgressBar(){const e=document.querySelector(".skeleton-progress-fill"),t=document.querySelector(".skeleton-progress-text");if(!e||!t)return;let a=0;e.style.width="0%",t.textContent="Loading... 0%";const o=()=>{a<100&&(a=Math.min(a+1.875+2*Math.random(),100),e.style.width=`${a}%`,t.textContent=`Loading... ${Math.floor(a)}%`,setTimeout(o,a>80?100:a>60?75:50))};o()}displayCaseDetails(e){const t=document.getElementById("gallery-content");if(!t)return;let a='<div class="brag-book-gallery-case-card-details">';a+='<button class="brag-book-gallery-back-button" onclick="history.back()">â† Back to Gallery</button>',a+='<div class="brag-book-gallery-case-header">',a+=`<h2>${e.procedureName||"Case Details"}</h2>`,a+='<div class="case-metadata">',e.caseNumber&&(a+=`<span class="case-number">Case #${e.caseNumber}</span>`),e.technique&&(a+=`<span class="case-technique">Technique: ${e.technique}</span>`),e.age&&(a+=`<span class="case-age">Age: ${e.age}</span>`),e.gender&&(a+=`<span class="case-gender">Gender: ${e.gender}</span>`),a+="</div>",a+="</div>",e.photos&&e.photos.length>0?(a+='<div class="brag-book-gallery-case-images">',e.photos.forEach((e,t)=>{(e.beforeImage||e.afterImage)&&(a+='<div class="brag-book-gallery-case-image-pair">',e.isProcessed&&e.beforeImage?(a+='<div class="processed-image">',a+=`<img src="${e.beforeImage}" alt="Before and After" />`,e.caption&&(a+=`<p class="image-caption">${e.caption}</p>`),a+="</div>"):(e.beforeImage&&(a+='<div class="before-image">',a+="<h3>Before</h3>",a+=`<img src="${e.beforeImage}" alt="Before" loading="lazy" />`,a+="</div>"),e.afterImage&&(a+='<div class="after-image">',a+="<h3>After</h3>",a+=`<img src="${e.afterImage}" alt="After" loading="lazy" />`,a+="</div>"),e.caption&&(a+=`<p class="image-caption">${e.caption}</p>`)),a+="</div>")}),a+="</div>"):a+='<div class="brag-book-gallery-no-images">No images available for this case.</div>',e.description&&(a+='<div class="brag-book-gallery-case-description">',a+="<h3>Details</h3>",e.description.includes("<")?a+=e.description:a+=`<p>${e.description}</p>`,a+="</div>"),a+="</div>",t.innerHTML=a,t.scrollIntoView({behavior:"smooth",block:"start"})}handleSearch(e){e.toLowerCase().trim()}applyFilters(e){}async handleFormSubmit(e){const t=new FormData(e),a=Object.fromEntries(t.entries()),o=e.querySelector('[data-action="form-submit"]'),r=o?o.textContent:"";o&&(o.disabled=!0,o.textContent="Sending...");try{if("undefined"==typeof bragBookGalleryConfig)throw new Error("Configuration not loaded. Please refresh the page.");const t=new URLSearchParams({action:"handle_form_submission",nonce:bragBookGalleryConfig.consultation_nonce||bragBookGalleryConfig.nonce,name:a.name||"",email:a.email||"",phone:a.phone||"",description:a.message||""}),o=await fetch(bragBookGalleryConfig.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t,credentials:"same-origin"}),r=await o.json();if(r.success)this.showModalMessage("Thank you for your consultation request! We will contact you soon.","success"),setTimeout(()=>{e.reset(),this.hideModalMessage(),this.components&&this.components.consultationDialog&&setTimeout(()=>{this.components.consultationDialog.close()},1e3)},3e3);else{const e=r.data||"Failed to send consultation request. Please try again.";this.showModalMessage(e,"error")}}catch(e){this.showModalMessage(e.message||"An error occurred. Please try again.","error")}finally{o&&(o.disabled=!1,o.textContent=r)}}showModalMessage(e,t="info"){const a=document.getElementById("consultationMessage"),o=a?.querySelector(".brag-book-gallery-form-message-content");if(!a||!o)return void this.showNotification(e,t);o.textContent=e,a.className="brag-book-gallery-form-message",a.classList.add(`brag-book-gallery-form-message-${t}`),a.style.display="block";const r=a.closest(".brag-book-gallery-dialog-content");r&&(r.scrollTop=0)}hideModalMessage(){const e=document.getElementById("consultationMessage");if(e){e.style.display="none";const t=e.querySelector(".brag-book-gallery-form-message-content");t&&(t.textContent="")}}initializeCaseDetailThumbnails(){document.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-thumbnail-item");if(!t)return;const a=document.querySelector(".brag-book-gallery-main-image-container");if(!a)return;const o=document.querySelectorAll(".brag-book-gallery-thumbnail-item");if(!o.length)return;o.forEach(e=>e.classList.remove("active")),t.classList.add("active");const r=t.dataset.processedUrl,s=t.dataset.imageIndex;a.dataset.imageIndex=s;let i="";if(r){const e=a.querySelector(".brag-book-gallery-favorite-button"),t=e?e.dataset.itemId.replace("_main",""):"";i=`\n\t\t\t\t\t<div class="brag-book-gallery-main-single">\n\t\t\t\t\t\t<img src="${r}" alt="Case Image" loading="eager">\n\t\t\t\t\t\t<div class="brag-book-gallery-item-actions">\n\t\t\t\t\t\t\t<button class="brag-book-gallery-favorite-button" data-favorited="false" data-item-id="${t}_main" aria-label="Add to favorites">\n\t\t\t\t\t\t\t\t<svg fill="rgba(255, 255, 255, 0.5)" stroke="white" stroke-width="2" viewBox="0 0 24 24">\n\t\t\t\t\t\t\t\t\t<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t`,"undefined"!=typeof bragBookGalleryConfig&&"yes"===bragBookGalleryConfig.enableSharing&&(i+=`\n\t\t\t\t\t\t\t<button class="brag-book-gallery-share-button" data-item-id="${t}_main" aria-label="Share this image">\n\t\t\t\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">\n\t\t\t\t\t\t\t\t\t<path d="M672.22-100q-44.91 0-76.26-31.41-31.34-31.41-31.34-76.28 0-6 4.15-29.16L284.31-404.31q-14.46 15-34.36 23.5t-42.64 8.5q-44.71 0-76.01-31.54Q100-435.39 100-480q0-44.61 31.3-76.15 31.3-31.54 76.01-31.54 22.74 0 42.64 8.5 19.9 8.5 34.36 23.5l284.46-167.08q-2.38-7.38-3.27-14.46-.88-7.08-.88-15.08 0-44.87 31.43-76.28Q627.49-860 672.4-860t76.25 31.44Q780-797.13 780-752.22q0 44.91-31.41 76.26-31.41 31.34-76.28 31.34-22.85 0-42.5-8.69Q610.15-662 595.69-677L311.23-509.54q2.38 7.39 3.27 14.46.88 7.08.88 15.08t-.88 15.08q-.89 7.07-3.27 14.46L595.69-283q14.46-15 34.12-23.69 19.65-8.69 42.5-8.69 44.87 0 76.28 31.43Q780-252.51 780-207.6t-31.44 76.25Q717.13-100 672.22-100Zm.09-60q20.27 0 33.98-13.71Q720-187.42 720-207.69q0-20.27-13.71-33.98-13.71-13.72-33.98-13.72-20.27 0-33.98 13.72-13.72 13.71-13.72 33.98 0 20.27 13.72 33.98Q652.04-160 672.31-160Zm-465-272.31q20.43 0 34.25-13.71 13.83-13.71 13.83-33.98 0-20.27-13.83-33.98-13.82-13.71-34.25-13.71-20.11 0-33.71 13.71Q160-500.27 160-480q0 20.27 13.6 33.98 13.6 13.71 33.71 13.71Zm465-272.3q20.27 0 33.98-13.72Q720-732.04 720-752.31q0-20.27-13.71-33.98Q692.58-800 672.31-800q-20.27 0-33.98 13.71-13.72 13.71-13.72 33.98 0 20.27 13.72 33.98 13.71 13.72 33.98 13.72Zm0 496.92ZM207.69-480Zm464.62-272.31Z"/>\n\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t`),i+="\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t"}a.innerHTML=i,window.bragBookGalleryApp&&window.bragBookGalleryApp.components&&(window.bragBookGalleryApp.components.favoritesManager&&window.bragBookGalleryApp.components.favoritesManager.initializeFavoriteButtons(),window.bragBookGalleryApp.components.shareManager&&window.bragBookGalleryApp.components.shareManager.initializeShareButtons())})}showNotification(e,t="info"){let a=document.querySelector(".brag-book-notification");a||(a=document.createElement("div"),a.className="brag-book-notification",a.style.cssText="\n\t\t\t\tposition: fixed;\n\t\t\t\ttop: 20px;\n\t\t\t\tright: 20px;\n\t\t\t\tpadding: 15px 20px;\n\t\t\t\tborder-radius: 4px;\n\t\t\t\tz-index: 10000;\n\t\t\t\ttransition: opacity 0.3s ease;\n\t\t\t\tmax-width: 350px;\n\t\t\t",document.body.appendChild(a));const o={success:"#4caf50",error:"#f44336",info:"#2196f3"};a.style.backgroundColor=o[t]||o.info,a.style.color="white",a.textContent=e,a.style.opacity="1",setTimeout(()=>{a.style.opacity="0",setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},300)},5e3)}initializeClearAllButton(){const e=()=>{const e=document.querySelector('[data-action="clear-filters"]');return!!e&&(e.removeEventListener("click",this.handleClearAll),e.addEventListener("click",this.handleClearAll.bind(this)),!0)};e()||setTimeout(()=>{e()},1e3),document.addEventListener("click",e=>{e.target&&"clear-filters"===e.target.dataset.action&&(e.preventDefault(),this.handleClearAll(e))})}handleClearAll(e){e.preventDefault(),this.clearDemographicFilters()}initializeDemographicFilterBadges(){window.updateDemographicFilterBadges=e=>{this.updateDemographicBadges(e)},window.applyProcedureFilters,this.monitorDemographicFilters(),document.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-badge-remove");if(t){e.preventDefault(),e.stopPropagation();const a=t.closest(".brag-book-gallery-filter-badge");if(a){const e=a.getAttribute("data-filter-category"),t=a.getAttribute("data-filter-value");e&&t&&this.removeDemographicFilter(e,t)}}})}monitorDemographicFilters(){document.addEventListener("change",e=>{"checkbox"===e.target.type&&e.target.closest(".brag-book-gallery-filter-group")&&setTimeout(()=>{const e=this.buildActiveFiltersFromDOM();this.updateDemographicBadges(e)},100)});let e="";setInterval(()=>{const t=this.buildActiveFiltersFromDOM(),a=JSON.stringify(t);a!==e&&(this.updateDemographicBadges(t),e=a)},1e3)}buildActiveFiltersFromDOM(){const e={age:[],gender:[],ethnicity:[],height:[],weight:[]};return document.querySelectorAll('.brag-book-gallery-filter-group input[type="checkbox"]:checked').forEach(t=>{const a=t.closest(".brag-book-gallery-filter-group"),o=a?.querySelector("summary"),r=o?.textContent?.toLowerCase()||"",s=t.nextElementSibling,i=s?.textContent?.trim()||t.value||"";r.includes("age")||i.includes("-")?e.age.push(i):r.includes("gender")||["male","female"].some(e=>i.toLowerCase().includes(e))?e.gender.push(i):r.includes("ethnicity")?e.ethnicity.push(i):r.includes("height")||i.includes("ft")||i.includes("'")?e.height.push(i):(r.includes("weight")||i.includes("lbs")||i.includes("kg"))&&e.weight.push(i)}),e}updateDemographicBadges(e){const t=document.querySelector('[data-action="filter-badges"]'),a=document.querySelector('[data-action="clear-filters"]');if(!t||!a)return;t.innerHTML="";let o=!1;e&&Object.keys(e).forEach(a=>{const r=e[a];r&&r.length>0&&(o=!0,r.forEach(e=>{const o=this.createDemographicBadge(a,e);t.appendChild(o)}))});const r=t.querySelectorAll("[data-filter-key]"),s=o||r.length>0;a.style.display=s?"inline-block":"none"}createDemographicBadge(e,t){const a=document.createElement("div");a.className="brag-book-gallery-filter-badge",a.setAttribute("data-filter-category",e),a.setAttribute("data-filter-value",t);let o="",r=t;switch(e){case"age":o=`Age: ${t}`;break;case"gender":o=`Gender: ${t}`,r=t.replace(/^(Male|Female)$/i,e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase());break;case"ethnicity":o=`Ethnicity: ${t}`;break;case"height":o=`Height: ${t}`;break;case"weight":o=`Weight: ${t}`;break;default:o=`${e}: ${t}`}return a.innerHTML=`\n\t\t\t<span class="brag-book-gallery-badge-text">${o}</span>\n\t\t\t<button class="brag-book-gallery-badge-remove" aria-label="Remove ${o} filter">\n\t\t\t\t<svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">\n\t\t\t\t\t<path d="M13 1L1 13M1 1l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n\t\t\t\t</svg>\n\t\t\t</button>\n\t\t`,a.querySelector(".brag-book-gallery-badge-remove").addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),this.removeDemographicFilter(e,t)}),a}createProcedureBadge(e,t,a){const o=document.createElement("div");o.className="brag-book-gallery-filter-badge",o.setAttribute("data-filter-key",a);let r=t;return o.innerHTML=`\n\t\t\t<span class="brag-book-gallery-badge-text">${r}</span>\n\t\t\t<button class="brag-book-gallery-badge-remove" aria-label="Remove ${r} filter">\n\t\t\t\t<svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">\n\t\t\t\t\t<path d="M13 1L1 13M1 1l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n\t\t\t\t</svg>\n\t\t\t</button>\n\t\t`,o.querySelector(".brag-book-gallery-badge-remove").addEventListener("click",e=>{e.preventDefault(),this.components.filterSystem&&this.components.filterSystem.removeFilterBadge(a)}),o}removeDemographicFilter(e,t){let a=null;const o=`input[type="checkbox"][data-filter-type="${e}"][value="${t}"]`;if(a=document.querySelector(o),a||document.querySelectorAll(`input[type="checkbox"][data-filter-type="${e}"]`).forEach(e=>{const o=e.value,r=e.nextElementSibling,s=r?.textContent?.trim()||"";o!==t&&o.toLowerCase()!==t.toLowerCase()&&s!==t&&s.toLowerCase()!==t.toLowerCase()||(a=e)}),!a){const o=`procedure-filter-${e}-${t}`.toLowerCase().replace(/\s+/g,"-");a=document.getElementById(o)}if(a){a.checked=!1;const o=new Event("change",{bubbles:!0});a.dispatchEvent(o);const r=new Event("input",{bubbles:!0});a.dispatchEvent(r),setTimeout(()=>{const e=this.buildActiveFiltersFromDOM();this.updateDemographicBadges(e),"function"==typeof window.applyDemographicFilters&&window.applyDemographicFilters()},100);const s=document.querySelector(`.brag-book-gallery-filter-badge[data-filter-category="${e}"][data-filter-value="${t}"]`);s&&s.remove()}else console.warn(`Could not find checkbox for ${e}: ${t}`),document.querySelectorAll('input[type="checkbox"][data-filter-type]').forEach(e=>{console.log(`  - Type: ${e.getAttribute("data-filter-type")}, Value: ${e.value}, ID: ${e.id}`)})}clearDemographicFilters(){['.brag-book-gallery-filter-group input[type="checkbox"]:checked','input[type="checkbox"][data-filter-category]:checked','.brag-book-gallery-filter-option input[type="checkbox"]:checked'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{e.checked=!1,e.dispatchEvent(new Event("change",{bubbles:!0}))})}),window.clearProcedureFilters&&window.clearProcedureFilters(),setTimeout(()=>{this.updateDemographicBadges({age:[],gender:[],ethnicity:[],height:[],weight:[]})},100)}reloadGalleryContent(){const e=document.querySelector(".brag-book-gallery-filtered-results");if(e){const t=new FormData;t.append("action","brag_book_gallery_load_filtered_gallery"),t.append("nonce",window.bragBookGalleryAjax?.nonce||""),t.append("procedure_ids",""),t.append("has_nudity",document.body.classList.contains("nudity-accepted")?"1":"0"),fetch(window.bragBookGalleryAjax?.ajax_url||"/wp-admin/admin-ajax.php",{method:"POST",body:t}).then(e=>e.json()).then(t=>{t.success?e.innerHTML=t.data.html:console.error("Failed to reload gallery:",t.data?.message)}).catch(e=>{console.error("Error reloading gallery:",e)})}}updateFavoritesCount(e){document.querySelectorAll("[data-favorites-count]").forEach(t=>{const a=t.closest(".brag-book-gallery-favorites-link--tiles");t.textContent=a?e:`(${e})`})}initializeFavoritesButton(){const e=document.querySelectorAll('[data-action="show-favorites"]');e.length&&e.forEach(e=>{e.addEventListener("click",t=>{e.classList.contains("brag-book-gallery-favorites-link")||(t.preventDefault(),t.stopPropagation(),this.toggleFavoritesView())})})}showFavoritesView(){document.querySelectorAll('[data-action="show-favorites"]').forEach(e=>e.classList.add("active")),this.showFavoritesOnly()}toggleFavoritesView(){const e=document.querySelector('[data-action="show-favorites"]:not(.brag-book-gallery-favorites-link)'),t=e?.classList.contains("active");t?(this.showAllCases(),document.querySelectorAll('[data-action="show-favorites"]').forEach(e=>{e.classList.remove("active")})):(this.showFavoritesOnly(),document.querySelectorAll('[data-action="show-favorites"]').forEach(e=>{e.classList.add("active")}))}showFavoritesOnly(){const e=document.getElementById("gallery-content");if(!e)return;const t=e.querySelector("#gallery-sections");t&&(t.style.display="none");const a="brag-book-user-info";let o=null;try{const e=localStorage.getItem(a);e&&(o=JSON.parse(e))}catch(e){console.error("Failed to load user info:",e)}if(!o||!o.email){const e=document.getElementById("favoritesEmailCapture");e&&(e.style.display="block");const t=document.getElementById("favoritesGridContainer");t&&(t.style.display="none");const o=document.getElementById("favorites-email-form");return void(o&&o.addEventListener("submit",e=>{e.preventDefault();const t={email:new FormData(o).get("email")};localStorage.setItem(a,JSON.stringify(t)),this.showFavoritesOnly()}))}const r=document.getElementById("favoritesEmailCapture"),s=document.getElementById("favoritesLoading"),i=document.getElementById("favoritesGridContainer");r&&(r.style.display="none"),s&&(s.style.display="block"),i&&(i.style.display="none");const l=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",n=window.bragBookGalleryConfig?.nonce||"";fetch(l,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"brag_book_get_favorites_list",email:o.email,nonce:n})}).then(e=>e.json()).then(e=>{if(s&&(s.style.display="none"),e.success&&e.data){if(e.data.user_info||e.data.name&&e.data.phone){const t=e.data.user_info||{email:o.email,name:e.data.name||"",phone:e.data.phone||""};if(t.name||t.phone){const e={email:o.email,name:t.name||o.name||"",phone:t.phone||o.phone||""};localStorage.setItem(a,JSON.stringify(e)),o=e}}if(e.data.cases&&Array.isArray(e.data.cases)){let t=[];const a=localStorage.getItem("brag-book-favorites");if(a)try{t=JSON.parse(a)}catch(e){console.error("Error parsing existing favorites:",e),t=[]}const o=new Set(t);e.data.cases.forEach(e=>{const t=e.id||e.caseId||"";t&&o.add(String(t))});const r=Array.from(o);localStorage.setItem("brag-book-favorites",JSON.stringify(r)),this.favoritesManager&&(this.favoritesManager.favorites=new Set(r),this.favoritesManager.updateUI()),document.querySelectorAll("[data-favorites-count]").forEach(e=>{const t=e.closest(".brag-book-gallery-favorites-link--tiles");e.textContent=t?r.length:`(${r.length})`,e.style&&(e.style.opacity="1")})}else localStorage.getItem("brag-book-favorites")||localStorage.setItem("brag-book-favorites",JSON.stringify([])),document.querySelectorAll("[data-favorites-count]").forEach(e=>{const t=e.closest(".brag-book-gallery-favorites-link--tiles");e.textContent=t?"0":"(0)",e.style&&(e.style.opacity="1")}),this.favoritesManager&&(this.favoritesManager.favorites=new Set,this.favoritesManager.updateUI());if(e.data.html){if(i){i.style.display="block";const t=i.querySelector("#favoritesGrid");t&&(t.innerHTML=e.data.html);const a=i.querySelector("#favoritesActions");a&&(a.style.display="block");const o=i.querySelector("#favoritesEmpty");o&&(o.style.display="none")}this.reinitializeGalleryComponents(),setTimeout(()=>{const e=localStorage.getItem("brag-book-favorites");if(e)try{JSON.parse(e).forEach(e=>{[`[data-item-id="${e}"]`,`[data-case-id="${e}"]`,`[data-item-id="case-${e}"]`,`[data-item-id="${e}_main"]`].forEach(e=>{document.querySelectorAll(e).forEach(e=>{void 0!==e.dataset.favorited&&(e.dataset.favorited="true")})})})}catch(e){console.error("Error updating favorite button states:",e)}},100)}else if(localStorage.getItem("brag-book-favorites")||localStorage.setItem("brag-book-favorites",JSON.stringify([])),i){i.style.display="block";const e=i.querySelector("#favoritesGrid");e&&(e.innerHTML="");const t=i.querySelector("#favoritesActions");t&&(t.style.display="none");const a=i.querySelector("#favoritesEmpty");a&&(a.style.display="block")}}else localStorage.getItem("brag-book-favorites")||localStorage.setItem("brag-book-favorites",JSON.stringify([])),console.error("Failed to load favorites:",e.data?.message||"Unknown error"),r&&(r.style.display="block"),i&&(i.style.display="none")}).catch(e=>{console.error("Error loading favorites:",e),s&&(s.style.display="none"),r&&(r.style.display="block"),i&&(i.style.display="none")}),this.components.filterSystem&&this.components.filterSystem.clearAllFilters()}showAllCases(){const e=document.getElementById("gallery-content"),t=e?.querySelector("#gallery-sections");t&&(t.style.display="");const a=e?.querySelector(".brag-book-gallery-favorites-header");a&&a.remove(),this.components.filterSystem&&(this.components.filterSystem.clearAllFilters(),this.components.filterSystem.loadInitialCases())}showFavoritesEmptyState(){const e=document.getElementById("gallery-content");if(!e)return;const t=e.querySelector("#gallery-sections");t&&(t.style.display="none");const a=e.querySelector(".brag-book-gallery-cases-grid");a&&(a.innerHTML="")}createCaseCard(e){const t=e.id,a=window.bragBookGalleryConfig?.gallerySlug||"before-after";let o="case",r="Case";const s=window.location.pathname,i=new RegExp(`/${a}/([^/]+)`),l=s.match(i);l&&l[1]?(o=l[1],r=o.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")):e.technique&&(o=e.technique.toLowerCase().replace(/\s+/g,"-"),r=e.technique);const n="/"+a+"/"+o+"/"+t+"/";let c="";e.photoSets&&e.photoSets.length>0&&(c=e.photoSets[0].postProcessedImageLocation||"");const d=this.components.favoritesManager.getFavorites().has(`case-${t}`);return`\n\t\t\t<article class="brag-book-gallery-case-card" data-case-id="${t}">\n\t\t\t\t<div class="brag-book-gallery-image-container">\n\t\t\t\t\t<div class="brag-book-gallery-skeleton-loader" style="display:none;"></div>\n\t\t\t\t\t<div class="brag-book-gallery-item-actions">\n\t\t\t\t\t\t<button class="brag-book-gallery-favorite-button" data-favorited="${d}" data-item-id="case-${t}" aria-label="${d?"Remove from":"Add to"} favorites">\n\t\t\t\t\t\t\t<svg fill="${d?"red":"rgba(255, 255, 255, 0.5)"}" stroke="white" stroke-width="2" viewBox="0 0 24 24">\n\t\t\t\t\t\t\t\t<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t<a href="${n}" class="brag-book-gallery-case-card-link" data-case-id="${t}">\n\t\t\t\t\t\t<picture class="brag-book-gallery-picture">\n\t\t\t\t\t\t\t<img src="${c}" alt="Case ${t}" loading="lazy" data-image-type="single">\n\t\t\t\t\t\t</picture>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t\t<div class="brag-book-gallery-case-card-summary">\n\t\t\t\t\t<div class="brag-book-gallery-case-card-summary-info">\n\t\t\t\t\t\t<span class="brag-book-gallery-case-card-summary-info__name">${r}</span>\n\t\t\t\t\t\t<span class="brag-book-gallery-case-card-summary-info__case-number">Case #${t}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="brag-book-gallery-case-card-summary-details">\n\t\t\t\t\t\t${e.age?`<span class="brag-book-gallery-age">${e.age} yrs</span>`:""}\n\t\t\t\t\t\t${e.gender?`<span class="brag-book-gallery-gender">${e.gender}</span>`:""}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</article>\n\t\t`}reinitializeGalleryComponents(){this.initializeCaseLinks(),this.components.favoritesManager&&document.querySelectorAll("[data-favorited]").forEach(e=>{const t=e.dataset.itemId,a=this.components.favoritesManager.getFavorites().has(t);e.dataset.favorited=a.toString()})}initializeNudityWarning(){this.components.nudityWarningManager=new i}initializeCasePreloading(){this.casePreloadCache=new Map,this.optimizeImageLoading(),this.setupCasePreloadObserver(),setTimeout(()=>{this.preloadVisibleCases()},1e3)}optimizeImageLoading(){const e=document.querySelectorAll(".brag-book-gallery-case-card img");Array.from(e).slice(0,3).forEach((e,t)=>{if(e.loading="eager",e.setAttribute("fetchpriority","high"),0===t){const t=document.createElement("link");t.rel="preload",t.as="image",t.href=e.src,t.fetchPriority="high",document.head.appendChild(t)}}),this.setupImageLoadingOptimization()}setupImageLoadingOptimization(){this.imageOptimizationObserver=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){const t=e.querySelectorAll?e.querySelectorAll(".brag-book-gallery-case-card img"):[];Array.from(t).slice(0,2).forEach(e=>{e.loading="eager",e.setAttribute("fetchpriority","high")})}})})});const e=document.getElementById("gallery-content");e&&this.imageOptimizationObserver.observe(e,{childList:!0,subtree:!0})}setupCasePreloadObserver(){window.IntersectionObserver&&(this.caseObserver=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target,a=t.dataset.caseId,o=t.dataset.procedureIds;a&&!this.casePreloadCache.has(a)&&this.preloadCase(a,o,"high")}})},{threshold:.25,rootMargin:"800px"}),document.querySelectorAll(".brag-book-gallery-case-card").forEach(e=>{this.caseObserver.observe(e),this.setupHoverPreloading(e)}))}setupHoverPreloading(e){let t;e.addEventListener("mouseenter",()=>{t=setTimeout(()=>{const t=e.dataset.caseId,a=e.dataset.procedureIds;t&&!this.casePreloadCache.has(t)&&this.preloadCase(t,a,"hover")},300)}),e.addEventListener("mouseleave",()=>{t&&clearTimeout(t)})}preloadVisibleCases(){const e=document.querySelectorAll(".brag-book-gallery-case-card");Array.from(e).slice(0,3).forEach(e=>{const t=e.dataset.caseId,a=e.dataset.procedureIds;t&&!this.casePreloadCache.has(t)&&this.preloadCase(t,a)})}async preloadCase(e,t,a="normal"){if(this.casePreloadCache.has(e))return;this.casePreloadCache.set(e,"loading"),this.preloadQueue||(this.preloadQueue=[]);const o={caseId:e,procedureIds:t,priority:a,timestamp:Date.now()},r={high:3,hover:2,normal:1},s=this.preloadQueue.findIndex(e=>r[e.priority]<r[a]);-1===s?this.preloadQueue.push(o):this.preloadQueue.splice(s,0,o),this.processPreloadQueue()}processPreloadQueue(){for(this.activePreloads||(this.activePreloads=new Set),this.preloadQueue&&this.preloadQueue.length>0&&this.preloadQueue.sort((e,t)=>{const a={high:3,hover:2,normal:1},o=a[t.priority]-a[e.priority];return 0===o&&"hover"===e.priority?t.timestamp-e.timestamp:o});this.activePreloads.size<3&&this.preloadQueue&&this.preloadQueue.length>0;){const e=this.preloadQueue.shift();this.activePreloads.has(e.caseId)||this.casePreloadCache.has(e.caseId)||(this.activePreloads.add(e.caseId),this.executePreloadTask(e).finally(()=>{this.activePreloads.delete(e.caseId),this.processPreloadQueue()}))}}async executePreloadTask(e){try{const t=await this.preloadCaseViaAjax(e.caseId,e.procedureIds);t&&(this.casePreloadCache.set(e.caseId,t),"high"===e.priority||e.priority)}catch(t){console.warn(`Queue failed to process case ${e.caseId}:`,t)}}async preloadCaseViaAjax(e,t){try{const a=window.location.pathname.split("/").filter(e=>e),o=a.length>1?a[a.length-1]:"";let r="";const s=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${o}"]`);if(s){const e=s.querySelector(".brag-book-gallery-filter-option-label");e&&(r=e.textContent.trim())}const i={action:"brag_book_gallery_load_case_details_html",case_id:e,procedure_slug:o,procedure_name:r,nonce:bragBookGalleryConfig.nonce||""};t&&(i.procedure_ids=t);const l=await fetch(bragBookGalleryConfig.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(i)});if(!l.ok)return null;const n=await l.json();return n.success&&n.data&&n.data.html?n.data.html:null}catch(e){return console.warn("AJAX preload failed:",e),null}}generateCaseDetailHTML(e){const t=e.id||"",a=this.extractProcedureDataForDetails(e),o=this.extractSEOData(e),r=e.navigation||null,s=window.location.pathname.split("/").filter(e=>e),i=s.length>2?s[s.length-2]:"",l=a.name||"";let n="";if(e.procedureIds&&Array.isArray(e.procedureIds)){const t=e.procedureIds.map(e=>parseInt(e)).filter(e=>!isNaN(e));n=` data-procedure-ids="${this.escapeHtml(t.join(","))}"`}const c=i?` data-procedure="${this.escapeHtml(i)}"`:"";return`<div class="brag-book-gallery-case-detail-view" data-case-id="${this.escapeHtml(t)}"${n}${c}>${this.renderCaseHeader(a,o,t,i,l,r)}${this.renderCaseImages(e,a,t)}${this.renderCaseDetailsCards(e)}</div>`}extractProcedureDataForDetails(e){let t="",a="",o=[];if(e.procedures&&Array.isArray(e.procedures)&&e.procedures.length>0){const r=e.procedures[0];if(r.name){const e=r.name;t=this.formatProcedureDisplayName(e),a=this.sanitizeTitle(e)}else r.id&&o.push(parseInt(r.id))}else e.procedureIds&&Array.isArray(e.procedureIds)&&(o=e.procedureIds.map(e=>parseInt(e)).filter(e=>!isNaN(e)));return{name:t,slug:a,ids:o,procedures:e.procedures||[]}}formatProcedureDisplayName(e){return e?e.trim():""}sanitizeTitle(e){return e?e.toLowerCase().trim().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,""):""}extractProcedureData(e){let t="",a="",o=[];if(e.procedures&&Array.isArray(e.procedures)&&e.procedures.length>0){const r=e.procedures[0];r.name&&(t=r.name),r.slugName&&(a=r.slugName),o=e.procedures.map(e=>e.id).filter(e=>e)}return 0===o.length&&e.procedureIds&&Array.isArray(e.procedureIds)&&(o=e.procedureIds),{procedureName:t,procedureSlug:a,procedureIds:o,hasProcedures:o.length>0}}extractSEOData(e){return{title:e.seoTitle||`Case ${e.id}`,description:e.seoDescription||"",keywords:e.seoKeywords||""}}renderCaseHeader(e,t,a,o,r,s){const i="/"+this.getGallerySlug().replace(/^\/+/,"");let l=i+"/",n="â† Back to Gallery";o&&(l=i+"/"+o+"/",r&&(n=`â† Back to ${r}`));const c=this.buildNavigationButtons(s,o),d=this.buildTitleContent(t,e,a,r);return`\n\t\t\t<div class="brag-book-gallery-case-detail-header">\n\t\t\t\t<div class="brag-book-gallery-case-navigation">\n\t\t\t\t\t<a href="${this.escapeHtml(l)}" class="brag-book-gallery-back-button" rel="nofollow">\n\t\t\t\t\t\t${this.escapeHtml(n)}\n\t\t\t\t\t</a>\n\t\t\t\t\t${c}\n\t\t\t\t</div>\n\t\t\t\t${d}\n\t\t\t</div>\n\t\t`}buildNavigationButtons(e,t){if(!e)return"";const a="/"+this.getGallerySlug().replace(/^\/+/,"");let o='<div class="brag-book-gallery-case-nav-buttons">';if(e.previous){const r=e.previous,s=t?`${a}/${t}/${r.id}/`:`${a}/case/${r.id}/`;o+=`\n\t\t\t\t<a href="${this.escapeHtml(s)}" class="brag-book-gallery-nav-button brag-book-gallery-prev-case" rel="prev nofollow">\n\t\t\t\t\t<span class="brag-book-gallery-nav-arrow">â†</span>\n\t\t\t\t\t<span class="brag-book-gallery-nav-text">Previous Case</span>\n\t\t\t\t</a>\n\t\t\t`}if(e.next){const r=e.next,s=t?`${a}/${t}/${r.id}/`:`${a}/case/${r.id}/`;o+=`\n\t\t\t\t<a href="${this.escapeHtml(s)}" class="brag-book-gallery-nav-button brag-book-gallery-next-case" rel="next nofollow">\n\t\t\t\t\t<span class="brag-book-gallery-nav-text">Next Case</span>\n\t\t\t\t\t<span class="brag-book-gallery-nav-arrow">â†’</span>\n\t\t\t\t</a>\n\t\t\t`}return o+"</div>"}buildTitleContent(e,t,a,o){const r=o||t.procedureName||"Case Study";return`\n\t\t\t<div class="brag-book-gallery-case-title-section">\n\t\t\t\t<h1 class="brag-book-gallery-case-title">${this.escapeHtml(r)}</h1>\n\t\t\t\t<div class="brag-book-gallery-case-subtitle">Case #${this.escapeHtml(a)}</div>\n\t\t\t</div>\n\t\t`}renderCaseImages(e,t,a){return e.photoSets&&Array.isArray(e.photoSets)&&0!==e.photoSets.length?`\n\t\t\t<div class="brag-book-gallery-brag-book-gallery-case-content">\n\t\t\t\t<div class="brag-book-gallery-case-images-section">\n\t\t\t\t\t<div class="brag-book-gallery-case-images-layout">\n\t\t\t\t\t\t${this.renderMainImageViewer(e.photoSets,t,a)}\n\t\t\t\t\t\t${e.photoSets.length>1?this.renderThumbnails(e.photoSets):""}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t`:this.renderNoImagesSection()}renderNoImagesSection(){return'\n\t\t\t<div class="brag-book-gallery-case-images-section">\n\t\t\t\t<div class="brag-book-gallery-no-images">\n\t\t\t\t\t<p>No images available for this case.</p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'}renderMainImageViewer(e,t,a){if(!e||0===e.length)return"";const o=e[0],r=o.beforeLocationUrl||"",s=o.afterLocationUrl1||"",i=o.postProcessedImageLocation||r||s;if(!i)return this.renderNoImagesSection();const l=t.procedureName||"Case Study";return`\n\t\t\t<div class="brag-book-gallery-main-image-viewer">\n\t\t\t\t<div class="brag-book-gallery-main-image-container" data-photoset-index="0">\n\t\t\t\t\t<img src="${this.escapeHtml(i)}"\n\t\t\t\t\t\t alt="${this.escapeHtml(l)} - Case ${this.escapeHtml(a)}"\n\t\t\t\t\t\t class="brag-book-gallery-main-image"\n\t\t\t\t\t\t loading="lazy">\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}renderThumbnails(e){return!e||e.length<=1?"":`\n\t\t\t<div class="brag-book-gallery-thumbnails-section">\n\t\t\t\t<div class="brag-book-gallery-thumbnails-grid">\n\t\t\t\t\t${e.map((e,t)=>{const a=e.postProcessedImageLocation||e.beforeLocationUrl||e.afterLocationUrl1||"";return a?`\n\t\t\t\t<div class="brag-book-gallery-thumbnail${0===t?" active":""}" data-photoset-index="${t}">\n\t\t\t\t\t<img src="${this.escapeHtml(a)}"\n\t\t\t\t\t\t alt="Thumbnail ${t+1}"\n\t\t\t\t\t\t loading="lazy">\n\t\t\t\t</div>\n\t\t\t`:""}).filter(e=>e).join("")}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}renderCaseDetailsCards(e){return`\n\t\t\t<div class="brag-book-gallery-case-card-details-section">\n\t\t\t\t<div class="brag-book-gallery-case-card-details-grid">\n\t\t\t\t\t${this.renderProceduresCard(e)}\n\t\t\t\t\t${this.renderPatientDetailsCard(e)}\n\t\t\t\t\t${this.renderProcedureDetailsCard(e)}\n\t\t\t\t\t${this.renderCaseNotesCard(e)}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>`}renderProceduresCard(e){return e.procedures&&Array.isArray(e.procedures)&&0!==e.procedures.length?`\n\t\t\t<div class="brag-book-gallery-detail-card">\n\t\t\t\t<h3 class="brag-book-gallery-detail-card-title">Procedures Performed</h3>\n\t\t\t\t<div class="brag-book-gallery-detail-card-content">\n\t\t\t\t\t<ul class="brag-book-gallery-procedures-list">\n\t\t\t\t\t\t${e.procedures.map(e=>`<li>${this.escapeHtml(e.name||"Unknown Procedure")}</li>`).join("")}\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`:""}renderPatientDetailsCard(e){const t=[];return e.age&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Age:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(String(e.age))}</span></div>`),e.gender&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Gender:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.gender)}</span></div>`),e.ethnicity&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Ethnicity:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.ethnicity)}</span></div>`),e.height&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Height:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.height)}</span></div>`),e.weight&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Weight:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.weight)}</span></div>`),0===t.length?"":`\n\t\t\t<div class="brag-book-gallery-detail-card">\n\t\t\t\t<h3 class="brag-book-gallery-detail-card-title">Patient Information</h3>\n\t\t\t\t<div class="brag-book-gallery-detail-card-content">\n\t\t\t\t\t${t.join("")}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}renderProcedureDetailsCard(e){const t=[];return e.surgeryDate&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Surgery Date:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.surgeryDate)}</span></div>`),e.followUpDate&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Follow-up Date:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.followUpDate)}</span></div>`),e.surgeon&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Surgeon:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.surgeon)}</span></div>`),e.location&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Location:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.location)}</span></div>`),0===t.length?"":`\n\t\t\t<div class="brag-book-gallery-detail-card">\n\t\t\t\t<h3 class="brag-book-gallery-detail-card-title">Procedure Details</h3>\n\t\t\t\t<div class="brag-book-gallery-detail-card-content">\n\t\t\t\t\t${t.join("")}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}renderCaseNotesCard(e){const t=e.notes||e.description||e.caseNotes||"";return t?`\n\t\t\t<div class="brag-book-gallery-detail-card brag-book-gallery-case-notes-card">\n\t\t\t\t<h3 class="brag-book-gallery-detail-card-title">Case Notes</h3>\n\t\t\t\t<div class="brag-book-gallery-detail-card-content">\n\t\t\t\t\t<div class="brag-book-gallery-case-notes-content">\n\t\t\t\t\t\t${this.escapeHtml(t).replace(/\n/g,"<br>")}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`:""}getGallerySlug(){return(window.bragBookGalleryConfig||{}).gallerySlug||"gallery"}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}updateCaseDetailsSEO(e,t){if(!e)return;const a=e.id||"",o=t?`${t} Case ${a} - Before & After`:`Case ${a} - Before & After`;document.title=o;let r=`View before and after photos for Case ${a}`;t&&(r=`${t} before and after photos - Case ${a}. See real patient results.`),this.updateMetaTag("description",r);const s=window.location.href;this.updateLinkTag("canonical",s),this.addCaseStructuredData(e,t)}updateMetaTag(e,t){let a=document.querySelector(`meta[name="${e}"]`);a||(a=document.createElement("meta"),a.setAttribute("name",e),document.head.appendChild(a)),a.setAttribute("content",t)}updateLinkTag(e,t){let a=document.querySelector(`link[rel="${e}"]`);a||(a=document.createElement("link"),a.setAttribute("rel",e),document.head.appendChild(a)),a.setAttribute("href",t)}addCaseStructuredData(e,t){const a={"@context":"https://schema.org","@type":"MedicalProcedure",name:t||"Medical Procedure",identifier:e.id,image:[],description:`Before and after case study for ${t||"medical procedure"}`};e.photoSets&&Array.isArray(e.photoSets)&&e.photoSets.forEach(e=>{e.postProcessedImageLocation?a.image.push(e.postProcessedImageLocation):e.beforeLocationUrl?a.image.push(e.beforeLocationUrl):e.afterLocationUrl1&&a.image.push(e.afterLocationUrl1)});const o=document.querySelector("script[data-case-structured-data]");o&&o.remove();const r=document.createElement("script");r.type="application/ld+json",r.setAttribute("data-case-structured-data","true"),r.textContent=JSON.stringify(a),document.head.appendChild(r)}initializeThumbnailNavigation(){const e=document.querySelectorAll(".brag-book-gallery-thumbnail"),t=document.querySelector(".brag-book-gallery-main-image");t&&0!==e.length&&e.forEach((a,o)=>{a.addEventListener("click",r=>{r.preventDefault(),e.forEach(e=>e.classList.remove("active")),a.classList.add("active");const s=a.querySelector("img");if(s&&s.src){t.src=s.src,t.alt=s.alt||`Case image ${o+1}`;const e=document.querySelector(".brag-book-gallery-main-image-container");e&&e.setAttribute("data-photoset-index",o.toString())}})})}getProcedureIdsFromSlug(e){if(!e)return null;if(window.bragBookGalleryConfig?.sidebarData){const t=window.bragBookGalleryConfig.sidebarData;for(const a of Object.values(t))if(a.procedures)for(const t of a.procedures)if(t.slug===e)return t.ids?t.ids.join(","):null}const t=document.querySelector(".brag-book-gallery-case-detail-view");if(t&&t.dataset.procedureIds)return t.dataset.procedureIds;const a=document.querySelector(`[data-procedure="${e}"]`);return a&&a.dataset.procedureIds?a.dataset.procedureIds:(console.warn(`âš ï¸ Could not find procedure IDs for slug: ${e}`),null)}setActiveSidebarForCase(e){try{const e=window.location.pathname.split("/").filter(e=>e),t=e.length>2?e[e.length-2]:"";if(!t)return;document.querySelectorAll(".brag-book-gallery-nav-link").forEach(e=>{e.classList.remove("brag-book-gallery-active")});const a=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${t}"]`);if(a){a.classList.add("brag-book-gallery-active");const e=a.closest(".brag-book-gallery-nav-list-submenu__item");e&&e.classList.add("brag-book-gallery-active")}else console.warn(`âš ï¸ Could not find sidebar link for procedure: ${t}`)}catch(e){console.error("Error setting sidebar active state:",e)}}initializeFavoritesPage(){let e=null,t=[];if(this.favoritesManager&&(e=this.favoritesManager.getUserInfo(),t=Array.from(this.favoritesManager.getFavorites()||[])),!e)try{const t=localStorage.getItem("brag-book-user-info");t&&(e=JSON.parse(t))}catch(e){console.error("Failed to load user info from localStorage:",e)}if(0===t.length)try{const e=localStorage.getItem("brag-book-favorites");e&&(t=JSON.parse(e))}catch(e){console.error("Failed to load favorites from localStorage:",e)}document.getElementById("brag-book-gallery-favorites")?this.initializeDedicatedFavoritesPage(e,t):e&&e.email?this.showFavoritesOnly():this.showFavoritesRegistrationPrompt()}initializeDedicatedFavoritesPage(e,t=[]){const a=document.getElementById("favoritesEmailCapture"),o=document.getElementById("favoritesGridContainer"),r=document.getElementById("favoritesLoading"),s=e&&e.email&&e.name&&e.phone,i=t&&t.length>0;return s?i?(a&&(a.style.display="none"),r&&(r.style.display="block"),o&&(o.style.display="none"),void this.fetchAndDisplayFavorites(e,t,o,r)):(a&&(a.style.display="none"),void this.showEmptyFavoritesState(o,r)):(a&&(a.style.display="block"),r&&(r.style.display="none"),void(o&&(o.style.display="none")))}async fetchAndDisplayFavorites(e,t,a,o){try{const t=new FormData;t.append("action","brag_book_lookup_favorites"),t.append("nonce",window.bragBookGalleryConfig?.nonce||""),t.append("email",e.email);const r=await fetch(window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",body:t});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const s=await r.json();s.success&&s.data&&s.data.favorites?this.displayFavoritesGrid(s.data.favorites,a,o):(console.warn("No favorites found or API error:",s),this.showEmptyFavoritesState(a,o))}catch(e){console.error("Error fetching favorites:",e),this.showEmptyFavoritesState(a,o)}}displayFavoritesGrid(e,t,a){a&&(a.style.display="none");const o=document.getElementById("favoritesEmailCapture");o&&(o.style.display="none"),t&&(t.style.display="block");let r=t.querySelector(".brag-book-gallery-favorites-grid");if(!r)return void console.error("Expected .brag-book-gallery-favorites-grid element not found in container");r.className="brag-book-gallery-case-grid masonry-layout grid-initialized";const s=t.querySelector(".brag-book-gallery-favorites-empty");if(r.innerHTML="",e.cases_data&&Object.keys(e.cases_data).length>0){if(s&&(s.style.display="none"),!t.querySelector(".brag-book-gallery-content-title")){const e='\n\t\t\t\t\t<h1 class="brag-book-gallery-content-title">\n\t\t\t\t\t\t<strong>My</strong><span>Favorites</span>\n\t\t\t\t\t</h1>\n\t\t\t\t';r.insertAdjacentHTML("beforebegin",e)}this.addUserInfoAfterTitle(e,t),Object.values(e.cases_data).forEach(async e=>{const t=await this.generateFavoriteCard(e);r.insertAdjacentHTML("beforeend",t)}),r.style.display="grid"}else r.style.display="none",this.showEmptyFavoritesState(t,a)}async generateFavoriteCard(e){const t=e.id||e.case_id||"";let a,o,r,s,i,l,n=null;try{const e=new FormData;e.append("action","brag_book_get_case_by_api_id"),e.append("nonce",window.bragBookGalleryConfig?.nonce||""),e.append("api_case_id",t);const a=await fetch(window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",body:e});if(a.ok){const e=await a.json();e.success&&e.data&&(n=e.data)}}catch(e){console.warn("Could not fetch WordPress post data for case:",t,e)}if(n)l=n.ID,a=n.post_meta?.brag_book_gallery_api_id||t,o=n.procedure_name||"Unknown Procedure",r=n.procedure_slug||"procedure",s=n.post_name||n.post_meta?._case_seo_suffix_url||a,i=n.featured_image_url||"";else if(l=e.post_id||"",a=t,o=e.procedure_name||"Unknown Procedure",r=e.procedure_slug||"procedure",s=e.seo_suffix||a,i="",e.images&&Array.isArray(e.images)){const t=e.images.find(e=>"after"===e.type),a=e.images.find(e=>"before"===e.type);i=t&&t.url||a&&a.url||""}const c=`/${window.bragBookGalleryConfig?.gallerySlug||"gallery"}/${r}/${s}/`;let d=`<article class="brag-book-gallery-case-card" ${[`data-case-id="${this.escapeHtml(a)}"`,`data-post-id="${l}"`,`data-age="${e.age||""}"`,`data-gender="${e.gender||""}"`,`data-ethnicity="${e.ethnicity||""}"`,`data-procedure-ids="${e.procedure_id||""}"`,'data-card="true"'].join(" ")}>`;return d+='<div class="brag-book-gallery-case-images single-image">',d+='<div class="brag-book-gallery-image-container">',d+='<div class="brag-book-gallery-skeleton-loader" style="display: none;"></div>',d+='<div class="brag-book-gallery-item-actions">',d+=`<button class="brag-book-gallery-favorite-button" data-favorited="true" data-item-id="case-${this.escapeHtml(a)}" aria-label="Remove from favorites">`,d+='<svg fill="rgba(255, 255, 255, 0.5)" stroke="white" stroke-width="2" viewBox="0 0 24 24">',d+='<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>',d+="</svg>",d+="</button>",d+="</div>",d+=`<a href="${this.escapeHtml(c)}" class="brag-book-gallery-case-permalink" data-case-id="${this.escapeHtml(a)}" data-procedure-ids="${e.procedure_id||""}">`,i&&(d+='<picture class="brag-book-gallery-picture">',d+=`<img src="${this.escapeHtml(i)}" alt="${this.escapeHtml(o)} - Case ${this.escapeHtml(a)}" loading="eager" data-image-type="single" data-image-url="${this.escapeHtml(i)}" onload="this.closest('.brag-book-gallery-image-container').querySelector('.brag-book-gallery-skeleton-loader').style.display='none';" fetchpriority="high">`,d+="</picture>"),d+="</a>",d+="</div>",d+="</div>",d+='<details class="brag-book-gallery-case-card-details">',d+='<summary class="brag-book-gallery-case-card-summary">',d+='<div class="brag-book-gallery-case-card-summary-info">',d+=`<span class="brag-book-gallery-case-card-summary-info__name">${this.escapeHtml(o)}</span>`,d+=`<span class="brag-book-gallery-case-card-summary-info__case-number">Case #${this.escapeHtml(a)}</span>`,d+="</div>",d+='<p class="brag-book-gallery-case-card-summary-details">',d+="<strong>More Details</strong>",d+='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">',d+='<path d="M444-288h72v-156h156v-72H516v-156h-72v156H288v72h156v156Zm36.28 192Q401-96 331-126t-122.5-82.5Q156-261 126-330.96t-30-149.5Q96-560 126-629.5q30-69.5 82.5-122T330.96-834q69.96-30 149.5-30t149.04 30q69.5 30 122 82.5T834-629.28q30 69.73 30 149Q864-401 834-331t-82.5 122.5Q699-156 629.28-126q-69.73 30-149 30Z"></path>',d+="</svg>",d+="</p>",d+="</summary>",d+='<div class="brag-book-gallery-case-card-details-content">',d+='<p class="brag-book-gallery-case-card-details-content__title">Procedures Performed:</p>',d+='<ul class="brag-book-gallery-case-card-procedures-list">',e.procedures&&Array.isArray(e.procedures)&&e.procedures.length>0?e.procedures.forEach(e=>{d+=`<li class="brag-book-gallery-case-card-procedures-list__item">${this.escapeHtml(e.name||"Unknown Procedure")}</li>`}):d+=`<li class="brag-book-gallery-case-card-procedures-list__item">${this.escapeHtml(o)}</li>`,d+="</ul>",d+="</div>",d+="</details>",d+="</article>",d}escapeHtml(e){return"string"!=typeof e?String(e||""):e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}showEmptyFavoritesState(e,t){if(t&&(t.style.display="none"),e){e.style.display="block";const t=e.querySelector(".brag-book-gallery-favorites-grid"),a=e.querySelector(".brag-book-gallery-case-grid");t&&(t.style.display="none"),a&&(a.style.display="none");const o=e.querySelector(".brag-book-gallery-favorites-empty");o&&(o.style.display="block")}const a=document.getElementById("favoritesEmailCapture");a&&(a.style.display="none")}addUserInfoAfterTitle(e,t){const a=t.querySelector(".brag-book-gallery-content-title");if(!a)return void console.warn("Content title not found");if(t.querySelector(".brag-book-gallery-user-info"))return;let o=null;try{const e=localStorage.getItem("brag-book-user-info");e&&(o=JSON.parse(e))}catch(e){console.error("Failed to parse user info from localStorage:",e)}const r=Object.keys(e.cases_data||{}).length,s=`\n\t\t\t<div class="brag-book-gallery-controls">\n\t\t\t\t<div class="brag-book-gallery-controls-left">\n\t\t\t\t\t<div class="user-email">\n\t\t\t\t\t\t<strong>Email:</strong>\n\t\t\t\t\t\t<span>${o?.email||"Unknown User"}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="favorites-count">\n\t\t\t\t\t\t<span>${r} favorite${1!==r?"s":""}</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="brag-book-gallery-grid-selector">\n\t\t\t\t\t<span class="brag-book-gallery-grid-label">View:</span>\n\t\t\t\t\t<div class="brag-book-gallery-grid-buttons">\n\t\t\t\t\t\t<button class="brag-book-gallery-grid-btn" data-columns="2" onclick="updateGridLayout(2)" aria-label="View in 2 columns">\n\t\t\t\t\t\t\t<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true"><rect x="1" y="1" width="6" height="6"></rect>\n\t\t\t\t\t\t\t\t<rect x="9" y="1" width="6" height="6"></rect>\n\t\t\t\t\t\t\t\t<rect x="1" y="9" width="6" height="6"></rect>\n\t\t\t\t\t\t\t\t<rect x="9" y="9" width="6" height="6"></rect>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t<span class="sr-only">2 Columns</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<button class="brag-book-gallery-grid-btn active" data-columns="3" onclick="updateGridLayout(3)" aria-label="View in 3 columns">\n\t\t\t\t\t\t\t<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">\n\t\t\t\t\t\t\t\t<rect x="1" y="1" width="4" height="4"></rect>\n\t\t\t\t\t\t\t\t<rect x="6" y="1" width="4" height="4"></rect>\n\t\t\t\t\t\t\t\t<rect x="11" y="1" width="4" height="4"></rect>\n\t\t\t\t\t\t\t\t<rect x="1" y="6" width="4" height="4"></rect>\n\t\t\t\t\t\t\t\t<rect x="6" y="6" width="4" height="4"></rect>\n\t\t\t\t\t\t\t\t<rect x="11" y="6" width="4" height="4"></rect>\n\t\t\t\t\t\t\t\t<rect x="1" y="11" width="4" height="4"></rect>\n\t\t\t\t\t\t\t\t<rect x="6" y="11" width="4" height="4"></rect>\n\t\t\t\t\t\t\t\t<rect x="11" y="11" width="4" height="4"></rect>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t<span class="sr-only">3 Columns</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;a.insertAdjacentHTML("afterend",s)}showFavoritesRegistrationPrompt(){const e=document.getElementById("gallery-content");e&&(e.innerHTML='\n\t\t\t<div class="brag-book-gallery-favorites-registration-prompt">\n\t\t\t\t<h2>My Favorites</h2>\n\t\t\t\t<p>To view your favorites, you need to register your email address first.</p>\n\t\t\t\t<p><a href="/gallery/myfavorites/" class="brag-book-gallery-button">Go to My Favorites Page</a></p>\n\t\t\t</div>\n\t\t')}async getFavoritesData(e){return e&&0!==e.length?e.map(e=>({id:e,images:[],procedures:[],age:"",gender:""})):[]}async loadUserFavorites(){if(!this.favoritesManager)return;const e=document.getElementById("favoritesGrid"),t=document.getElementById("favoritesEmpty"),a=document.getElementById("favoritesActions"),o=document.getElementById("favoritesLoading");if(!e||!t||!a)return;const r=this.favoritesManager.getFavorites(),s=this.favoritesManager.getUserInfo();if(0===r.size)return t.style.display="block",e.style.display="none",void(a.style.display="none");o&&(o.style.display="block"),t.style.display="none",e.style.display="none",a.style.display="none";try{const i=await this.getFavoritesData(Array.from(r)),l=await this.callAjaxEndpoint("brag_book_load_favorites_grid",{favorites:i,userInfo:s,columns:3});o&&(o.style.display="none"),l.success&&l.data.html?l.data.isEmpty?(t.style.display="block",e.style.display="none",a.style.display="none"):(e.innerHTML=l.data.html,e.style.display="grid",a.style.display="flex"):(console.error("Failed to load favorites grid:",l.data?.message||"Unknown error"),t.style.display="block",e.style.display="none",a.style.display="none")}catch(r){console.error("Error loading favorites grid:",r),o&&(o.style.display="none"),t.style.display="block",e.style.display="none",a.style.display="none"}}async populateFavoritesGrid(e){const t=document.getElementById("favoritesGrid");t&&(t.innerHTML="",e.forEach(e=>{const a=document.createElement("div");a.className="brag-book-gallery-case-card",a.dataset.caseId=e,a.innerHTML=`\n\t\t\t\t<div class="brag-book-gallery-case-card-image">\n\t\t\t\t\t<img src="${window.bragBookGalleryConfig?.placeholderImage||"#"}"\n\t\t\t\t\t\t alt="Case ${e}"\n\t\t\t\t\t\t loading="lazy">\n\t\t\t\t</div>\n\t\t\t\t<div class="brag-book-gallery-case-card-content">\n\t\t\t\t\t<h3>Case ${e}</h3>\n\t\t\t\t\t<p>Favorited case details would be loaded here</p>\n\t\t\t\t</div>\n\t\t\t\t<div class="brag-book-gallery-item-actions">\n\t\t\t\t\t<button class="brag-book-gallery-favorite-button"\n\t\t\t\t\t\t\tdata-favorited="true"\n\t\t\t\t\t\t\tdata-item-id="${e}">\n\t\t\t\t\t\t<svg fill="red" stroke="red" stroke-width="2" viewBox="0 0 24 24">\n\t\t\t\t\t\t\t<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t`,t.appendChild(a)}),this.favoritesManager&&this.favoritesManager.refreshEventListeners())}},c=class{constructor(e){this.wrappers={},this.options={wrapper:".brag-book-gallery-carousel-wrapper",nav:"[data-direction]",pagination:".brag-book-gallery-carousel-pagination",track:".brag-book-gallery-carousel-track",direction:"horizontal",autoplay:!1,autoplayInterval:5e3,itemPerPage:1,itemPerGroup:1,...e},this.state={currentSlide:0,totalSlides:0,progress:0},this.setupIntersectionObserver(),this.init()}Wrapper=class{constructor(e,t,a){if(this.wrapper=e,this.nav=e.querySelectorAll(a.nav),this.pagination=e.querySelector(a.pagination),this.grid=e.querySelector(a.track),this.index=t,this.grid){this.grid.setAttribute("data-wrapper-id",this.index),this.items=this.grid.children;const e=window.getComputedStyle(this.grid);this.columnGap=parseInt(e.columnGap,10),this.rowGap=parseInt(e.rowGap,10),this.itemPerPageMobile=parseInt(this.grid.getAttribute("data-mobile-items")||1,10),this.itemPerPageTablet=parseInt(this.grid.getAttribute("data-tablet-items")||2,10),this.itemPerPageDesktop=parseInt(this.grid.getAttribute("data-desktop-items")||3,10)}this.isDragging=!1,this.startX=0,this.scrollLeft=0,this.autoplay="true"===this.wrapper.getAttribute("data-carousel-autoplay"),this.autoplayInterval=parseInt(e.getAttribute("data-carousel-interval")||5e3,10),this.autoplayTimer=null,this.isHovered=!1}};startAutoplay=e=>{e.autoplay&&(this.stopAutoplay(e),e.autoplayTimer=setInterval(()=>{if(!e.isHovered){const t=e.grid,a=t.scrollWidth-t.offsetWidth;if(t.scrollLeft>=a)t.scrollTo({left:0,behavior:"smooth"});else{const a=e.items[0];if(!a)return;const o=a.offsetWidth+e.columnGap;t.scrollTo({left:t.scrollLeft+o,behavior:"smooth"})}}},e.autoplayInterval))};stopAutoplay=e=>{e.autoplayTimer&&(clearInterval(e.autoplayTimer),e.autoplayTimer=null)};setupAutoplay=e=>{e.autoplay&&(this.startAutoplay(e),e.wrapper.addEventListener("mouseenter",()=>{e.isHovered=!0}),e.wrapper.addEventListener("mouseleave",()=>{e.isHovered=!1}),e.wrapper.addEventListener("focusin",()=>{e.isHovered=!0}),e.wrapper.addEventListener("focusout",()=>{e.isHovered=!1}),e.wrapper.addEventListener("touchstart",()=>{e.isHovered=!0}),e.wrapper.addEventListener("touchend",()=>{e.isHovered=!1}))};updateSlideStates=e=>{if(!e||!e.grid||!e.items.length)return;const t=this.getCurrentSlideIndex(e);Array.from(e.items).forEach(e=>{e.classList.remove("is-active-slide","is-next-slide","is-prev-slide","is-next-next-slide","is-prev-prev-slide")}),Array.from(e.items).forEach((e,a)=>{a===t&&e.classList.add("is-active-slide"),a===t+1&&e.classList.add("is-next-slide"),a===t-1&&e.classList.add("is-prev-slide"),a===t+2&&e.classList.add("is-next-next-slide"),a===t-2&&e.classList.add("is-prev-prev-slide")})};setupTrackDrag=e=>{if(!e.grid)return;let t=!1,a=0,o=0,r=0,s=0,i=null;const l=a=>{if(!t)return;a.preventDefault();const o=a.pageX,i=o-r;r=o,s=2*i,e.grid.scrollLeft=e.grid.scrollLeft-i},n=()=>{if(!t)return;t=!1,e.grid.style.cursor="",e.grid.style.userSelect="";const a=()=>{Math.abs(s)>.5?(e.grid.scrollLeft-=s,s*=.95,i=requestAnimationFrame(a)):(cancelAnimationFrame(i),e.grid.style.scrollBehavior="smooth",this.snapToClosestSlide(e.grid))};a(),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",n)};e.grid.addEventListener("mousedown",s=>{t=!0,a=s.pageX,r=a,o=e.grid.scrollLeft,e.grid.style.cursor="grabbing",e.grid.style.userSelect="none",e.grid.style.scrollBehavior="auto",document.addEventListener("mousemove",l),document.addEventListener("mouseup",n)})};initializePagination=e=>{if(!e.pagination||!e.items.length)return;let t;e.pagination.innerHTML="";const a=window.innerWidth;t=a<768?e.itemPerPageMobile:a<992?e.itemPerPageTablet:e.itemPerPageDesktop;const o=Math.ceil(e.items.length/t);for(let t=0;t<o;t++){const a=document.createElement("button");a.className="brag-book-gallery-pagination-dot",a.setAttribute("role","tab"),a.setAttribute("aria-label",`Go to slide ${t+1}`),a.setAttribute("tabindex","0"),0===t?(a.classList.add("brag-book-gallery-active"),a.setAttribute("aria-selected","true")):a.setAttribute("aria-selected","false"),a.clickHandler=()=>{const a=e.items[0];if(!a)return;a.offsetWidth,e.columnGap;const o=t*e.grid.clientWidth;this.smoothScrollTo(e.grid,o)},a.addEventListener("click",a.clickHandler),e.pagination.appendChild(a)}this.updatePaginationState(e)};updatePaginationState=e=>{if(!e.pagination)return;const t=e.pagination.querySelectorAll(".brag-book-gallery-pagination-dot");if(!t.length)return;let a;const o=window.innerWidth;a=o<768?e.itemPerPageMobile:o<992?e.itemPerPageTablet:e.itemPerPageDesktop;const r=e.grid.scrollWidth-e.grid.clientWidth,s=e.grid.scrollLeft,i=e.grid.clientWidth,l=e.items.length,n=Math.ceil(l/a);let c;c=s>=r?n-1:Math.round(s/i),t.forEach((e,t)=>{t===c?(e.classList.add("brag-book-gallery-active"),e.setAttribute("aria-selected","true")):(e.classList.remove("brag-book-gallery-active"),e.setAttribute("aria-selected","false"))})};setupIntersectionObserver=()=>{this.observer=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(e.target.classList.add("is-visible"),e.target.querySelectorAll("img[data-src]").forEach(e=>{e.src=e.dataset.src,e.removeAttribute("data-src")}))})},{root:null,rootMargin:"50px",threshold:.1})};handleScroll=e=>{if(!e||!e.grid)return;const t=e.grid.scrollLeft,a=e.grid.scrollWidth-e.grid.clientWidth;if(this.updateSlideStates(e),e.nav.length>=2){const o=e.nav[0],r=e.nav[1],s=t<=0,i=t>=a-1;o&&(o.disabled=s,s?o.setAttribute("disabled","disabled"):o.removeAttribute("disabled")),r&&(r.disabled=i,i?r.setAttribute("disabled","disabled"):r.removeAttribute("disabled"))}this.updatePaginationState(e),this.updateAriaLabels(e)};updateAriaLabels=e=>{const t=this.getCurrentSlideIndex(e),a=e.items.length;e.wrapper.setAttribute("aria-label",`Carousel with ${a} slides`),Array.from(e.items).forEach((e,o)=>{e.setAttribute("aria-label",`Slide ${o+1} of ${a}`),e.setAttribute("aria-hidden",(o!==t).toString())})};handleNext=e=>{if(!e||!e.grid)return void console.log("handleNext: no object or grid");const t=e.grid,a=t.scrollWidth-t.offsetWidth,o=e.items[0];if(!o)return;const r=o.offsetWidth+e.columnGap;if(t.scrollLeft<a){const e=t.scrollLeft+r;this.smoothScrollTo(t,e)}};handlePrev=e=>{if(!e||!e.grid)return void console.log("handlePrev: no object or grid");const t=e.grid,a=e.items[0];if(!a)return;const o=a.offsetWidth+e.columnGap;if(t.scrollLeft>0){const e=t.scrollLeft-o;this.smoothScrollTo(t,e)}};smoothScrollTo=(e,t)=>{const a=e.style.scrollSnapType;e.style.scrollSnapType="none";try{e.scrollTo({left:t,behavior:"smooth"})}catch(a){e.scrollLeft=t}setTimeout(()=>{e.style.scrollSnapType=a||"x mandatory"},500)};setupTouchEvents=(e,t)=>{let a,o,r;e.addEventListener("touchstart",t=>{a=t.touches[0].clientX,o=t.touches[0].clientY,r=e.scrollLeft},{passive:!0}),e.addEventListener("touchmove",s=>{if(!a||!o)return;const i=s.touches[0].clientX,l=s.touches[0].clientY,n=a-i,c=Math.abs(o-l);Math.abs(n)>c&&(s.preventDefault(),e.scrollLeft=r+n,this.handleScroll(t))},{passive:!1}),e.addEventListener("touchend",()=>{a=null,o=null,this.snapToClosestSlide(e)})};snapToClosestSlide=e=>{if(!e.children[0])return;const t=e.children[0].offsetWidth,a=e.scrollLeft,o=Math.round(a/t);e.style.scrollBehavior="smooth",e.scrollTo({left:o*t})};getCurrentSlideIndex=e=>{if(!e.items[0])return 0;const t=e.grid.scrollLeft,a=e.items[0].offsetWidth;return Math.round(t/a)};init=()=>{document.querySelectorAll(this.options.wrapper).forEach((e,t)=>{this.wrappers[t]=new this.Wrapper(e,t,this.options);const a=this.wrappers[t];if(!a.grid)return;a.handleScroll=()=>this.handleScroll(a),a.handleResize=()=>{a.pagination&&this.initializePagination(a)},a.grid.addEventListener("scroll",a.handleScroll,{passive:!0}),this.setupTouchEvents(a.grid,a),this.setupTrackDrag(a),a.pagination&&(this.initializePagination(a),window.addEventListener("resize",a.handleResize));const o=e.querySelector('[data-direction="prev"]'),r=e.querySelector('[data-direction="next"]');o&&o.addEventListener("click",e=>{e.preventDefault(),this.handlePrev(a)}),r&&r.addEventListener("click",e=>{e.preventDefault(),this.handleNext(a)}),this.handleScroll(a),this.setupAutoplay(a)})};destroy=()=>{Object.values(this.wrappers).forEach(e=>{this.observer&&this.observer.disconnect(),this.stopAutoplay(e),e.grid&&e.grid.removeEventListener("scroll",e.handleScroll),e.pagination&&e.pagination.querySelectorAll(".brag-book-gallery-pagination-dot").forEach(e=>{e.clickHandler&&e.removeEventListener("click",e.clickHandler)}),e.handleResize&&window.removeEventListener("resize",e.handleResize)}),this.wrappers={}}};function d(){document.querySelectorAll(".brag-book-gallery-active-filters").forEach(e=>{e.querySelectorAll(".brag-book-gallery-filter-badge").forEach(e=>{const t=e.hasAttribute("data-filter-key"),a=e.querySelector('button[onclick*="clearProcedureFilter"]'),o=e.querySelector("span")&&!e.querySelector("[data-filter-type]");(t||a||o)&&e.remove()}),0===e.querySelectorAll(".brag-book-gallery-filter-badge").length&&(e.style.display="none")}),document.querySelectorAll(".brag-book-gallery-clear-all-filters").forEach(e=>{0===document.querySelectorAll('.brag-book-gallery-filter-option input[type="checkbox"]:checked').length&&(e.style.display="none")})}async function g(e){try{const t=new FormData;t.append("action","brag_book_gallery_load_filtered_cases"),t.append("case_ids",e.join(",")),t.append("nonce","undefined"!=typeof bragBookAjax?bragBookAjax.nonce:"");const a=await fetch("undefined"!=typeof ajaxurl?ajaxurl:"/wp-admin/admin-ajax.php",{method:"POST",body:t}),o=await a.json();return o.success&&o.data?{success:!0,html:o.data.html||"",casesFound:o.data.casesFound||0,totalCount:o.data.totalCount||e.length}:{success:!1,error:o.data?.message||"Failed to load filtered cases"}}catch(e){return console.error("AJAX error loading filtered cases:",e),{success:!1,error:e.message}}}function u(e,t,a,o,r,s,i){const l=window.bragBookGalleryConfig?.nonce||"",n=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",c=document.querySelector(".brag-book-gallery-nav-link.brag-book-gallery-active"),d=c?.dataset.procedureId||"",g=c?.dataset.termId||"",u=new FormData;u.append("action","brag_book_gallery_load_more_cases"),u.append("nonce",l),u.append("start_page",t),u.append("procedure_ids",a),u.append("procedure_name",o),u.append("has_nudity",r?"1":"0"),u.append("loaded_ids",s.join(",")),u.append("current_procedure_id",d),u.append("current_term_id",g),fetch(n,{method:"POST",body:u}).then(e=>e.json()).then(a=>{a.success?p(a,e,i,t):(console.error("Failed to load more cases:",a.data?a.data.message:"Unknown error"),e.disabled=!1,e.textContent=i,alert("Failed to load more cases. Please try again."))}).catch(t=>{console.error("AJAX fallback error loading more cases:",t),e.disabled=!1,e.textContent=i,alert("Error loading more cases. Please check your connection and try again.")})}function h(){const e=document.querySelector(".brag-book-gallery-wrapper");if(e){const t=e.getBoundingClientRect().top+window.pageYOffset-20;window.scrollTo({top:t,behavior:"smooth"})}}function p(e,t,a,o){const r=e.data||e;let s=document.querySelector(".brag-book-gallery-case-grid.masonry-layout");if(s||(s=document.querySelector(".brag-book-gallery-cases-grid")),s||(s=document.querySelector(".brag-book-gallery-case-grid")),s||(s=document.querySelector(".brag-book-gallery-cases-container")),s||(s=document.querySelector(".brag-book-gallery-cases-container .brag-book-gallery-cases-grid")),s||(s=document.querySelector(".brag-book-gallery-grid")),s)if(r.html){const e=s.querySelector(".brag-book-gallery-case-card:last-child");e?e.insertAdjacentHTML("afterend",r.html):s.insertAdjacentHTML("beforeend",r.html),h()}else console.error("No HTML received from server");else console.error("Container not found - tried .brag-book-gallery-case-grid.masonry-layout, .brag-book-gallery-cases-grid, .brag-book-gallery-case-grid, .brag-book-gallery-cases-container, and .brag-book-gallery-grid");const i=r.casesLoaded||0;if(r.hasMore&&i>0)t.setAttribute("data-start-page",parseInt(o)+1),t.disabled=!1,t.textContent=a;else{const e=t.closest(".brag-book-gallery-load-more-container")||t.parentElement;e&&(e.style.display="none")}if(s){const e=document.querySelector(".brag-book-gallery-favorite-count-label")||document.querySelector(".cases-count")||document.querySelector('[class*="count-label"]');if(e){const t=s.querySelectorAll(".brag-book-gallery-case-card").length,a=e.textContent.match(/(\d+) of (\d+)/);if(a){const o=a[2];e.textContent="Showing "+t+" of "+o}}}i>0&&setTimeout(()=>{regenerateProcedureFilters()},100)}function b(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}let y,m;window.storeProcedureReferrer=function(e,t,a,o,r,s,i){if(!e)return;const l={slug:e,name:t||e,url:a||window.location.href,"case-id":s||null,"case-wp-id":i||null,"procedure-id":o||null,"term-id":r||null,timestamp:Date.now()};localStorage.setItem("brag-book-gallery-procedure-referrer",JSON.stringify(l))},window.getProcedureReferrer=function(){try{const e=localStorage.getItem("brag-book-gallery-procedure-referrer");if(!e)return null;const t=JSON.parse(e),a=36e5;return Date.now()-t.timestamp>a?(localStorage.removeItem("brag-book-gallery-procedure-referrer"),null):t}catch(e){return console.error("Error reading procedure referrer:",e),null}},window.clearProcedureReferrer=function(){localStorage.removeItem("brag-book-gallery-procedure-referrer")},window.updateNavigationFromReferrer=function(){const e=getProcedureReferrer();if(!e)return;const t=document.querySelector('.brag-book-gallery-back-link, .brag-book-gallery-back-button, a[href*="/gallery/"][class*="back"]');t&&e.url&&(t.href=e.url),function(e,t){if(!e)return void console.warn("updateAdjacentPostLinks: No procedure slug provided");const a=document.querySelector('.brag-book-gallery-nav-button--next, .brag-book-gallery-next-post, .nav-next a, a[rel="next"]'),o=document.querySelector('.brag-book-gallery-nav-button--prev, .brag-book-gallery-prev-post, .nav-previous a, a[rel="prev"]'),r=function(){const e=document.body.className.match(/postid-(\d+)/);if(e)return parseInt(e[1]);const t=document.querySelector("[data-post-id]");return t?parseInt(t.dataset.postId):window.bragBookGalleryConfig?.postId?parseInt(window.bragBookGalleryConfig.postId):null}();r?function(e,t,a,o){const r=new FormData;r.append("action","brag_book_get_adjacent_cases"),r.append("procedure_slug",e),t&&r.append("term_id",t),r.append("post_id",a);const s=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php";fetch(s,{method:"POST",body:r,credentials:"same-origin"}).then(e=>e.json()).then(e=>{e.success&&e.data?o(e.data):(console.error("Failed to fetch adjacent cases:",e),console.error("Error details:",e.data||e),o({next:null,prev:null}))}).catch(e=>{console.error("Error fetching adjacent cases:",e),o({next:null,prev:null})})}(e,t,r,e=>{e.next&&a&&(a.href=e.next,a.style.display=""),e.prev&&o&&(o.href=e.prev,o.style.display="")}):console.error("updateAdjacentPostLinks: Could not find current post ID")}(e.slug,e.termId)},window.updateGridLayout=function(e){const t=document.querySelector(".brag-book-gallery-case-grid");t&&window.innerWidth>=1024&&(t.classList.add("grid-initialized"),t.setAttribute("data-columns",e),document.querySelectorAll(".brag-book-gallery-grid-btn").forEach(t=>{parseInt(t.dataset.columns)===e?t.classList.add("active"):t.classList.remove("active")}),localStorage.setItem("brag-book-gallery-grid-columns",e))},window.bragBookProcedureFilters={age:[],gender:[],ethnicity:[],height:[],weight:[]},window.initializeProcedureFilters=function(){const e=document.getElementById("procedure-filters-details");e&&(d(),generateProcedureFilterOptions(),e.dataset.initialized="true")},window.regenerateProcedureFilters=function(){const e=document.getElementById("procedure-filters-details");e&&(e.dataset.initialized="false",window.bragBookProcedureFilters={age:[],gender:[],ethnicity:[],height:[],weight:[]},function(){const e=document.querySelector(".brag-book-gallery-active-filters");e&&(e.querySelectorAll(".brag-book-gallery-filter-badges").forEach(e=>{e.innerHTML=""}),e.style.display="none",e.querySelectorAll(".brag-book-gallery-filter-badge").forEach(e=>e.remove()))}(),initializeProcedureFilters())},window.generateProcedureFilterOptions=function(){const e=document.getElementById("brag-book-gallery-filters")||document.querySelector(".brag-book-gallery-filter-content")||document.querySelector(".brag-book-gallery-filters");if(!e)return;const t=document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]'),a={age:new Set,gender:new Set,ethnicity:new Set,height:new Set,weight:new Set,procedureDetails:new Map},o=[],r=[],s=[];t.forEach(e=>{const t=e.dataset.age;t&&o.push(parseInt(t)),e.dataset.gender&&a.gender.add(e.dataset.gender),e.dataset.ethnicity&&a.ethnicity.add(e.dataset.ethnicity);const i=e.dataset.height;if(i){const t=parseInt(i);"cm"===(e.dataset.heightUnit||"in")?r.push(Math.round(t/2.54)):r.push(t)}const l=e.dataset.weight;if(l){const t=parseInt(l);"kg"===(e.dataset.weightUnit||"lbs")?s.push(Math.round(2.205*t)):s.push(t)}Object.keys(e.dataset).forEach(t=>{if(t.startsWith("procedureDetail")){const o=t.replace("procedureDetail","").replace(/([A-Z])/g," $1").trim(),r=e.dataset[t];r&&r.split(",").map(e=>e.trim()).filter(e=>e).forEach(e=>{a.procedureDetails.has(o)||a.procedureDetails.set(o,new Set);const t=e.split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ");a.procedureDetails.get(o).add(t)})}})}),o.some(e=>e>=18&&e<25)&&a.age.add("18-24"),o.some(e=>e>=25&&e<35)&&a.age.add("25-34"),o.some(e=>e>=35&&e<45)&&a.age.add("35-44"),o.some(e=>e>=45&&e<55)&&a.age.add("45-54"),o.some(e=>e>=55&&e<65)&&a.age.add("55-64"),o.some(e=>e>=65)&&a.age.add("65+"),r.some(e=>e<60)&&a.height.add("Under 5'0\""),r.some(e=>e>=60&&e<64)&&a.height.add("5'0\" - 5'3\""),r.some(e=>e>=64&&e<68)&&a.height.add("5'4\" - 5'7\""),r.some(e=>e>=68&&e<72)&&a.height.add("5'8\" - 5'11\""),r.some(e=>e>=72)&&a.height.add("6'0\" and above"),s.some(e=>e<120)&&a.weight.add("Under 120 lbs"),s.some(e=>e>=120&&e<150)&&a.weight.add("120-149 lbs"),s.some(e=>e>=150&&e<180)&&a.weight.add("150-179 lbs"),s.some(e=>e>=180&&e<210)&&a.weight.add("180-209 lbs"),s.some(e=>e>=210)&&a.weight.add("210+ lbs"),generateFilterHTML(e,a)},window.generateFilterHTML=function(e,t){const a=e=>e?String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):"";let o="";t.age.size>0&&(o+='<details class="brag-book-gallery-filter">',o+='<summary class="brag-book-gallery-filter-label">',o+='<span class="brag-book-gallery-filter-label__name">Age</span>',o+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="</summary>",o+='<ul class="brag-book-gallery-filter-options">',Array.from(t.age).sort().forEach(e=>{const t=`procedure-filter-age-${e.replace(/\s+/g,"-")}`;o+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${a(e)}" data-filter-type="age">\n\t\t\t\t<label for="${t}">${a(e)}</label>\n\t\t\t</li>`}),o+="</ul>",o+="</details>"),t.gender.size>0&&(o+='<details class="brag-book-gallery-filter">',o+='<summary class="brag-book-gallery-filter-label">',o+='<span class="brag-book-gallery-filter-label__name">Gender</span>',o+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="</summary>",o+='<ul class="brag-book-gallery-filter-options">',Array.from(t.gender).sort().forEach(e=>{const t=`procedure-filter-gender-${e}`,r=e.charAt(0).toUpperCase()+e.slice(1);o+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${a(e)}" data-filter-type="gender">\n\t\t\t\t<label for="${t}">${a(r)}</label>\n\t\t\t</li>`}),o+="</ul>",o+="</details>"),t.ethnicity.size>0&&(o+='<details class="brag-book-gallery-filter">',o+='<summary class="brag-book-gallery-filter-label">',o+='<span class="brag-book-gallery-filter-label__name">Ethnicity</span>',o+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="</summary>",o+='<ul class="brag-book-gallery-filter-options">',Array.from(t.ethnicity).sort().forEach(e=>{const t=`procedure-filter-ethnicity-${e.replace(/\s+/g,"-")}`,r=e.charAt(0).toUpperCase()+e.slice(1);o+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${a(e)}" data-filter-type="ethnicity">\n\t\t\t\t<label for="${t}">${a(r)}</label>\n\t\t\t</li>`}),o+="</ul>",o+="</details>"),t.height.size>0&&(o+='<details class="brag-book-gallery-filter">',o+='<summary class="brag-book-gallery-filter-label">',o+='<span class="brag-book-gallery-filter-label__name">Height</span>',o+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="</summary>",o+='<ul class="brag-book-gallery-filter-options">',Array.from(t.height).sort().forEach(e=>{const t=`procedure-filter-height-${e.replace(/\s+/g,"-")}`;o+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${a(e)}" data-filter-type="height">\n\t\t\t\t<label for="${t}">${a(e)}</label>\n\t\t\t</li>`}),o+="</ul>",o+="</details>"),t.weight.size>0&&(o+='<details class="brag-book-gallery-filter">',o+='<summary class="brag-book-gallery-filter-label">',o+='<span class="brag-book-gallery-filter-label__name">Weight</span>',o+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="</summary>",o+='<ul class="brag-book-gallery-filter-options">',Array.from(t.weight).sort().forEach(e=>{const t=`procedure-filter-weight-${e.replace(/\s+/g,"-")}`;o+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${a(e)}" data-filter-type="weight">\n\t\t\t\t<label for="${t}">${a(e)}</label>\n\t\t\t</li>`}),o+="</ul>",o+="</details>"),t.procedureDetails&&t.procedureDetails.size>0&&t.procedureDetails.forEach((e,t)=>{if(e.size>0){const r="procedure_detail_"+t.toLowerCase().replace(/\s+/g,"_");o+='<details class="brag-book-gallery-filter">',o+='<summary class="brag-book-gallery-filter-label">',o+=`<span class="brag-book-gallery-filter-label__name">${a(t)}</span>`,o+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="</summary>",o+='<ul class="brag-book-gallery-filter-options">',Array.from(e).sort().forEach(e=>{const t=`procedure-filter-${r}-${e.replace(/\s+/g,"-").toLowerCase()}`,s=e.toLowerCase();o+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t\t\t<input type="checkbox" id="${t}" value="${a(s)}" data-filter-type="${a(r)}">\n\t\t\t\t\t\t<label for="${t}">${a(e)}</label>\n\t\t\t\t\t</li>`}),o+="</ul>",o+="</details>"}}),e.innerHTML=o||"<p>No filters available</p>",e.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.addEventListener("change",function(){try{"function"==typeof window.applyProcedureFilters?window.applyProcedureFilters():console.error("window.applyProcedureFilters function not found, typeof:",typeof window.applyProcedureFilters)}catch(e){console.error("Error calling applyProcedureFilters:",e)}})});const r=document.getElementById("procedure-filters-details");if(r){const e=o&&"<p>No filters available</p>"!==o;r.style.display=e?"":"none"}},window.applyProcedureFilters=function(){const e=document.querySelectorAll(".brag-book-gallery-filter-option input:checked");window.bragBookProcedureFilters={age:[],gender:[],ethnicity:[],height:[],weight:[],procedureDetails:{}},e.forEach(e=>{const t=e.dataset.filterType,a=e.value;if(t.startsWith("procedure_detail_")){const e=t.replace("procedure_detail_","");window.bragBookProcedureFilters.procedureDetails[e]||(window.bragBookProcedureFilters.procedureDetails[e]=[]),window.bragBookProcedureFilters.procedureDetails[e].push(a)}else window.bragBookProcedureFilters[t]&&window.bragBookProcedureFilters[t].push(a)});const t=Object.keys(window.bragBookProcedureFilters).some(e=>"procedureDetails"===e?Object.keys(window.bragBookProcedureFilters.procedureDetails).length>0:window.bragBookProcedureFilters[e].length>0);!function(){const e=document.querySelector(".brag-book-gallery-filter-badges");e&&e.remove();const t=document.querySelector(".brag-book-gallery-controls-left"),a=t?t.querySelector(".brag-book-gallery-clear-all-filters"):null;let o=t?t.querySelector(".brag-book-gallery-active-filters"):null;o||(o=document.createElement("div"),o.className="brag-book-gallery-active-filters",a&&t?t.insertBefore(o,a):t&&t.appendChild(o)),o.innerHTML="";const r=document.querySelectorAll('.brag-book-gallery-filter-option input[type="checkbox"]:checked');if(0===r.length){o.style.display="none";const e=document.querySelector(".brag-book-gallery-clear-all-filters");return void(e&&e.remove())}if(o.style.display="flex",r.forEach(e=>{const t=e.dataset.filterType,a=e.value,r=e.parentNode.querySelector("label"),s=r?r.textContent.trim():a,i=document.createElement("div");let l;i.className="brag-book-gallery-filter-badge",i.setAttribute("data-filter-key",`${t}:${a}`),i.setAttribute("data-filter-type",t),i.setAttribute("data-filter-value",a),l=t.startsWith("procedure_detail_")?t.replace("procedure_detail_","").split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "):t.charAt(0).toUpperCase()+t.slice(1),i.innerHTML=`\n\t\t\t<span class="brag-book-gallery-badge-text">${l}: ${b(s)}</span>\n\t\t\t<button class="brag-book-gallery-badge-remove" aria-label="Remove ${l}: ${b(s)} filter">\n\t\t\t\t<svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">\n\t\t\t\t\t<path d="M13 1L1 13M1 1l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>\n\t\t\t\t</svg>\n\t\t\t</button>\n\t\t`,o.appendChild(i)}),r.length>0){const e=document.querySelector(".brag-book-gallery-clear-all-filters");e&&e.remove();const t=document.createElement("button");t.className="brag-book-gallery-clear-all-filters",t.setAttribute("data-action","clear-filters"),t.textContent="Clear All",t.onclick=function(e){e.preventDefault();try{if("function"==typeof window.clearProcedureFilters)return void window.clearProcedureFilters();if("function"==typeof clearProcedureFilters)return void clearProcedureFilters();document.querySelectorAll('.brag-book-gallery-filter-option input[type="checkbox"]').forEach(e=>{e.checked=!1}),document.querySelectorAll(".brag-book-gallery-case-card").forEach(e=>{e.style.display=""});const e=document.querySelector(".brag-book-gallery-active-filters");e&&(e.style.display="none",e.innerHTML="");const t=document.querySelector(".brag-book-gallery-filter-dropdown__toggle");t&&t.classList.remove("has-active-filters")}catch(e){console.error("Error in Clear All button:",e)}},o.parentNode&&o.parentNode.insertBefore(t,o.nextSibling)}else{const e=document.querySelector(".brag-book-gallery-clear-all-filters");e&&e.remove()}}();let a=document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]');if(0===a.length&&(a=document.querySelectorAll(".brag-book-gallery-case-grid .brag-book-gallery-case-card")),0===a.length&&(a=document.querySelectorAll(".brag-book-gallery-case-card")),a.length>0&&a[0],!t){a.forEach(e=>{e.style.display=""});const e=document.querySelector('button[onclick*="loadMoreCases"]')||document.querySelector(".brag-book-gallery-load-more button"),t=e?e.closest(".brag-book-gallery-load-more-container")||e.parentElement:null;return void(t&&e.hasAttribute("data-start-page")&&(t.style.display=""))}a.forEach((e,t)=>{let a=!0;if(e.dataset.caseId,window.bragBookProcedureFilters.age.length>0){const t=parseInt(e.dataset.age);let o=!1;window.bragBookProcedureFilters.age.forEach(e=>{("18-24"===e&&t>=18&&t<25||"25-34"===e&&t>=25&&t<35||"35-44"===e&&t>=35&&t<45||"45-54"===e&&t>=45&&t<55||"55-64"===e&&t>=55&&t<65||"65+"===e&&t>=65)&&(o=!0)}),o||(a=!1)}if(a&&window.bragBookProcedureFilters.gender.length>0){const t=(e.dataset.gender||"").toLowerCase();window.bragBookProcedureFilters.gender.map(e=>e.toLowerCase()).includes(t)||(a=!1)}if(a&&window.bragBookProcedureFilters.ethnicity.length>0){const t=(e.dataset.ethnicity||"").toLowerCase();window.bragBookProcedureFilters.ethnicity.map(e=>e.toLowerCase()).includes(t)||(a=!1)}if(a&&window.bragBookProcedureFilters.height.length>0){const t=parseInt(e.dataset.height);let o=!1;window.bragBookProcedureFilters.height.forEach(e=>{("Under 5'0\""===e&&t<60||"5'0\" - 5'3\""===e&&t>=60&&t<64||"5'4\" - 5'7\""===e&&t>=64&&t<68||"5'8\" - 5'11\""===e&&t>=68&&t<72||"6'0\" and above"===e&&t>=72)&&(o=!0)}),o||(a=!1)}if(a&&window.bragBookProcedureFilters.weight.length>0){const t=parseInt(e.dataset.weight);let o=!1;window.bragBookProcedureFilters.weight.forEach(e=>{("Under 120 lbs"===e&&t<120||"120-149 lbs"===e&&t>=120&&t<150||"150-179 lbs"===e&&t>=150&&t<180||"180-209 lbs"===e&&t>=180&&t<210||"210+ lbs"===e&&t>=210)&&(o=!0)}),o||(a=!1)}if(a&&Object.keys(window.bragBookProcedureFilters.procedureDetails).length>0)for(const t in window.bragBookProcedureFilters.procedureDetails){const o=window.bragBookProcedureFilters.procedureDetails[t];if(o.length>0){const r="procedureDetail"+t.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(""),s=(e.dataset[r]||"").toLowerCase();let i=!1;if(s){const e=s.split(",").map(e=>e.trim());o.forEach(t=>{e.includes(t.toLowerCase())&&(i=!0)})}if(!i){a=!1;break}}}e.style.display=a?"":"none"});const o=document.getElementById("procedure-filters-details");if(o){o.open=!1;const e=o.querySelector(".brag-book-gallery-filter-dropdown__toggle");e&&(t?e.classList.add("has-active-filters"):e.classList.remove("has-active-filters"))}const r=document.querySelector('button[onclick*="loadMoreCases"]')||document.querySelector(".brag-book-gallery-load-more button"),s=r?r.closest(".brag-book-gallery-load-more-container")||r.parentElement:null;s&&(s.style.display=t?"none":"")},window.loadFilteredCases=function(e){const t=document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]');t.forEach(e=>{e.style.display="none"});let a=0,o=[];if(e.forEach(e=>{const t=document.querySelector(`.brag-book-gallery-case-card[data-case-id="${e}"]`);t?(t.style.display="",a++):o.push(e)}),o.length>0){const e=document.querySelector(".brag-book-gallery-case-grid")||document.querySelector(".brag-book-gallery-case-grid");if(e){const t=document.createElement("div");t.className="filter-loading-message",t.textContent=`Loading ${o.length} additional matching cases...`,t.style.cssText="padding: 20px; text-align: center; font-style: italic;",e.appendChild(t),async function(e){try{let t=[],a=[];window.bragBookCompleteDataset&&Array.isArray(window.bragBookCompleteDataset)?e.forEach(e=>{const o=window.bragBookCompleteDataset.find(t=>String(t.id)===String(e));o?t.push(o):a.push(e)}):a=[...e];let o="";if(t.length>0&&t.forEach(e=>{o+=function(e){const t=e.id||"";let a="";if(e.photoSets&&Array.isArray(e.photoSets)&&e.photoSets.length>0){const t=e.photoSets[0];a=t.postProcessedImageLocation||t.beforeLocationUrl||t.afterLocationUrl1||""}let o="Unknown Procedure";e.procedures&&Array.isArray(e.procedures)&&e.procedures.length>0&&(o=e.procedures[0].name||o);let r=`<article class="brag-book-gallery-case-card" data-case-id="${b(String(t))}" data-card="true">`;r+=`<div class="brag-book-gallery-case-image-container" onclick="loadCaseDetails('${t}')">`,a&&(r+=`<img src="${b(a)}" alt="${b(o)} case" loading="lazy">`);const s=document.querySelector(".brag-book-gallery-nav-link.brag-book-gallery-active");return s&&"true"===s.dataset.nudity&&(r+='<div class="brag-book-gallery-nudity-overlay">',r+='<div class="brag-book-gallery-nudity-warning">',r+='<div class="brag-book-gallery-nudity-warning-content">',r+='<h4 class="brag-book-gallery-nudity-warning-title">Nudity Warning</h4>',r+='<p class="brag-book-gallery-nudity-warning-caption">Click to proceed if you wish to view.</p>',r+='<button class="brag-book-gallery-nudity-warning-button" type="button">Proceed</button>',r+="</div>",r+="</div>",r+="</div>"),r+='<div class="brag-book-gallery-case-overlay">',r+='<span class="brag-book-gallery-case-view-text">View Case</span>',r+="</div>",r+="</div>",r+='<div class="brag-book-gallery-case-info">',r+=`<h3>${b(o)}</h3>`,r+="</div>",r+="</article>",r}(e)}),a.length>0)try{const e=await g(a);e.success&&e.html&&(o+=e.html)}catch(e){console.warn("AJAX fallback failed for filtered cases:",e)}return{success:o.length>0,html:o,casesFound:t.length+(a.length>0?1:0),fromCache:t.length,fromAjax:a.length}}catch(t){return console.error("Error in optimized filtered cases loading:",t),await g(e)}}(o).then(t=>{const o=e.querySelector(".filter-loading-message");if(o&&o.remove(),t.success&&t.html){const o=document.createElement("div");o.innerHTML=t.html,o.querySelectorAll(".brag-book-gallery-case-card").forEach(t=>{e.appendChild(t),a++}),updateFilteredCount(a,window.bragBookCompleteDataset.length)}else updateFilteredCount(a,window.bragBookCompleteDataset.length)}).catch(t=>{console.error("Error loading filtered cases:",t);const o=e.querySelector(".filter-loading-message");o&&(o.textContent="Failed to load additional cases. Showing only currently loaded matches.",setTimeout(()=>o.remove(),3e3)),updateFilteredCount(a,window.bragBookCompleteDataset.length)})}}else updateFilteredCount(a,window.bragBookCompleteDataset?window.bragBookCompleteDataset.length:t.length);const r=document.querySelector('button[onclick*="loadMoreCases"]')||document.querySelector(".brag-book-gallery-load-more button"),s=r?r.closest(".brag-book-gallery-load-more-container")||r.parentElement:null;s&&(s.style.display="none")},window.updateFilteredCount=function(e,t){const a=document.querySelector(".brag-book-gallery-favorite-count-label")||document.querySelector(".cases-count");a&&(a.textContent=`Showing ${e} of ${t}`)},window.clearProcedureFilters=function(){document.querySelectorAll('.brag-book-gallery-filter-option input[type="checkbox"]').forEach(e=>{e.checked=!1}),window.bragBookProcedureFilters&&(window.bragBookProcedureFilters.age=[],window.bragBookProcedureFilters.gender=[],window.bragBookProcedureFilters.ethnicity=[],window.bragBookProcedureFilters.height=[],window.bragBookProcedureFilters.weight=[],window.bragBookProcedureFilters.procedureDetails={}),document.querySelectorAll(".brag-book-gallery-case-card").forEach(e=>{e.style.display="",e.style.visibility=""});const e=document.querySelector(".brag-book-gallery-wrapper");e&&e.classList.contains("has-active-filters")&&e.classList.remove("has-active-filters");const t=document.querySelector(".brag-book-gallery-active-filters");t&&(t.style.display="none",t.innerHTML="");const a=document.querySelector('button[onclick*="loadMoreCases"]')||document.querySelector(".brag-book-gallery-load-more button");if(a){const e=a.closest(".brag-book-gallery-load-more-container")||a.parentElement;e&&(e.style.display="")}const o=document.querySelector(".brag-book-gallery-clear-all-filters");o&&(o.style.display="none");const r=document.getElementById("procedure-filters-details");if(r){r.open=!1;const e=r.querySelector("summary");e&&e.classList.contains("has-active-filters")&&e.classList.remove("has-active-filters")}},window.syncImageHeights=function(e){e.style.opacity="1";const t=e.closest(".brag-book-gallery-image-container");if(t){const e=t.querySelector(".brag-book-gallery-skeleton-loader");e&&(e.style.display="none")}const a=e.closest(".brag-book-gallery-case-images");if(!a)return;const o=a.querySelectorAll("img");let r=!0;if(o.forEach(e=>{e.complete&&e.naturalHeight||(r=!1)}),!r)return;let s=0;o.forEach(e=>{const t=e.naturalHeight/e.naturalWidth;t>s&&(s=t)}),a.querySelectorAll(".brag-book-gallery-image-container").forEach(e=>{e.style.paddingBottom=100*s+"%"})},window.loadCaseDetails=function(e,t,a,o){window.loadCaseDetailsWithName(e,t,a,"",o)},window.loadCaseDetailsWithName=function(e,t,a,o,r){const s=document.getElementById("gallery-content");if(!s)return void console.error("Gallery content container not found");if(!r){const t=document.querySelector(`.brag-book-gallery-case-card[data-case-id="${e}"]`);t&&t.dataset.procedureIds&&(r=t.dataset.procedureIds)}if(s.innerHTML='<div class="brag-book-gallery-loading">Loading case details...</div>',a&&window.history&&window.history.pushState){const o=document.querySelector(".brag-book-gallery-wrapper");let r=o?.dataset.baseUrl||window.location.pathname;if(r=r.replace(/\/[^\/]+\/\d+\/?$/,""),r=r.replace(/\/[^\/]+\/?$/,""),r=r.replace(/\/$/,""),!r||""===r){const e=window.location.pathname.split("/").filter(e=>e);r=e.length>0?"/"+e[0]:""}const s=`${r}/${a}/${e}`;window.history.pushState({caseId:e,procedureId:t,procedureSlug:a},"",s)}const i={action:"brag_book_gallery_load_case_details",case_id:e,nonce:bragBookGalleryConfig.nonce};t&&(i.procedure_id=t),a&&(i.procedure_slug=a),o&&(i.procedure_name=o),r&&(i.procedure_ids=r),fetch(bragBookGalleryConfig.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(i)}).then(e=>e.json()).then(e=>{if(e.success){s.innerHTML=e.data.html;const t=document.querySelector(".brag-book-gallery-wrapper");t?t.scrollIntoView({behavior:"smooth",block:"start"}):s.scrollIntoView({behavior:"smooth",block:"start"})}else{let t="Unknown error";e.data&&(t="string"==typeof e.data?e.data:e.data.message?e.data.message:JSON.stringify(e.data)),s.innerHTML='<div class="brag-book-gallery-error">Failed to load case details: '+t+"</div>"}}).catch(e=>{console.error("Error loading case details:",e),s.innerHTML='<div class="brag-book-gallery-error">Error loading case details. Please try again.</div>'})},window.loadMoreCases=function(e){e.disabled=!0;const t=e.textContent;e.textContent="Loading...";const a=e.getAttribute("data-start-page"),o=e.getAttribute("data-procedure-ids"),r=e.getAttribute("data-procedure-name")||"";let s=!1;const i=document.querySelector(".brag-book-gallery-nav-link.brag-book-gallery-active");i&&"true"===i.dataset.nudity&&(s=!0);const l=document.querySelectorAll("[data-case-id]"),n=Array.from(l).map(e=>e.getAttribute("data-case-id")).filter(Boolean);(async function(e,t,a,o,r){try{const o=window.bragBookGalleryConfig?.apiToken||"",s=window.bragBookGalleryConfig?.websitePropertyId||"",i=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",l=window.bragBookGalleryConfig?.nonce||"";if(!(o&&s&&i&&l))return{success:!1,error:"Missing API configuration"};const n={apiTokens:[o],websitePropertyIds:[parseInt(s)],count:parseInt(e)};if(t){const e=t.split(",").map(e=>parseInt(e)).filter(e=>!isNaN(e));e.length>0&&(n.procedureIds=e)}const c=new FormData;c.append("action","brag_book_api_proxy"),c.append("nonce",l),c.append("endpoint","/api/plugin/combine/cases"),c.append("method","POST"),c.append("body",JSON.stringify(n)),c.append("timeout","8");const d=new AbortController,g=setTimeout(()=>d.abort(),1e4),u=await fetch(i,{method:"POST",body:c,signal:d.signal});if(clearTimeout(g),!u.ok)throw new Error(`HTTP error! status: ${u.status}`);const h=await u.json();if(!h.success||!h.data||!h.data.data)throw new Error(h.data?.message||"API proxy request failed");const p=h.data.data;if(!p||!p.data||!Array.isArray(p.data))return{success:!1,error:"Invalid API response"};const y=[];p.data.forEach(e=>{const t=e.id?String(e.id):"";t&&!r.includes(t)&&y.push(e)});let m=!1;const f=10;if(p.data.length>=f){const t={...n,count:parseInt(e)+1};try{const e=new FormData;e.append("action","brag_book_api_proxy"),e.append("nonce",l),e.append("endpoint","/api/plugin/combine/cases"),e.append("method","POST"),e.append("body",JSON.stringify(t)),e.append("timeout","5");const a=await fetch(i,{method:"POST",body:e,signal:AbortSignal.timeout(5e3)});if(a.ok){const e=await a.json();e.success&&e.data&&e.data.data&&e.data.data.data&&Array.isArray(e.data.data.data)&&e.data.data.data.length>0&&(m=!0)}}catch(e){m=p.data.length>=f}}const v=function(e,t){let a="";return e.forEach(e=>{const o={...e};if(o.mainImageUrl="",e.photoSets&&Array.isArray(e.photoSets)&&e.photoSets.length>0){const t=e.photoSets[0];o.mainImageUrl=t.postProcessedImageLocation||t.beforeLocationUrl||t.afterLocationUrl1||""}o.procedureTitle=t||"Unknown Procedure",e.procedures&&Array.isArray(e.procedures)&&e.procedures.length>0&&(o.procedureTitle=e.procedures[0].name||o.procedureTitle),a+=function(e){const t=e.id||"",a=e.procedureTitle||"Unknown Procedure";let o='data-card="true"';e.age&&(o+=` data-age="${b(e.age)}"`),e.gender&&(o+=` data-gender="${b(e.gender.toLowerCase())}"`),e.ethnicity&&(o+=` data-ethnicity="${b(e.ethnicity.toLowerCase())}"`);const r=e.procedureIds?e.procedureIds.join(","):"",s=window.bragBookGalleryConfig?.gallerySlug||"gallery",i=function(){const e=window.location.pathname.split("/").filter(e=>e),t=window.bragBookGalleryConfig?.gallerySlug||"gallery",a=e.indexOf(t.replace(/^\/+/,""));if(a>=0&&a+1<e.length){const t=e[a+1];if(!/^\d+$/.test(t))return t}return null}()||"case",l=`/${s}/${i}/${e.caseDetails&&e.caseDetails[0]&&e.caseDetails[0].seoSuffixUrl||t}/`;let n=`<article class="brag-book-gallery-case-card" ${o} data-case-id="${b(t)}" data-procedure-ids="${b(r)}">`;n+=`<a href="${b(l)}" class="case-link" data-case-id="${b(t)}" data-procedure-ids="${b(r)}">`;const c=window.bragBookGalleryConfig?.imageDisplayMode||"single";if(e.photoSets&&Array.isArray(e.photoSets)&&e.photoSets.length>0){const t=e.photoSets[0];if("before_after"===c)n+='<div class="brag-book-gallery-case-images before-after">',t.beforePhoto&&(n+=`<img src="${b(t.beforePhoto)}" alt="Before" class="before-image" />`),t.afterPhoto&&(n+=`<img src="${b(t.afterPhoto)}" alt="After" class="after-image" />`),n+="</div>";else{const e=t.afterPhoto||t.beforePhoto||"";e&&(n+=`<div class="brag-book-gallery-case-images"><img src="${b(e)}" alt="Case Image" /></div>`)}}const d=document.querySelector(".brag-book-gallery-nav-link.brag-book-gallery-active");d&&"true"===d.dataset.nudity&&(n+='<div class="brag-book-gallery-nudity-warning">',n+='<div class="brag-book-gallery-nudity-warning-content">',n+='<h4 class="brag-book-gallery-nudity-warning-title">Nudity Warning</h4>',n+='<p class="brag-book-gallery-nudity-warning-caption">Click to proceed if you wish to view.</p>',n+='<button class="brag-book-gallery-nudity-warning-button" type="button">Proceed</button>',n+="</div>",n+="</div>");const g=e.caseDetails&&e.caseDetails[0]&&e.caseDetails[0].seoHeadline||a;return g&&(n+=`<h3 class="case-title">${b(g)}</h3>`),n+="</a>",n+="</article>",n}(o)}),a}(y,a);return{success:!0,html:v,casesLoaded:y.length,hasMore:m,nextPage:m?parseInt(e)+1:null}}catch(e){return console.error("Direct API error for load more:",e),{success:!1,error:e.message}}})(a,o,r,0,n).then(i=>{i.success?p(i,e,t,a):u(e,a,o,r,s,n,t)}).catch(i=>{u(e,a,o,r,s,n,t)})},window.clearProcedureFilter=function(){window.location.href=window.location.origin+window.location.pathname.split("/").slice(0,-1).join("/")+"/"},window.removeFilterBadge=function(e,t){const a=document.querySelectorAll(`#brag-book-gallery-filters input[data-filter-type="${e}"]`);let o=null;a.forEach(e=>{e.value===t&&(o=e)}),o&&(o.checked=!1),applyProcedureFilters()},window.bragBookSetImageAspectRatio=function(e){const t=e.naturalWidth,a=e.naturalHeight;if(t&&a){const o=t+"/"+a,r=e.closest(".brag-book-gallery-image-container, .brag-book-gallery-thumb-image");r&&(r.style.aspectRatio=o,r.style.width="100%",r.style.height="auto",r.style.minHeight="auto",r.style.maxHeight="none",e.style.width="100%",e.style.height="100%",e.style.objectFit="contain",r.removeAttribute("data-image-loading"))}},window.initInfiniteScroll=function(){if("yes"!==window.bragBookGalleryConfig?.infiniteScroll)return;let e,t=!1;const a=()=>{clearTimeout(e),e=setTimeout(()=>{if(t)return;const e=document.querySelector('button[onclick*="loadMoreCases"]')||document.querySelector(".brag-book-gallery-load-more button");if(!e||e.disabled||"none"===e.style.display)return;const a=e.closest(".brag-book-gallery-load-more-container");a&&"none"===a.style.display||window.innerHeight+window.scrollY>=document.documentElement.offsetHeight-800&&(t=!0,e.click(),setTimeout(()=>{t=!1},1e3))},100)};window.addEventListener("scroll",a,{passive:!0}),window.addEventListener("resize",a,{passive:!0}),window.infiniteScrollHandler=a},function(){const e=()=>{const e=document.querySelector(".brag-book-gallery-filter-results");e&&(e.style.display="none !important")};e(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e(),new MutationObserver(e=>{e.forEach(e=>{"childList"===e.type&&e.addedNodes.forEach(e=>{1===e.nodeType&&e.classList&&e.classList.contains("brag-book-gallery-filter-results")&&(e.style.display="none !important")})})}).observe(document.body||document.documentElement,{childList:!0,subtree:!0})}(),window.loadMoreCasesFromCache=function(e){e.disabled=!0;const t=e.textContent;e.textContent="Loading...";const a=e.getAttribute("data-start-page")||"2",o=e.getAttribute("data-procedure-ids")||"",r=e.getAttribute("data-procedure-name")||"",s=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",i=window.bragBookGalleryConfig?.nonce||"",l=document.querySelector(".brag-book-gallery-nav-link.brag-book-gallery-active"),n=l?.dataset.procedureId||"",c=l?.dataset.termId||"",d=new FormData;d.append("action","brag_book_gallery_load_more_cases"),d.append("nonce",i),d.append("start_page",a),d.append("procedure_ids",o),d.append("procedure_name",r),d.append("loaded_ids",""),d.append("current_procedure_id",n),d.append("current_term_id",c),fetch(s,{method:"POST",body:d}).then(e=>e.json()).then(o=>{if(o.success&&o.data&&o.data.html){let r=document.querySelector(".brag-book-gallery-case-grid");if(r||(r=document.querySelector(".brag-book-gallery-cases-grid")),r){const s=r.querySelector(".brag-book-gallery-case-card:last-child");s?s.insertAdjacentHTML("afterend",o.data.html):r.insertAdjacentHTML("beforeend",o.data.html),h();const i=parseInt(a)+1;e.setAttribute("data-start-page",i.toString()),!1===o.data.hasMore?e.style.display="none":(e.disabled=!1,e.textContent=t)}}else console.error("Load more failed:",o),e.disabled=!1,e.textContent=t}).catch(a=>{console.error("Load more error:",a),e.disabled=!1,e.textContent=t})},document.addEventListener("DOMContentLoaded",()=>{d();const e=document.querySelector(".brag-book-gallery-filter-badges");e&&e.remove(),new n,y=new i,m=new l,document.querySelectorAll(".brag-book-gallery-carousel-wrapper").length>0&&new c({}),function(){const e=window.location.pathname;if(e.match(/\/\d+\/?$/))return void updateNavigationFromReferrer();const t=(window.bragBookGalleryConfig?.gallerySlug||"gallery").replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=new RegExp(`\\/${t}\\/([^\\/]+)\\/?$`),o=e.match(a);if(!o)return;const r=o[1],s=document.querySelector(".brag-book-gallery-content-title strong"),i=s?s.textContent.trim():r,l=document.querySelector(`[data-procedure-slug="${r}"]`),n=l?.dataset.procedureId||null,c=l?.dataset.termId||null;document.querySelectorAll('.brag-book-gallery-case-permalink, .brag-book-gallery-case-card a[href*="/gallery/"]').forEach(e=>{e.addEventListener("click",t=>{const a=e.closest(".brag-book-gallery-case-card"),o=a?.dataset.currentProcedureId||n,s=a?.dataset.currentTermId||c;storeProcedureReferrer(r,i,window.location.href,o,s)})})}();const t=document.querySelector(".brag-book-gallery-case-grid");if(t){setTimeout(()=>{t.classList.add("grid-initialized")},1e3);const e=t.classList.contains("brag-book-gallery-case-grid--tiles");if(window.innerWidth>=1024&&!e){const e=localStorage.getItem("brag-book-gallery-grid-columns");if(e){const a=parseInt(e);t.setAttribute("data-columns",a),document.querySelectorAll(".brag-book-gallery-grid-btn").forEach(e=>{parseInt(e.dataset.columns)===a?e.classList.add("active"):e.classList.remove("active")})}else t.setAttribute("data-columns","3")}}initInfiniteScroll()}),document.addEventListener("DOMContentLoaded",function(){setTimeout(function(){!window.bragBookCompleteDataset&&window.bragBookGalleryConfig&&window.bragBookGalleryConfig.completeDataset&&(window.bragBookCompleteDataset=window.bragBookGalleryConfig.completeDataset),initializeProcedureFilters();const e=document.querySelector(".brag-book-gallery-wrapper");if(e&&e.dataset.initialCaseId){const t=e.dataset.initialCaseId,a=window.location.pathname.split("/").filter(e=>e),o=a.length>2?a[a.length-2]:"";let r="";const s=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${o}"]`);if(s){const e=s.querySelector(".brag-book-gallery-filter-option-label");e&&(r=e.textContent.trim())}if(!r&&window.bragBookGalleryConfig&&window.bragBookGalleryConfig.sidebarData){const e=window.bragBookGalleryConfig.sidebarData;for(const t of Object.values(e)){if(t.procedures)for(const e of t.procedures)if(e.slug===o){r=e.name;break}if(r)break}}let i="";setTimeout(()=>{const e=document.querySelector(`.brag-book-gallery-case-card[data-case-id="${t}"]`);e&&e.dataset.procedureIds&&(i=e.dataset.procedureIds),window.loadCaseDetailsWithName(t,"",o,r,i)},200)}},100)}),document.addEventListener("toggle",function(e){if("procedure-filters-details"===e.target.id){const t=e.target;t.open&&!t.dataset.initialized&&(generateProcedureFilterOptions(),t.dataset.initialized="true")}}),document.addEventListener("click",function(e){const t=e.target.closest(".brag-book-gallery-badge-remove");if(t){e.preventDefault();const a=t.closest(".brag-book-gallery-filter-badge");if(a){const e=a.getAttribute("data-filter-type"),t=a.getAttribute("data-filter-value");e&&t&&removeFilterBadge(e,t)}return}const a=document.getElementById("procedure-filters-details"),o=document.querySelector(".brag-book-gallery-filter-dropdown__panel");a&&a.open&&o&&(a.contains(e.target)||o.contains(e.target)||(a.open=!1))})}();