!function(){"use strict";var e=class{constructor(e,t={}){this.wrapper=e,this.content=e.querySelector(".brag-book-gallery-carousel-content"),this.track=e.querySelector(".brag-book-gallery-carousel-track"),this.prevBtn=e.querySelector('[data-direction="prev"]'),this.nextBtn=e.querySelector('[data-direction="next"]'),this.paginationContainer=e.querySelector(".brag-book-gallery-carousel-pagination"),this.options={itemsPerView:t.itemsPerView||this.getItemsPerView(),gap:t.gap||16,animationDuration:t.animationDuration||.4,slideSelector:t.slideSelector||".brag-book-gallery-carousel-item",infinite:!1!==t.infinite,autoplay:t.autoplay||!1,autoplayDelay:t.autoplayDelay||3e3,pauseOnHover:!1!==t.pauseOnHover,...t},this.isDown=!1,this.startX=0,this.scrollLeft=0,this.currentSlide=0,this.autoplayTimer=null,this.isPaused=!1,this.track&&this.init()}init(){this.createLiveRegion(),this.addShareButtons(),this.setupEventListeners(),this.initializePagination(),this.updateCarouselButtons(),this.updateAriaLabels(),this.options.autoplay&&this.startAutoplay()}addShareButtons(){const e=!this.wrapper.closest(".brag-book-gallery-wrapper");this.track.querySelectorAll(this.options.slideSelector).forEach(t=>{if(!t.querySelector(".brag-book-gallery-carousel-image, img")){const e="https://bragbookgallery.com/nitropack_static/FCmixFCiYNkGgqjxyaUSblqHbCgLrqyJ/assets/images/optimized/rev-407fb37/ngnqwvuungodwrpnrczq.supabase.co/storage/v1/object/sign/brag-photos/org_2vm5nGWtoCYuaQBCP587ez6cYXF/c68b56b086f4f8eef8292f3f23320f1b.Blepharoplasty%20-%20aa239d58-badc-4ded-a26b-f89c2dd059b6.jpg",a=t.querySelector("span");a&&a.remove();const o=t.dataset.caseId;if(o&&""!==o){const a=t.dataset.procedureSlug||"procedure",r=`${window.location.pathname.replace(/\/[^\/]+\/[^\/]+\/?$/,"")}/${a}/${o}/`.replace(/\/+/g,"/"),s=document.createElement("a");s.href=r,s.className="brag-book-gallery-case-card-link",s.dataset.caseId=o;const i=document.createElement("img");i.src=e,i.alt="Before and after result",i.className="brag-book-gallery-carousel-image",i.loading="lazy",s.appendChild(i),t.insertBefore(s,t.firstChild)}else{const a=document.createElement("img");a.src=e,a.alt="Before and after result",a.className="brag-book-gallery-carousel-image",a.loading="lazy",t.insertBefore(a,t.firstChild)}}if(e)return;let a=t.querySelector(".brag-book-gallery-item-actions");if(a||(a=document.createElement("div"),a.className="brag-book-gallery-item-actions",t.appendChild(a)),!a.querySelector(".brag-book-gallery-favorite-button")){const e=t.querySelector(".brag-book-gallery-favorite-button");if(e)a.appendChild(e);else{const e=document.createElement("button");e.className="brag-book-gallery-favorite-button",e.dataset.favorited="false",e.dataset.itemId=t.dataset.slide,e.setAttribute("aria-label","Add to favorites"),e.innerHTML='\n                        <svg fill="rgba(255, 255, 255, 0.5)" stroke="white" stroke-width="2" viewBox="0 0 24 24">\n                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n                        </svg>\n                    ',a.appendChild(e)}}if(!a.querySelector(".brag-book-gallery-share-button")&&"undefined"!=typeof bragBookGalleryConfig&&"yes"===bragBookGalleryConfig.enableSharing){const e=document.createElement("button");e.className="brag-book-gallery-share-button",e.dataset.itemId=t.dataset.slide,e.setAttribute("aria-label","Share this image"),e.innerHTML='\n                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">\n                        <path d="M672.22-100q-44.91 0-76.26-31.41-31.34-31.41-31.34-76.28 0-6 4.15-29.16L284.31-404.31q-14.46 15-34.36 23.5t-42.64 8.5q-44.71 0-76.01-31.54Q100-435.39 100-480q0-44.61 31.3-76.15 31.3-31.54 76.01-31.54 22.74 0 42.64 8.5 19.9 8.5 34.36 23.5l284.46-167.08q-2.38-7.38-3.27-14.46-.88-7.08-.88-15.08 0-44.87 31.43-76.28Q627.49-860 672.4-860t76.25 31.44Q780-797.13 780-752.22q0 44.91-31.41 76.26-31.41 31.34-76.28 31.34-22.85 0-42.5-8.69Q610.15-662 595.69-677L311.23-509.54q2.38 7.39 3.27 14.46.88 7.08.88 15.08t-.88 15.08q-.89 7.07-3.27 14.46L595.69-283q14.46-15 34.12-23.69 19.65-8.69 42.5-8.69 44.87 0 76.28 31.43Q780-252.51 780-207.6t-31.44 76.25Q717.13-100 672.22-100Zm.09-60q20.27 0 33.98-13.71Q720-187.42 720-207.69q0-20.27-13.71-33.98-13.71-13.72-33.98-13.72-20.27 0-33.98 13.72-13.72 13.71-13.72 33.98 0 20.27 13.72 33.98Q652.04-160 672.31-160Zm-465-272.31q20.43 0 34.25-13.71 13.83-13.71 13.83-33.98 0-20.27-13.83-33.98-13.82-13.71-34.25-13.71-20.11 0-33.71 13.71Q160-500.27 160-480q0 20.27 13.6 33.98 13.6 13.71 33.71 13.71Zm465-272.3q20.27 0 33.98-13.72Q720-732.04 720-752.31q0-20.27-13.71-33.98Q692.58-800 672.31-800q-20.27 0-33.98 13.71-13.72 13.71-13.72 33.98 0 20.27 13.72 33.98 13.71 13.72 33.98 13.72Zm0 496.92ZM207.69-480Zm464.62-272.31Z"/>\n                    </svg>\n                ',a.appendChild(e)}})}createLiveRegion(){this.liveRegion=document.createElement("div"),this.liveRegion.setAttribute("aria-live","polite"),this.liveRegion.setAttribute("aria-atomic","true"),this.liveRegion.className="sr-only",this.liveRegion.style.position="absolute",this.liveRegion.style.width="1px",this.liveRegion.style.height="1px",this.liveRegion.style.padding="0",this.liveRegion.style.margin="-1px",this.liveRegion.style.overflow="hidden",this.liveRegion.style.clip="rect(0, 0, 0, 0)",this.liveRegion.style.whiteSpace="nowrap",this.liveRegion.style.border="0",this.wrapper.appendChild(this.liveRegion)}setupEventListeners(){this.track.addEventListener("scroll",()=>{this.updateCarouselButtons(),this.updatePagination()}),this.prevBtn&&this.prevBtn.addEventListener("click",()=>{this.navigate("prev"),this.options.autoplay&&(this.stopAutoplay(),this.startAutoplay())}),this.nextBtn&&this.nextBtn.addEventListener("click",()=>{this.navigate("next"),this.options.autoplay&&(this.stopAutoplay(),this.startAutoplay())}),this.track.addEventListener("mousedown",e=>this.handleMouseDown(e)),this.track.addEventListener("mouseleave",()=>this.handleMouseLeave()),this.track.addEventListener("mouseup",()=>this.handleMouseUp()),this.track.addEventListener("mousemove",e=>this.handleMouseMove(e)),this.options.autoplay&&this.options.pauseOnHover&&(this.wrapper.addEventListener("mouseenter",()=>this.pauseAutoplay()),this.wrapper.addEventListener("mouseleave",()=>this.resumeAutoplay())),this.track.addEventListener("wheel",e=>this.handleWheel(e),{passive:!1}),this.track.addEventListener("keydown",e=>this.handleKeydown(e)),this.wrapper.addEventListener("keydown",e=>this.handleKeydown(e)),document.addEventListener("keydown",e=>{this.wrapper.contains(document.activeElement)&&this.handleKeydown(e)}),this.track.tabIndex=0,this.track.setAttribute("aria-label","Use arrow keys to navigate through slides"),this.setupSlideFocusManagement()}handleMouseDown(e){this.isDown=!0,this.track.classList.add("brag-book-gallery-grabbing"),this.startX=e.pageX-this.track.offsetLeft,this.scrollLeft=this.track.scrollLeft}handleMouseLeave(){this.isDown=!1,this.track.classList.remove("brag-book-gallery-grabbing")}handleMouseUp(){this.isDown=!1,this.track.classList.remove("brag-book-gallery-grabbing")}handleMouseMove(e){if(!this.isDown)return;e.preventDefault();const t=2*(e.pageX-this.track.offsetLeft-this.startX);this.track.scrollLeft=this.scrollLeft-t}handleKeydown(e){if("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName)return;const t=this.track.querySelectorAll(this.options.slideSelector);if(0===t.length)return;const a=this.getCurrentSlideIndex();let o=!1;switch(e.key){case"ArrowLeft":e.preventDefault(),e.stopPropagation(),this.navigateToSlide(Math.max(0,a-1)),o=!0;break;case"ArrowRight":e.preventDefault(),e.stopPropagation(),this.navigateToSlide(Math.min(t.length-1,a+1)),o=!0;break;case"Home":e.preventDefault(),e.stopPropagation(),this.navigateToSlide(0),o=!0;break;case"End":e.preventDefault(),e.stopPropagation(),this.navigateToSlide(t.length-1),o=!0;break;case"PageUp":e.preventDefault(),e.stopPropagation();const r=this.getItemsPerView();this.navigateToSlide(Math.max(0,a-r)),o=!0;break;case"PageDown":e.preventDefault(),e.stopPropagation();const s=this.getItemsPerView();this.navigateToSlide(Math.min(t.length-1,a+s)),o=!0}o&&document.activeElement!==this.track&&!this.track.contains(document.activeElement)&&this.track.focus(),o&&this.options.autoplay&&(this.stopAutoplay(),this.startAutoplay())}handleWheel(e){e.preventDefault();const t=e.deltaY||e.deltaX,a=Math.abs(t)>50?t:3*t;this.wheelTimeout&&clearTimeout(this.wheelTimeout),this.track.scrollBy({left:a,behavior:"smooth"}),this.wheelTimeout=setTimeout(()=>{this.updateCarouselButtons(),this.updatePagination()},150)}getItemsPerView(){const e=window.innerWidth;return e<=480?1:e<=768?2:3}navigate(e){const t=this.track.querySelectorAll(this.options.slideSelector);if(0===t.length)return;const a=this.getCurrentSlideIndex();let o;o=this.options.infinite?"next"===e?a>=t.length-1?0:a+1:a<=0?t.length-1:a-1:"next"===e?Math.min(t.length-1,a+1):Math.max(0,a-1),this.navigateToSlide(o)}navigateToSlide(e){const t=this.track.querySelectorAll(this.options.slideSelector);if(0===t.length||e<0||e>=t.length)return;const a=t[e],o=a.offsetWidth,r=this.track.offsetWidth;let s=a.offsetLeft-(r-o)/2;s=Math.max(0,Math.min(s,this.track.scrollWidth-r)),"undefined"!=typeof gsap?gsap.to(this.track,{scrollLeft:s,duration:this.options.animationDuration,ease:"power2.inOut",onComplete:()=>{this.updateAriaLabels(),this.focusSlide(e)}}):(this.track.scrollTo({left:s,behavior:"smooth"}),setTimeout(()=>{this.updateAriaLabels(),this.focusSlide(e)},300)),this.currentSlide=e}getCurrentSlideIndex(){const e=this.track.querySelectorAll(this.options.slideSelector),t=this.track.scrollLeft+this.track.offsetWidth/2;let a=0,o=1/0;return e.forEach((e,r)=>{const s=e.offsetLeft+e.offsetWidth/2,i=Math.abs(s-t);i<o&&(o=i,a=r)}),a}startAutoplay(){this.options.autoplay&&!this.autoplayTimer&&(this.autoplayTimer=setInterval(()=>{this.isPaused||this.isDown||this.navigate("next")},this.options.autoplayDelay))}stopAutoplay(){this.autoplayTimer&&(clearInterval(this.autoplayTimer),this.autoplayTimer=null)}pauseAutoplay(){this.isPaused=!0}resumeAutoplay(){this.isPaused=!1}setupSlideFocusManagement(){this.track.querySelectorAll(this.options.slideSelector).forEach((e,t)=>{e.tabIndex=-1,e.addEventListener("focus",()=>{this.currentSlide=t}),e.addEventListener("click",t=>{t.target.closest("button")||e.focus()})}),this.wrapper.tabIndex=-1,this.wrapper.style.outline="none",this.wrapper.addEventListener("click",e=>{e.target.closest("button")||e.target.closest("[tabindex]")||this.track.focus()})}focusSlide(e){const t=this.track.querySelectorAll(this.options.slideSelector);t[e]&&document.activeElement===this.track&&t[e].focus()}initializePagination(){if(!this.paginationContainer)return;this.paginationContainer.innerHTML="";const e=this.track.querySelectorAll(this.options.slideSelector),t=this.getItemsPerView(),a=Math.ceil(e.length/t);for(let e=0;e<a;e++){const t=document.createElement("button");t.className="brag-book-gallery-pagination-dot",t.role="tab",0===e?(t.classList.add("brag-book-gallery-active"),t.setAttribute("aria-selected","true")):t.setAttribute("aria-selected","false"),t.setAttribute("data-page",e),t.setAttribute("aria-label",`Go to slide group ${e+1}`),t.addEventListener("click",()=>this.goToPage(e)),this.paginationContainer.appendChild(t)}}goToPage(e){const t=this.track.querySelectorAll(this.options.slideSelector);if(0===t.length)return;const a=t[0].offsetWidth,o=this.getItemsPerView(),r=e*o*(a+this.options.gap);this.currentSlide=e*o,"undefined"!=typeof gsap?gsap.to(this.track,{scrollLeft:r,duration:.5,ease:"power2.inOut",onComplete:()=>this.updateAriaLabels()}):(this.track.scrollLeft=r,this.updateAriaLabels())}updatePagination(){if(!this.paginationContainer)return;const e=this.track.querySelectorAll(this.options.slideSelector);if(0===e.length)return;const t=e[0].offsetWidth,a=this.getItemsPerView(),o=this.track.scrollLeft,r=Math.round(o/((t+this.options.gap)*a));this.currentSlide=r*a,this.paginationContainer.querySelectorAll(".brag-book-gallery-pagination-dot").forEach((e,t)=>{t===r?(e.classList.add("brag-book-gallery-active"),e.setAttribute("aria-selected","true")):(e.classList.remove("brag-book-gallery-active"),e.setAttribute("aria-selected","false"))})}updateCarouselButtons(){if(this.options.infinite)return this.prevBtn&&(this.prevBtn.disabled=!1),void(this.nextBtn&&(this.nextBtn.disabled=!1));const e=this.track.scrollLeft,t=this.track.scrollWidth,a=this.track.clientWidth;this.prevBtn&&(this.prevBtn.disabled=e<=0),this.nextBtn&&(this.nextBtn.disabled=e>=t-a-1)}updateAriaLabels(){const e=this.track.querySelectorAll(this.options.slideSelector),t=e.length,a=this.getCurrentSlideIndex();e.forEach((e,o)=>{const r=o+1,s=o===a;e.setAttribute("aria-label",`Slide ${r} of ${t}${s?" (current)":""}`),e.setAttribute("aria-current",s?"true":"false")}),this.liveRegion&&(this.liveRegion.textContent=`Slide ${a+1} of ${t}`)}refresh(){this.options.itemsPerView=this.getItemsPerView(),this.initializePagination(),this.updatePagination(),this.updateAriaLabels()}goToSlide(e){const t=this.track.querySelectorAll(this.options.slideSelector),a=Array.from(t).find(t=>t.dataset.slide===e);if(a){const e=Array.from(t).indexOf(a),o=this.getItemsPerView(),r=Math.floor(e/o);this.goToPage(r)}}},t=class{constructor(e,t={}){this.dialog=document.getElementById(e),this.closeButtons=this.dialog?.querySelectorAll('[data-action*="close"]'),this.options={closeOnBackdrop:!1!==t.closeOnBackdrop,closeOnEscape:!1!==t.closeOnEscape,onOpen:t.onOpen||(()=>{}),onClose:t.onClose||(()=>{}),...t},this.dialog&&this.init()}init(){this.setupEventListeners()}setupEventListeners(){this.closeButtons?.forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.close()})}),this.options.closeOnBackdrop&&this.dialog&&this.dialog.addEventListener("click",e=>{e.target===this.dialog&&this.close()}),this.options.closeOnEscape&&this.dialog&&this.dialog.addEventListener("cancel",e=>{e.preventDefault(),this.close()})}open(){if(this.dialog)try{this.dialog.showModal(),document.body.style.overflow="hidden",this.options.onOpen()}catch(e){console.error("Error opening dialog:",e),this.dialog.setAttribute("open",""),this.dialog.style.display="block",document.body.style.overflow="hidden",this.options.onOpen()}}close(){if(this.dialog)try{this.dialog.close(),document.body.style.overflow="",this.dialog.style.display="",this.options.onClose()}catch(e){console.error("Error closing dialog:",e),this.dialog.removeAttribute("open"),this.dialog.style.display="none",document.body.style.overflow="",this.options.onClose()}}isOpen(){return this.dialog?.open||this.dialog?.hasAttribute("open")}},a=class{constructor(e,t={}){this.container=e,this.filterHeaders=e?.querySelectorAll(".brag-book-gallery-nav-button"),this.activeFilters=new Map,this.categories=new Map,this.procedures=new Map,this.originalTitle=document.title,this.originalDescription=document.querySelector('meta[name="description"]')?.content||"",this.options={mode:t.mode||"javascript",baseUrl:t.baseUrl||"/gallery",animateWithGsap:"undefined"!=typeof gsap,closeOthersOnOpen:!0===t.closeOthersOnOpen,onFilterChange:t.onFilterChange||(()=>{}),onNavigate:t.onNavigate||(e=>{window.location.href=e}),...t},this.container&&this.init()}init(){this.indexFilters(),this.setupEventListeners(),this.loadStateFromUrl()}indexFilters(){const e=this.container?.querySelectorAll("[data-category]");e?.forEach(e=>{const t=e.dataset.category;this.categories.has(t)||this.categories.set(t,{name:t,procedures:new Set,element:e}),e.querySelectorAll(".brag-book-gallery-nav-link").forEach(e=>{const t=e.dataset.procedure,a=e.dataset.category;if(t&&a){const o={id:t,category:a,count:parseInt(e.dataset.procedureCount||"0"),element:e.parentElement,link:e};this.procedures.set(`${a}:${t}`,o),this.categories.get(a).procedures.add(t)}})})}setupEventListeners(){const e=this.container?.querySelectorAll(".brag-book-gallery-nav-link");e?.forEach(e=>{e.addEventListener("click",e=>{e.currentTarget.closest("summary")||(e.preventDefault(),this.handleFilterClick(e.currentTarget))})}),window.addEventListener("popstate",e=>{e.state&&e.state.caseId?window.loadCaseDetails(e.state.caseId,e.state.procedureId,e.state.procedureSlug):e.state&&e.state.category&&e.state.procedure?(this.reactivateFilter(e.state.category,e.state.procedure),this.loadFilteredContent(e.state.category,e.state.procedure,e.state.procedureIds,e.state.hasNudity||!1)):(this.clearAll(),window.location.reload())})}handleFilterClick(e){const t=e.dataset.category,a=e.dataset.procedure,o=e.dataset.procedureIds,r=parseInt(e.dataset.procedureCount||"0"),s="true"===e.dataset.nudity;this.activeFilters.clear(),this.container?.querySelectorAll(".brag-book-gallery-nav-link").forEach(e=>{e.classList.remove("brag-book-gallery-active")}),e.classList.add("brag-book-gallery-active");const i=e.closest(".brag-book-gallery-nav-list-submenu__item");i&&i.classList.add("brag-book-gallery-active"),this.activeFilters.set(`${t}:${a}`,{category:t,procedure:a,procedureIds:o,count:r,hasNudity:s});const l=document.querySelector(".brag-book-gallery-wrapper");let n=l?.dataset.baseUrl||window.location.pathname;!l?.dataset.baseUrl&&n.match(/\/[^\/]+\/?$/)&&(n=n.replace(/\/[^\/]+\/?$/,""));const c=`${n}/${a}/`.replace(/\/+/g,"/");window.history.pushState({category:t,procedure:a,procedureIds:o,basePath:n,hasNudity:s},"",c),this.loadFilteredContent(t,a,o,s),this.options.animateWithGsap&&"undefined"!=typeof gsap&&gsap.to(e,{scale:1.02,duration:.1,yoyo:!0,repeat:1,ease:"power2.inOut"})}navigateToFilteredPage(){if(this.activeFilters.size>0){const e=`/${Array.from(this.activeFilters.values())[0].procedure}`;this.options.onNavigate(e)}else this.options.onNavigate(this.options.baseUrl)}updateUrlState(){if(window.history&&window.history.replaceState){const e=new URLSearchParams,t=new Map;this.activeFilters.forEach(e=>{t.has(e.category)||t.set(e.category,[]),t.get(e.category).push(e.procedure)}),t.forEach((t,a)=>{e.append(a,t.join(","))});const a=e.toString()?`?${e.toString()}`:window.location.pathname;window.history.replaceState({},"",a)}}reactivateFilter(e,t){this.activeFilters.clear(),this.container?.querySelectorAll(".brag-book-gallery-nav-link").forEach(e=>{e.classList.remove("brag-book-gallery-active")});const a=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${t}"]`);a&&(a.classList.add("brag-book-gallery-active"),this.activeFilters.set(`${e}:${t}`,{category:e,procedure:t,procedureIds:a.dataset.procedureIds,count:parseInt(a.dataset.procedureCount||"0")}))}loadStateFromUrl(){const e=document.querySelector(".brag-book-gallery-wrapper"),t=e?.dataset.baseUrl||"",a=e?.dataset.initialProcedure;if(a){const e=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${a}"]`);if(e){const t=e.dataset.category||"",o="true"===e.dataset.nudity;return this.reactivateFilter(t,a),void this.loadFilteredContent(t,a,e.dataset.procedureIds,o)}}const o=window.location.pathname;let r=o;t&&o.startsWith(t)&&(r=o.substring(t.length));const s=r.match(/^\/([^\/]+)\/(\d+)\/?$/);if(s){const[,e,t]=s;return}const i=r.match(/^\/([^\/]+)\/?$/);if(i){const[,e]=i,t=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${e}"]`);if(t){const a=t.dataset.category||"",o="true"===t.dataset.nudity;this.reactivateFilter(a,e),this.loadFilteredContent(a,e,t.dataset.procedureIds,o)}}}getActiveFilters(){return this.activeFilters}getFiltersByCategory(e){const t=[];return this.activeFilters.forEach(a=>{a.category===e&&t.push(a)}),t}getFiltersByProcedure(e){const t=[];return this.activeFilters.forEach(a=>{a.procedure===e&&t.push(a)}),t}clearCategory(e){const t=[];this.activeFilters.forEach((a,o)=>{a.category===e&&t.push(o)}),t.forEach(e=>{const t=this.procedures.get(e);t&&t.link&&t.link.classList.remove("brag-book-gallery-active")}),t.forEach(e=>this.activeFilters.delete(e))}clearAll(){const e=this.container?.querySelectorAll(".brag-book-gallery-nav-link");e?.forEach(e=>{e.classList.remove("brag-book-gallery-active")}),this.activeFilters.clear(),window.history.pushState({},"",window.location.pathname)}setMode(e){this.options.mode=e}loadFilteredContent(e,t,a,o=!1){const r=document.getElementById("gallery-content");if(!r)return;r.innerHTML='<div class="brag-book-gallery-loading">Loading filtered results...</div>';let s=t;const i=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${t}"]`);if(i){const e=i.querySelector(".brag-book-gallery-filter-option-label");e&&(s=e.textContent.trim())}this.loadFilteredContentDirectly(t,a,o,s).then(i=>{if(i.success){if(this.updateGalleryContent(i.html),i.seo&&(i.seo.title&&(document.title=i.seo.title),i.seo.description)){let e=document.querySelector('meta[name="description"]');e||(e=document.createElement("meta"),e.name="description",document.head.appendChild(e)),e.content=i.seo.description}r.querySelectorAll(".brag-book-gallery-carousel-wrapper").forEach(e=>{new Carousel(e)}),setTimeout(function(){regenerateProcedureFilters()},100),"procedure"===e&&t&&this.updateUrlForProcedure(t),r.scrollIntoView({behavior:"smooth",block:"start"})}else console.log("Direct API failed, falling back to AJAX"),this.loadFilteredContentViaAjax(e,t,a,o,s,r)}).catch(i=>{console.log("Direct API error, falling back to AJAX:",i),this.loadFilteredContentViaAjax(e,t,a,o,s,r)})}async loadFilteredContentDirectly(e,t,a,o){try{const a=window.bragBookGalleryConfig?.apiToken||"",r=window.bragBookGalleryConfig?.websitePropertyId||"",s=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",i=window.bragBookGalleryConfig?.nonce||"";if(!(a&&r&&s&&i))return{success:!1,error:"Missing API configuration"};const l={apiTokens:[a],websitePropertyIds:[parseInt(r)],count:1};if(t){const e=t.split(",").map(e=>parseInt(e)).filter(e=>!isNaN(e));e.length>0&&(l.procedureIds=e)}let n=[],c=1;const d=20;for(;c<=d;){l.count=c;const e=new FormData;e.append("action","brag_book_api_proxy"),e.append("nonce",i),e.append("endpoint","/api/plugin/combine/cases"),e.append("method","POST"),e.append("body",JSON.stringify(l)),e.append("timeout","8");const t=new AbortController,a=setTimeout(()=>t.abort(),1e4),o=await fetch(s,{method:"POST",body:e,signal:t.signal});if(clearTimeout(a),!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const r=await o.json();if(!r.success||!r.data||!r.data.data)throw new Error(r.data?.message||"API proxy request failed");const d=r.data.data;if(!(d&&d.data&&Array.isArray(d.data)&&d.data.length>0))break;if(n=n.concat(d.data),d.data.length<10)break;c++}const g=this.generateFilteredGalleryHTML(n,o,e,t),h=this.generateSEOData(o);return{success:!0,html:g,totalCount:n.length,procedureName:o,seo:h}}catch(e){return console.error("Direct API error:",e),{success:!1,error:e.message}}}loadFilteredContentViaAjax(e,t,a,o,r,s){const i=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",l=window.bragBookGalleryConfig?.nonce||"",n=new FormData;n.append("action","brag_book_gallery_load_filtered_gallery"),n.append("nonce",l),n.append("procedure_name",r),n.append("procedure_slug",t),n.append("procedure_ids",a||""),n.append("procedure_id",a?.split(",")[0]||""),n.append("has_nudity",o?"1":"0"),fetch(i,{method:"POST",body:n}).then(e=>e.json()).then(a=>{if(a.success&&a.data?.html){if(this.updateGalleryContent(a.data.html),a.data.seo&&(a.data.seo.title&&(document.title=a.data.seo.title),a.data.seo.description)){let e=document.querySelector('meta[name="description"]');e||(e=document.createElement("meta"),e.name="description",document.head.appendChild(e)),e.content=a.data.seo.description}s.querySelectorAll(".brag-book-gallery-carousel-wrapper").forEach(e=>{new Carousel(e)}),setTimeout(function(){regenerateProcedureFilters()},100),"procedure"===e&&t&&this.updateUrlForProcedure(t),s.scrollIntoView({behavior:"smooth",block:"start"})}else s.innerHTML='<div class="brag-book-gallery-error">No results found for the selected filter.</div>'}).catch(e=>{console.error("AJAX fallback error:",e),s.innerHTML='<div class="brag-book-gallery-error">Failed to load filtered content. Please try again.</div>'})}generateFilteredGalleryHTML(e,t,a,o){"undefined"!=typeof allCasesData&&(allCasesData=e,currentDisplayedCases=Math.min(10,e.length));const r=e.map(e=>{const t={...e};if(t.mainImageUrl="",e.photoSets&&Array.isArray(e.photoSets)&&e.photoSets.length>0){const a=e.photoSets[0];t.mainImageUrl=a.postProcessedImageLocation||a.beforeLocationUrl||a.afterLocationUrl1||""}return t.procedureTitle="Unknown Procedure",e.procedures&&Array.isArray(e.procedures)&&e.procedures.length>0&&(t.procedureTitle=e.procedures[0].name||"Unknown Procedure"),t}).filter(e=>e.mainImageUrl||e.id);let s="";const i=this.formatProcedureDisplayName(t);s+=`<h2 class="brag-book-gallery-content-title"><strong>${this.escapeHtml(i)}</strong> Before &amp; After Gallery</h2>`,s+='<div class="brag-book-gallery-controls">',s+='<div class="brag-book-gallery-controls-left">',s+='<details class="brag-book-gallery-filter-dropdown" id="procedure-filters-details" data-initialized="true">',s+='<summary class="brag-book-gallery-filter-dropdown__toggle">',s+='<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">',s+='<path d="M400-240v-80h160v80H400ZM240-440v-80h480v80H240ZM120-640v-80h720v80H120Z"></path>',s+="</svg>",s+="<span>Filters</span>",s+="</summary>",s+='<div class="brag-book-gallery-filter-dropdown__panel">',s+='<div class="brag-book-gallery-filter-content">',s+='<div class="brag-book-gallery-filter-section">',s+='<div id="brag-book-gallery-filters">',s+=this.generateProcedureFilterSections(r),s+="</div>",s+="</div>",s+="</div>",s+='<div class="brag-book-gallery-filter-actions">',s+='<button class="brag-book-gallery-button brag-book-gallery-button--apply" onclick="applyProcedureFilters()">Apply Filters</button>',s+='<button class="brag-book-gallery-button brag-book-gallery-button--clear" onclick="clearProcedureFilters()">Clear All</button>',s+="</div>",s+="</div>",s+="</details>",s+='<div class="brag-book-gallery-active-filters" style="display: none;"></div>',s+="</div>",s+='<div class="brag-book-gallery-grid-selector">',s+='<span class="brag-book-gallery-grid-label">View:</span>',s+='<div class="brag-book-gallery-grid-buttons">',s+='<button class="brag-book-gallery-grid-btn" data-columns="2" onclick="updateGridLayout(2)" aria-label="View in 2 columns">',s+='<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">',s+='<rect x="1" y="1" width="6" height="6"></rect><rect x="9" y="1" width="6" height="6"></rect>',s+='<rect x="1" y="9" width="6" height="6"></rect><rect x="9" y="9" width="6" height="6"></rect>',s+="</svg>",s+='<span class="sr-only">2 Columns</span>',s+="</button>",s+='<button class="brag-book-gallery-grid-btn active" data-columns="3" onclick="updateGridLayout(3)" aria-label="View in 3 columns">',s+='<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">',s+='<rect x="1" y="1" width="4" height="4"></rect><rect x="6" y="1" width="4" height="4"></rect><rect x="11" y="1" width="4" height="4"></rect>',s+='<rect x="1" y="6" width="4" height="4"></rect><rect x="6" y="6" width="4" height="4"></rect><rect x="11" y="6" width="4" height="4"></rect>',s+='<rect x="1" y="11" width="4" height="4"></rect><rect x="6" y="11" width="4" height="4"></rect><rect x="11" y="11" width="4" height="4"></rect>',s+="</svg>",s+='<span class="sr-only">3 Columns</span>',s+="</button>",s+="</div>",s+="</div>",s+="</div>",s+='<div class="brag-book-gallery-sections" id="gallery-sections">',s+='<div class="brag-book-gallery-section" aria-label="Filtered Gallery Results">';const l=r.length,n=Math.min(10,l);return s+=`<div class="brag-book-gallery-filter-results" style="display: block;">Filter applied: Showing ${n} of ${l} matching procedure${1!==l?"s":""}</div>`,s+='<div class="brag-book-gallery-filter-badges" data-action="filter-badges"></div>',s+='<div class="brag-book-gallery-case-grid masonry-layout" data-columns="3">',r.slice(0,10).forEach(e=>{s+=this.generateCaseHTML(e)}),s+="</div>",r.length>10&&(s+='<div class="brag-book-gallery-load-more-container">',s+='<button type="button" class="brag-book-gallery-button brag-book-gallery-button--load-more" ',s+=`data-procedure-name="${this.escapeHtml(t)}" `,s+=`data-start-page="2" data-procedure-ids="${this.escapeHtml(o)}" `,s+='onclick="loadMoreCasesFromCache(this)">Load More</button>',s+="</div>"),s+="</div>",s+="</div>",s}updateGalleryContent(e){const t=document.getElementById("gallery-content");if(t){t.innerHTML=e;const a=t.querySelector(".brag-book-gallery-filter-results");a&&(a.style.display="none"),this.setupFilterEventListeners(),this.scrollToGalleryWrapper()}}setupFilterEventListeners(){const e=document.querySelectorAll('.brag-book-gallery-filter-option input[type="checkbox"]');console.log("Setting up FilterSystem event listeners for",e.length,"checkboxes");const t=document.querySelector(".brag-book-gallery-active-filters");t&&(t.style.display="none",t.innerHTML=""),e.forEach(e=>{e.removeEventListener("change",this.handleFilterChange),e.addEventListener("change",this.handleFilterChange.bind(this))})}handleFilterChange(e){console.log("FilterSystem checkbox changed:",e.target.dataset.filterType,"=",e.target.value,"checked:",e.target.checked),"function"==typeof window.applyProcedureFilters?window.applyProcedureFilters():console.error("window.applyProcedureFilters is not available")}generateCaseHTML(e){const t=e.id||"",a=e.procedureTitle||"Unknown Procedure";let o='data-card="true"';o+=` data-case-id="${this.escapeHtml(t)}"`,e.age&&(o+=` data-age="${this.escapeHtml(e.age)}"`),e.gender&&(o+=` data-gender="${this.escapeHtml(e.gender.toLowerCase())}"`),e.ethnicity&&(o+=` data-ethnicity="${this.escapeHtml(e.ethnicity.toLowerCase())}"`);const r=e.procedureIds?e.procedureIds.join(","):"";r&&(o+=` data-procedure-ids="${this.escapeHtml(r)}"`);const s=`/${window.bragBookGalleryConfig?.gallerySlug||"gallery"}/${this.extractProcedureSlugFromUrl()||"case"}/${e.caseDetails&&e.caseDetails[0]&&e.caseDetails[0].seoSuffixUrl||t}/`;let i="";if(e.photoSets&&Array.isArray(e.photoSets)&&e.photoSets.length>0){const t=e.photoSets[0];i=t.postProcessedImageLocation||t.afterLocationUrl1||t.beforeLocationUrl||t.afterPhoto||t.beforePhoto||""}let l=`<article class="brag-book-gallery-case-card" ${o}>`;l+='<div class="brag-book-gallery-case-images single-image">',l+='<div class="brag-book-gallery-single-image">',l+='<div class="brag-book-gallery-image-container">',l+='<div class="brag-book-gallery-skeleton-loader" style="display: none;"></div>',l+='<div class="brag-book-gallery-item-actions">',l+=`<button class="brag-book-gallery-favorite-button" data-favorited="false" data-item-id="case-${this.escapeHtml(t)}" aria-label="Add to favorites">`,l+='<svg fill="rgba(255, 255, 255, 0.5)" stroke="white" stroke-width="2" viewBox="0 0 24 24">',l+='<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>',l+="</svg>",l+="</button>",l+="</div>",l+=`<a href="${this.escapeHtml(s)}" class="brag-book-gallery-case-card-link" data-case-id="${this.escapeHtml(t)}" data-procedure-ids="${this.escapeHtml(r)}">`,i&&(l+='<picture class="brag-book-gallery-picture">',l+=`<img src="${this.escapeHtml(i)}" alt="${this.escapeHtml(a)} - Case ${this.escapeHtml(t)}" loading="lazy" data-image-type="single" data-image-url="${this.escapeHtml(i)}" onload="this.closest('.brag-book-gallery-image-container').querySelector('.brag-book-gallery-skeleton-loader').style.display='none';">`,l+="</picture>"),l+="</a>";const n=document.querySelector(".brag-book-gallery-nav-link.brag-book-gallery-active");return n&&"true"===n.dataset.nudity&&(l+='<div class="brag-book-gallery-nudity-warning">',l+='<div class="brag-book-gallery-nudity-warning-content">',l+='<h4 class="brag-book-gallery-nudity-warning-title">Nudity Warning</h4>',l+='<p class="brag-book-gallery-nudity-warning-caption">This procedure may contain nudity or sensitive content. Click to proceed if you wish to view.</p>',l+='<button class="brag-book-gallery-nudity-warning-button" type="button">Proceed</button>',l+="</div>",l+="</div>"),l+="</div>",l+="</div>",l+="</div>",l+='<details class="brag-book-gallery-case-card-details">',l+='<summary class="brag-book-gallery-case-card-summary">',l+='<div class="brag-book-gallery-case-card-summary-info">',l+=`<span class="brag-book-gallery-case-card-summary-info__name">${this.escapeHtml(a)}</span>`,l+=`<span class="brag-book-gallery-case-card-summary-info__case-number">Case #${this.escapeHtml(t)}</span>`,l+="</div>",l+='<div class="brag-book-gallery-case-card-summary-details">',l+='<p class="brag-book-gallery-case-card-summary-details__more">',l+="<strong>More Details</strong>",l+='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">',l+='<path d="M444-288h72v-156h156v-72H516v-156h-72v156H288v72h156v156Zm36.28 192Q401-96 331-126t-122.5-82.5Q156-261 126-330.96t-30-149.5Q96-560 126-629.5q30-69.5 82.5-122T330.96-834q69.96-30 149.5-30t149.04 30q69.5 30 122 82.5T834-629.28q30 69.73 30 149Q864-401 834-331t-82.5 122.5Q699-156 629.28-126q-69.73 30-149 30Z"></path>',l+="</svg>",l+="</p>",l+="</div>",l+="</summary>",l+='<div class="brag-book-gallery-case-card-details-content">',l+='<p class="brag-book-gallery-case-card-details-content__title">Procedures Performed:</p>',l+='<ul class="brag-book-gallery-case-card-procedures-list">',e.procedures&&Array.isArray(e.procedures)&&e.procedures.length>0?e.procedures.forEach(e=>{l+=`<li class="brag-book-gallery-case-card-procedures-list__item">${this.escapeHtml(e.name||"Unknown Procedure")}</li>`}):l+=`<li class="brag-book-gallery-case-card-procedures-list__item">${this.escapeHtml(a)}</li>`,l+="</ul>",l+="</div>",l+="</details>",l+="</article>",l}extractProcedureSlugFromUrl(){const e=window.location.pathname.split("/").filter(e=>e),t=window.bragBookGalleryConfig?.gallerySlug||"gallery",a=e.indexOf(t.replace(/^\/+/,""));if(a>=0&&a+1<e.length){const t=e[a+1];if(!/^\d+$/.test(t))return t}return null}generateProcedureFilterSections(e){const t={age:new Set,gender:new Set,ethnicity:new Set,height:new Set,weight:new Set};e.forEach(e=>{if(e.age){const a=parseInt(e.age);a>=18&&a<25?t.age.add("18-24"):a>=25&&a<35?t.age.add("25-34"):a>=35&&a<45?t.age.add("35-44"):a>=45&&a<55?t.age.add("45-54"):a>=55&&a<65?t.age.add("55-64"):a>=65&&t.age.add("65+")}if(e.gender&&t.gender.add(e.gender.toLowerCase()),e.ethnicity&&t.ethnicity.add(e.ethnicity),e.height){const a=parseFloat(e.height);a<60?t.height.add("Under 5'0\""):a>=60&&a<64?t.height.add("5'0\" - 5'3\""):a>=64&&a<68?t.height.add("5'4\" - 5'7\""):a>=68&&a<72?t.height.add("5'8\" - 5'11\""):a>=72&&t.height.add("6'0\" and above")}if(e.weight){const a=parseFloat(e.weight);a<120?t.weight.add("Under 120 lbs"):a>=120&&a<150?t.weight.add("120-149 lbs"):a>=150&&a<180?t.weight.add("150-179 lbs"):a>=180&&a<210?t.weight.add("180-209 lbs"):a>=210&&t.weight.add("210+ lbs")}});let a="";if(t.age.size>0&&(a+=this.generateFilterSection("Age","age",Array.from(t.age).sort())),t.gender.size>0){const e=Array.from(t.gender).map(e=>"male"===e?"Male":"female"===e?"Female":e);a+=this.generateFilterSection("Gender","gender",e)}return t.ethnicity.size>0&&(a+=this.generateFilterSection("Ethnicity","ethnicity",Array.from(t.ethnicity).sort())),t.height.size>0&&(a+=this.generateFilterSection("Height","height",Array.from(t.height))),t.weight.size>0&&(a+=this.generateFilterSection("Weight","weight",Array.from(t.weight))),a}generateFilterSection(e,t,a){let o='<details class="brag-book-gallery-filter">';return o+='<summary class="brag-book-gallery-filter-label">',o+=`<span class="brag-book-gallery-filter-label__name">${this.escapeHtml(e)}</span>`,o+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>',o+="</svg>",o+="</summary>",o+='<ul class="brag-book-gallery-filter-options">',a.forEach(e=>{const a=`procedure-filter-${t}-${e.replace(/[^a-zA-Z0-9]/g,"-")}`,r="age"===t?e:e.toLowerCase();o+='<li class="brag-book-gallery-filter-option">',o+=`<input type="checkbox" id="${a}" value="${this.escapeHtml(r)}" data-filter-type="${t}">`,o+=`<label for="${a}">${this.escapeHtml(e)}</label>`,o+="</li>"}),o+="</ul>",o+="</details>",o}generateSEOData(e){const t={};if(e){const a=this.formatProcedureDisplayName(e),o=document.title.split(" | ").pop()||"BRAGBook Gallery";t.title=`${a} Before & After Gallery | ${o}`,t.description=`View before and after photos of ${a} procedures. Browse our gallery to see real patient results.`}return t}formatProcedureDisplayName(e){return e?e.split(/[\s-_]+/).map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" "):""}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}updateFilterBadges(){}createFilterBadge(e,t,a){const o=document.createElement("div");o.className="brag-book-gallery-filter-badge",o.setAttribute("data-filter-key",a);let r="";switch(e){case"age":r=`Age: ${t}`;break;case"gender":r=`Gender: ${t}`;break;case"ethnicity":r=`Ethnicity: ${t}`;break;case"procedure":r=t;break;default:r=`${e}: ${t}`}return o.innerHTML=`\n\t\t\t<span class="brag-book-gallery-badge-text">${r}</span>\n\t\t\t<button class="brag-book-gallery-badge-remove" aria-label="Remove ${r} filter">\n\t\t\t\t<svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">\n\t\t\t\t\t<path d="M13 1L1 13M1 1l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n\t\t\t\t</svg>\n\t\t\t</button>\n\t\t`,o.querySelector(".brag-book-gallery-badge-remove").addEventListener("click",e=>{e.preventDefault(),this.removeFilterBadge(a)}),o}removeFilterBadge(e){const t=this.activeFilters.get(e);if(t){this.activeFilters.delete(e);const a=document.querySelector(`[data-category="${t.category}"][data-procedure="${t.procedure}"]`);a&&a.classList.remove("brag-book-gallery-active"),this.options.onFilterChange(this.activeFilters)}}clearAllFilters(){const e=this.container?.querySelectorAll(".brag-book-gallery-nav-list-submenu-link");e?.forEach(e=>{e.classList.remove("brag-book-gallery-active")}),this.activeFilters.clear(),this.options.onFilterChange(this.activeFilters),window.history.pushState({},"",window.location.pathname)}scrollToGalleryWrapper(){const e=document.querySelector(".brag-book-gallery-wrapper");if(e){const t=e.getBoundingClientRect().top+window.pageYOffset-20;window.scrollTo({top:t,behavior:"smooth"})}}},o=class{constructor(e={}){this.sidebar=document.querySelector(".brag-book-gallery-sidebar"),this.overlay=document.querySelector(".brag-book-gallery-mobile-overlay"),this.menuToggle=document.querySelector(".brag-book-gallery-mobile-menu-toggle"),this.closeButton=document.querySelector('[data-action="close-menu"]'),this.options={breakpoint:e.breakpoint||1024,swipeToClose:!1!==e.swipeToClose,...e},this.touchStartX=0,this.touchEndX=0,this.sidebar&&this.menuToggle&&this.init()}init(){let e;this.setupEventListeners(),this.checkMobileView(),window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{this.checkMobileView()},250)})}setupEventListeners(){this.menuToggle?.addEventListener("click",()=>this.toggle()),this.overlay?.addEventListener("click",()=>this.close()),this.closeButton?.addEventListener("click",()=>this.close()),this.sidebar&&this.sidebar.addEventListener("click",e=>{e.target.closest(".brag-book-gallery-nav-link")&&window.innerWidth<this.options.breakpoint&&setTimeout(()=>{this.close()},100)}),this.options.swipeToClose&&this.setupSwipeGestures(),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isOpen()&&this.close()})}setupSwipeGestures(){this.sidebar?.addEventListener("touchstart",e=>{this.touchStartX=e.changedTouches[0].screenX},{passive:!0}),this.sidebar?.addEventListener("touchend",e=>{this.touchEndX=e.changedTouches[0].screenX,this.handleSwipeGesture()},{passive:!0})}handleSwipeGesture(){this.touchStartX-this.touchEndX>50&&this.isOpen()&&this.close()}checkMobileView(){const e=window.innerWidth<=this.options.breakpoint,t=document.querySelector(".brag-book-gallery-sidebar-header"),a=document.querySelector(".brag-book-gallery-mobile-header");t&&(t.style.display=e?"flex":"none"),a&&(a.style.display=e?"flex":"none"),e||(this.close(),document.body.classList.remove("brag-book-gallery-mobile-menu-open"))}toggle(){this.isOpen()?this.close():this.open()}open(){if(!this.sidebar||!this.menuToggle)return;this.menuToggle.dataset.menuOpen="true",this.menuToggle.setAttribute("aria-expanded","true"),this.menuToggle.setAttribute("aria-label","Close navigation menu"),this.sidebar.classList.add("brag-book-gallery-active"),this.overlay?.classList.add("brag-book-gallery-active"),document.body.classList.add("brag-book-gallery-mobile-menu-open");const e=document.querySelector(".brag-book-gallery-wrapper");e&&(e.style.zIndex="9999");const t=this.menuToggle.querySelector("svg");t&&(t.innerHTML='<path d="M256-213.85 213.85-256l224-224-224-224L256-746.15l224 224 224-224L746.15-704l-224 224 224 224L704-213.85l-224-224-224 224Z"/>'),document.body.style.overflow="hidden",this.previousFocus=document.activeElement,setTimeout(()=>{const e=this.sidebar.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');e&&e.focus()},300)}close(){if(!this.sidebar||!this.menuToggle)return;this.menuToggle.dataset.menuOpen="false",this.menuToggle.setAttribute("aria-expanded","false"),this.menuToggle.setAttribute("aria-label","Open navigation menu"),this.sidebar.classList.remove("brag-book-gallery-active"),this.overlay?.classList.remove("brag-book-gallery-active"),document.body.classList.remove("brag-book-gallery-mobile-menu-open");const e=document.querySelector(".brag-book-gallery-wrapper");e&&(e.style.zIndex="");const t=this.menuToggle.querySelector("svg");t&&(t.innerHTML='<path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"/>'),document.body.style.overflow="",this.previousFocus&&this.previousFocus.focus&&this.previousFocus.focus()}isOpen(){return"true"===this.menuToggle?.dataset.menuOpen}},r=class{constructor(e={}){this.favorites=new Set,this.userInfo=null,this.hasShownDialog=!1,this.options={storageKey:e.storageKey||"brag-book-favorites",userInfoKey:e.userInfoKey||"brag-book-user-info",persistToStorage:!1!==e.persistToStorage,onUpdate:e.onUpdate||(()=>{}),...e},this.init()}init(){this.favoritesDialog=new t("favoritesDialog",{onClose:()=>{!this.userInfo&&this.lastAddedFavorite&&(this.removeFavorite(this.lastAddedFavorite),this.lastAddedFavorite=null)}}),this.options.persistToStorage&&(this.loadFromStorage(),this.loadUserInfo()),this.setupEventListeners(),this.updateUI()}setupEventListeners(){document.addEventListener("click",e=>{const t=e.target.closest("[data-favorited]");t&&(e.preventDefault(),this.toggleFavorite(t)),e.target.closest('[data-action="close-favorites-dialog"]')&&this.favoritesDialog.close()});const e=document.querySelector('[data-form="favorites"]');e&&e.addEventListener("submit",e=>{e.preventDefault(),this.handleFavoritesFormSubmit(e.target)})}toggleFavorite(e){let t=e.dataset.itemId||e.dataset.caseId||"";const a="true"===e.dataset.favorited;if(t){const e=t.match(/(\d+)/);e&&(t=e[1])}a?this.removeFavorite(t,e):t?(this.userInfo&&this.userInfo.email||this.loadUserInfo(),this.userInfo&&this.userInfo.email?(this.addFavorite(t,e),this.submitFavoriteToAPI(t)):(this.lastAddedFavorite=t,this.lastAddedButton=e,this.addFavorite(t,e),this.favoritesDialog.open(),this.hasShownDialog=!0)):console.error("No item ID found on button:",e)}addFavorite(e,t){t&&(t.dataset.favorited="true"),document.querySelectorAll(`[data-item-id="${e}"], [data-case-id="${e}"]`).forEach(e=>{void 0!==e.dataset.favorited&&(e.dataset.favorited="true")}),this.favorites.add(e),this.options.persistToStorage&&this.saveToStorage(),this.updateUI(),this.options.onUpdate(this.favorites),window.dispatchEvent(new CustomEvent("favoritesUpdated",{detail:{favorites:this.favorites}}))}removeFavorite(e,t){t?(t.dataset.favorited="false",document.querySelectorAll(`[data-item-id="${e}"], [data-case-id="${e}"]`).forEach(e=>{e!==t&&void 0!==e.dataset.favorited&&(e.dataset.favorited="false")})):document.querySelectorAll(`[data-item-id="${e}"][data-favorited="true"], [data-case-id="${e}"][data-favorited="true"]`).forEach(e=>{e.dataset.favorited="false"}),this.favorites.delete(e),this.options.persistToStorage&&this.saveToStorage(),this.updateUI(),this.options.onUpdate(this.favorites),window.dispatchEvent(new CustomEvent("favoritesUpdated",{detail:{favorites:this.favorites}}))}submitFavoriteToAPI(e){const t=new FormData;t.append("action","brag_book_add_favorite"),t.append("nonce",window.bragBookGalleryConfig?.nonce||""),t.append("case_id",e),t.append("email",this.userInfo.email||""),t.append("phone",this.userInfo.phone||""),t.append("name",this.userInfo.name||""),fetch(window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",body:t}).then(e=>e.json()).then(e=>{e.success?this.showSuccessNotification("Added to favorites!"):console.error("Failed to save favorite:",e.data?.message)}).catch(e=>{console.error("Error submitting favorite:",e)})}handleFavoritesFormSubmit(e){const t=new FormData(e),a=Object.fromEntries(t.entries());this.lastAddedFavorite&&t.append("case_id",this.lastAddedFavorite),t.append("action","brag_book_add_favorite"),t.append("nonce",window.bragBookGalleryConfig?.nonce||"");const o=e.querySelector('button[type="submit"]'),r=o?o.textContent:"";o&&(o.disabled=!0,o.textContent="Submitting...");const s=e.querySelector(".brag-book-gallery-form-error"),i=e.querySelector(".brag-book-gallery-form-success");s&&s.remove(),i&&i.remove(),fetch(window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",body:t}).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(t=>{if(t.success){this.userInfo=a,this.options.persistToStorage&&this.saveUserInfo();try{localStorage.setItem(this.options.userInfoKey,JSON.stringify(a))}catch(e){console.error("Failed to save user info to localStorage:",e)}const o=document.createElement("div");o.className="brag-book-gallery-form-success",o.textContent=t.data.message||"Your information has been saved. Keep adding favorites!",e.appendChild(o),setTimeout(()=>{this.favoritesDialog.close(),e.reset(),o&&o.remove()},2e3),this.showSuccessNotification(t.data.message||"Your information has been saved. Keep adding favorites!"),this.lastAddedFavorite=null,this.lastAddedButton=null}else{const a=document.createElement("div");a.className="brag-book-gallery-form-error",a.textContent=t.data.message||"Failed to save. Please try again.",e.appendChild(a),this.lastAddedFavorite&&this.lastAddedButton&&this.removeFavorite(this.lastAddedFavorite,this.lastAddedButton)}}).catch(t=>{console.error("Error submitting favorites form:",t);const a=document.createElement("div");a.className="brag-book-gallery-form-error",a.textContent="An error occurred. Please try again.",e.appendChild(a),this.lastAddedFavorite&&this.lastAddedButton&&this.removeFavorite(this.lastAddedFavorite,this.lastAddedButton)}).finally(()=>{o&&(o.disabled=!1,o.textContent=r)})}showSuccessNotification(e){let t=document.getElementById("favoritesNotification");t||(t=document.createElement("div"),t.id="favoritesNotification",t.className="brag-book-gallery-favorites-notification",document.body.appendChild(t)),t.textContent=e,t.classList.add("active"),"undefined"!=typeof gsap&&gsap.fromTo(t,{y:-20,opacity:0},{y:0,opacity:1,duration:.3,ease:"back.out(1.7)"}),setTimeout(()=>{"undefined"!=typeof gsap?gsap.to(t,{y:-20,opacity:0,duration:.2,ease:"power2.in",onComplete:()=>{t.classList.remove("active")}}):t.classList.remove("active")},3e3)}updateFavoritesDisplay(){const e=document.getElementById("favorites-grid"),t=document.getElementById("favorites-empty");e&&t&&(e.innerHTML="",0===this.favorites.size?(e.style.display="none",t.style.display="block"):(e.style.display="grid",t.style.display="none",this.favorites.forEach(t=>{const a=document.querySelector(`[data-item-id="${t}"]`);if(!a)return;const o=a.closest(".brag-book-gallery-carousel-item");if(!o)return;const r=o.querySelector("img");if(!r)return;const s=document.createElement("div");s.className="brag-book-gallery-favorites-item",s.dataset.itemId=t;const i=r.cloneNode(!0);s.appendChild(i);const l=document.createElement("button");l.className="brag-book-gallery-favorites-item-remove",l.innerHTML="Ã—",l.title="Remove from favorites",l.onclick=e=>{e.stopPropagation(),this.removeFavorite(t)},s.appendChild(l),e.appendChild(s)})))}updateUI(){const e=document.querySelectorAll("[data-favorites-count]"),t=this.favorites.size;e.forEach(e=>{"undefined"!=typeof gsap?gsap.to(e,{opacity:0,duration:.1,onComplete:()=>{e.textContent=`(${t})`,gsap.to(e,{opacity:1,duration:.1})}}):e.textContent=`(${t})`}),this.updateFavoritesDisplay()}loadFromStorage(){try{const e=localStorage.getItem(this.options.storageKey);if(e){const t=JSON.parse(e);this.favorites=new Set(t),t.forEach(e=>{document.querySelectorAll(`[data-item-id="${e}"], [data-case-id="${e}"]`).forEach(e=>{void 0!==e.dataset.favorited&&(e.dataset.favorited="true")})})}}catch(e){console.error("Failed to load favorites from storage:",e)}}saveToStorage(){try{localStorage.setItem(this.options.storageKey,JSON.stringify([...this.favorites]))}catch(e){console.error("Failed to save favorites to storage:",e)}}loadUserInfo(){try{const e=localStorage.getItem(this.options.userInfoKey);e&&(this.userInfo=JSON.parse(e),this.hasShownDialog=!0)}catch(e){console.error("Failed to load user info from storage:",e)}}saveUserInfo(){try{localStorage.setItem(this.options.userInfoKey,JSON.stringify(this.userInfo))}catch(e){console.error("Failed to save user info to storage:",e)}}getFavorites(){return this.favorites}clear(){this.favorites.clear(),this.options.persistToStorage&&this.saveToStorage(),this.updateUI()}},s=class{constructor(e={}){this.options={shareMenuId:e.shareMenuId||"shareMenu",animateWithGsap:"undefined"!=typeof gsap,onShare:e.onShare||(()=>{}),...e},this.shareMenu=document.getElementById(this.options.shareMenuId),this.activeButton=null,this.activeItem=null,this.init()}init(){this.setupEventListeners(),this.createShareMenu()}createShareMenu(){}setupEventListeners(){document.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-share-button");t&&(e.preventDefault(),e.stopPropagation(),this.toggleShareDropdown(t));const a=e.target.closest(".brag-book-gallery-share-dropdown-item");if(a){e.preventDefault();const t=a.dataset.shareType;t&&(this.handleShare(t),this.hideShareDropdown())}document.querySelectorAll(".brag-book-gallery-share-dropdown.active").forEach(t=>{if(!t.contains(e.target)&&!e.target.closest(".brag-book-gallery-share-button")){t.classList.remove("active");const e=t.closest(".brag-book-gallery-share-button");e&&e.classList.remove("active")}})}),document.addEventListener("keydown",e=>{"Escape"===e.key&&document.querySelectorAll(".brag-book-gallery-share-dropdown.active").forEach(e=>{e.classList.remove("active");const t=e.closest(".brag-book-gallery-share-button");t&&t.classList.remove("active")})})}toggleShareDropdown(e){this.activeButton===e&&this.shareMenu?.classList.contains("active")?this.hideShareDropdown():this.showShareDropdown(e)}showShareDropdown(e){this.activeItem=e.closest(".brag-book-gallery-carousel-item"),this.activeButton=e;let t=e.querySelector(".brag-book-gallery-share-dropdown");if(!t){const a='\n                <div class="brag-book-gallery-share-dropdown" role="menu">\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="link" role="menuitem">Copy Link</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="email" role="menuitem">Email</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="facebook" role="menuitem">Facebook</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="twitter" role="menuitem">Twitter</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="pinterest" role="menuitem">Pinterest</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="whatsapp" role="menuitem">WhatsApp</button>\n                </div>\n            ';e.insertAdjacentHTML("beforeend",a),t=e.querySelector(".brag-book-gallery-share-dropdown")}this.shareMenu=t,e.classList.add("active"),this.shareMenu.classList.add("active"),this.options.animateWithGsap&&"undefined"!=typeof gsap&&gsap.fromTo(this.shareMenu,{y:-10,opacity:0},{y:0,opacity:1,duration:.2,ease:"power2.out"})}hideShareDropdown(){this.shareMenu&&(this.activeButton&&this.activeButton.classList.remove("active"),this.options.animateWithGsap&&"undefined"!=typeof gsap?gsap.to(this.shareMenu,{y:-10,opacity:0,duration:.15,ease:"power2.in",onComplete:()=>{this.shareMenu.classList.remove("active"),this.activeButton=null,this.activeItem=null}}):(this.shareMenu.classList.remove("active"),this.activeButton=null,this.activeItem=null))}handleShare(e){if(!this.activeItem)return;const t=this.activeItem.querySelector("img"),a=t?.src||"",o=t?.alt||"Medical procedure result",r=this.activeItem.dataset.slide||"",s=`${window.location.origin+window.location.pathname}#${r}`,i=`Check out this ${o}`;switch(e){case"link":this.copyToClipboard(s);break;case"email":this.shareViaEmail(s,i);break;case"facebook":this.shareViaFacebook(s);break;case"twitter":this.shareViaTwitter(s,i);break;case"pinterest":this.shareViaPinterest(s,a,i);break;case"whatsapp":this.shareViaWhatsApp(s,i)}this.options.onShare({type:e,url:s,text:i})}copyToClipboard(e){navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{this.showNotification("Link copied to clipboard!")}).catch(()=>{this.fallbackCopyToClipboard(e)}):this.fallbackCopyToClipboard(e)}fallbackCopyToClipboard(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-999999px",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),this.showNotification("Link copied to clipboard!")}catch(e){this.showNotification("Failed to copy link")}document.body.removeChild(t)}shareViaEmail(e,t){const a=encodeURIComponent("Check out this medical procedure result"),o=encodeURIComponent(`${t}\n\n${e}`);window.location.href=`mailto:?subject=${a}&body=${o}`}shareViaFacebook(e){const t=`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(e)}`;this.openShareWindow(t,"facebook")}shareViaTwitter(e,t){const a=`https://twitter.com/intent/tweet?url=${encodeURIComponent(e)}&text=${encodeURIComponent(t)}`;this.openShareWindow(a,"twitter")}shareViaPinterest(e,t,a){const o=`https://pinterest.com/pin/create/button/?url=${encodeURIComponent(e)}&media=${encodeURIComponent(t)}&description=${encodeURIComponent(a)}`;this.openShareWindow(o,"pinterest")}shareViaWhatsApp(e,t){const a=`https://wa.me/?text=${encodeURIComponent(`${t} ${e}`)}`;this.openShareWindow(a,"whatsapp")}openShareWindow(e,t){const a=(window.innerWidth-600)/2,o=(window.innerHeight-400)/2;window.open(e,`share-${t}`,`width=600,height=400,left=${a},top=${o},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`)}showNotification(e){let t=document.getElementById("shareNotification");t||(t=document.createElement("div"),t.id="shareNotification",t.className="brag-book-gallery-share-notification",document.body.appendChild(t)),t.textContent=e,t.classList.add("active"),this.options.animateWithGsap&&"undefined"!=typeof gsap&&gsap.fromTo(t,{y:-20,opacity:0},{y:0,opacity:1,duration:.3,ease:"back.out(1.7)"}),setTimeout(()=>{this.options.animateWithGsap&&"undefined"!=typeof gsap?gsap.to(t,{y:-20,opacity:0,duration:.2,ease:"power2.in",onComplete:()=>{t.classList.remove("active")}}):t.classList.remove("active")},3e3)}async shareNative(e){if(navigator.share)try{return await navigator.share({title:e.title||"Medical Procedure Result",text:e.text,url:e.url}),!0}catch(e){return"AbortError"!==e.name&&console.error("Share failed:",e),!1}return!1}},i=class{constructor(e,t={}){this.wrapper=e,this.input=e.querySelector(".brag-book-gallery-search-input"),this.dropdown=e.querySelector(".brag-book-gallery-search-dropdown"),this.searchIcon=e.querySelector(".brag-book-gallery-search-icon"),this.options={minChars:t.minChars||1,debounceDelay:t.debounceDelay||200,maxResults:t.maxResults||10,onSelect:t.onSelect||(()=>{}),...t},this.procedures=[],this.filteredResults=[],this.selectedIndex=-1,this.isOpen=!1,this.debounceTimer=null,this.input&&this.dropdown&&this.init()}init(){this.collectProcedures(),this.setupEventListeners()}collectProcedures(){const e=document.querySelectorAll(".brag-book-gallery-nav-link"),t=new Map;e.forEach(e=>{const a=e.dataset.procedure,o=e.dataset.category,r=e.querySelector(".brag-book-gallery-filter-option-label")?.textContent||a,s=parseInt(e.dataset.procedureCount||"0");if(a&&o){const e=`${o}:${a}`;t.has(e)||t.set(e,{id:a,name:r.trim(),category:o,count:s,searchText:r.toLowerCase(),fullName:`${r} (${s})`})}}),this.procedures=Array.from(t.values())}setupEventListeners(){this.input.addEventListener("input",e=>this.handleInput(e)),this.input.addEventListener("focus",()=>this.handleFocus()),this.input.addEventListener("blur",e=>this.handleBlur(e)),this.input.addEventListener("keydown",e=>this.handleKeydown(e)),document.addEventListener("click",e=>{this.wrapper.contains(e.target)||this.close()}),this.dropdown.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-search-item");t&&this.selectItem(t)})}handleInput(e){const t=e.target.value.trim();this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{t.length>=this.options.minChars?this.search(t):this.close()},this.options.debounceDelay)}handleFocus(){const e=this.input.value.trim();e.length>=this.options.minChars&&this.search(e)}handleBlur(e){setTimeout(()=>{this.wrapper.contains(document.activeElement)||this.close()},200)}handleKeydown(e){if(this.isOpen)switch(e.key){case"ArrowDown":e.preventDefault(),this.moveSelection(1);break;case"ArrowUp":e.preventDefault(),this.moveSelection(-1);break;case"Enter":if(e.preventDefault(),this.selectedIndex>=0){const e=this.dropdown.querySelector(`[data-index="${this.selectedIndex}"]`);e&&this.selectItem(e)}break;case"Escape":this.close(),this.input.blur()}else"ArrowDown"===e.key&&this.input.value.trim().length>=this.options.minChars&&(e.preventDefault(),this.search(this.input.value.trim()))}search(e){const t=e.toLowerCase();this.filteredResults=this.procedures.filter(e=>e.searchText.includes(t)||e.category.includes(t)).slice(0,this.options.maxResults),this.filteredResults.sort((e,a)=>{const o=e.searchText===t,r=a.searchText===t;if(o&&!r)return-1;if(!o&&r)return 1;const s=e.searchText.startsWith(t),i=a.searchText.startsWith(t);return s&&!i?-1:!s&&i?1:0}),this.renderResults(e),this.open()}renderResults(e){if(0===this.filteredResults.length)return void(this.dropdown.innerHTML=`\n                <div class="brag-book-gallery-search-no-results">\n                    No procedures found for "${this.escapeHtml(e)}"\n                </div>\n            `);const t=this.filteredResults.map((t,a)=>{const o=this.highlightMatch(t.name,e),r=1===t.count?"case":"cases";return`\n                <div class="brag-book-gallery-search-item"\n                     role="option"\n                     data-index="${a}"\n                     data-procedure="${t.id}"\n                     data-category="${t.category}"\n                     aria-selected="${a===this.selectedIndex}">\n                    <div class="brag-book-gallery-search-item-content">\n                        <span class="brag-book-gallery-search-item-name">${o}</span>\n                        <span class="brag-book-gallery-search-item-count">${t.count} ${r}</span>\n                    </div>\n                    <span class="brag-book-gallery-search-item-category">${t.category}</span>\n                </div>\n            `}).join("");this.dropdown.innerHTML=t,this.selectedIndex=-1}highlightMatch(e,t){const a=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp(`(${a})`,"gi");return e.replace(o,"<mark>$1</mark>")}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}moveSelection(e){const t=this.dropdown.querySelectorAll(".brag-book-gallery-search-item");0!==t.length&&(this.selectedIndex+=e,this.selectedIndex<0?this.selectedIndex=t.length-1:this.selectedIndex>=t.length&&(this.selectedIndex=0),t.forEach((e,t)=>{const a=t===this.selectedIndex;e.setAttribute("aria-selected",a),a&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}))}selectItem(e){const t=e.dataset.procedure,a=e.dataset.category,o=e.querySelector(".brag-book-gallery-search-item-name"),r=o?o.textContent.replace(/<mark>/g,"").replace(/<\/mark>/g,""):"";this.input.value=r,this.close(),this.options.onSelect({procedure:t,category:a,name:r});const s=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${t}"]`);s&&s.click()}open(){this.isOpen||(this.isOpen=!0,this.dropdown.classList.add("active"),this.wrapper.classList.add("active"),this.input.setAttribute("aria-expanded","true"))}close(){this.isOpen&&(this.isOpen=!1,this.dropdown.classList.remove("active"),this.wrapper.classList.remove("active"),this.input.setAttribute("aria-expanded","false"),this.selectedIndex=-1)}};class l{constructor(){this.nudityAccepted=!1,this.storageKey="brag-book-nudity-accepted",this.checkInitialAcceptance(),this.init()}checkInitialAcceptance(){try{const e=localStorage.getItem(this.storageKey);this.nudityAccepted="true"===e,this.nudityAccepted&&document.body.classList.add("nudity-accepted")}catch(e){console.warn("Could not load nudity acceptance status from localStorage:",e),this.nudityAccepted=!1}}init(){this.setupEventListeners()}saveAcceptanceStatus(){try{localStorage.setItem(this.storageKey,"true")}catch(e){console.warn("Could not save nudity acceptance status to localStorage:",e)}}setupEventListeners(){document.addEventListener("click",e=>{e.target.matches(".brag-book-gallery-nudity-warning-button")?this.handleProceedButtonClick(e.target):(e.target.matches(".brag-book-gallery-nudity-warning")||e.target.closest(".brag-book-gallery-nudity-warning"))&&(e.target.matches(".brag-book-gallery-nudity-warning-button")||e.target.closest(".brag-book-gallery-nudity-warning-button")||(e.stopPropagation(),e.preventDefault()))})}handleProceedButtonClick(e){this.nudityAccepted=!0,this.saveAcceptanceStatus(),document.body.classList.add("nudity-accepted"),this.animateRemoval()}animateRemoval(){const e=document.querySelectorAll(".brag-book-gallery-nudity-warning"),t=document.querySelectorAll(".brag-book-gallery-nudity-blur");e.forEach(e=>{"undefined"!=typeof gsap?gsap.to(e,{opacity:0,duration:.5,ease:"power2.out",onComplete:()=>{e.style.display="none"}}):(e.style.transition="opacity 0.5s ease-out",e.style.opacity="0",setTimeout(()=>{e.style.display="none"},500))}),t.forEach(e=>{"undefined"!=typeof gsap?gsap.to(e,{filter:"blur(0px)",duration:.5,ease:"power2.out"}):(e.style.transition="filter 0.5s ease-out",e.style.filter="blur(0px)")})}resetAcceptance(){this.nudityAccepted=!1;try{localStorage.removeItem(this.storageKey),document.body.classList.remove("nudity-accepted"),console.log("âœ… Nudity warning acceptance has been reset. Refresh the page to see warnings again.")}catch(e){console.warn("Could not remove nudity acceptance status from localStorage:",e)}}}class n{constructor(){this.init()}init(){document.querySelectorAll('[data-phone-format="true"]').forEach(e=>{this.setupPhoneInput(e)})}setupPhoneInput(e){e.addEventListener("input",e=>{this.formatPhoneNumber(e.target)}),e.addEventListener("paste",e=>{setTimeout(()=>{this.formatPhoneNumber(e.target)},0)}),e.addEventListener("keypress",e=>{const t=String.fromCharCode(e.which);/[0-9]/.test(t)||8===e.which||46===e.which||e.preventDefault()})}formatPhoneNumber(e){let t=e.value.replace(/\D/g,"");t=t.substring(0,10);let a="";t.length>0&&(a=t.length<=3?`(${t}`:t.length<=6?`(${t.substring(0,3)}) ${t.substring(3)}`:`(${t.substring(0,3)}) ${t.substring(3,6)}-${t.substring(6,10)}`),e.value=a,10===t.length?e.setCustomValidity(""):e.hasAttribute("required")&&t.length>0&&e.setCustomValidity("Please enter a complete 10-digit phone number")}}var c=class{constructor(){this.components={},window.bragBookGalleryApp=this,this.init()}async init(){if(await this.handleDirectCaseUrl())return this.initializeDialogs(),this.initializeMobileMenu(),this.initializeCaseLinks(),this.initializeNudityWarning(),this.initializeShareManager(),this.initializeFavorites(),void this.initializeCasePreloading();this.initializeCarousels(),this.initializeDialogs(),this.initializeFilters(),this.initializeMobileMenu(),this.initializeFavorites(),this.initializeSearch(),this.initializeShareManager(),this.initializeConsultationForm(),this.initializeCaseLinks(),this.initializeNudityWarning(),this.initializeCasePreloading();const e=document.getElementById("gallery-content");e&&"true"===e.dataset.favoritesPage&&setTimeout(()=>{this.showFavoritesOnly()},100)}initializeCarousels(){const t=document.querySelectorAll(".brag-book-gallery-carousel-wrapper");let a;this.components.carousels=[],t.forEach((t,a)=>{const o=0===a?{infinite:!0,autoplay:!0,autoplayDelay:4e3,pauseOnHover:!0}:{infinite:!1,autoplay:!1};this.components.carousels.push(new e(t,o))}),window.addEventListener("resize",()=>{clearTimeout(a),a=setTimeout(()=>{this.components.carousels.forEach(e=>e.refresh())},250)})}initializeDialogs(){this.components.consultationDialog=new t("consultationDialog",{onOpen:()=>{},onClose:()=>{}}),document.querySelectorAll('[data-action="request-consultation"]').forEach(e=>{e.addEventListener("click",()=>{this.components.consultationDialog.open()})})}initializeFilters(){const e=document.querySelector(".brag-book-gallery-nav"),t=e?.dataset.filterMode||"javascript";this.components.filterSystem=new a(e,{mode:t,baseUrl:"/gallery",onFilterChange:e=>{this.applyFilters(e)},onNavigate:e=>{window.location.href=e}}),this.initializeClearAllButton(),this.initializeDemographicFilterBadges()}initializeMobileMenu(){this.components.mobileMenu=new o}initializeFavorites(){if(this.components.favoritesManager=new r({onUpdate:e=>{this.updateFavoritesCount(e.size)}}),this.components.favoritesManager){const e=this.components.favoritesManager.getFavorites().size;this.updateFavoritesCount(e)}this.initializeFavoritesButton(),window.addEventListener("favoritesUpdated",e=>{const t=window.location.pathname;(t===`/${window.bragBookGalleryConfig?.gallerySlug||"before-after"}/myfavorites/`||t.includes("myfavorites"))&&setTimeout(()=>{this.showFavoritesOnly()},100)})}initializeSearch(){const e=document.querySelectorAll(".brag-book-gallery-search-wrapper");this.components.searchAutocompletes=[],e.forEach(e=>{const t=new i(e,{minChars:1,debounceDelay:200,maxResults:10,onSelect:e=>{}});this.components.searchAutocompletes.push(t)})}initializeShareManager(){"undefined"!=typeof bragBookGalleryConfig&&"yes"===bragBookGalleryConfig.enableSharing&&(this.components.shareManager=new s({onShare:e=>{}}))}initializeConsultationForm(){const e=document.querySelector('[data-form="consultation"]');e&&e.addEventListener("submit",e=>{e.preventDefault(),this.handleFormSubmit(e.target)});const t=document.getElementById("consultationDialog");t&&new MutationObserver(e=>{e.forEach(e=>{"attributes"===e.type&&"open"===e.attributeName&&t.hasAttribute("open")&&this.hideModalMessage()})}).observe(t,{attributes:!0})}initializeCaseLinks(){document.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-case-card-link");if(t){e.preventDefault(),e.stopPropagation();const a=t.dataset.caseId,o=t.dataset.procedureIds;if(a){const e=t.closest(".brag-book-gallery-case-card");e&&(e.style.opacity="0.6",e.style.transform="scale(0.98)",e.style.transition="opacity 0.2s ease, transform 0.2s ease"),this.loadCaseDetails(a,t.href,!0,o)}return}const a=e.target.closest(".brag-book-gallery-case-card");if(a&&!e.target.closest("button")&&!e.target.closest("details")){const t=a.querySelector(".brag-book-gallery-case-card-link");if(t&&t.href){e.preventDefault();const o=t.dataset.caseId,r=t.dataset.procedureIds||a.dataset.procedureIds;o&&(a.style.opacity="0.6",a.style.transform="scale(0.98)",a.style.transition="opacity 0.2s ease, transform 0.2s ease",this.loadCaseDetails(o,t.href,!0,r))}}const o=e.target.closest(".brag-book-gallery-nav-button");if(o&&!o.closest("summary")){e.preventDefault(),e.stopPropagation();const t=o.href;if(t){const e=new URL(t).pathname.split("/").filter(e=>e);if(e.length>=3){const a=e[e.length-1],r=e[e.length-2];let s="";const i=document.querySelector("[data-case-id]");if(i&&i.dataset.procedureIds&&(s=i.dataset.procedureIds,console.log("Using procedure IDs from current case element:",s)),!s){const e=window.bragBookGalleryConfig?.sidebarData;if(e&&r)for(const t of Object.values(e)){if(t.procedures)for(const e of t.procedures)if(e.slug===r){s=e.ids?e.ids.join(","):"",console.log("Using procedure IDs from sidebar data:",s);break}if(s)break}}if(!s){const e=window.location.pathname.split("/").filter(e=>e);if(e.length>=2&&e[e.length-2]===r){const e=document.querySelector("[data-procedure-ids]");e&&e.dataset.procedureIds&&(s=e.dataset.procedureIds,console.log("Using procedure IDs from any case element:",s))}}a&&(o.style.opacity="0.7",o.style.transition="opacity 0.2s ease",console.log(`Loading case ${a} with procedure context: ${s}`),this.loadCaseDetails(a,t,!0,s))}}return}}),this.initializeCaseDetailThumbnails(),window.addEventListener("popstate",e=>{e.state&&e.state.caseId?this.loadCaseDetails(e.state.caseId,window.location.href,!1):window.location.reload()})}async handleDirectCaseUrl(){const e=window.location.pathname.split("/").filter(e=>e);if(e.length>=3){const t=e[e.length-1];if(/^\d+$/.test(t)){const a=t,o=e[e.length-2];if(document.getElementById("gallery-content"))try{let e=null;return window.bragBookGalleryConfig?.sidebarData&&o&&(e=this.getProcedureIdsFromSlug(o),e&&console.log(`ðŸ”— Direct case load with procedure context: case ${a}, procedure ${o}, IDs: ${e}`)),await this.loadCaseDetails(a,window.location.href,!1,e),!0}catch(e){return console.warn("Failed to load direct case URL:",e),!1}}}return!1}async loadCaseDetails(e,t,a=!0,o=null){const r=document.getElementById("gallery-content");if(r)if(this.currentCaseLoad)console.log("Debouncing case load request");else{if(this.currentCaseLoad=e,!o){const t=document.querySelector(`.brag-book-gallery-case-card[data-case-id="${e}"]`);t&&t.dataset.procedureIds&&(o=t.dataset.procedureIds)}a&&window.history&&window.history.pushState&&window.history.pushState({caseId:e},"",t),r.innerHTML='<div class="brag-book-gallery-loading">Loading case details...</div>',window.scrollTo({top:0,behavior:"smooth"});try{if("undefined"==typeof bragBookGalleryConfig)throw new Error("Configuration not loaded");if(this.casePreloadCache&&this.casePreloadCache.has(e)){const t=this.casePreloadCache.get(e);if(t&&"loading"!==t){console.log(`âš¡ Loading case ${e} from preload cache`),r.innerHTML=t,this.setActiveSidebarForCase(e);const a=document.querySelector(".brag-book-gallery-wrapper");return a?a.scrollIntoView({behavior:"smooth",block:"start"}):r.scrollIntoView({behavior:"smooth",block:"start"}),void(this.currentCaseLoad=null)}}console.log("ðŸ”„ Using AJAX method for consistent server-side HTML rendering"),await this.loadCaseDetailsViaAjax(e,t,o)}catch(e){let t="Failed to load case details. Please try again.";e.message&&(t+="<br><small>"+e.message+"</small>"),r.innerHTML='<div class="brag-book-gallery-error">'+t+"</div>"}finally{this.currentCaseLoad=null}}}async loadCaseDetailsViaAjax(e,t,a){const o=document.getElementById("gallery-content");if(o)try{const t=window.location.pathname.split("/").filter(e=>e),r=t.length>2?t[t.length-2]:"";let s="";const i=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${r}"]`);if(i){const e=i.querySelector(".brag-book-gallery-filter-option-label");e&&(s=e.textContent.trim())}if(!s&&window.bragBookGalleryConfig&&window.bragBookGalleryConfig.sidebarData){const e=window.bragBookGalleryConfig.sidebarData;for(const t of Object.values(e)){if(t.procedures)for(const e of t.procedures)if(e.slug===r){s=e.name;break}if(s)break}}const l={action:"brag_book_gallery_load_case_details_html",case_id:e,procedure_slug:r,procedure_name:s,nonce:bragBookGalleryConfig.nonce||""};a?(l.procedure_ids=a,console.log(`ðŸ”— AJAX call with procedure context: case ${e}, procedure IDs ${a}`)):console.warn(`âš ï¸ AJAX call WITHOUT procedure context: case ${e} (no procedure IDs provided)`);const n=await fetch(bragBookGalleryConfig.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(l)});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const c=await n.json();if(!(c.success&&c.data&&c.data.html))throw new Error(c.data?.message||c.data||c.message||"Failed to load case details");{console.log(`âœ… AJAX response received for case ${e}:`,{hasHtml:!!c.data.html,hasSeo:!!c.data.seo,hasNavigation:c.data.html.includes("brag-book-gallery-case-nav-buttons"),htmlLength:c.data.html.length}),o.innerHTML=c.data.html,this.setActiveSidebarForCase(e);const t=document.querySelector(".brag-book-gallery-wrapper");if(t?t.scrollIntoView({behavior:"smooth",block:"start"}):o.scrollIntoView({behavior:"smooth",block:"start"}),c.data.seo&&(c.data.seo.title&&(document.title=c.data.seo.title),c.data.seo.description)){let e=document.querySelector('meta[name="description"]');e||(e=document.createElement("meta"),e.name="description",document.head.appendChild(e)),e.content=c.data.seo.description}c.data.view_tracked?console.log(`âœ… Case view tracked successfully for Case ID: ${c.data.case_id}`):!1===c.data.view_tracked&&(console.warn(`âš ï¸ Case view tracking failed for Case ID: ${c.data.case_id}`),c.data.debug&&(console.group("View Tracking Debug Info:"),console.log("Tracking attempted:",c.data.debug.view_tracking_attempted),console.log("View tracked:",c.data.debug.view_tracked),c.data.debug.tracking_error&&console.error("Tracking error:",c.data.debug.tracking_error),console.groupEnd())),this.casePreloadCache&&e&&this.casePreloadCache.set(e,c.data.html),this.initializeCaseDetailThumbnails()}}catch(e){let t="Failed to load case details via AJAX. Please try again.";e.message&&(t+="<br><small>"+e.message+"</small>"),o.innerHTML='<div class="brag-book-gallery-error">'+t+"</div>"}finally{this.currentCaseLoad=null}}displayCaseDetails(e){const t=document.getElementById("gallery-content");if(!t)return;let a='<div class="brag-book-gallery-case-card-details">';a+='<button class="brag-book-gallery-back-button" onclick="history.back()">â† Back to Gallery</button>',a+='<div class="brag-book-gallery-case-header">',a+=`<h2>${e.procedureName||"Case Details"}</h2>`,a+='<div class="case-metadata">',e.caseNumber&&(a+=`<span class="case-number">Case #${e.caseNumber}</span>`),e.technique&&(a+=`<span class="case-technique">Technique: ${e.technique}</span>`),e.age&&(a+=`<span class="case-age">Age: ${e.age}</span>`),e.gender&&(a+=`<span class="case-gender">Gender: ${e.gender}</span>`),a+="</div>",a+="</div>",e.photos&&e.photos.length>0?(a+='<div class="brag-book-gallery-case-images">',e.photos.forEach((e,t)=>{(e.beforeImage||e.afterImage)&&(a+='<div class="brag-book-gallery-case-image-pair">',e.isProcessed&&e.beforeImage?(a+='<div class="processed-image">',a+=`<img src="${e.beforeImage}" alt="Before and After" />`,e.caption&&(a+=`<p class="image-caption">${e.caption}</p>`),a+="</div>"):(e.beforeImage&&(a+='<div class="before-image">',a+="<h3>Before</h3>",a+=`<img src="${e.beforeImage}" alt="Before" loading="lazy" />`,a+="</div>"),e.afterImage&&(a+='<div class="after-image">',a+="<h3>After</h3>",a+=`<img src="${e.afterImage}" alt="After" loading="lazy" />`,a+="</div>"),e.caption&&(a+=`<p class="image-caption">${e.caption}</p>`)),a+="</div>")}),a+="</div>"):a+='<div class="brag-book-gallery-no-images">No images available for this case.</div>',e.description&&(a+='<div class="brag-book-gallery-case-description">',a+="<h3>Details</h3>",e.description.includes("<")?a+=e.description:a+=`<p>${e.description}</p>`,a+="</div>"),a+="</div>",t.innerHTML=a,t.scrollIntoView({behavior:"smooth",block:"start"})}handleSearch(e){e.toLowerCase().trim()}applyFilters(e){}async handleFormSubmit(e){const t=new FormData(e),a=Object.fromEntries(t.entries()),o=e.querySelector('[data-action="form-submit"]'),r=o?o.textContent:"";o&&(o.disabled=!0,o.textContent="Sending...");try{if("undefined"==typeof bragBookGalleryConfig)throw new Error("Configuration not loaded. Please refresh the page.");const t=new URLSearchParams({action:"handle_form_submission",nonce:bragBookGalleryConfig.consultation_nonce||bragBookGalleryConfig.nonce,name:a.name||"",email:a.email||"",phone:a.phone||"",description:a.message||""}),o=await fetch(bragBookGalleryConfig.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t,credentials:"same-origin"}),r=await o.json();if(r.success)this.showModalMessage("Thank you for your consultation request! We will contact you soon.","success"),setTimeout(()=>{e.reset(),this.hideModalMessage(),this.components&&this.components.consultationDialog&&setTimeout(()=>{this.components.consultationDialog.close()},1e3)},3e3);else{const e=r.data||"Failed to send consultation request. Please try again.";this.showModalMessage(e,"error")}}catch(e){this.showModalMessage(e.message||"An error occurred. Please try again.","error")}finally{o&&(o.disabled=!1,o.textContent=r)}}showModalMessage(e,t="info"){const a=document.getElementById("consultationMessage"),o=a?.querySelector(".brag-book-gallery-form-message-content");if(!a||!o)return void this.showNotification(e,t);o.textContent=e,a.className="brag-book-gallery-form-message",a.classList.add(`brag-book-gallery-form-message-${t}`),a.style.display="block";const r=a.closest(".brag-book-gallery-dialog-content");r&&(r.scrollTop=0)}hideModalMessage(){const e=document.getElementById("consultationMessage");if(e){e.style.display="none";const t=e.querySelector(".brag-book-gallery-form-message-content");t&&(t.textContent="")}}initializeCaseDetailThumbnails(){document.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-thumbnail-item");if(!t)return;const a=document.querySelector(".brag-book-gallery-main-image-container");if(!a)return;const o=document.querySelectorAll(".brag-book-gallery-thumbnail-item");if(!o.length)return;o.forEach(e=>e.classList.remove("active")),t.classList.add("active");const r=t.dataset.processedUrl,s=t.dataset.imageIndex;a.dataset.imageIndex=s;let i="";if(r){const e=a.querySelector(".brag-book-gallery-favorite-button"),t=e?e.dataset.itemId.replace("_main",""):"";i=`\n\t\t\t\t\t<div class="brag-book-gallery-main-single">\n\t\t\t\t\t\t<img src="${r}" alt="Case Image" loading="eager">\n\t\t\t\t\t\t<div class="brag-book-gallery-item-actions">\n\t\t\t\t\t\t\t<button class="brag-book-gallery-favorite-button" data-favorited="false" data-item-id="${t}_main" aria-label="Add to favorites">\n\t\t\t\t\t\t\t\t<svg fill="rgba(255, 255, 255, 0.5)" stroke="white" stroke-width="2" viewBox="0 0 24 24">\n\t\t\t\t\t\t\t\t\t<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t`,"undefined"!=typeof bragBookGalleryConfig&&"yes"===bragBookGalleryConfig.enableSharing&&(i+=`\n\t\t\t\t\t\t\t<button class="brag-book-gallery-share-button" data-item-id="${t}_main" aria-label="Share this image">\n\t\t\t\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">\n\t\t\t\t\t\t\t\t\t<path d="M672.22-100q-44.91 0-76.26-31.41-31.34-31.41-31.34-76.28 0-6 4.15-29.16L284.31-404.31q-14.46 15-34.36 23.5t-42.64 8.5q-44.71 0-76.01-31.54Q100-435.39 100-480q0-44.61 31.3-76.15 31.3-31.54 76.01-31.54 22.74 0 42.64 8.5 19.9 8.5 34.36 23.5l284.46-167.08q-2.38-7.38-3.27-14.46-.88-7.08-.88-15.08 0-44.87 31.43-76.28Q627.49-860 672.4-860t76.25 31.44Q780-797.13 780-752.22q0 44.91-31.41 76.26-31.41 31.34-76.28 31.34-22.85 0-42.5-8.69Q610.15-662 595.69-677L311.23-509.54q2.38 7.39 3.27 14.46.88 7.08.88 15.08t-.88 15.08q-.89 7.07-3.27 14.46L595.69-283q14.46-15 34.12-23.69 19.65-8.69 42.5-8.69 44.87 0 76.28 31.43Q780-252.51 780-207.6t-31.44 76.25Q717.13-100 672.22-100Zm.09-60q20.27 0 33.98-13.71Q720-187.42 720-207.69q0-20.27-13.71-33.98-13.71-13.72-33.98-13.72-20.27 0-33.98 13.72-13.72 13.71-13.72 33.98 0 20.27 13.72 33.98Q652.04-160 672.31-160Zm-465-272.31q20.43 0 34.25-13.71 13.83-13.71 13.83-33.98 0-20.27-13.83-33.98-13.82-13.71-34.25-13.71-20.11 0-33.71 13.71Q160-500.27 160-480q0 20.27 13.6 33.98 13.6 13.71 33.71 13.71Zm465-272.3q20.27 0 33.98-13.72Q720-732.04 720-752.31q0-20.27-13.71-33.98Q692.58-800 672.31-800q-20.27 0-33.98 13.71-13.72 13.71-13.72 33.98 0 20.27 13.72 33.98 13.71 13.72 33.98 13.72Zm0 496.92ZM207.69-480Zm464.62-272.31Z"/>\n\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t`),i+="\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t"}a.innerHTML=i,window.bragBookGalleryApp&&window.bragBookGalleryApp.components&&(window.bragBookGalleryApp.components.favoritesManager&&window.bragBookGalleryApp.components.favoritesManager.initializeFavoriteButtons(),window.bragBookGalleryApp.components.shareManager&&window.bragBookGalleryApp.components.shareManager.initializeShareButtons())})}showNotification(e,t="info"){let a=document.querySelector(".brag-book-notification");a||(a=document.createElement("div"),a.className="brag-book-notification",a.style.cssText="\n\t\t\t\tposition: fixed;\n\t\t\t\ttop: 20px;\n\t\t\t\tright: 20px;\n\t\t\t\tpadding: 15px 20px;\n\t\t\t\tborder-radius: 4px;\n\t\t\t\tz-index: 10000;\n\t\t\t\ttransition: opacity 0.3s ease;\n\t\t\t\tmax-width: 350px;\n\t\t\t",document.body.appendChild(a));const o={success:"#4caf50",error:"#f44336",info:"#2196f3"};a.style.backgroundColor=o[t]||o.info,a.style.color="white",a.textContent=e,a.style.opacity="1",setTimeout(()=>{a.style.opacity="0",setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},300)},5e3)}initializeClearAllButton(){const e=()=>{const e=document.querySelector('[data-action="clear-filters"]');return!!e&&(e.removeEventListener("click",this.handleClearAll),e.addEventListener("click",this.handleClearAll.bind(this)),!0)};e()||setTimeout(()=>{e()},1e3),document.addEventListener("click",e=>{e.target&&"clear-filters"===e.target.dataset.action&&(e.preventDefault(),this.handleClearAll(e))})}handleClearAll(e){e.preventDefault(),this.clearDemographicFilters()}initializeDemographicFilterBadges(){window.updateDemographicFilterBadges=e=>{this.updateDemographicBadges(e)},window.applyProcedureFilters,this.monitorDemographicFilters(),document.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-badge-remove");if(t){e.preventDefault(),e.stopPropagation();const a=t.closest(".brag-book-gallery-filter-badge");if(a){const e=a.getAttribute("data-filter-category"),t=a.getAttribute("data-filter-value");e&&t&&this.removeDemographicFilter(e,t)}}})}monitorDemographicFilters(){const e=console.log;console.log=(...t)=>{e.apply(console,t),t.length>=2&&"Active filters:"===t[0]&&"object"==typeof t[1]&&this.updateDemographicBadges(t[1])},document.addEventListener("change",e=>{"checkbox"===e.target.type&&e.target.closest(".brag-book-gallery-filter-group")&&setTimeout(()=>{const e=this.buildActiveFiltersFromDOM();this.updateDemographicBadges(e)},100)});let t="";setInterval(()=>{const e=this.buildActiveFiltersFromDOM(),a=JSON.stringify(e);a!==t&&(this.updateDemographicBadges(e),t=a)},1e3)}buildActiveFiltersFromDOM(){const e={age:[],gender:[],ethnicity:[],height:[],weight:[]};return document.querySelectorAll('.brag-book-gallery-filter-group input[type="checkbox"]:checked').forEach(t=>{const a=t.closest(".brag-book-gallery-filter-group"),o=a?.querySelector("summary"),r=o?.textContent?.toLowerCase()||"",s=t.nextElementSibling,i=s?.textContent?.trim()||t.value||"";r.includes("age")||i.includes("-")?e.age.push(i):r.includes("gender")||["male","female"].some(e=>i.toLowerCase().includes(e))?e.gender.push(i):r.includes("ethnicity")?e.ethnicity.push(i):r.includes("height")||i.includes("ft")||i.includes("'")?e.height.push(i):(r.includes("weight")||i.includes("lbs")||i.includes("kg"))&&e.weight.push(i)}),e}updateDemographicBadges(e){const t=document.querySelector('[data-action="filter-badges"]'),a=document.querySelector('[data-action="clear-filters"]');if(!t||!a)return;t.innerHTML="";let o=!1;e&&Object.keys(e).forEach(a=>{const r=e[a];r&&r.length>0&&(o=!0,r.forEach(e=>{const o=this.createDemographicBadge(a,e);t.appendChild(o)}))});const r=t.querySelectorAll("[data-filter-key]"),s=o||r.length>0;a.style.display=s?"inline-block":"none"}createDemographicBadge(e,t){const a=document.createElement("div");a.className="brag-book-gallery-filter-badge",a.setAttribute("data-filter-category",e),a.setAttribute("data-filter-value",t);let o="",r=t;switch(e){case"age":o=`Age: ${t}`;break;case"gender":o=`Gender: ${t}`,r=t.replace(/^(Male|Female)$/i,e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase());break;case"ethnicity":o=`Ethnicity: ${t}`;break;case"height":o=`Height: ${t}`;break;case"weight":o=`Weight: ${t}`;break;default:o=`${e}: ${t}`}return a.innerHTML=`\n\t\t\t<span class="brag-book-gallery-badge-text">${o}</span>\n\t\t\t<button class="brag-book-gallery-badge-remove" aria-label="Remove ${o} filter">\n\t\t\t\t<svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">\n\t\t\t\t\t<path d="M13 1L1 13M1 1l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n\t\t\t\t</svg>\n\t\t\t</button>\n\t\t`,a.querySelector(".brag-book-gallery-badge-remove").addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),this.removeDemographicFilter(e,t)}),a}createProcedureBadge(e,t,a){const o=document.createElement("div");o.className="brag-book-gallery-filter-badge",o.setAttribute("data-filter-key",a);let r=t;return o.innerHTML=`\n\t\t\t<span class="brag-book-gallery-badge-text">${r}</span>\n\t\t\t<button class="brag-book-gallery-badge-remove" aria-label="Remove ${r} filter">\n\t\t\t\t<svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">\n\t\t\t\t\t<path d="M13 1L1 13M1 1l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n\t\t\t\t</svg>\n\t\t\t</button>\n\t\t`,o.querySelector(".brag-book-gallery-badge-remove").addEventListener("click",e=>{e.preventDefault(),this.components.filterSystem&&this.components.filterSystem.removeFilterBadge(a)}),o}removeDemographicFilter(e,t){let a=null;const o=`input[type="checkbox"][data-filter-type="${e}"][value="${t}"]`;if(a=document.querySelector(o),a||document.querySelectorAll(`input[type="checkbox"][data-filter-type="${e}"]`).forEach(e=>{const o=e.value,r=e.nextElementSibling,s=r?.textContent?.trim()||"";o!==t&&o.toLowerCase()!==t.toLowerCase()&&s!==t&&s.toLowerCase()!==t.toLowerCase()||(a=e)}),!a){const o=`procedure-filter-${e}-${t}`.toLowerCase().replace(/\s+/g,"-");a=document.getElementById(o)}if(a){a.checked=!1;const o=new Event("change",{bubbles:!0});a.dispatchEvent(o);const r=new Event("input",{bubbles:!0});a.dispatchEvent(r),setTimeout(()=>{const e=this.buildActiveFiltersFromDOM();this.updateDemographicBadges(e),"function"==typeof window.applyDemographicFilters&&window.applyDemographicFilters()},100);const s=document.querySelector(`.brag-book-gallery-filter-badge[data-filter-category="${e}"][data-filter-value="${t}"]`);s&&s.remove()}else console.warn(`Could not find checkbox for ${e}: ${t}`),document.querySelectorAll('input[type="checkbox"][data-filter-type]').forEach(e=>{console.log(`  - Type: ${e.getAttribute("data-filter-type")}, Value: ${e.value}, ID: ${e.id}`)})}clearDemographicFilters(){['.brag-book-gallery-filter-group input[type="checkbox"]:checked','input[type="checkbox"][data-filter-category]:checked','.brag-book-gallery-filter-option input[type="checkbox"]:checked'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{e.checked=!1,e.dispatchEvent(new Event("change",{bubbles:!0}))})}),window.clearProcedureFilters&&window.clearProcedureFilters(),setTimeout(()=>{this.updateDemographicBadges({age:[],gender:[],ethnicity:[],height:[],weight:[]})},100)}reloadGalleryContent(){const e=document.querySelector(".brag-book-gallery-filtered-results");if(e){const t=new FormData;t.append("action","brag_book_gallery_load_filtered_gallery"),t.append("nonce",window.bragBookGalleryAjax?.nonce||""),t.append("procedure_ids",""),t.append("has_nudity",document.body.classList.contains("nudity-accepted")?"1":"0"),fetch(window.bragBookGalleryAjax?.ajax_url||"/wp-admin/admin-ajax.php",{method:"POST",body:t}).then(e=>e.json()).then(t=>{t.success?e.innerHTML=t.data.html:console.error("Failed to reload gallery:",t.data?.message)}).catch(e=>{console.error("Error reloading gallery:",e)})}}updateFavoritesCount(e){document.querySelectorAll("[data-favorites-count]").forEach(t=>{t.textContent=`(${e})`})}initializeFavoritesButton(){const e=document.querySelectorAll('[data-action="show-favorites"]');e.length&&e.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),e.classList.contains("brag-book-gallery-favorites-link")?this.showFavoritesView():this.toggleFavoritesView()})})}showFavoritesView(){if(document.querySelectorAll('[data-action="show-favorites"]').forEach(e=>e.classList.add("active")),window.history&&window.history.pushState){const e=`/${window.bragBookGalleryConfig?.gallerySlug||"before-after"}/myfavorites/`;window.history.pushState({view:"favorites"},"",e)}this.showFavoritesOnly()}toggleFavoritesView(){const e=document.querySelector('[data-action="show-favorites"]:not(.brag-book-gallery-favorites-link)'),t=e?.classList.contains("active");t?(this.showAllCases(),document.querySelectorAll('[data-action="show-favorites"]').forEach(e=>{e.classList.remove("active")})):(this.showFavoritesOnly(),document.querySelectorAll('[data-action="show-favorites"]').forEach(e=>{e.classList.add("active")}))}showFavoritesOnly(){const e=document.getElementById("gallery-content");if(!e)return;const t=e.querySelector("#gallery-sections");t&&(t.style.display="none");const a="brag-book-user-info";let o=null;try{const e=localStorage.getItem(a);e&&(o=JSON.parse(e))}catch(e){console.error("Failed to load user info:",e)}if(!o||!o.email){e.innerHTML='\n\t\t\t\t<div class="brag-book-gallery-favorites-wrapper">\n\t\t\t\t\t<div class="brag-book-gallery-favorites-container">\n\t\t\t\t\t\t<div class="brag-book-gallery-favorites-form-wrapper">\n\t\t\t\t\t\t\t<svg class="brag-book-gallery-favorites-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 180">\n\t\t\t\t\t\t\t\t<path fill="#ff595c" d="M85.5,124.6l40-84.7h16.2v104.9h-12.8V60.7l-39.8,84.1h-7.2L42.2,59.7v85.1h-12.8V39.9h16.8l39.3,84.7Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#ff595c" d="M186.2,131.1l25-62.4h12.9l-32.6,80.1c-2.6,6.3-5.2,11.4-7.9,15.3-2.7,3.8-5.7,6.6-9.1,8.3-3.3,1.7-7.4,2.6-12.2,2.6s-3.4,0-4.9-.4c-1.5-.2-2.9-.6-4.2-.9v-10.6c1.3.2,2.7.4,4.2.6,1.4.2,2.9.3,4.5.3,3.9,0,7.2-1.3,9.8-3.9,2.6-2.6,5.3-7.2,8.1-13.9l-32.4-77.3h13.4l25.4,62.4v-.2Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M303.1,39.9v11.2h-60.4v35.6h55.2v11.2h-55.2v46.9h-12.8V39.9h73.2,0Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M344.1,67.2c11.6,0,20.2,2.9,25.9,8.7,5.7,5.8,8.5,14.9,8.5,27.4v41.5h-7.9l-2.4-23.7c-2.7,7.8-7.2,13.9-13.7,18.4-6.4,4.5-14,6.8-22.8,6.8s-9.2-.9-12.8-2.8c-3.6-1.9-6.5-4.4-8.5-7.5s-3-6.5-3-10,1.3-8.7,3.9-12.5,6.7-7.1,12.4-9.9c5.7-2.8,13-4.7,22.1-5.8l20-2.5c-.8-6.2-2.9-10.7-6.4-13.4s-8.6-4-15.2-4-12.3,1.4-15.7,4.3c-3.3,2.9-5.6,6.8-6.8,11.8h-12.6c1.1-7.8,4.5-14.2,10.2-19.3,5.8-5.1,14-7.6,24.9-7.6h-.1ZM335,135.5c5.8,0,11.1-1.4,15.8-4.2,4.7-2.8,8.4-6.5,11.2-11.2,2.8-4.7,4.2-9.9,4.2-15.7l-15.4,1.9c-7.9,1-14,2.3-18.5,4.2-4.5,1.8-7.7,3.9-9.6,6.3-1.9,2.3-2.8,4.8-2.9,7.4,0,3.2,1.1,5.9,3.7,8.1s6.4,3.3,11.6,3.3h-.1Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M419.7,127l25-58.4h13.1l-33.4,76.2h-9.8l-33.2-76.2h13.2l25,58.4h.1Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M495.7,146.3c-7.9,0-14.7-1.6-20.4-4.7-5.8-3.1-10.2-7.5-13.3-13.3s-4.7-12.5-4.7-20.3v-2.6c0-7.8,1.6-14.6,4.7-20.3,3.1-5.7,7.6-10.1,13.3-13.2,5.8-3.1,12.6-4.7,20.4-4.7s14.6,1.6,20.4,4.7c5.8,3.1,10.2,7.5,13.3,13.2s4.7,12.5,4.7,20.3v2.6c0,7.8-1.6,14.5-4.7,20.3-3.1,5.8-7.5,10.2-13.3,13.3s-12.6,4.7-20.4,4.7ZM495.7,135.5c8.3,0,14.8-2.4,19.3-7.1,4.5-4.8,6.8-12,6.8-21.6s-2.3-16.9-6.8-21.6c-4.5-4.8-10.9-7.1-19.3-7.1s-14.8,2.4-19.3,7.1c-4.5,4.7-6.8,11.9-6.8,21.6s2.3,16.9,6.8,21.6,10.9,7.1,19.3,7.1Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M579.5,67.2c2.2,0,4,0,5.5.4,1.5.2,2.7.5,3.7.8v12.1c-1.4-.2-2.9-.3-4.5-.4-1.6,0-3.4,0-5.5,0-7.2,0-12.8,2.6-16.8,7.8s-6,13.9-6,26.1v31h-12.2v-76.2h7.9l2.3,22.1c2.1-8.3,5.4-14.4,10-18,4.6-3.7,9.8-5.5,15.6-5.5h0Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M607.6,144.8h-12.2v-76.2h12.2v76.2Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M670,68.7v10.8h-27.2v40.5c0,5.5,1.1,9.4,3.4,11.9,2.3,2.4,5.8,3.7,10.5,3.7s5.1,0,7.2-.4c2.1-.3,4.2-.6,6.2-1v10.6c-1.6.4-3.5.7-5.5,1-2.1.3-4.7.4-7.8.4-17.4,0-26.2-8.4-26.2-25.3v-41.5h-15.7v-10.8h16l4-22.6h7.9v22.6h27.2,0Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M749.7,102.9c0,2.8-.2,5.3-.6,7.5h-62.2c.7,8.5,3.2,14.9,7.6,19,4.4,4.1,10.5,6.2,18.3,6.2s8.8-.7,11.9-2.1c3-1.4,5.4-3.3,7.1-5.5,1.7-2.3,3.1-4.8,4-7.5h12.5c-.9,4.5-2.7,8.7-5.5,12.7s-6.6,7.2-11.6,9.6c-4.9,2.4-11.2,3.6-18.8,3.6s-14.5-1.6-20.2-4.7c-5.7-3.1-10.1-7.5-13.2-13.3-3.1-5.8-4.7-12.5-4.7-20.3v-2.6c0-7.8,1.6-14.6,4.7-20.3,3.1-5.7,7.6-10.1,13.4-13.2,5.8-3.1,12.6-4.7,20.5-4.7s14.1,1.5,19.5,4.5c5.5,3,9.7,7.1,12.7,12.4,3,5.3,4.5,11.6,4.5,18.8h0ZM712.9,78c-7.6,0-13.6,1.9-18,5.6-4.4,3.7-7,9.4-7.9,17h50.3c-.6-7.5-3-13.1-7.1-16.9-4.2-3.8-9.9-5.7-17.3-5.7h0Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M753.3,119.4h12.5c1.1,5,3.4,8.9,7,11.8,3.7,2.9,9.8,4.3,18.4,4.3s10.1-.5,13.4-1.6c3.3-1.1,5.7-2.5,7.1-4.3,1.4-1.7,2.2-3.5,2.2-5.3s-.6-4.2-1.7-5.8c-1.2-1.6-3.5-2.9-7-4s-8.9-2-16-2.8c-9-1.1-16-2.5-20.9-4.5-4.9-1.9-8.3-4.3-10.1-7.2s-2.8-6.2-2.8-9.9,1.2-7.8,3.7-11.2c2.4-3.4,6.1-6.2,11.1-8.4,4.9-2.2,11.2-3.3,18.8-3.3s14.3,1.2,19.3,3.5,8.9,5.5,11.6,9.6c2.7,4,4.3,8.6,4.8,13.8h-12.5c-.9-5.1-3-9-6.3-11.9s-9-4.3-16.8-4.3-13.4,1.2-16.5,3.5c-3.2,2.3-4.7,5-4.7,7.8s.6,3.9,1.8,5.5c1.2,1.5,3.6,2.9,7.3,4,3.7,1.2,9.2,2.2,16.7,3,8.8,1,15.6,2.4,20.3,4.5,4.8,2,8,4.5,9.9,7.3,1.8,2.9,2.7,6.1,2.7,9.8s-1.3,7.7-3.8,11.2-6.3,6.4-11.5,8.5c-5.2,2.2-11.8,3.2-19.8,3.2s-15.5-1.1-20.9-3.4c-5.4-2.3-9.4-5.5-12.1-9.5-2.7-4-4.4-8.7-5-13.9h-.2Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M849.8,22.7v2.4h-6.1v20.1h-2.9v-20.1h-6.1v-2.4h15.2-.1Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M876.2,22.8v22.3h-2.9v-16.6l-7.4,16.6h-2.1l-7.4-16.7v16.7h-2.9v-22.3h3.2l8.3,18.4,8.3-18.4h3.1-.2Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#ff595c" d="M614.2,19c-2.4-.6-4.8-.3-6.9.9-2.2,1.2-4.1,3.1-5.6,5.2-.2.3-.4.6-.5.9-2.3-3.9-6.6-7.6-11.3-7.2-4.4.4-8.2,3.6-9.1,7.9-1.1,5,2.1,9.6,5.1,13.3,2.8,3.3,5.9,6.3,9,9.3,1.9,1.8,3.9,3.6,5.9,5.3h0c0,0,.2.1.3.1s.2,0,.3-.1c1.7-1.4,3.3-2.9,4.9-4.3,3.2-2.9,6.3-5.9,9.1-9.1,3.1-3.5,6.6-7.9,6.3-12.9-.3-4.3-3.4-8.1-7.6-9.2h0Z"></path>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t<p>Please enter your email to view your saved favorites:</p>\n\t\t\t\t\t\t\t<form class="brag-book-gallery-favorites-lookup-form" id="favorites-email-form">\n\t\t\t\t\t\t\t\t<div class="brag-book-gallery-form-group">\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype="email"\n\t\t\t\t\t\t\t\t\t\tname="email"\n\t\t\t\t\t\t\t\t\t\tclass="brag-book-gallery-form-input"\n\t\t\t\t\t\t\t\t\t\tplaceholder="Enter your email address"\n\t\t\t\t\t\t\t\t\t\trequired\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<button type="submit" class="brag-book-gallery-button brag-book-gallery-button--full" data-action="form-submit">\n\t\t\t\t\t\t\t\t\t\tView Favorites\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</form>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t';const t=document.getElementById("favorites-email-form");return void(t&&t.addEventListener("submit",e=>{e.preventDefault();const o={email:new FormData(t).get("email")};localStorage.setItem(a,JSON.stringify(o)),this.showFavoritesOnly()}))}e.innerHTML='\n\t\t\t<div class="brag-book-gallery-loading">\n\t\t\t\t<div class="brag-book-gallery-spinner"></div>\n\t\t\t\t<p>Loading your favorites...</p>\n\t\t\t</div>\n\t\t';const r=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",s=window.bragBookGalleryConfig?.nonce||"";fetch(r,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"brag_book_get_favorites_list",email:o.email,nonce:s})}).then(e=>e.json()).then(t=>{if(t.success&&t.data){if(t.data.user_info||t.data.name&&t.data.phone){const e=t.data.user_info||{email:o.email,name:t.data.name||"",phone:t.data.phone||""};if(e.name||e.phone){const t={email:o.email,name:e.name||o.name||"",phone:e.phone||o.phone||""};localStorage.setItem(a,JSON.stringify(t)),o=t}}if(t.data.cases&&Array.isArray(t.data.cases)){let e=[];const a=localStorage.getItem("brag-book-favorites");if(a)try{e=JSON.parse(a)}catch(t){console.error("Error parsing existing favorites:",t),e=[]}const o=new Set(e);t.data.cases.forEach(e=>{const t=e.id||e.caseId||"";t&&o.add(String(t))});const r=Array.from(o);localStorage.setItem("brag-book-favorites",JSON.stringify(r)),this.favoritesManager&&(this.favoritesManager.favorites=new Set(r),this.favoritesManager.updateUI()),document.querySelectorAll("[data-favorites-count]").forEach(e=>{e.textContent=`(${r.length})`,e.style&&(e.style.opacity="1")})}else localStorage.getItem("brag-book-favorites")||localStorage.setItem("brag-book-favorites",JSON.stringify([])),document.querySelectorAll("[data-favorites-count]").forEach(e=>{e.textContent="(0)",e.style&&(e.style.opacity="1")}),this.favoritesManager&&(this.favoritesManager.favorites=new Set,this.favoritesManager.updateUI());if(t.data.html){e.innerHTML=`\n\t\t\t\t\t\t<div class="brag-book-gallery-favorites-wrapper">\n\t\t\t\t\t\t\t<div class="brag-book-gallery-favorites-container">\n\t\t\t\t\t\t\t\t<div class="brag-book-gallery-favorites-view">\n\t\t\t\t\t\t\t\t\t${t.data.html}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`;const a=e.querySelector(".brag-book-gallery-favorites-user");a&&(a.textContent=`Showing favorites for: ${o.email}`),this.reinitializeGalleryComponents(),setTimeout(()=>{const e=localStorage.getItem("brag-book-favorites");if(e)try{JSON.parse(e).forEach(e=>{[`[data-item-id="${e}"]`,`[data-case-id="${e}"]`,`[data-item-id="case-${e}"]`,`[data-item-id="${e}_main"]`].forEach(e=>{document.querySelectorAll(e).forEach(e=>{void 0!==e.dataset.favorited&&(e.dataset.favorited="true")})})})}catch(e){console.error("Error updating favorite button states:",e)}},100)}else"string"==typeof t.data?e.innerHTML=t.data:(localStorage.getItem("brag-book-favorites")||localStorage.setItem("brag-book-favorites",JSON.stringify([])),e.innerHTML=`\n\t\t\t\t\t\t<div class="brag-book-gallery-favorites-wrapper">\n\t\t\t\t\t\t\t<div class="brag-book-gallery-favorites-container">\n\t\t\t\t\t\t\t\t<div class="brag-book-filtered-results">\n\t\t\t\t\t\t\t\t\t<svg class="brag-book-gallery-favorites-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 180">\n\t\t\t\t\t\t\t\t\t\t<path fill="#ff595c" d="M85.5,124.6l40-84.7h16.2v104.9h-12.8V60.7l-39.8,84.1h-7.2L42.2,59.7v85.1h-12.8V39.9h16.8l39.3,84.7Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#ff595c" d="M186.2,131.1l25-62.4h12.9l-32.6,80.1c-2.6,6.3-5.2,11.4-7.9,15.3-2.7,3.8-5.7,6.6-9.1,8.3-3.3,1.7-7.4,2.6-12.2,2.6s-3.4,0-4.9-.4c-1.5-.2-2.9-.6-4.2-.9v-10.6c1.3.2,2.7.4,4.2.6,1.4.2,2.9.3,4.5.3,3.9,0,7.2-1.3,9.8-3.9,2.6-2.6,5.3-7.2,8.1-13.9l-32.4-77.3h13.4l25.4,62.4v-.2Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M303.1,39.9v11.2h-60.4v35.6h55.2v11.2h-55.2v46.9h-12.8V39.9h73.2,0Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M344.1,67.2c11.6,0,20.2,2.9,25.9,8.7,5.7,5.8,8.5,14.9,8.5,27.4v41.5h-7.9l-2.4-23.7c-2.7,7.8-7.2,13.9-13.7,18.4-6.4,4.5-14,6.8-22.8,6.8s-9.2-.9-12.8-2.8c-3.6-1.9-6.5-4.4-8.5-7.5s-3-6.5-3-10,1.3-8.7,3.9-12.5,6.7-7.1,12.4-9.9c5.7-2.8,13-4.7,22.1-5.8l20-2.5c-.8-6.2-2.9-10.7-6.4-13.4s-8.6-4-15.2-4-12.3,1.4-15.7,4.3c-3.3,2.9-5.6,6.8-6.8,11.8h-12.6c1.1-7.8,4.5-14.2,10.2-19.3,5.8-5.1,14-7.6,24.9-7.6h-.1ZM335,135.5c5.8,0,11.1-1.4,15.8-4.2,4.7-2.8,8.4-6.5,11.2-11.2,2.8-4.7,4.2-9.9,4.2-15.7l-15.4,1.9c-7.9,1-14,2.3-18.5,4.2-4.5,1.8-7.7,3.9-9.6,6.3-1.9,2.3-2.8,4.8-2.9,7.4,0,3.2,1.1,5.9,3.7,8.1s6.4,3.3,11.6,3.3h-.1Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M419.7,127l25-58.4h13.1l-33.4,76.2h-9.8l-33.2-76.2h13.2l25,58.4h.1Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M495.7,146.3c-7.9,0-14.7-1.6-20.4-4.7-5.8-3.1-10.2-7.5-13.3-13.3s-4.7-12.5-4.7-20.3v-2.6c0-7.8,1.6-14.6,4.7-20.3,3.1-5.7,7.6-10.1,13.3-13.2,5.8-3.1,12.6-4.7,20.4-4.7s14.6,1.6,20.4,4.7c5.8,3.1,10.2,7.5,13.3,13.2s4.7,12.5,4.7,20.3v2.6c0,7.8-1.6,14.5-4.7,20.3-3.1,5.8-7.5,10.2-13.3,13.3s-12.6,4.7-20.4,4.7ZM495.7,135.5c8.3,0,14.8-2.4,19.3-7.1,4.5-4.8,6.8-12,6.8-21.6s-2.3-16.9-6.8-21.6c-4.5-4.8-10.9-7.1-19.3-7.1s-14.8,2.4-19.3,7.1c-4.5,4.7-6.8,11.9-6.8,21.6s2.3,16.9,6.8,21.6,10.9,7.1,19.3,7.1Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M579.5,67.2c2.2,0,4,0,5.5.4,1.5.2,2.7.5,3.7.8v12.1c-1.4-.2-2.9-.3-4.5-.4-1.6,0-3.4,0-5.5,0-7.2,0-12.8,2.6-16.8,7.8s-6,13.9-6,26.1v31h-12.2v-76.2h7.9l2.3,22.1c2.1-8.3,5.4-14.4,10-18,4.6-3.7,9.8-5.5,15.6-5.5h0Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M607.6,144.8h-12.2v-76.2h12.2v76.2Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M670,68.7v10.8h-27.2v40.5c0,5.5,1.1,9.4,3.4,11.9,2.3,2.4,5.8,3.7,10.5,3.7s5.1,0,7.2-.4c2.1-.3,4.2-.6,6.2-1v10.6c-1.6.4-3.5.7-5.5,1-2.1.3-4.7.4-7.8.4-17.4,0-26.2-8.4-26.2-25.3v-41.5h-15.7v-10.8h16l4-22.6h7.9v22.6h27.2,0Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M749.7,102.9c0,2.8-.2,5.3-.6,7.5h-62.2c.7,8.5,3.2,14.9,7.6,19,4.4,4.1,10.5,6.2,18.3,6.2s8.8-.7,11.9-2.1c3-1.4,5.4-3.3,7.1-5.5,1.7-2.3,3.1-4.8,4-7.5h12.5c-.9,4.5-2.7,8.7-5.5,12.7s-6.6,7.2-11.6,9.6c-4.9,2.4-11.2,3.6-18.8,3.6s-14.5-1.6-20.2-4.7c-5.7-3.1-10.1-7.5-13.2-13.3-3.1-5.8-4.7-12.5-4.7-20.3v-2.6c0-7.8,1.6-14.6,4.7-20.3,3.1-5.7,7.6-10.1,13.4-13.2,5.8-3.1,12.6-4.7,20.5-4.7s14.1,1.5,19.5,4.5c5.5,3,9.7,7.1,12.7,12.4,3,5.3,4.5,11.6,4.5,18.8h0ZM712.9,78c-7.6,0-13.6,1.9-18,5.6-4.4,3.7-7,9.4-7.9,17h50.3c-.6-7.5-3-13.1-7.1-16.9-4.2-3.8-9.9-5.7-17.3-5.7h0Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M753.3,119.4h12.5c1.1,5,3.4,8.9,7,11.8,3.7,2.9,9.8,4.3,18.4,4.3s10.1-.5,13.4-1.6c3.3-1.1,5.7-2.5,7.1-4.3,1.4-1.7,2.2-3.5,2.2-5.3s-.6-4.2-1.7-5.8c-1.2-1.6-3.5-2.9-7-4s-8.9-2-16-2.8c-9-1.1-16-2.5-20.9-4.5-4.9-1.9-8.3-4.3-10.1-7.2s-2.8-6.2-2.8-9.9,1.2-7.8,3.7-11.2c2.4-3.4,6.1-6.2,11.1-8.4,4.9-2.2,11.2-3.3,18.8-3.3s14.3,1.2,19.3,3.5,8.9,5.5,11.6,9.6c2.7,4,4.3,8.6,4.8,13.8h-12.5c-.9-5.1-3-9-6.3-11.9s-9-4.3-16.8-4.3-13.4,1.2-16.5,3.5c-3.2,2.3-4.7,5-4.7,7.8s.6,3.9,1.8,5.5c1.2,1.5,3.6,2.9,7.3,4,3.7,1.2,9.2,2.2,16.7,3,8.8,1,15.6,2.4,20.3,4.5,4.8,2,8,4.5,9.9,7.3,1.8,2.9,2.7,6.1,2.7,9.8s-1.3,7.7-3.8,11.2-6.3,6.4-11.5,8.5c-5.2,2.2-11.8,3.2-19.8,3.2s-15.5-1.1-20.9-3.4c-5.4-2.3-9.4-5.5-12.1-9.5-2.7-4-4.4-8.7-5-13.9h-.2Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M849.8,22.7v2.4h-6.1v20.1h-2.9v-20.1h-6.1v-2.4h15.2-.1Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M876.2,22.8v22.3h-2.9v-16.6l-7.4,16.6h-2.1l-7.4-16.7v16.7h-2.9v-22.3h3.2l8.3,18.4,8.3-18.4h3.1-.2Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#ff595c" d="M614.2,19c-2.4-.6-4.8-.3-6.9.9-2.2,1.2-4.1,3.1-5.6,5.2-.2.3-.4.6-.5.9-2.3-3.9-6.6-7.6-11.3-7.2-4.4.4-8.2,3.6-9.1,7.9-1.1,5,2.1,9.6,5.1,13.3,2.8,3.3,5.9,6.3,9,9.3,1.9,1.8,3.9,3.6,5.9,5.3h0c0,0,.2.1.3.1s.2,0,.3-.1c1.7-1.4,3.3-2.9,4.9-4.3,3.2-2.9,6.3-5.9,9.1-9.1,3.1-3.5,6.6-7.9,6.3-12.9-.3-4.3-3.4-8.1-7.6-9.2h0Z"></path>\n\t\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t\t\t<p class="brag-book-gallery-favorites-user">Showing favorites for: ${o.email}</p>\n\t\t\t\t\t\t\t\t\t<div class="brag-book-gallery-favorites-empty">\n\t\t\t\t\t\t\t\t\t\t<svg class="empty-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t\t\t\t\t\t\t\t\t\t\t<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n\t\t\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t\t\t\t<h3>No favorites yet</h3>\n\t\t\t\t\t\t\t\t\t\t<p>Start browsing the gallery and click the heart icon on cases you love to save them here.</p>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`)}else localStorage.getItem("brag-book-favorites")||localStorage.setItem("brag-book-favorites",JSON.stringify([])),e.innerHTML=`\n\t\t\t\t\t<div class="brag-book-gallery-favorites-empty">\n\t\t\t\t\t\t<svg class="empty-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t\t\t\t\t\t\t<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t<h2>No favorites found</h2>\n\t\t\t\t\t\t<p>${t.data?.message||"Unable to load favorites. Please try again."}</p>\n\t\t\t\t\t</div>\n\t\t\t\t`}).catch(t=>{console.error("Error loading favorites:",t),e.innerHTML='\n\t\t\t\t<div class="brag-book-gallery-favorites-empty">\n\t\t\t\t\t<svg class="empty-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t\t\t\t\t\t<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n\t\t\t\t\t</svg>\n\t\t\t\t\t<h2>Error loading favorites</h2>\n\t\t\t\t\t<p>An error occurred while loading your favorites. Please try again.</p>\n\t\t\t\t</div>\n\t\t\t'}),this.components.filterSystem&&this.components.filterSystem.clearAllFilters()}showAllCases(){const e=document.getElementById("gallery-content"),t=e?.querySelector("#gallery-sections");t&&(t.style.display="");const a=e?.querySelector(".brag-book-gallery-favorites-header");a&&a.remove(),this.components.filterSystem&&(this.components.filterSystem.clearAllFilters(),this.components.filterSystem.loadInitialCases())}showFavoritesEmptyState(){const e=document.getElementById("gallery-content");if(!e)return;const t=e.querySelector("#gallery-sections");t&&(t.style.display="none");const a=e.querySelector(".brag-book-gallery-cases-grid");if(a){a.innerHTML="";const e=document.createElement("div");e.className="brag-book-gallery-favorites-empty-state",e.innerHTML='\n\t\t\t\t<svg class="empty-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t\t\t\t\t<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n\t\t\t\t</svg>\n\t\t\t\t<h2>No favorites yet</h2>\n\t\t\t\t<p>Start browsing the gallery and click the heart icon on cases you love to save them here.</p>\n\t\t\t\t<button class="brag-book-gallery-button" onclick="document.querySelector(\'[data-action=\\\'show-favorites\\\']\').click()">\n\t\t\t\t\tBrowse Gallery\n\t\t\t\t</button>\n\t\t\t',a.parentElement.insertBefore(e,a)}}createCaseCard(e){const t=e.id,a=window.bragBookGalleryConfig?.gallerySlug||"before-after";let o="case",r="Case";const s=window.location.pathname,i=new RegExp(`/${a}/([^/]+)`),l=s.match(i);l&&l[1]?(o=l[1],r=o.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")):e.technique&&(o=e.technique.toLowerCase().replace(/\s+/g,"-"),r=e.technique);const n="/"+a+"/"+o+"/"+t+"/";let c="";e.photoSets&&e.photoSets.length>0&&(c=e.photoSets[0].postProcessedImageLocation||"");const d=this.components.favoritesManager.getFavorites().has(`case-${t}`);return`\n\t\t\t<article class="brag-book-gallery-case-card" data-case-id="${t}">\n\t\t\t\t<div class="brag-book-gallery-image-container brag-book-gallery-single-image">\n\t\t\t\t\t<div class="brag-book-gallery-skeleton-loader" style="display:none;"></div>\n\t\t\t\t\t<div class="brag-book-gallery-item-actions">\n\t\t\t\t\t\t<button class="brag-book-gallery-favorite-button" data-favorited="${d}" data-item-id="case-${t}" aria-label="${d?"Remove from":"Add to"} favorites">\n\t\t\t\t\t\t\t<svg fill="${d?"red":"rgba(255, 255, 255, 0.5)"}" stroke="white" stroke-width="2" viewBox="0 0 24 24">\n\t\t\t\t\t\t\t\t<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t<a href="${n}" class="brag-book-gallery-case-card-link" data-case-id="${t}">\n\t\t\t\t\t\t<picture class="brag-book-gallery-picture">\n\t\t\t\t\t\t\t<img src="${c}" alt="Case ${t}" loading="lazy" data-image-type="single">\n\t\t\t\t\t\t</picture>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t\t<div class="brag-book-gallery-case-card-summary">\n\t\t\t\t\t<div class="brag-book-gallery-case-card-summary-info">\n\t\t\t\t\t\t<span class="brag-book-gallery-case-card-summary-info__name">${r}</span>\n\t\t\t\t\t\t<span class="brag-book-gallery-case-card-summary-info__case-number">Case #${t}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="brag-book-gallery-case-card-summary-details">\n\t\t\t\t\t\t${e.age?`<span class="brag-book-gallery-age">${e.age} yrs</span>`:""}\n\t\t\t\t\t\t${e.gender?`<span class="brag-book-gallery-gender">${e.gender}</span>`:""}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</article>\n\t\t`}reinitializeGalleryComponents(){this.initializeCaseLinks(),this.components.favoritesManager&&document.querySelectorAll("[data-favorited]").forEach(e=>{const t=e.dataset.itemId,a=this.components.favoritesManager.getFavorites().has(t);e.dataset.favorited=a.toString()})}initializeNudityWarning(){this.components.nudityWarningManager=new l}initializeCasePreloading(){this.casePreloadCache=new Map,this.optimizeImageLoading(),this.setupCasePreloadObserver(),setTimeout(()=>{this.preloadVisibleCases()},1e3)}optimizeImageLoading(){const e=document.querySelectorAll(".brag-book-gallery-case-card img");Array.from(e).slice(0,3).forEach((e,t)=>{if(e.loading="eager",e.setAttribute("fetchpriority","high"),0===t){const t=document.createElement("link");t.rel="preload",t.as="image",t.href=e.src,t.fetchPriority="high",document.head.appendChild(t)}}),this.setupImageLoadingOptimization()}setupImageLoadingOptimization(){this.imageOptimizationObserver=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){const t=e.querySelectorAll?e.querySelectorAll(".brag-book-gallery-case-card img"):[];Array.from(t).slice(0,2).forEach(e=>{e.loading="eager",e.setAttribute("fetchpriority","high")})}})})});const e=document.getElementById("gallery-content");e&&this.imageOptimizationObserver.observe(e,{childList:!0,subtree:!0})}setupCasePreloadObserver(){window.IntersectionObserver&&(this.caseObserver=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target,a=t.dataset.caseId,o=t.dataset.procedureIds;a&&!this.casePreloadCache.has(a)&&this.preloadCase(a,o)}})},{threshold:.5,rootMargin:"200px"}),document.querySelectorAll(".brag-book-gallery-case-card").forEach(e=>{this.caseObserver.observe(e)}))}preloadVisibleCases(){const e=document.querySelectorAll(".brag-book-gallery-case-card");Array.from(e).slice(0,3).forEach(e=>{const t=e.dataset.caseId,a=e.dataset.procedureIds;t&&!this.casePreloadCache.has(t)&&this.preloadCase(t,a)})}async preloadCase(e,t){if(!this.casePreloadCache.has(e)){this.casePreloadCache.set(e,"loading");try{const a=await this.loadCaseDetailsDirectly(e,t);if(a)this.casePreloadCache.set(e,a),console.log(`âœ… Preloaded case ${e}`);else{const a=await this.preloadCaseViaAjax(e,t);a&&(this.casePreloadCache.set(e,a),console.log(`âœ… Preloaded case ${e} via AJAX`))}}catch(t){this.casePreloadCache.delete(e),console.warn(`Failed to preload case ${e}:`,t)}}}async preloadCaseViaAjax(e,t){try{const a=window.location.pathname.split("/").filter(e=>e),o=a.length>1?a[a.length-1]:"";let r="";const s=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${o}"]`);if(s){const e=s.querySelector(".brag-book-gallery-filter-option-label");e&&(r=e.textContent.trim())}const i={action:"brag_book_gallery_load_case_details_html",case_id:e,procedure_slug:o,procedure_name:r,nonce:bragBookGalleryConfig.nonce||""};t&&(i.procedure_ids=t);const l=await fetch(bragBookGalleryConfig.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(i)});if(!l.ok)return null;const n=await l.json();return n.success&&n.data&&n.data.html?n.data.html:null}catch(e){return console.warn("AJAX preload failed:",e),null}}async loadCaseDetailsDirectly(e,t=null){const a=bragBookGalleryConfig.ajaxUrl||"/wp-admin/admin-ajax.php",o=bragBookGalleryConfig.nonce||"",r=bragBookGalleryConfig.apiToken||"",s=bragBookGalleryConfig.websitePropertyId||"";if(!(a&&o&&r&&s))throw new Error("Missing API configuration for case details");try{const i=`/api/plugin/combine/cases/${e}`,l={apiTokens:[r],count:1,websitePropertyIds:[parseInt(s)]};if(t){const a=t.split(",").map(e=>parseInt(e.trim())).filter(e=>!isNaN(e));a.length>0?(l.procedureIds=a,console.log(`ðŸ”— Direct API call with procedure context: case ${e}, procedure IDs ${a.join(",")}`)):console.warn(`âš ï¸ Direct API call WITHOUT procedure context: case ${e} (invalid procedure IDs: ${t})`)}else console.warn(`âš ï¸ Direct API call WITHOUT procedure context: case ${e} (no procedure IDs provided)`);console.log(`ðŸŒ Making API proxy request to endpoint: ${i} with POST data:`,l);const n=new FormData;n.append("action","brag_book_api_proxy"),n.append("nonce",o),n.append("endpoint",i),n.append("method","POST"),n.append("body",JSON.stringify(l)),n.append("timeout","3");const c=new AbortController,d=setTimeout(()=>c.abort(),3e3),g=await fetch(a,{method:"POST",body:n,signal:c.signal});if(clearTimeout(d),!g.ok)throw new Error(`Proxy response ${g.status}`);const h=await g.json();if(console.log("ðŸ” Full API proxy response:",h),!h.success||!h.data||!h.data.data)throw console.error("Direct API response structure:",h),console.error("Expected: result.success =",h.success),console.error("Expected: result.data =",h.data),console.error("Expected: result.data.data =",h.data?.data),h.data&&h.data.status&&(console.error("ðŸš¨ API returned HTTP status:",h.data.status),console.error("ðŸš¨ API error message:",h.data.message),console.error("ðŸš¨ API debug info:",h.data.debug)),new Error(h.data?.message||"Case details proxy request failed");if(h.data&&h.data.html)return console.log("âœ… Direct API returned HTML content"),h.data.html;const u=h.data.data;if(!u||!u.data||!u.data[0])return console.warn("Direct API returned unexpected data structure"),null;console.warn("âš ï¸ Direct API returned raw data, falling back to JavaScript rendering");const p=u.data[0];return this.generateCaseDetailHTML(p)}catch(e){return console.warn("Direct API call failed:",e),null}}generateCaseDetailHTML(e){const t=e.id||"",a=this.extractProcedureDataForDetails(e),o=this.extractSEOData(e),r=e.navigation||null,s=window.location.pathname.split("/").filter(e=>e),i=s.length>2?s[s.length-2]:"",l=a.name||"";let n="";if(e.procedureIds&&Array.isArray(e.procedureIds)){const t=e.procedureIds.map(e=>parseInt(e)).filter(e=>!isNaN(e));n=` data-procedure-ids="${this.escapeHtml(t.join(","))}"`}const c=i?` data-procedure="${this.escapeHtml(i)}"`:"";return`<div class="brag-book-gallery-case-detail-view" data-case-id="${this.escapeHtml(t)}"${n}${c}>${this.renderCaseHeader(a,o,t,i,l,r)}${this.renderCaseImages(e,a,t)}${this.renderCaseDetailsCards(e)}</div>`}extractProcedureDataForDetails(e){let t="",a="",o=[];if(e.procedures&&Array.isArray(e.procedures)&&e.procedures.length>0){const r=e.procedures[0];if(r.name){const e=r.name;t=this.formatProcedureDisplayName(e),a=this.sanitizeTitle(e)}else r.id&&o.push(parseInt(r.id))}else e.procedureIds&&Array.isArray(e.procedureIds)&&(o=e.procedureIds.map(e=>parseInt(e)).filter(e=>!isNaN(e)));return{name:t,slug:a,ids:o,procedures:e.procedures||[]}}formatProcedureDisplayName(e){return e?e.trim():""}sanitizeTitle(e){return e?e.toLowerCase().trim().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,""):""}extractProcedureData(e){let t="",a="",o=[];if(e.procedures&&Array.isArray(e.procedures)&&e.procedures.length>0){const r=e.procedures[0];r.name&&(t=r.name),r.slugName&&(a=r.slugName),o=e.procedures.map(e=>e.id).filter(e=>e)}return 0===o.length&&e.procedureIds&&Array.isArray(e.procedureIds)&&(o=e.procedureIds),{procedureName:t,procedureSlug:a,procedureIds:o,hasProcedures:o.length>0}}extractSEOData(e){return{title:e.seoTitle||`Case ${e.id}`,description:e.seoDescription||"",keywords:e.seoKeywords||""}}renderCaseHeader(e,t,a,o,r,s){const i="/"+this.getGallerySlug().replace(/^\/+/,"");let l=i+"/",n="â† Back to Gallery";o&&(l=i+"/"+o+"/",r&&(n=`â† Back to ${r}`));const c=this.buildNavigationButtons(s,o),d=this.buildTitleContent(t,e,a,r);return`\n\t\t\t<div class="brag-book-gallery-case-detail-header">\n\t\t\t\t<div class="brag-book-gallery-case-navigation">\n\t\t\t\t\t<a href="${this.escapeHtml(l)}" class="brag-book-gallery-back-button" rel="nofollow">\n\t\t\t\t\t\t${this.escapeHtml(n)}\n\t\t\t\t\t</a>\n\t\t\t\t\t${c}\n\t\t\t\t</div>\n\t\t\t\t${d}\n\t\t\t</div>\n\t\t`}buildNavigationButtons(e,t){if(!e)return"";const a="/"+this.getGallerySlug().replace(/^\/+/,"");let o='<div class="brag-book-gallery-case-nav-buttons">';if(e.previous){const r=e.previous,s=t?`${a}/${t}/${r.id}/`:`${a}/case/${r.id}/`;o+=`\n\t\t\t\t<a href="${this.escapeHtml(s)}" class="brag-book-gallery-nav-button brag-book-gallery-prev-case" rel="prev nofollow">\n\t\t\t\t\t<span class="brag-book-gallery-nav-arrow">â†</span>\n\t\t\t\t\t<span class="brag-book-gallery-nav-text">Previous Case</span>\n\t\t\t\t</a>\n\t\t\t`}if(e.next){const r=e.next,s=t?`${a}/${t}/${r.id}/`:`${a}/case/${r.id}/`;o+=`\n\t\t\t\t<a href="${this.escapeHtml(s)}" class="brag-book-gallery-nav-button brag-book-gallery-next-case" rel="next nofollow">\n\t\t\t\t\t<span class="brag-book-gallery-nav-text">Next Case</span>\n\t\t\t\t\t<span class="brag-book-gallery-nav-arrow">â†’</span>\n\t\t\t\t</a>\n\t\t\t`}return o+"</div>"}buildTitleContent(e,t,a,o){const r=o||t.procedureName||"Case Study";return`\n\t\t\t<div class="brag-book-gallery-case-title-section">\n\t\t\t\t<h1 class="brag-book-gallery-case-title">${this.escapeHtml(r)}</h1>\n\t\t\t\t<div class="brag-book-gallery-case-subtitle">Case #${this.escapeHtml(a)}</div>\n\t\t\t</div>\n\t\t`}renderCaseImages(e,t,a){return e.photoSets&&Array.isArray(e.photoSets)&&0!==e.photoSets.length?`\n\t\t\t<div class="brag-book-gallery-brag-book-gallery-case-content">\n\t\t\t\t<div class="brag-book-gallery-case-images-section">\n\t\t\t\t\t<div class="brag-book-gallery-case-images-layout">\n\t\t\t\t\t\t${this.renderMainImageViewer(e.photoSets,t,a)}\n\t\t\t\t\t\t${e.photoSets.length>1?this.renderThumbnails(e.photoSets):""}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t`:this.renderNoImagesSection()}renderNoImagesSection(){return'\n\t\t\t<div class="brag-book-gallery-case-images-section">\n\t\t\t\t<div class="brag-book-gallery-no-images">\n\t\t\t\t\t<p>No images available for this case.</p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'}renderMainImageViewer(e,t,a){if(!e||0===e.length)return"";const o=e[0],r=o.beforeLocationUrl||"",s=o.afterLocationUrl1||"",i=o.postProcessedImageLocation||r||s;if(!i)return this.renderNoImagesSection();const l=t.procedureName||"Case Study";return`\n\t\t\t<div class="brag-book-gallery-main-image-viewer">\n\t\t\t\t<div class="brag-book-gallery-main-image-container" data-photoset-index="0">\n\t\t\t\t\t<img src="${this.escapeHtml(i)}" \n\t\t\t\t\t\t alt="${this.escapeHtml(l)} - Case ${this.escapeHtml(a)}" \n\t\t\t\t\t\t class="brag-book-gallery-main-image" \n\t\t\t\t\t\t loading="lazy">\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}renderThumbnails(e){return!e||e.length<=1?"":`\n\t\t\t<div class="brag-book-gallery-thumbnails-section">\n\t\t\t\t<div class="brag-book-gallery-thumbnails-grid">\n\t\t\t\t\t${e.map((e,t)=>{const a=e.postProcessedImageLocation||e.beforeLocationUrl||e.afterLocationUrl1||"";return a?`\n\t\t\t\t<div class="brag-book-gallery-thumbnail${0===t?" active":""}" data-photoset-index="${t}">\n\t\t\t\t\t<img src="${this.escapeHtml(a)}" \n\t\t\t\t\t\t alt="Thumbnail ${t+1}" \n\t\t\t\t\t\t loading="lazy">\n\t\t\t\t</div>\n\t\t\t`:""}).filter(e=>e).join("")}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}renderCaseDetailsCards(e){return`\n\t\t\t<div class="brag-book-gallery-case-card-details-section">\n\t\t\t\t<div class="brag-book-gallery-case-card-details-grid">\n\t\t\t\t\t${this.renderProceduresCard(e)}\n\t\t\t\t\t${this.renderPatientDetailsCard(e)}\n\t\t\t\t\t${this.renderProcedureDetailsCard(e)}\n\t\t\t\t\t${this.renderCaseNotesCard(e)}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>`}renderProceduresCard(e){return e.procedures&&Array.isArray(e.procedures)&&0!==e.procedures.length?`\n\t\t\t<div class="brag-book-gallery-detail-card">\n\t\t\t\t<h3 class="brag-book-gallery-detail-card-title">Procedures Performed</h3>\n\t\t\t\t<div class="brag-book-gallery-detail-card-content">\n\t\t\t\t\t<ul class="brag-book-gallery-procedures-list">\n\t\t\t\t\t\t${e.procedures.map(e=>`<li>${this.escapeHtml(e.name||"Unknown Procedure")}</li>`).join("")}\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`:""}renderPatientDetailsCard(e){const t=[];return e.age&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Age:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(String(e.age))}</span></div>`),e.gender&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Gender:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.gender)}</span></div>`),e.ethnicity&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Ethnicity:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.ethnicity)}</span></div>`),e.height&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Height:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.height)}</span></div>`),e.weight&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Weight:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.weight)}</span></div>`),0===t.length?"":`\n\t\t\t<div class="brag-book-gallery-detail-card">\n\t\t\t\t<h3 class="brag-book-gallery-detail-card-title">Patient Information</h3>\n\t\t\t\t<div class="brag-book-gallery-detail-card-content">\n\t\t\t\t\t${t.join("")}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}renderProcedureDetailsCard(e){const t=[];return e.surgeryDate&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Surgery Date:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.surgeryDate)}</span></div>`),e.followUpDate&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Follow-up Date:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.followUpDate)}</span></div>`),e.surgeon&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Surgeon:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.surgeon)}</span></div>`),e.location&&t.push(`<div class="brag-book-gallery-detail-row"><span class="brag-book-gallery-detail-label">Location:</span> <span class="brag-book-gallery-detail-value">${this.escapeHtml(e.location)}</span></div>`),0===t.length?"":`\n\t\t\t<div class="brag-book-gallery-detail-card">\n\t\t\t\t<h3 class="brag-book-gallery-detail-card-title">Procedure Details</h3>\n\t\t\t\t<div class="brag-book-gallery-detail-card-content">\n\t\t\t\t\t${t.join("")}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}renderCaseNotesCard(e){const t=e.notes||e.description||e.caseNotes||"";return t?`\n\t\t\t<div class="brag-book-gallery-detail-card brag-book-gallery-case-notes-card">\n\t\t\t\t<h3 class="brag-book-gallery-detail-card-title">Case Notes</h3>\n\t\t\t\t<div class="brag-book-gallery-detail-card-content">\n\t\t\t\t\t<div class="brag-book-gallery-case-notes-content">\n\t\t\t\t\t\t${this.escapeHtml(t).replace(/\n/g,"<br>")}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`:""}getGallerySlug(){return(window.bragBookGalleryConfig||{}).gallerySlug||"gallery"}escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}updateCaseDetailsSEO(e,t){if(!e)return;const a=e.id||"",o=t?`${t} Case ${a} - Before & After`:`Case ${a} - Before & After`;document.title=o;let r=`View before and after photos for Case ${a}`;t&&(r=`${t} before and after photos - Case ${a}. See real patient results.`),this.updateMetaTag("description",r);const s=window.location.href;this.updateLinkTag("canonical",s),this.addCaseStructuredData(e,t)}updateMetaTag(e,t){let a=document.querySelector(`meta[name="${e}"]`);a||(a=document.createElement("meta"),a.setAttribute("name",e),document.head.appendChild(a)),a.setAttribute("content",t)}updateLinkTag(e,t){let a=document.querySelector(`link[rel="${e}"]`);a||(a=document.createElement("link"),a.setAttribute("rel",e),document.head.appendChild(a)),a.setAttribute("href",t)}addCaseStructuredData(e,t){const a={"@context":"https://schema.org","@type":"MedicalProcedure",name:t||"Medical Procedure",identifier:e.id,image:[],description:`Before and after case study for ${t||"medical procedure"}`};e.photoSets&&Array.isArray(e.photoSets)&&e.photoSets.forEach(e=>{e.postProcessedImageLocation?a.image.push(e.postProcessedImageLocation):e.beforeLocationUrl?a.image.push(e.beforeLocationUrl):e.afterLocationUrl1&&a.image.push(e.afterLocationUrl1)});const o=document.querySelector("script[data-case-structured-data]");o&&o.remove();const r=document.createElement("script");r.type="application/ld+json",r.setAttribute("data-case-structured-data","true"),r.textContent=JSON.stringify(a),document.head.appendChild(r)}initializeThumbnailNavigation(){const e=document.querySelectorAll(".brag-book-gallery-thumbnail"),t=document.querySelector(".brag-book-gallery-main-image");t&&0!==e.length&&e.forEach((a,o)=>{a.addEventListener("click",r=>{r.preventDefault(),e.forEach(e=>e.classList.remove("active")),a.classList.add("active");const s=a.querySelector("img");if(s&&s.src){t.src=s.src,t.alt=s.alt||`Case image ${o+1}`;const e=document.querySelector(".brag-book-gallery-main-image-container");e&&e.setAttribute("data-photoset-index",o.toString())}})})}getProcedureIdsFromSlug(e){if(!e)return null;if(console.log("ðŸ” Looking up procedure IDs for slug:",e),window.bragBookGalleryConfig?.sidebarData){const t=window.bragBookGalleryConfig.sidebarData;for(const a of Object.values(t))if(a.procedures)for(const t of a.procedures)if(t.slug===e)return console.log("âœ… Found procedure IDs from sidebar data:",t.ids),t.ids?t.ids.join(","):null}console.log("ðŸ” Checking page elements for procedure context...");const t=document.querySelector(".brag-book-gallery-case-detail-view");if(t&&t.dataset.procedureIds)return console.log("âœ… Found procedure IDs from case detail view:",t.dataset.procedureIds),t.dataset.procedureIds;const a=document.querySelector(`[data-procedure="${e}"]`);return a&&a.dataset.procedureIds?(console.log("âœ… Found procedure IDs from DOM element:",a.dataset.procedureIds),a.dataset.procedureIds):(console.warn(`âš ï¸ Could not find procedure IDs for slug: ${e}`),null)}setActiveSidebarForCase(e){try{const e=window.location.pathname.split("/").filter(e=>e),t=e.length>2?e[e.length-2]:"";if(!t)return void console.log("No procedure slug found in URL, cannot set sidebar active state");document.querySelectorAll(".brag-book-gallery-nav-link").forEach(e=>{e.classList.remove("brag-book-gallery-active")});const a=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${t}"]`);if(a){a.classList.add("brag-book-gallery-active");const e=a.closest(".brag-book-gallery-nav-list-submenu__item");e&&e.classList.add("brag-book-gallery-active"),console.log(`âœ… Set sidebar active state for procedure: ${t}`)}else console.warn(`âš ï¸ Could not find sidebar link for procedure: ${t}`)}catch(e){console.error("Error setting sidebar active state:",e)}}};function d(){console.log("Cleaning up procedure badges..."),document.querySelectorAll(".brag-book-gallery-active-filters").forEach(e=>{e.querySelectorAll(".brag-book-gallery-filter-badge").forEach(e=>{const t=e.hasAttribute("data-filter-key"),a=e.querySelector('button[onclick*="clearProcedureFilter"]'),o=e.querySelector("span")&&!e.querySelector("[data-filter-type]");(t||a||o)&&(console.log("Removing procedure badge:",e.textContent.trim()),e.remove())}),0===e.querySelectorAll(".brag-book-gallery-filter-badge").length&&(e.style.display="none")}),document.querySelectorAll(".brag-book-gallery-clear-all-filters").forEach(e=>{0===document.querySelectorAll('.brag-book-gallery-filter-option input[type="checkbox"]:checked').length&&(e.style.display="none")})}async function g(e){try{const t=new FormData;t.append("action","brag_book_gallery_load_filtered_cases"),t.append("case_ids",e.join(",")),t.append("nonce","undefined"!=typeof bragBookAjax?bragBookAjax.nonce:"");const a=await fetch("undefined"!=typeof ajaxurl?ajaxurl:"/wp-admin/admin-ajax.php",{method:"POST",body:t}),o=await a.json();return o.success&&o.data?{success:!0,html:o.data.html||"",casesFound:o.data.casesFound||0,totalCount:o.data.totalCount||e.length}:{success:!1,error:o.data?.message||"Failed to load filtered cases"}}catch(e){return console.error("AJAX error loading filtered cases:",e),{success:!1,error:e.message}}}function h(e,t,a,o,r,s,i){const l=window.bragBookGalleryConfig?.nonce||"",n=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",c=new FormData;c.append("action","brag_book_gallery_load_more_cases"),c.append("nonce",l),c.append("start_page",t),c.append("procedure_ids",a),c.append("procedure_name",o),c.append("has_nudity",r?"1":"0"),c.append("loaded_ids",s.join(",")),fetch(n,{method:"POST",body:c}).then(e=>e.json()).then(a=>{a.success?p(a,e,i,t):(console.error("Failed to load more cases:",a.data?a.data.message:"Unknown error"),e.disabled=!1,e.textContent=i,alert("Failed to load more cases. Please try again."))}).catch(t=>{console.error("AJAX fallback error loading more cases:",t),e.disabled=!1,e.textContent=i,alert("Error loading more cases. Please check your connection and try again.")})}function u(){const e=document.querySelector(".brag-book-gallery-wrapper");if(e){const t=e.getBoundingClientRect().top+window.pageYOffset-20;window.scrollTo({top:t,behavior:"smooth"})}}function p(e,t,a,o){const r=e.data||e;let s=document.querySelector(".brag-book-gallery-case-grid.masonry-layout");if(s||(s=document.querySelector(".brag-book-gallery-cases-grid")),s||(s=document.querySelector(".brag-book-gallery-case-grid")),s||(s=document.querySelector(".brag-book-gallery-cases-container")),s||(s=document.querySelector(".brag-book-gallery-cases-container .brag-book-gallery-cases-grid")),s||(s=document.querySelector(".brag-book-gallery-grid")),s)if(r.html){const e=s.querySelector(".brag-book-gallery-case-card:last-child");e?e.insertAdjacentHTML("afterend",r.html):s.insertAdjacentHTML("beforeend",r.html),u()}else console.error("No HTML received from server");else console.error("Container not found - tried .brag-book-gallery-case-grid.masonry-layout, .brag-book-gallery-cases-grid, .brag-book-gallery-case-grid, .brag-book-gallery-cases-container, and .brag-book-gallery-grid");const i=r.casesLoaded||0;if(r.hasMore&&i>0)t.setAttribute("data-start-page",parseInt(o)+1),t.disabled=!1,t.textContent=a;else{const e=t.closest(".brag-book-gallery-load-more-container")||t.parentElement;e&&(e.style.display="none")}if(s){const e=document.querySelector(".brag-book-gallery-favorite-count-label")||document.querySelector(".cases-count")||document.querySelector('[class*="count-label"]');if(e){const t=s.querySelectorAll(".brag-book-gallery-case-card").length,a=e.textContent.match(/(\d+) of (\d+)/);if(a){const o=a[2];e.textContent="Showing "+t+" of "+o}}}i>0&&setTimeout(()=>{regenerateProcedureFilters()},100)}function b(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}let y,m;window.updateGridLayout=function(e){const t=document.querySelector(".brag-book-gallery-case-grid");t&&window.innerWidth>=1024&&(t.classList.add("grid-initialized"),t.setAttribute("data-columns",e),document.querySelectorAll(".brag-book-gallery-grid-btn").forEach(t=>{parseInt(t.dataset.columns)===e?t.classList.add("active"):t.classList.remove("active")}),localStorage.setItem("bragbook-grid-columns",e))},window.bragBookProcedureFilters={age:[],gender:[],ethnicity:[],height:[],weight:[]},window.initializeProcedureFilters=function(){const e=document.getElementById("procedure-filters-details");e&&(console.log("Initializing procedure filters..."),d(),generateProcedureFilterOptions(),e.dataset.initialized="true")},window.regenerateProcedureFilters=function(){console.log("Force regenerating procedure filters...");const e=document.getElementById("procedure-filters-details");e&&(e.dataset.initialized="false",window.bragBookProcedureFilters={age:[],gender:[],ethnicity:[],height:[],weight:[]},function(){const e=document.querySelector(".brag-book-gallery-active-filters");e&&(e.querySelectorAll(".brag-book-gallery-filter-badges").forEach(e=>{e.innerHTML=""}),e.style.display="none",e.querySelectorAll(".brag-book-gallery-filter-badge").forEach(e=>e.remove()))}(),initializeProcedureFilters())},window.generateProcedureFilterOptions=function(){const e=document.getElementById("brag-book-gallery-filters")||document.querySelector(".brag-book-gallery-filter-content")||document.querySelector(".brag-book-gallery-filters");if(!e)return void console.log("Filter container not found - likely on a procedure or case page");const t=document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]');console.log("Filter generation - Scanning case cards on page, found:",t.length);const a={age:new Set,gender:new Set,ethnicity:new Set,height:new Set,weight:new Set},o=[],r=[],s=[];t.forEach(e=>{const t=e.dataset.age;t&&(o.push(parseInt(t)),console.log("Found case with age:",t)),e.dataset.gender&&(a.gender.add(e.dataset.gender),console.log("Found case with gender:",e.dataset.gender)),e.dataset.ethnicity&&(a.ethnicity.add(e.dataset.ethnicity),console.log("Found case with ethnicity:",e.dataset.ethnicity));const i=e.dataset.height;if(i){const t=parseInt(i);"cm"===(e.dataset.heightUnit||"in")?r.push(Math.round(t/2.54)):r.push(t)}const l=e.dataset.weight;if(l){const t=parseInt(l);"kg"===(e.dataset.weightUnit||"lbs")?s.push(Math.round(2.205*t)):s.push(t)}}),o.some(e=>e>=18&&e<25)&&a.age.add("18-24"),o.some(e=>e>=25&&e<35)&&a.age.add("25-34"),o.some(e=>e>=35&&e<45)&&a.age.add("35-44"),o.some(e=>e>=45&&e<55)&&a.age.add("45-54"),o.some(e=>e>=55&&e<65)&&a.age.add("55-64"),o.some(e=>e>=65)&&a.age.add("65+"),r.some(e=>e<60)&&a.height.add("Under 5'0\""),r.some(e=>e>=60&&e<64)&&a.height.add("5'0\" - 5'3\""),r.some(e=>e>=64&&e<68)&&a.height.add("5'4\" - 5'7\""),r.some(e=>e>=68&&e<72)&&a.height.add("5'8\" - 5'11\""),r.some(e=>e>=72)&&a.height.add("6'0\" and above"),s.some(e=>e<120)&&a.weight.add("Under 120 lbs"),s.some(e=>e>=120&&e<150)&&a.weight.add("120-149 lbs"),s.some(e=>e>=150&&e<180)&&a.weight.add("150-179 lbs"),s.some(e=>e>=180&&e<210)&&a.weight.add("180-209 lbs"),s.some(e=>e>=210)&&a.weight.add("210+ lbs"),generateFilterHTML(e,a)},window.generateFilterHTML=function(e,t){let a="";t.age.size>0&&(a+='<details class="brag-book-gallery-filter">',a+='<summary class="brag-book-gallery-filter-label">',a+='<span class="brag-book-gallery-filter-label__name">Age</span>',a+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',a+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',a+="</svg>",a+="</summary>",a+='<ul class="brag-book-gallery-filter-options">',Array.from(t.age).sort().forEach(e=>{const t=`procedure-filter-age-${e.replace(/\s+/g,"-")}`;a+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${e}" data-filter-type="age">\n\t\t\t\t<label for="${t}">${e}</label>\n\t\t\t</li>`}),a+="</ul>",a+="</details>"),t.gender.size>0&&(a+='<details class="brag-book-gallery-filter">',a+='<summary class="brag-book-gallery-filter-label">',a+='<span class="brag-book-gallery-filter-label__name">Gender</span>',a+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',a+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',a+="</svg>",a+="</summary>",a+='<ul class="brag-book-gallery-filter-options">',Array.from(t.gender).sort().forEach(e=>{const t=`procedure-filter-gender-${e}`,o=e.charAt(0).toUpperCase()+e.slice(1);a+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${e}" data-filter-type="gender">\n\t\t\t\t<label for="${t}">${o}</label>\n\t\t\t</li>`}),a+="</ul>",a+="</details>"),t.ethnicity.size>0&&(a+='<details class="brag-book-gallery-filter">',a+='<summary class="brag-book-gallery-filter-label">',a+='<span class="brag-book-gallery-filter-label__name">Ethnicity</span>',a+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',a+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',a+="</svg>",a+="</summary>",a+='<ul class="brag-book-gallery-filter-options">',Array.from(t.ethnicity).sort().forEach(e=>{const t=`procedure-filter-ethnicity-${e.replace(/\s+/g,"-")}`,o=e.charAt(0).toUpperCase()+e.slice(1);a+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${e}" data-filter-type="ethnicity">\n\t\t\t\t<label for="${t}">${o}</label>\n\t\t\t</li>`}),a+="</ul>",a+="</details>"),t.height.size>0&&(a+='<details class="brag-book-gallery-filter">',a+='<summary class="brag-book-gallery-filter-label">',a+='<span class="brag-book-gallery-filter-label__name">Height</span>',a+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',a+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',a+="</svg>",a+="</summary>",a+='<ul class="brag-book-gallery-filter-options">',Array.from(t.height).sort().forEach(e=>{const t=`procedure-filter-height-${e.replace(/\s+/g,"-")}`;a+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${e}" data-filter-type="height">\n\t\t\t\t<label for="${t}">${e}</label>\n\t\t\t</li>`}),a+="</ul>",a+="</details>"),t.weight.size>0&&(a+='<details class="brag-book-gallery-filter">',a+='<summary class="brag-book-gallery-filter-label">',a+='<span class="brag-book-gallery-filter-label__name">Weight</span>',a+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',a+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',a+="</svg>",a+="</summary>",a+='<ul class="brag-book-gallery-filter-options">',Array.from(t.weight).sort().forEach(e=>{const t=`procedure-filter-weight-${e.replace(/\s+/g,"-")}`;a+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${e}" data-filter-type="weight">\n\t\t\t\t<label for="${t}">${e}</label>\n\t\t\t</li>`}),a+="</ul>",a+="</details>"),e.innerHTML=a||"<p>No filters available</p>";const o=e.querySelectorAll('input[type="checkbox"]');console.log("Setting up event listeners for",o.length,"filter checkboxes"),o.forEach(e=>{e.addEventListener("change",function(){console.log("Checkbox changed:",this.dataset.filterType,"=",this.value,"checked:",this.checked),console.log("About to call applyProcedureFilters...");try{"function"==typeof window.applyProcedureFilters?(console.log("Calling window.applyProcedureFilters()"),window.applyProcedureFilters(),console.log("Successfully called applyProcedureFilters")):console.error("window.applyProcedureFilters function not found, typeof:",typeof window.applyProcedureFilters)}catch(e){console.error("Error calling applyProcedureFilters:",e)}})});const r=document.getElementById("procedure-filters-details");if(r){const e=a&&"<p>No filters available</p>"!==a;r.style.display=e?"":"none"}},window.applyProcedureFilters=function(){console.log("applyProcedureFilters called");const e=document.querySelectorAll(".brag-book-gallery-filter-option input:checked");console.log("Found checked filters:",e.length),window.bragBookProcedureFilters={age:[],gender:[],ethnicity:[],height:[],weight:[]},e.forEach(e=>{const t=e.dataset.filterType,a=e.value;console.log("Adding filter:",t,"=",a),window.bragBookProcedureFilters[t]&&window.bragBookProcedureFilters[t].push(a)}),console.log("Active filters:",window.bragBookProcedureFilters);const t=Object.values(window.bragBookProcedureFilters).some(e=>e.length>0);!function(){const e=document.querySelector(".brag-book-gallery-filter-badges");e&&e.remove();let t=document.querySelector(".brag-book-gallery-active-filters");if(!t){t=document.createElement("div"),t.className="brag-book-gallery-active-filters";const e=document.querySelector(".brag-book-gallery-filter-results"),a=document.querySelector(".brag-book-gallery-case-grid")||document.querySelector(".brag-book-gallery-cases-grid");e&&e.parentNode?e.parentNode.insertBefore(t,e.nextSibling):a&&a.parentNode&&a.parentNode.insertBefore(t,a)}t.innerHTML="";const a=document.querySelectorAll('.brag-book-gallery-filter-option input[type="checkbox"]:checked');if(0!==a.length)if(t.style.display="block",a.forEach(e=>{const a=e.dataset.filterType,o=e.value,r=e.parentNode.querySelector("label"),s=r?r.textContent.trim():o,i=document.createElement("div");i.className="brag-book-gallery-filter-badge",i.setAttribute("data-filter-key",`${a}:${o}`),i.setAttribute("data-filter-type",a),i.setAttribute("data-filter-value",o);const l=a.charAt(0).toUpperCase()+a.slice(1);i.innerHTML=`\n\t\t\t<span class="brag-book-gallery-badge-text">${l}: ${b(s)}</span>\n\t\t\t<button class="brag-book-gallery-badge-remove" aria-label="Remove ${l}: ${b(s)} filter" onclick="removeFilterBadge('${a}', '${b(o)}')">\n\t\t\t\t<svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">\n\t\t\t\t\t<path d="M13 1L1 13M1 1l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>\n\t\t\t\t</svg>\n\t\t\t</button>\n\t\t`,t.appendChild(i)}),a.length>0){const e=document.querySelector(".brag-book-gallery-clear-all-filters");e&&e.remove();const a=document.createElement("button");a.className="brag-book-gallery-clear-all-filters",a.setAttribute("data-action","clear-filters"),a.textContent="Clear All",a.onclick=function(e){e.preventDefault(),console.log("Clear All button clicked!");try{if("function"==typeof window.clearProcedureFilters)return console.log("Method 1: Calling window.clearProcedureFilters..."),console.log("Function definition:",window.clearProcedureFilters.toString().substring(0,100)),window.clearProcedureFilters(),void console.log("Function call completed");if("function"==typeof clearProcedureFilters)return console.log("Method 2: Calling clearProcedureFilters..."),void clearProcedureFilters();console.log("Method 3: Manual clear - function not found");const e=document.querySelectorAll('.brag-book-gallery-filter-option input[type="checkbox"]');console.log("Manually unchecking",e.length,"checkboxes"),e.forEach(e=>{e.checked=!1});const t=document.querySelectorAll(".brag-book-gallery-case-card");console.log("Manually showing",t.length,"cards"),t.forEach(e=>{e.style.display=""});const a=document.querySelector(".brag-book-gallery-active-filters");a&&(a.style.display="none",a.innerHTML="");const o=document.querySelector(".brag-book-gallery-filter-results");o&&(o.style.display="none");const r=document.querySelector(".brag-book-gallery-filter-dropdown__toggle");r&&r.classList.remove("has-active-filters"),console.log("Manual clear completed")}catch(e){console.error("Error in Clear All button:",e)}},console.log("Created Clear All button"),t.parentNode&&t.parentNode.insertBefore(a,t.nextSibling)}else{const e=document.querySelector(".brag-book-gallery-clear-all-filters");e&&e.remove()}else t.style.display="none"}();let a=document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]');if(0===a.length&&(a=document.querySelectorAll(".brag-book-gallery-case-grid .brag-book-gallery-case-card")),0===a.length&&(a=document.querySelectorAll(".brag-book-gallery-case-card")),console.log("Filtering cards, found:",a.length,"cards"),a.length>0){const e=a[0];console.log("First card data attributes:",{age:e.dataset.age,gender:e.dataset.gender,ethnicity:e.dataset.ethnicity,caseId:e.dataset.caseId})}if(!t){a.forEach(e=>{e.style.display=""});const e=document.querySelector(".brag-book-gallery-filter-results");e&&(e.style.display="none");const t=document.querySelector('button[onclick*="loadMoreCases"]')||document.querySelector(".brag-book-gallery-load-more button"),o=t?t.closest(".brag-book-gallery-load-more-container")||t.parentElement:null;return void(o&&t.hasAttribute("data-start-page")&&(o.style.display=""))}let o=0;if(a.forEach((e,t)=>{let a=!0;const r=e.dataset.caseId;if(window.bragBookProcedureFilters.age.length>0){const t=parseInt(e.dataset.age);console.log("Case",r,"has age:",t,"(type:",typeof t,") checking against filters:",window.bragBookProcedureFilters.age);let o=!1;window.bragBookProcedureFilters.age.forEach(e=>{console.log("Checking age range:",e,"against card age:",t),"18-24"===e&&t>=18&&t<25?(console.log("Matched 18-24 range"),o=!0):"25-34"===e&&t>=25&&t<35?(console.log("Matched 25-34 range"),o=!0):"35-44"===e&&t>=35&&t<45?(console.log("Matched 35-44 range"),o=!0):"45-54"===e&&t>=45&&t<55?(console.log("Matched 45-54 range"),o=!0):"55-64"===e&&t>=55&&t<65?(console.log("Matched 55-64 range"),o=!0):"65+"===e&&t>=65&&(console.log("Matched 65+ range"),o=!0)}),console.log("Case",r,"age match result:",o),o||(a=!1)}if(a&&window.bragBookProcedureFilters.gender.length>0){const t=(e.dataset.gender||"").toLowerCase(),o=window.bragBookProcedureFilters.gender.map(e=>e.toLowerCase());console.log("Case",r,"has gender:",t,"checking against filters:",o),o.includes(t)||(console.log("Case",r,"gender does not match"),a=!1)}if(a&&window.bragBookProcedureFilters.ethnicity.length>0){const t=(e.dataset.ethnicity||"").toLowerCase(),o=window.bragBookProcedureFilters.ethnicity.map(e=>e.toLowerCase());console.log("Case",r,"has ethnicity:",t,"checking against filters:",o),o.includes(t)||(console.log("Case",r,"ethnicity does not match"),a=!1)}if(a&&window.bragBookProcedureFilters.height.length>0){const t=parseInt(e.dataset.height);let o=!1;window.bragBookProcedureFilters.height.forEach(e=>{("Under 5'0\""===e&&t<60||"5'0\" - 5'3\""===e&&t>=60&&t<64||"5'4\" - 5'7\""===e&&t>=64&&t<68||"5'8\" - 5'11\""===e&&t>=68&&t<72||"6'0\" and above"===e&&t>=72)&&(o=!0)}),console.log("Case",r,"height match:",o),o||(a=!1)}if(a&&window.bragBookProcedureFilters.weight.length>0){const t=parseInt(e.dataset.weight);let o=!1;window.bragBookProcedureFilters.weight.forEach(e=>{("Under 120 lbs"===e&&t<120||"120-149 lbs"===e&&t>=120&&t<150||"150-179 lbs"===e&&t>=150&&t<180||"180-209 lbs"===e&&t>=180&&t<210||"210+ lbs"===e&&t>=210)&&(o=!0)}),console.log("Case",r,"weight match:",o),o||(a=!1)}console.log("Case",r,"final show decision:",a),e.style.display=a?"":"none",a&&o++}),t){const e=0===o?"No cases match the selected filters":`Filter applied: Showing ${o} matching case${1!==o?"s":""}`,t=function(){let e=document.querySelector(".brag-book-gallery-filter-results");if(!e){e=document.createElement("div"),e.className="brag-book-gallery-filter-results",e.style.display="none";const t=document.querySelector(".brag-book-gallery-case-grid")||document.querySelector(".brag-book-gallery-cases-grid");t&&t.parentNode&&t.parentNode.insertBefore(e,t)}return e}();t.textContent=e,t.style.display="block"}else{const e=document.querySelector(".brag-book-gallery-filter-results");e&&(e.style.display="none")}const r=document.getElementById("procedure-filters-details");if(r){r.open=!1;const e=r.querySelector(".brag-book-gallery-filter-dropdown__toggle");e&&e.classList.add("has-active-filters")}const s=document.querySelector('button[onclick*="loadMoreCases"]')||document.querySelector(".brag-book-gallery-load-more button"),i=s?s.closest(".brag-book-gallery-load-more-container")||s.parentElement:null;i&&(i.style.display="none")},window.loadFilteredCases=function(e){const t=document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]');t.forEach(e=>{e.style.display="none"});let a=0,o=[];if(e.forEach(e=>{const t=document.querySelector(`.brag-book-gallery-case-card[data-case-id="${e}"]`);t?(t.style.display="",a++):o.push(e)}),o.length>0){const e=document.querySelector(".brag-book-gallery-case-grid")||document.querySelector(".brag-book-gallery-case-grid");if(e){const t=document.createElement("div");t.className="filter-loading-message",t.textContent=`Loading ${o.length} additional matching cases...`,t.style.cssText="padding: 20px; text-align: center; font-style: italic;",e.appendChild(t),async function(e){try{let t=[],a=[];window.bragBookCompleteDataset&&Array.isArray(window.bragBookCompleteDataset)?e.forEach(e=>{const o=window.bragBookCompleteDataset.find(t=>String(t.id)===String(e));o?t.push(o):a.push(e)}):a=[...e];let o="";if(t.length>0&&t.forEach(e=>{o+=function(e){const t=e.id||"";let a="";if(e.photoSets&&Array.isArray(e.photoSets)&&e.photoSets.length>0){const t=e.photoSets[0];a=t.postProcessedImageLocation||t.beforeLocationUrl||t.afterLocationUrl1||""}let o="Unknown Procedure";e.procedures&&Array.isArray(e.procedures)&&e.procedures.length>0&&(o=e.procedures[0].name||o);let r=`<article class="brag-book-gallery-case-card" data-case-id="${b(String(t))}" data-card="true">`;r+=`<div class="brag-book-gallery-case-image-container" onclick="loadCaseDetails('${t}')">`,a&&(r+=`<img src="${b(a)}" alt="${b(o)} case" loading="lazy">`);const s=document.querySelector(".brag-book-gallery-nav-link.brag-book-gallery-active");return s&&"true"===s.dataset.nudity&&(r+='<div class="brag-book-gallery-nudity-overlay">',r+='<div class="brag-book-gallery-nudity-warning">',r+='<div class="brag-book-gallery-nudity-warning-content">',r+='<h4 class="brag-book-gallery-nudity-warning-title">Nudity Warning</h4>',r+='<p class="brag-book-gallery-nudity-warning-caption">This procedure may contain nudity or sensitive content. Click to proceed if you wish to view.</p>',r+='<button class="brag-book-gallery-nudity-warning-button" type="button">Proceed</button>',r+="</div>",r+="</div>",r+="</div>"),r+='<div class="brag-book-gallery-case-overlay">',r+='<span class="brag-book-gallery-case-view-text">View Case</span>',r+="</div>",r+="</div>",r+='<div class="brag-book-gallery-case-info">',r+=`<h3>${b(o)}</h3>`,r+="</div>",r+="</article>",r}(e)}),a.length>0)try{const e=await g(a);e.success&&e.html&&(o+=e.html)}catch(e){console.warn("AJAX fallback failed for filtered cases:",e)}return{success:o.length>0,html:o,casesFound:t.length+(a.length>0?1:0),fromCache:t.length,fromAjax:a.length}}catch(t){return console.error("Error in optimized filtered cases loading:",t),await g(e)}}(o).then(t=>{const o=e.querySelector(".filter-loading-message");if(o&&o.remove(),t.success&&t.html){const o=document.createElement("div");o.innerHTML=t.html,o.querySelectorAll(".brag-book-gallery-case-card").forEach(t=>{e.appendChild(t),a++}),updateFilteredCount(a,window.bragBookCompleteDataset.length)}else updateFilteredCount(a,window.bragBookCompleteDataset.length)}).catch(t=>{console.error("Error loading filtered cases:",t);const o=e.querySelector(".filter-loading-message");o&&(o.textContent="Failed to load additional cases. Showing only currently loaded matches.",setTimeout(()=>o.remove(),3e3)),updateFilteredCount(a,window.bragBookCompleteDataset.length)})}}else updateFilteredCount(a,window.bragBookCompleteDataset?window.bragBookCompleteDataset.length:t.length);const r=document.querySelector('button[onclick*="loadMoreCases"]')||document.querySelector(".brag-book-gallery-load-more button"),s=r?r.closest(".brag-book-gallery-load-more-container")||r.parentElement:null;s&&(s.style.display="none")},window.updateFilteredCount=function(e,t){const a=document.querySelector(".brag-book-gallery-favorite-count-label")||document.querySelector(".cases-count");a&&(a.textContent=`Showing ${e} of ${t}`)},window.clearProcedureFilters=function(){console.log("clearProcedureFilters called");const e=document.querySelectorAll('.brag-book-gallery-filter-option input[type="checkbox"]');console.log("Unchecking",e.length,"filter checkboxes"),e.forEach(e=>{e.checked=!1}),window.bragBookProcedureFilters&&(window.bragBookProcedureFilters.age=[],window.bragBookProcedureFilters.gender=[],window.bragBookProcedureFilters.ethnicity=[],window.bragBookProcedureFilters.height=[],window.bragBookProcedureFilters.weight=[],console.log("Reset global filter state"));const t=document.querySelectorAll(".brag-book-gallery-case-card");console.log("Showing",t.length,"case cards"),t.forEach(e=>{e.style.display="",e.style.visibility=""});const a=document.querySelector(".brag-book-gallery-wrapper");a&&a.classList.contains("has-active-filters")&&(console.log("Removing has-active-filters class from wrapper"),a.classList.remove("has-active-filters"));const o=document.querySelector(".brag-book-gallery-active-filters");o&&(console.log("Hiding active filters section"),o.style.display="none",o.innerHTML="");const r=document.querySelector(".brag-book-gallery-filter-results");r&&(console.log("Hiding filter results message"),r.style.display="none");const s=document.querySelector('button[onclick*="loadMoreCases"]')||document.querySelector(".brag-book-gallery-load-more button");if(s){const e=s.closest(".brag-book-gallery-load-more-container")||s.parentElement;e&&(console.log("Showing Load More button"),e.style.display="")}const i=document.querySelector(".brag-book-gallery-clear-all-filters");i&&(console.log("Hiding Clear All button"),i.style.display="none");const l=document.getElementById("procedure-filters-details");if(l){l.open=!1;const e=l.querySelector("summary");e&&e.classList.contains("has-active-filters")&&(console.log("Removing has-active-filters class from filter dropdown summary"),e.classList.remove("has-active-filters"))}console.log("clearProcedureFilters completed")},window.syncImageHeights=function(e){e.style.opacity="1";const t=e.closest(".brag-book-gallery-image-container");if(t){const e=t.querySelector(".brag-book-gallery-skeleton-loader");e&&(e.style.display="none")}const a=e.closest(".brag-book-gallery-case-images");if(!a)return;const o=a.querySelectorAll("img");let r=!0;if(o.forEach(e=>{e.complete&&e.naturalHeight||(r=!1)}),!r)return;let s=0;o.forEach(e=>{const t=e.naturalHeight/e.naturalWidth;t>s&&(s=t)}),a.querySelectorAll(".brag-book-gallery-image-container").forEach(e=>{e.style.paddingBottom=100*s+"%"})},window.loadCaseDetails=function(e,t,a,o){window.loadCaseDetailsWithName(e,t,a,"",o)},window.loadCaseDetailsWithName=function(e,t,a,o,r){const s=document.getElementById("gallery-content");if(!s)return void console.error("Gallery content container not found");if(!r){const t=document.querySelector(`.brag-book-gallery-case-card[data-case-id="${e}"]`);t&&t.dataset.procedureIds&&(r=t.dataset.procedureIds)}if(s.innerHTML='<div class="brag-book-gallery-loading">Loading case details...</div>',a&&window.history&&window.history.pushState){const o=document.querySelector(".brag-book-gallery-wrapper");let r=o?.dataset.baseUrl||window.location.pathname;if(r=r.replace(/\/[^\/]+\/\d+\/?$/,""),r=r.replace(/\/[^\/]+\/?$/,""),r=r.replace(/\/$/,""),!r||""===r){const e=window.location.pathname.split("/").filter(e=>e);r=e.length>0?"/"+e[0]:""}const s=`${r}/${a}/${e}`;window.history.pushState({caseId:e,procedureId:t,procedureSlug:a},"",s)}const i={action:"brag_book_gallery_load_case_details",case_id:e,nonce:bragBookGalleryConfig.nonce};t&&(i.procedure_id=t),a&&(i.procedure_slug=a),o&&(i.procedure_name=o),r&&(i.procedure_ids=r),fetch(bragBookGalleryConfig.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(i)}).then(e=>e.json()).then(e=>{if(e.success){s.innerHTML=e.data.html;const t=document.querySelector(".brag-book-gallery-wrapper");t?t.scrollIntoView({behavior:"smooth",block:"start"}):s.scrollIntoView({behavior:"smooth",block:"start"})}else{let t="Unknown error";e.data&&(t="string"==typeof e.data?e.data:e.data.message?e.data.message:JSON.stringify(e.data)),s.innerHTML='<div class="brag-book-gallery-error">Failed to load case details: '+t+"</div>"}}).catch(e=>{console.error("Error loading case details:",e),s.innerHTML='<div class="brag-book-gallery-error">Error loading case details. Please try again.</div>'})},window.loadMoreCases=function(e){e.disabled=!0;const t=e.textContent;e.textContent="Loading...";const a=e.getAttribute("data-start-page"),o=e.getAttribute("data-procedure-ids"),r=e.getAttribute("data-procedure-name")||"";let s=!1;const i=document.querySelector(".brag-book-gallery-nav-link.brag-book-gallery-active");i&&"true"===i.dataset.nudity&&(s=!0);const l=document.querySelectorAll("[data-case-id]"),n=Array.from(l).map(e=>e.getAttribute("data-case-id")).filter(Boolean);(async function(e,t,a,o,r){try{const o=window.bragBookGalleryConfig?.apiToken||"",s=window.bragBookGalleryConfig?.websitePropertyId||"",i=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",l=window.bragBookGalleryConfig?.nonce||"";if(!(o&&s&&i&&l))return{success:!1,error:"Missing API configuration"};const n={apiTokens:[o],websitePropertyIds:[parseInt(s)],count:parseInt(e)};if(t){const e=t.split(",").map(e=>parseInt(e)).filter(e=>!isNaN(e));e.length>0&&(n.procedureIds=e)}const c=new FormData;c.append("action","brag_book_api_proxy"),c.append("nonce",l),c.append("endpoint","/api/plugin/combine/cases"),c.append("method","POST"),c.append("body",JSON.stringify(n)),c.append("timeout","8");const d=new AbortController,g=setTimeout(()=>d.abort(),1e4),h=await fetch(i,{method:"POST",body:c,signal:d.signal});if(clearTimeout(g),!h.ok)throw new Error(`HTTP error! status: ${h.status}`);const u=await h.json();if(!u.success||!u.data||!u.data.data)throw new Error(u.data?.message||"API proxy request failed");const p=u.data.data;if(!p||!p.data||!Array.isArray(p.data))return{success:!1,error:"Invalid API response"};const y=[];p.data.forEach(e=>{const t=e.id?String(e.id):"";t&&!r.includes(t)&&y.push(e)});let m=!1;const f=10;if(p.data.length>=f){const t={...n,count:parseInt(e)+1};try{const e=new FormData;e.append("action","brag_book_api_proxy"),e.append("nonce",l),e.append("endpoint","/api/plugin/combine/cases"),e.append("method","POST"),e.append("body",JSON.stringify(t)),e.append("timeout","5");const a=await fetch(i,{method:"POST",body:e,signal:AbortSignal.timeout(5e3)});if(a.ok){const e=await a.json();e.success&&e.data&&e.data.data&&e.data.data.data&&Array.isArray(e.data.data.data)&&e.data.data.data.length>0&&(m=!0)}}catch(e){m=p.data.length>=f}}const v=function(e,t){let a="";return e.forEach(e=>{const o={...e};if(o.mainImageUrl="",e.photoSets&&Array.isArray(e.photoSets)&&e.photoSets.length>0){const t=e.photoSets[0];o.mainImageUrl=t.postProcessedImageLocation||t.beforeLocationUrl||t.afterLocationUrl1||""}o.procedureTitle=t||"Unknown Procedure",e.procedures&&Array.isArray(e.procedures)&&e.procedures.length>0&&(o.procedureTitle=e.procedures[0].name||o.procedureTitle),a+=function(e){const t=e.id||"",a=e.procedureTitle||"Unknown Procedure";let o='data-card="true"';e.age&&(o+=` data-age="${b(e.age)}"`),e.gender&&(o+=` data-gender="${b(e.gender.toLowerCase())}"`),e.ethnicity&&(o+=` data-ethnicity="${b(e.ethnicity.toLowerCase())}"`);const r=e.procedureIds?e.procedureIds.join(","):"",s=window.bragBookGalleryConfig?.gallerySlug||"gallery",i=function(){const e=window.location.pathname.split("/").filter(e=>e),t=window.bragBookGalleryConfig?.gallerySlug||"gallery",a=e.indexOf(t.replace(/^\/+/,""));if(a>=0&&a+1<e.length){const t=e[a+1];if(!/^\d+$/.test(t))return t}return null}()||"case",l=`/${s}/${i}/${e.caseDetails&&e.caseDetails[0]&&e.caseDetails[0].seoSuffixUrl||t}/`;let n=`<article class="brag-book-gallery-case-card" ${o} data-case-id="${b(t)}" data-procedure-ids="${b(r)}">`;n+=`<a href="${b(l)}" class="case-link" data-case-id="${b(t)}" data-procedure-ids="${b(r)}">`;const c=window.bragBookGalleryConfig?.imageDisplayMode||"single";if(e.photoSets&&Array.isArray(e.photoSets)&&e.photoSets.length>0){const t=e.photoSets[0];if("before_after"===c)n+='<div class="brag-book-gallery-case-images before-after">',t.beforePhoto&&(n+=`<img src="${b(t.beforePhoto)}" alt="Before" class="before-image" />`),t.afterPhoto&&(n+=`<img src="${b(t.afterPhoto)}" alt="After" class="after-image" />`),n+="</div>";else{const e=t.afterPhoto||t.beforePhoto||"";e&&(n+=`<div class="brag-book-gallery-case-images"><img src="${b(e)}" alt="Case Image" /></div>`)}}const d=document.querySelector(".brag-book-gallery-nav-link.brag-book-gallery-active");d&&"true"===d.dataset.nudity&&(n+='<div class="brag-book-gallery-nudity-warning">',n+='<div class="brag-book-gallery-nudity-warning-content">',n+='<h4 class="brag-book-gallery-nudity-warning-title">Nudity Warning</h4>',n+='<p class="brag-book-gallery-nudity-warning-caption">This procedure may contain nudity or sensitive content. Click to proceed if you wish to view.</p>',n+='<button class="brag-book-gallery-nudity-warning-button" type="button">Proceed</button>',n+="</div>",n+="</div>");const g=e.caseDetails&&e.caseDetails[0]&&e.caseDetails[0].seoHeadline||a;return g&&(n+=`<h3 class="case-title">${b(g)}</h3>`),n+="</a>",n+="</article>",n}(o)}),a}(y,a);return{success:!0,html:v,casesLoaded:y.length,hasMore:m,nextPage:m?parseInt(e)+1:null}}catch(e){return console.error("Direct API error for load more:",e),{success:!1,error:e.message}}})(a,o,r,0,n).then(i=>{i.success?p(i,e,t,a):(console.log("Direct API failed for load more, falling back to AJAX"),h(e,a,o,r,s,n,t))}).catch(i=>{console.log("Direct API error for load more, falling back to AJAX:",i),h(e,a,o,r,s,n,t)})},window.clearProcedureFilter=function(){window.location.href=window.location.origin+window.location.pathname.split("/").slice(0,-1).join("/")+"/"},window.removeFilterBadge=function(e,t){const a=document.querySelector(`#brag-book-gallery-filters input[data-filter-type="${e}"][value="${t}"]`);a&&(a.checked=!1),applyProcedureFilters()},window.bragBookSetImageAspectRatio=function(e){const t=e.naturalWidth,a=e.naturalHeight;if(t&&a){const o=t+"/"+a,r=e.closest(".brag-book-gallery-image-container, .brag-book-gallery-thumb-image");r&&(r.style.aspectRatio=o,r.style.width="100%",r.style.height="auto",r.style.minHeight="auto",r.style.maxHeight="none",e.style.width="100%",e.style.height="100%",e.style.objectFit="contain",r.removeAttribute("data-image-loading"))}},window.initInfiniteScroll=function(){if("yes"!==window.bragBookGalleryConfig?.infiniteScroll)return;let e,t=!1;const a=()=>{clearTimeout(e),e=setTimeout(()=>{if(t)return;const e=document.querySelector('button[onclick*="loadMoreCases"]')||document.querySelector(".brag-book-gallery-load-more button");if(!e||e.disabled||"none"===e.style.display)return;const a=e.closest(".brag-book-gallery-load-more-container");a&&"none"===a.style.display||window.innerHeight+window.scrollY>=document.documentElement.offsetHeight-800&&(t=!0,e.click(),setTimeout(()=>{t=!1},1e3))},100)};window.addEventListener("scroll",a,{passive:!0}),window.addEventListener("resize",a,{passive:!0}),window.infiniteScrollHandler=a},function(){const e=()=>{const e=document.querySelector(".brag-book-gallery-filter-results");e&&(e.style.display="none !important")};e(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e(),new MutationObserver(e=>{e.forEach(e=>{"childList"===e.type&&e.addedNodes.forEach(e=>{1===e.nodeType&&e.classList&&e.classList.contains("brag-book-gallery-filter-results")&&(e.style.display="none !important")})})}).observe(document.body||document.documentElement,{childList:!0,subtree:!0})}(),window.loadMoreCasesFromCache=function(e){console.log("loadMoreCasesFromCache called"),e.disabled=!0;const t=e.textContent;e.textContent="Loading...";const a=e.getAttribute("data-start-page")||"2",o=e.getAttribute("data-procedure-ids")||"",r=e.getAttribute("data-procedure-name")||"";console.log("Loading page:",a,"for procedure:",r);const s=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",i=window.bragBookGalleryConfig?.nonce||"",l=new FormData;l.append("action","brag_book_gallery_load_more_cases"),l.append("nonce",i),l.append("start_page",a),l.append("procedure_ids",o),l.append("procedure_name",r),l.append("loaded_ids",""),fetch(s,{method:"POST",body:l}).then(e=>e.json()).then(o=>{if(console.log("Load more result:",o),o.success&&o.data&&o.data.html){let r=document.querySelector(".brag-book-gallery-case-grid");if(r||(r=document.querySelector(".brag-book-gallery-cases-grid")),r){const s=r.querySelector(".brag-book-gallery-case-card:last-child");s?s.insertAdjacentHTML("afterend",o.data.html):r.insertAdjacentHTML("beforeend",o.data.html),u();const i=parseInt(a)+1;e.setAttribute("data-start-page",i.toString()),!1===o.data.hasMore?e.style.display="none":(e.disabled=!1,e.textContent=t)}}else console.error("Load more failed:",o),e.disabled=!1,e.textContent=t}).catch(a=>{console.error("Load more error:",a),e.disabled=!1,e.textContent=t})},document.addEventListener("DOMContentLoaded",()=>{d();const e=document.querySelector(".brag-book-gallery-filter-results");e&&(e.style.display="none");const t=document.querySelector(".brag-book-gallery-filter-badges");t&&t.remove(),new c,y=new l,m=new n,console.log("Simplified pagination system initialized");const a=document.querySelector(".brag-book-gallery-case-grid");if(a&&(setTimeout(()=>{a.classList.add("grid-initialized")},1e3),window.innerWidth>=1024)){const e=localStorage.getItem("bragbook-grid-columns");if(e){const t=parseInt(e);a.setAttribute("data-columns",t),document.querySelectorAll(".brag-book-gallery-grid-btn").forEach(e=>{parseInt(e.dataset.columns)===t?e.classList.add("active"):e.classList.remove("active")})}else a.setAttribute("data-columns","3")}initInfiniteScroll()}),document.addEventListener("DOMContentLoaded",function(){setTimeout(function(){!window.bragBookCompleteDataset&&window.bragBookGalleryConfig&&window.bragBookGalleryConfig.completeDataset&&(window.bragBookCompleteDataset=window.bragBookGalleryConfig.completeDataset),initializeProcedureFilters();const e=document.querySelector(".brag-book-gallery-wrapper");if(e&&e.dataset.initialCaseId){const t=e.dataset.initialCaseId,a=window.location.pathname.split("/").filter(e=>e),o=a.length>2?a[a.length-2]:"";let r="";const s=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${o}"]`);if(s){const e=s.querySelector(".brag-book-gallery-filter-option-label");e&&(r=e.textContent.trim())}if(!r&&window.bragBookGalleryConfig&&window.bragBookGalleryConfig.sidebarData){const e=window.bragBookGalleryConfig.sidebarData;for(const t of Object.values(e)){if(t.procedures)for(const e of t.procedures)if(e.slug===o){r=e.name;break}if(r)break}}let i="";setTimeout(()=>{const e=document.querySelector(`.brag-book-gallery-case-card[data-case-id="${t}"]`);e&&e.dataset.procedureIds&&(i=e.dataset.procedureIds),window.loadCaseDetailsWithName(t,"",o,r,i)},200)}},100)}),document.addEventListener("toggle",function(e){if("procedure-filters-details"===e.target.id){const t=e.target;t.open&&!t.dataset.initialized&&(generateProcedureFilterOptions(),t.dataset.initialized="true")}}),document.addEventListener("click",function(e){const t=document.getElementById("procedure-filters-details"),a=document.querySelector(".brag-book-gallery-filter-dropdown__panel");t&&t.open&&a&&(t.contains(e.target)||a.contains(e.target)||(t.open=!1))})}();