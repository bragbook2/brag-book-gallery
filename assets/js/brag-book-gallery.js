!function(){"use strict";var e=class{constructor(e,t={}){this.wrapper=e,this.content=e.querySelector(".brag-book-gallery-carousel-content"),this.track=e.querySelector(".brag-book-gallery-carousel-track"),this.prevBtn=e.querySelector('[data-direction="prev"]'),this.nextBtn=e.querySelector('[data-direction="next"]'),this.paginationContainer=e.querySelector(".brag-book-gallery-carousel-pagination"),this.options={itemsPerView:t.itemsPerView||this.getItemsPerView(),gap:t.gap||16,animationDuration:t.animationDuration||.4,slideSelector:t.slideSelector||".brag-book-gallery-carousel-item",infinite:!1!==t.infinite,autoplay:t.autoplay||!1,autoplayDelay:t.autoplayDelay||3e3,pauseOnHover:!1!==t.pauseOnHover,...t},this.isDown=!1,this.startX=0,this.scrollLeft=0,this.currentSlide=0,this.autoplayTimer=null,this.isPaused=!1,this.track&&this.init()}init(){this.createLiveRegion(),this.addShareButtons(),this.setupEventListeners(),this.initializePagination(),this.updateCarouselButtons(),this.updateAriaLabels(),this.options.autoplay&&this.startAutoplay()}addShareButtons(){this.track.querySelectorAll(this.options.slideSelector).forEach((e,t)=>{if(!e.querySelector(".brag-book-gallery-carousel-image, img")){const t="https://bragbookgallery.com/nitropack_static/FCmixFCiYNkGgqjxyaUSblqHbCgLrqyJ/assets/images/optimized/rev-407fb37/ngnqwvuungodwrpnrczq.supabase.co/storage/v1/object/sign/brag-photos/org_2vm5nGWtoCYuaQBCP587ez6cYXF/c68b56b086f4f8eef8292f3f23320f1b.Blepharoplasty%20-%20aa239d58-badc-4ded-a26b-f89c2dd059b6.jpg",o=e.querySelector("span");o&&o.remove();const a=e.dataset.caseId;if(a&&""!==a){const o=e.dataset.procedureSlug||"procedure",r=`${window.location.pathname.replace(/\/[^\/]+\/[^\/]+\/?$/,"")}/${o}/${a}`.replace(/\/+/g,"/"),s=document.createElement("a");s.href=r,s.className="brag-book-gallery-case-card-link",s.dataset.caseId=a;const i=document.createElement("img");i.src=t,i.alt="Before and after result",i.className="brag-book-gallery-carousel-image",i.loading="lazy",s.appendChild(i),e.insertBefore(s,e.firstChild)}else{const o=document.createElement("img");o.src=t,o.alt="Before and after result",o.className="brag-book-gallery-carousel-image",o.loading="lazy",e.insertBefore(o,e.firstChild)}}let o=e.querySelector(".brag-book-gallery-item-actions");if(o||(o=document.createElement("div"),o.className="brag-book-gallery-item-actions",e.appendChild(o)),!o.querySelector(".brag-book-gallery-favorite-button")){const t=e.querySelector(".brag-book-gallery-favorite-button");if(t)o.appendChild(t);else{const t=document.createElement("button");t.className="brag-book-gallery-favorite-button",t.dataset.favorited="false",t.dataset.itemId=e.dataset.slide,t.setAttribute("aria-label","Add to favorites"),t.innerHTML='\n                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n                        </svg>\n                    ',o.appendChild(t)}}if(!o.querySelector(".brag-book-gallery-share-button")&&"undefined"!=typeof bragBookGalleryConfig&&"yes"===bragBookGalleryConfig.enableSharing){const t=document.createElement("button");t.className="brag-book-gallery-share-button",t.dataset.itemId=e.dataset.slide,t.setAttribute("aria-label","Share this image"),t.innerHTML='\n                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">\n                        <path d="M672.22-100q-44.91 0-76.26-31.41-31.34-31.41-31.34-76.28 0-6 4.15-29.16L284.31-404.31q-14.46 15-34.36 23.5t-42.64 8.5q-44.71 0-76.01-31.54Q100-435.39 100-480q0-44.61 31.3-76.15 31.3-31.54 76.01-31.54 22.74 0 42.64 8.5 19.9 8.5 34.36 23.5l284.46-167.08q-2.38-7.38-3.27-14.46-.88-7.08-.88-15.08 0-44.87 31.43-76.28Q627.49-860 672.4-860t76.25 31.44Q780-797.13 780-752.22q0 44.91-31.41 76.26-31.41 31.34-76.28 31.34-22.85 0-42.5-8.69Q610.15-662 595.69-677L311.23-509.54q2.38 7.39 3.27 14.46.88 7.08.88 15.08t-.88 15.08q-.89 7.07-3.27 14.46L595.69-283q14.46-15 34.12-23.69 19.65-8.69 42.5-8.69 44.87 0 76.28 31.43Q780-252.51 780-207.6t-31.44 76.25Q717.13-100 672.22-100Zm.09-60q20.27 0 33.98-13.71Q720-187.42 720-207.69q0-20.27-13.71-33.98-13.71-13.72-33.98-13.72-20.27 0-33.98 13.72-13.72 13.71-13.72 33.98 0 20.27 13.72 33.98Q652.04-160 672.31-160Zm-465-272.31q20.43 0 34.25-13.71 13.83-13.71 13.83-33.98 0-20.27-13.83-33.98-13.82-13.71-34.25-13.71-20.11 0-33.71 13.71Q160-500.27 160-480q0 20.27 13.6 33.98 13.6 13.71 33.71 13.71Zm465-272.3q20.27 0 33.98-13.72Q720-732.04 720-752.31q0-20.27-13.71-33.98Q692.58-800 672.31-800q-20.27 0-33.98 13.71-13.72 13.71-13.72 33.98 0 20.27 13.72 33.98 13.71 13.72 33.98 13.72Zm0 496.92ZM207.69-480Zm464.62-272.31Z"/>\n                    </svg>\n                ',o.appendChild(t)}})}createLiveRegion(){this.liveRegion=document.createElement("div"),this.liveRegion.setAttribute("aria-live","polite"),this.liveRegion.setAttribute("aria-atomic","true"),this.liveRegion.className="sr-only",this.liveRegion.style.position="absolute",this.liveRegion.style.width="1px",this.liveRegion.style.height="1px",this.liveRegion.style.padding="0",this.liveRegion.style.margin="-1px",this.liveRegion.style.overflow="hidden",this.liveRegion.style.clip="rect(0, 0, 0, 0)",this.liveRegion.style.whiteSpace="nowrap",this.liveRegion.style.border="0",this.wrapper.appendChild(this.liveRegion)}setupEventListeners(){this.track.addEventListener("scroll",()=>{this.updateCarouselButtons(),this.updatePagination()}),this.prevBtn&&this.prevBtn.addEventListener("click",()=>{this.navigate("prev"),this.options.autoplay&&(this.stopAutoplay(),this.startAutoplay())}),this.nextBtn&&this.nextBtn.addEventListener("click",()=>{this.navigate("next"),this.options.autoplay&&(this.stopAutoplay(),this.startAutoplay())}),this.track.addEventListener("mousedown",e=>this.handleMouseDown(e)),this.track.addEventListener("mouseleave",()=>this.handleMouseLeave()),this.track.addEventListener("mouseup",()=>this.handleMouseUp()),this.track.addEventListener("mousemove",e=>this.handleMouseMove(e)),this.options.autoplay&&this.options.pauseOnHover&&(this.wrapper.addEventListener("mouseenter",()=>this.pauseAutoplay()),this.wrapper.addEventListener("mouseleave",()=>this.resumeAutoplay())),this.track.addEventListener("wheel",e=>this.handleWheel(e),{passive:!1}),this.track.addEventListener("keydown",e=>this.handleKeydown(e)),this.wrapper.addEventListener("keydown",e=>this.handleKeydown(e)),document.addEventListener("keydown",e=>{this.wrapper.contains(document.activeElement)&&this.handleKeydown(e)}),this.track.tabIndex=0,this.track.setAttribute("aria-label","Use arrow keys to navigate through slides"),this.setupSlideFocusManagement()}handleMouseDown(e){this.isDown=!0,this.track.classList.add("brag-book-gallery-grabbing"),this.startX=e.pageX-this.track.offsetLeft,this.scrollLeft=this.track.scrollLeft}handleMouseLeave(){this.isDown=!1,this.track.classList.remove("brag-book-gallery-grabbing")}handleMouseUp(){this.isDown=!1,this.track.classList.remove("brag-book-gallery-grabbing")}handleMouseMove(e){if(!this.isDown)return;e.preventDefault();const t=2*(e.pageX-this.track.offsetLeft-this.startX);this.track.scrollLeft=this.scrollLeft-t}handleKeydown(e){if("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName)return;const t=this.track.querySelectorAll(this.options.slideSelector);if(0===t.length)return;const o=this.getCurrentSlideIndex();let a=!1;switch(e.key){case"ArrowLeft":e.preventDefault(),e.stopPropagation(),this.navigateToSlide(Math.max(0,o-1)),a=!0;break;case"ArrowRight":e.preventDefault(),e.stopPropagation(),this.navigateToSlide(Math.min(t.length-1,o+1)),a=!0;break;case"Home":e.preventDefault(),e.stopPropagation(),this.navigateToSlide(0),a=!0;break;case"End":e.preventDefault(),e.stopPropagation(),this.navigateToSlide(t.length-1),a=!0;break;case"PageUp":e.preventDefault(),e.stopPropagation();const r=this.getItemsPerView();this.navigateToSlide(Math.max(0,o-r)),a=!0;break;case"PageDown":e.preventDefault(),e.stopPropagation();const s=this.getItemsPerView();this.navigateToSlide(Math.min(t.length-1,o+s)),a=!0}a&&document.activeElement!==this.track&&!this.track.contains(document.activeElement)&&this.track.focus(),a&&this.options.autoplay&&(this.stopAutoplay(),this.startAutoplay())}handleWheel(e){e.preventDefault();const t=e.deltaY||e.deltaX,o=Math.abs(t)>50?t:3*t;this.wheelTimeout&&clearTimeout(this.wheelTimeout),this.track.scrollBy({left:o,behavior:"smooth"}),this.wheelTimeout=setTimeout(()=>{this.updateCarouselButtons(),this.updatePagination()},150)}getItemsPerView(){const e=window.innerWidth;return e<=480?1:e<=768?2:3}navigate(e){const t=this.track.querySelectorAll(this.options.slideSelector);if(0===t.length)return;const o=this.getCurrentSlideIndex();let a;a=this.options.infinite?"next"===e?o>=t.length-1?0:o+1:o<=0?t.length-1:o-1:"next"===e?Math.min(t.length-1,o+1):Math.max(0,o-1),this.navigateToSlide(a)}navigateToSlide(e){const t=this.track.querySelectorAll(this.options.slideSelector);if(0===t.length||e<0||e>=t.length)return;const o=t[e],a=o.offsetWidth,r=this.track.offsetWidth;let s=o.offsetLeft-(r-a)/2;s=Math.max(0,Math.min(s,this.track.scrollWidth-r)),"undefined"!=typeof gsap?gsap.to(this.track,{scrollLeft:s,duration:this.options.animationDuration,ease:"power2.inOut",onComplete:()=>{this.updateAriaLabels(),this.focusSlide(e)}}):(this.track.scrollTo({left:s,behavior:"smooth"}),setTimeout(()=>{this.updateAriaLabels(),this.focusSlide(e)},300)),this.currentSlide=e}getCurrentSlideIndex(){const e=this.track.querySelectorAll(this.options.slideSelector),t=this.track.scrollLeft+this.track.offsetWidth/2;let o=0,a=1/0;return e.forEach((e,r)=>{const s=e.offsetLeft+e.offsetWidth/2,i=Math.abs(s-t);i<a&&(a=i,o=r)}),o}startAutoplay(){this.options.autoplay&&!this.autoplayTimer&&(this.autoplayTimer=setInterval(()=>{this.isPaused||this.isDown||this.navigate("next")},this.options.autoplayDelay))}stopAutoplay(){this.autoplayTimer&&(clearInterval(this.autoplayTimer),this.autoplayTimer=null)}pauseAutoplay(){this.isPaused=!0}resumeAutoplay(){this.isPaused=!1}setupSlideFocusManagement(){this.track.querySelectorAll(this.options.slideSelector).forEach((e,t)=>{e.tabIndex=-1,e.addEventListener("focus",()=>{this.currentSlide=t}),e.addEventListener("click",t=>{t.target.closest("button")||e.focus()})}),this.wrapper.tabIndex=-1,this.wrapper.style.outline="none",this.wrapper.addEventListener("click",e=>{e.target.closest("button")||e.target.closest("[tabindex]")||this.track.focus()})}focusSlide(e){const t=this.track.querySelectorAll(this.options.slideSelector);t[e]&&document.activeElement===this.track&&t[e].focus()}initializePagination(){if(!this.paginationContainer)return;this.paginationContainer.innerHTML="";const e=this.track.querySelectorAll(this.options.slideSelector),t=this.getItemsPerView(),o=Math.ceil(e.length/t);for(let e=0;e<o;e++){const t=document.createElement("button");t.className="brag-book-gallery-pagination-dot",t.role="tab",0===e?(t.classList.add("brag-book-gallery-active"),t.setAttribute("aria-selected","true")):t.setAttribute("aria-selected","false"),t.setAttribute("data-page",e),t.setAttribute("aria-label",`Go to slide group ${e+1}`),t.addEventListener("click",()=>this.goToPage(e)),this.paginationContainer.appendChild(t)}}goToPage(e){const t=this.track.querySelectorAll(this.options.slideSelector);if(0===t.length)return;const o=t[0].offsetWidth,a=this.getItemsPerView(),r=e*a*(o+this.options.gap);this.currentSlide=e*a,"undefined"!=typeof gsap?gsap.to(this.track,{scrollLeft:r,duration:.5,ease:"power2.inOut",onComplete:()=>this.updateAriaLabels()}):(this.track.scrollLeft=r,this.updateAriaLabels())}updatePagination(){if(!this.paginationContainer)return;const e=this.track.querySelectorAll(this.options.slideSelector);if(0===e.length)return;const t=e[0].offsetWidth,o=this.getItemsPerView(),a=this.track.scrollLeft,r=Math.round(a/((t+this.options.gap)*o));this.currentSlide=r*o,this.paginationContainer.querySelectorAll(".brag-book-gallery-pagination-dot").forEach((e,t)=>{t===r?(e.classList.add("brag-book-gallery-active"),e.setAttribute("aria-selected","true")):(e.classList.remove("brag-book-gallery-active"),e.setAttribute("aria-selected","false"))})}updateCarouselButtons(){if(this.options.infinite)return this.prevBtn&&(this.prevBtn.disabled=!1),void(this.nextBtn&&(this.nextBtn.disabled=!1));const e=this.track.scrollLeft,t=this.track.scrollWidth,o=this.track.clientWidth;this.prevBtn&&(this.prevBtn.disabled=e<=0),this.nextBtn&&(this.nextBtn.disabled=e>=t-o-1)}updateAriaLabels(){const e=this.track.querySelectorAll(this.options.slideSelector),t=e.length,o=this.getCurrentSlideIndex();e.forEach((e,a)=>{const r=a+1,s=a===o;e.setAttribute("aria-label",`Slide ${r} of ${t}${s?" (current)":""}`),e.setAttribute("aria-current",s?"true":"false")}),this.liveRegion&&(this.liveRegion.textContent=`Slide ${o+1} of ${t}`)}refresh(){this.options.itemsPerView=this.getItemsPerView(),this.initializePagination(),this.updatePagination(),this.updateAriaLabels()}goToSlide(e){const t=this.track.querySelectorAll(this.options.slideSelector),o=Array.from(t).find(t=>t.dataset.slide===e);if(o){const e=Array.from(t).indexOf(o),a=this.getItemsPerView(),r=Math.floor(e/a);this.goToPage(r)}}},t=class{constructor(e,t={}){this.dialog=document.getElementById(e),this.closeButtons=this.dialog?.querySelectorAll('[data-action*="close"]'),this.options={closeOnBackdrop:!1!==t.closeOnBackdrop,closeOnEscape:!1!==t.closeOnEscape,onOpen:t.onOpen||(()=>{}),onClose:t.onClose||(()=>{}),...t},this.dialog&&this.init()}init(){this.setupEventListeners()}setupEventListeners(){this.closeButtons?.forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.close()})}),this.options.closeOnBackdrop&&this.dialog&&this.dialog.addEventListener("click",e=>{e.target===this.dialog&&this.close()}),this.options.closeOnEscape&&this.dialog&&this.dialog.addEventListener("cancel",e=>{e.preventDefault(),this.close()})}open(){if(this.dialog)try{this.dialog.showModal(),document.body.style.overflow="hidden",this.options.onOpen()}catch(e){console.error("Error opening dialog:",e),this.dialog.setAttribute("open",""),this.dialog.style.display="block",document.body.style.overflow="hidden",this.options.onOpen()}}close(){if(this.dialog)try{this.dialog.close(),document.body.style.overflow="",this.dialog.style.display="",this.options.onClose()}catch(e){console.error("Error closing dialog:",e),this.dialog.removeAttribute("open"),this.dialog.style.display="none",document.body.style.overflow="",this.options.onClose()}}isOpen(){return this.dialog?.open||this.dialog?.hasAttribute("open")}},o=class{constructor(e,t={}){this.container=e,this.filterHeaders=e?.querySelectorAll(".brag-book-gallery-nav-button"),this.activeFilters=new Map,this.categories=new Map,this.procedures=new Map,this.originalTitle=document.title,this.originalDescription=document.querySelector('meta[name="description"]')?.content||"",this.options={mode:t.mode||"javascript",baseUrl:t.baseUrl||"/gallery",animateWithGsap:"undefined"!=typeof gsap,closeOthersOnOpen:!1!==t.closeOthersOnOpen,onFilterChange:t.onFilterChange||(()=>{}),onNavigate:t.onNavigate||(e=>{window.location.href=e}),...t},this.container&&this.init()}init(){this.indexFilters(),this.setupEventListeners(),this.loadStateFromUrl(),this.options.animateWithGsap&&"undefined"!=typeof gsap&&gsap.set(".brag-book-gallery-nav-list-submenu",{height:0})}indexFilters(){const e=this.container?.querySelectorAll("[data-category]");e?.forEach(e=>{const t=e.dataset.category;this.categories.has(t)||this.categories.set(t,{name:t,procedures:new Set,element:e}),e.querySelectorAll(".brag-book-gallery-nav-link").forEach(e=>{const t=e.dataset.procedure,o=e.dataset.category;if(t&&o){const a={id:t,category:o,count:parseInt(e.dataset.procedureCount||"0"),element:e.parentElement,link:e};this.procedures.set(`${o}:${t}`,a),this.categories.get(o).procedures.add(t)}})})}setupEventListeners(){this.filterHeaders?.forEach(e=>{e.addEventListener("click",()=>this.toggleFilter(e))});const e=this.container?.querySelectorAll(".brag-book-gallery-nav-link");e?.forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),this.handleFilterClick(e.currentTarget)})}),window.addEventListener("popstate",e=>{e.state&&e.state.caseId?window.loadCaseDetails(e.state.caseId,e.state.procedureId,e.state.procedureSlug):e.state&&e.state.category&&e.state.procedure?(this.reactivateFilter(e.state.category,e.state.procedure),this.loadFilteredContent(e.state.category,e.state.procedure,e.state.procedureIds,e.state.hasNudity||!1)):(this.clearAll(),window.location.reload())})}toggleFilter(e){const t="true"===e.dataset.expanded,o=e.nextElementSibling,a=e.closest(".brag-book-gallery-nav-list__item");!t&&this.options.closeOthersOnOpen&&this.closeOtherFilters(e),e.dataset.expanded=!t,o.dataset.expanded=!t,a.dataset.expanded=!t,this.options.animateWithGsap&&"undefined"!=typeof gsap?t?gsap.to(o,{height:0,opacity:0,duration:.3,ease:"power2.in"}):gsap.to(o,{height:"auto",opacity:1,duration:.4,ease:"power2.out"}):(o.style.height=t?"0":"auto",o.style.opacity=t?"0":"1")}closeOtherFilters(e){this.filterHeaders?.forEach(t=>{if(t!==e&&"true"===t.dataset.expanded){const e=t.nextElementSibling,o=t.closest(".brag-book-gallery-nav-list__item");t.dataset.expanded="false",e.dataset.expanded="false",o.dataset.expanded="false",this.options.animateWithGsap&&"undefined"!=typeof gsap?gsap.to(e,{height:0,opacity:0,duration:.3,ease:"power2.in"}):(e.style.height="0",e.style.opacity="0")}})}closeAllFilters(){this.filterHeaders?.forEach(e=>{"true"===e.dataset.expanded&&this.toggleFilter(e)})}handleFilterClick(e){const t=e.dataset.category,o=e.dataset.procedure,a=e.dataset.procedureIds,r=parseInt(e.dataset.procedureCount||"0"),s="true"===e.dataset.nudity;this.activeFilters.clear(),this.container?.querySelectorAll(".brag-book-gallery-nav-link").forEach(e=>{e.classList.remove("brag-book-gallery-active")}),e.classList.add("brag-book-gallery-active");const i=e.closest(".brag-book-gallery-nav-list-submenu__item");i&&i.classList.add("brag-book-gallery-active"),this.activeFilters.set(`${t}:${o}`,{category:t,procedure:o,procedureIds:a,count:r,hasNudity:s}),console.log("Updating filter badges after filter activation"),this.updateFilterBadges();const n=document.querySelector(".brag-book-gallery-wrapper");let l=n?.dataset.baseUrl||window.location.pathname;!n?.dataset.baseUrl&&l.match(/\/[^\/]+\/?$/)&&(l=l.replace(/\/[^\/]+\/?$/,""));const c=`${l}/${o}`.replace(/\/+/g,"/");window.history.pushState({category:t,procedure:o,procedureIds:a,basePath:l,hasNudity:s},"",c),this.loadFilteredContent(t,o,a,s),this.options.animateWithGsap&&"undefined"!=typeof gsap&&gsap.to(e,{scale:1.02,duration:.1,yoyo:!0,repeat:1,ease:"power2.inOut"})}navigateToFilteredPage(){if(this.activeFilters.size>0){const e=`/${Array.from(this.activeFilters.values())[0].procedure}`;this.options.onNavigate(e)}else this.options.onNavigate(this.options.baseUrl)}updateUrlState(){if(window.history&&window.history.replaceState){const e=new URLSearchParams,t=new Map;this.activeFilters.forEach(e=>{t.has(e.category)||t.set(e.category,[]),t.get(e.category).push(e.procedure)}),t.forEach((t,o)=>{e.append(o,t.join(","))});const o=e.toString()?`?${e.toString()}`:window.location.pathname;window.history.replaceState({},"",o)}}reactivateFilter(e,t){this.activeFilters.clear(),this.container?.querySelectorAll(".brag-book-gallery-nav-link").forEach(e=>{e.classList.remove("brag-book-gallery-active")});const o=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${t}"]`);o&&(o.classList.add("brag-book-gallery-active"),this.activeFilters.set(`${e}:${t}`,{category:e,procedure:t,procedureIds:o.dataset.procedureIds,count:parseInt(o.dataset.procedureCount||"0")}),this.updateFilterBadges())}loadStateFromUrl(){const e=document.querySelector(".brag-book-gallery-wrapper"),t=e?.dataset.baseUrl||"",o=e?.dataset.initialProcedure;if(o){const e=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${o}"]`);if(e){const t=e.dataset.category||"",a="true"===e.dataset.nudity;return this.reactivateFilter(t,o),void this.loadFilteredContent(t,o,e.dataset.procedureIds,a)}}const a=window.location.pathname;let r=a;t&&a.startsWith(t)&&(r=a.substring(t.length));const s=r.match(/^\/([^\/]+)\/(\d+)\/?$/);if(s){const[,e,t]=s;return}const i=r.match(/^\/([^\/]+)\/?$/);if(i){const[,e]=i,t=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${e}"]`);if(t){const o=t.dataset.category||"",a="true"===t.dataset.nudity;this.reactivateFilter(o,e),this.loadFilteredContent(o,e,t.dataset.procedureIds,a)}}}getActiveFilters(){return this.activeFilters}getFiltersByCategory(e){const t=[];return this.activeFilters.forEach(o=>{o.category===e&&t.push(o)}),t}getFiltersByProcedure(e){const t=[];return this.activeFilters.forEach(o=>{o.procedure===e&&t.push(o)}),t}clearCategory(e){const t=[];this.activeFilters.forEach((o,a)=>{o.category===e&&t.push(a)}),t.forEach(e=>{const t=this.procedures.get(e);t&&t.link&&t.link.classList.remove("brag-book-gallery-active")}),t.forEach(e=>this.activeFilters.delete(e))}clearAll(){const e=this.container?.querySelectorAll(".brag-book-gallery-nav-link");e?.forEach(e=>{e.classList.remove("brag-book-gallery-active")}),this.activeFilters.clear(),window.history.pushState({},"",window.location.pathname)}setMode(e){this.options.mode=e}loadFilteredContent(e,t,o,a=!1){const r=document.getElementById("gallery-content");if(!r)return;r.innerHTML='<div class="brag-book-gallery-loading">Loading filtered results...</div>';const s=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",i=window.bragBookGalleryConfig?.nonce||"";let n=t;const l=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${t}"]`);if(l){const e=l.querySelector(".brag-book-gallery-filter-option-label");e&&(n=e.textContent.trim())}const c=new FormData;c.append("action","brag_book_load_filtered_gallery"),c.append("nonce",i),c.append("procedure_name",n),c.append("procedure_slug",t),c.append("procedure_ids",o||""),c.append("procedure_id",o?.split(",")[0]||""),c.append("has_nudity",a?"1":"0"),fetch(s,{method:"POST",body:c}).then(e=>e.json()).then(e=>{if(e.success&&e.data?.html){if(r.innerHTML=e.data.html,e.data.seo&&(e.data.seo.title&&(document.title=e.data.seo.title),e.data.seo.description)){let t=document.querySelector('meta[name="description"]');t||(t=document.createElement("meta"),t.name="description",document.head.appendChild(t)),t.content=e.data.seo.description}r.querySelectorAll(".brag-book-gallery-carousel-wrapper").forEach(e=>{new Carousel(e)}),setTimeout(function(){initializeProcedureFilters()},100)}else r.innerHTML='<div class="brag-book-gallery-error">No results found for the selected filter.</div>'}).catch(e=>{console.error("Filter loading error:",e),r.innerHTML='<div class="brag-book-gallery-error">Failed to load filtered content. Please try again.</div>'})}updateFilterBadges(){console.log("updateFilterBadges called, activeFilters size:",this.activeFilters.size);const e=document.querySelector('[data-action="filter-badges"]'),t=document.querySelector('[data-action="clear-filters"]');if(console.log("Badges container found:",!!e),console.log("Clear all button found:",!!t),!e||!t)return;e.querySelectorAll("[data-filter-key]").forEach(e=>e.remove());const o=this.activeFilters.size>0;o&&(console.log("Creating badges for procedure filters:",Array.from(this.activeFilters.entries())),this.activeFilters.forEach((t,o)=>{const a=this.createFilterBadge(t.category,t.procedure,o);console.log("Created badge for:",t.category,t.procedure),e.appendChild(a)}));const a=e.querySelectorAll("[data-filter-category]"),r=o||a.length>0;t.style.display=r?"inline-block":"none"}createFilterBadge(e,t,o){const a=document.createElement("div");a.className="brag-book-gallery-filter-badge",a.setAttribute("data-filter-key",o);let r="";switch(e){case"age":r=`Age: ${t}`;break;case"gender":r=`Gender: ${t}`;break;case"ethnicity":r=`Ethnicity: ${t}`;break;case"procedure":r=t;break;default:r=`${e}: ${t}`}return a.innerHTML=`\n\t\t\t<span class="brag-book-gallery-badge-text">${r}</span>\n\t\t\t<button class="brag-book-gallery-badge-remove" aria-label="Remove ${r} filter">\n\t\t\t\t<svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">\n\t\t\t\t\t<path d="M13 1L1 13M1 1l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n\t\t\t\t</svg>\n\t\t\t</button>\n\t\t`,a.querySelector(".brag-book-gallery-badge-remove").addEventListener("click",e=>{e.preventDefault(),this.removeFilterBadge(o)}),a}removeFilterBadge(e){const t=this.activeFilters.get(e);if(t){this.activeFilters.delete(e);const o=document.querySelector(`[data-category="${t.category}"][data-procedure="${t.procedure}"]`);o&&o.classList.remove("brag-book-gallery-active"),this.updateFilterBadges(),this.options.onFilterChange(this.activeFilters)}}clearAllFilters(){const e=this.container?.querySelectorAll(".brag-book-gallery-nav-list-submenu-link");e?.forEach(e=>{e.classList.remove("brag-book-gallery-active")}),this.activeFilters.clear(),this.updateFilterBadges(),this.options.onFilterChange(this.activeFilters),window.history.pushState({},"",window.location.pathname)}},a=class{constructor(e={}){this.sidebar=document.querySelector(".brag-book-gallery-sidebar"),this.overlay=document.querySelector(".brag-book-gallery-mobile-overlay"),this.menuToggle=document.querySelector(".brag-book-gallery-mobile-menu-toggle"),this.closeButton=document.querySelector('[data-action="close-menu"]'),this.options={breakpoint:e.breakpoint||1024,swipeToClose:!1!==e.swipeToClose,...e},this.touchStartX=0,this.touchEndX=0,this.sidebar&&this.menuToggle&&this.init()}init(){let e;this.setupEventListeners(),this.checkMobileView(),window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{this.checkMobileView()},250)})}setupEventListeners(){this.menuToggle?.addEventListener("click",()=>this.toggle()),this.overlay?.addEventListener("click",()=>this.close()),this.closeButton?.addEventListener("click",()=>this.close()),this.sidebar&&this.sidebar.addEventListener("click",e=>{e.target.closest(".brag-book-gallery-nav-link")&&window.innerWidth<this.options.breakpoint&&setTimeout(()=>{this.close()},100)}),this.options.swipeToClose&&this.setupSwipeGestures(),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isOpen()&&this.close()})}setupSwipeGestures(){this.sidebar?.addEventListener("touchstart",e=>{this.touchStartX=e.changedTouches[0].screenX},{passive:!0}),this.sidebar?.addEventListener("touchend",e=>{this.touchEndX=e.changedTouches[0].screenX,this.handleSwipeGesture()},{passive:!0})}handleSwipeGesture(){this.touchStartX-this.touchEndX>50&&this.isOpen()&&this.close()}checkMobileView(){const e=window.innerWidth<=this.options.breakpoint,t=document.querySelector(".brag-book-gallery-sidebar-header"),o=document.querySelector(".brag-book-gallery-mobile-header");t&&(t.style.display=e?"flex":"none"),o&&(o.style.display=e?"flex":"none"),e||(this.close(),document.body.classList.remove("brag-book-gallery-mobile-menu-open"))}toggle(){this.isOpen()?this.close():this.open()}open(){if(!this.sidebar||!this.menuToggle)return;this.menuToggle.dataset.menuOpen="true",this.menuToggle.setAttribute("aria-expanded","true"),this.menuToggle.setAttribute("aria-label","Close navigation menu"),this.sidebar.classList.add("brag-book-gallery-active"),this.overlay?.classList.add("brag-book-gallery-active"),document.body.classList.add("brag-book-gallery-mobile-menu-open");const e=this.menuToggle.querySelector("svg");e&&(e.innerHTML='<path d="M256-213.85 213.85-256l224-224-224-224L256-746.15l224 224 224-224L746.15-704l-224 224 224 224L704-213.85l-224-224-224 224Z"/>'),document.body.style.overflow="hidden",this.previousFocus=document.activeElement,setTimeout(()=>{const e=this.sidebar.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');e&&e.focus()},300)}close(){if(!this.sidebar||!this.menuToggle)return;this.menuToggle.dataset.menuOpen="false",this.menuToggle.setAttribute("aria-expanded","false"),this.menuToggle.setAttribute("aria-label","Open navigation menu"),this.sidebar.classList.remove("brag-book-gallery-active"),this.overlay?.classList.remove("brag-book-gallery-active"),document.body.classList.remove("brag-book-gallery-mobile-menu-open");const e=this.menuToggle.querySelector("svg");e&&(e.innerHTML='<path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"/>'),document.body.style.overflow="",this.previousFocus&&this.previousFocus.focus&&this.previousFocus.focus()}isOpen(){return"true"===this.menuToggle?.dataset.menuOpen}},r=class{constructor(e={}){this.favorites=new Set,this.userInfo=null,this.hasShownDialog=!1,this.options={storageKey:e.storageKey||"brag-book-favorites",userInfoKey:e.userInfoKey||"brag-book-user-info",persistToStorage:!1!==e.persistToStorage,onUpdate:e.onUpdate||(()=>{}),...e},this.init()}init(){this.favoritesDialog=new t("favoritesDialog",{onClose:()=>{!this.userInfo&&this.lastAddedFavorite&&(this.removeFavorite(this.lastAddedFavorite),this.lastAddedFavorite=null)}}),this.options.persistToStorage&&(this.loadFromStorage(),this.loadUserInfo()),this.setupEventListeners(),this.updateUI()}setupEventListeners(){document.addEventListener("click",e=>{const t=e.target.closest("[data-favorited]");t&&(e.preventDefault(),this.toggleFavorite(t)),e.target.closest('[data-action="close-favorites-dialog"]')&&this.favoritesDialog.close()});const e=document.querySelector('[data-form="favorites"]');e&&e.addEventListener("submit",e=>{e.preventDefault(),this.handleFavoritesFormSubmit(e.target)})}toggleFavorite(e){let t=e.dataset.itemId||e.dataset.caseId||"";const o="true"===e.dataset.favorited;if(t){const e=t.match(/(\d+)/);e&&(t=e[1])}console.log("Toggle favorite:",{itemId:t,isFavorited:o,original:e.dataset.itemId}),o?this.removeFavorite(t,e):t?(this.userInfo&&this.userInfo.email||this.loadUserInfo(),this.userInfo&&this.userInfo.email?(this.addFavorite(t,e),this.submitFavoriteToAPI(t)):(this.lastAddedFavorite=t,this.lastAddedButton=e,this.addFavorite(t,e),this.favoritesDialog.open(),this.hasShownDialog=!0)):console.error("No item ID found on button:",e)}addFavorite(e,t){t&&(t.dataset.favorited="true"),document.querySelectorAll(`[data-item-id="${e}"], [data-case-id="${e}"]`).forEach(e=>{void 0!==e.dataset.favorited&&(e.dataset.favorited="true")}),this.favorites.add(e),this.options.persistToStorage&&this.saveToStorage(),this.updateUI(),this.options.onUpdate(this.favorites),window.dispatchEvent(new CustomEvent("favoritesUpdated",{detail:{favorites:this.favorites}}))}removeFavorite(e,t){t?(t.dataset.favorited="false",document.querySelectorAll(`[data-item-id="${e}"], [data-case-id="${e}"]`).forEach(e=>{e!==t&&void 0!==e.dataset.favorited&&(e.dataset.favorited="false")})):document.querySelectorAll(`[data-item-id="${e}"][data-favorited="true"], [data-case-id="${e}"][data-favorited="true"]`).forEach(e=>{e.dataset.favorited="false"}),this.favorites.delete(e),this.options.persistToStorage&&this.saveToStorage(),this.updateUI(),this.options.onUpdate(this.favorites),window.dispatchEvent(new CustomEvent("favoritesUpdated",{detail:{favorites:this.favorites}}))}submitFavoriteToAPI(e){const t=new FormData;t.append("action","brag_book_add_favorite"),t.append("nonce",window.bragBookGalleryConfig?.nonce||""),t.append("case_id",e),t.append("email",this.userInfo.email||""),t.append("phone",this.userInfo.phone||""),t.append("name",this.userInfo.name||""),console.log("Submitting favorite to API:",{caseId:e,email:this.userInfo.email,name:this.userInfo.name}),fetch(window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",body:t}).then(e=>e.json()).then(e=>{console.log("API Response:",e),e.success?this.showSuccessNotification("Added to favorites!"):console.error("Failed to save favorite:",e.data?.message)}).catch(e=>{console.error("Error submitting favorite:",e)})}handleFavoritesFormSubmit(e){const t=new FormData(e),o=Object.fromEntries(t.entries());this.lastAddedFavorite&&t.append("case_id",this.lastAddedFavorite),t.append("action","brag_book_add_favorite"),t.append("nonce",window.bragBookGalleryConfig?.nonce||""),console.log("Submitting to:",window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php"),console.log("Form data:",{action:"brag_book_add_favorite",nonce:window.bragBookGalleryConfig?.nonce||"no-nonce",email:o.email,phone:o.phone,name:o.name,case_id:this.lastAddedFavorite||"no-case-id"});const a=e.querySelector('button[type="submit"]'),r=a?a.textContent:"";a&&(a.disabled=!0,a.textContent="Submitting...");const s=e.querySelector(".brag-book-gallery-form-error"),i=e.querySelector(".brag-book-gallery-form-success");s&&s.remove(),i&&i.remove(),fetch(window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",body:t}).then(e=>{if(console.log("Response status:",e.status),!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(t=>{if(console.log("Response data:",t),t.success){this.userInfo=o,this.options.persistToStorage&&this.saveUserInfo();try{localStorage.setItem(this.options.userInfoKey,JSON.stringify(o))}catch(e){console.error("Failed to save user info to localStorage:",e)}const a=document.createElement("div");a.className="brag-book-gallery-form-success",a.textContent=t.data.message||"Your information has been saved. Keep adding favorites!",e.appendChild(a),setTimeout(()=>{this.favoritesDialog.close(),e.reset(),a&&a.remove()},2e3),this.showSuccessNotification(t.data.message||"Your information has been saved. Keep adding favorites!"),this.lastAddedFavorite=null,this.lastAddedButton=null}else{const o=document.createElement("div");o.className="brag-book-gallery-form-error",o.textContent=t.data.message||"Failed to save. Please try again.",e.appendChild(o),this.lastAddedFavorite&&this.lastAddedButton&&this.removeFavorite(this.lastAddedFavorite,this.lastAddedButton)}}).catch(t=>{console.error("Error submitting favorites form:",t);const o=document.createElement("div");o.className="brag-book-gallery-form-error",o.textContent="An error occurred. Please try again.",e.appendChild(o),this.lastAddedFavorite&&this.lastAddedButton&&this.removeFavorite(this.lastAddedFavorite,this.lastAddedButton)}).finally(()=>{a&&(a.disabled=!1,a.textContent=r)})}showSuccessNotification(e){let t=document.getElementById("favoritesNotification");t||(t=document.createElement("div"),t.id="favoritesNotification",t.className="brag-book-gallery-favorites-notification",document.body.appendChild(t)),t.textContent=e,t.classList.add("active"),"undefined"!=typeof gsap&&gsap.fromTo(t,{y:-20,opacity:0},{y:0,opacity:1,duration:.3,ease:"back.out(1.7)"}),setTimeout(()=>{"undefined"!=typeof gsap?gsap.to(t,{y:-20,opacity:0,duration:.2,ease:"power2.in",onComplete:()=>{t.classList.remove("active")}}):t.classList.remove("active")},3e3)}updateFavoritesDisplay(){const e=document.getElementById("favorites-grid"),t=document.getElementById("favorites-empty");e&&t&&(e.innerHTML="",0===this.favorites.size?(e.style.display="none",t.style.display="block"):(e.style.display="grid",t.style.display="none",this.favorites.forEach(t=>{const o=document.querySelector(`[data-item-id="${t}"]`);if(!o)return;const a=o.closest(".brag-book-gallery-carousel-item");if(!a)return;const r=a.querySelector("img");if(!r)return;const s=document.createElement("div");s.className="brag-book-gallery-favorites-item",s.dataset.itemId=t;const i=r.cloneNode(!0);s.appendChild(i);const n=document.createElement("button");n.className="brag-book-gallery-favorites-item-remove",n.innerHTML="×",n.title="Remove from favorites",n.onclick=e=>{e.stopPropagation(),this.removeFavorite(t)},s.appendChild(n),e.appendChild(s)})))}updateUI(){const e=document.querySelectorAll("[data-favorites-count]"),t=this.favorites.size;e.forEach(e=>{"undefined"!=typeof gsap?gsap.to(e,{opacity:0,duration:.1,onComplete:()=>{e.textContent=`(${t})`,gsap.to(e,{opacity:1,duration:.1})}}):e.textContent=`(${t})`}),this.updateFavoritesDisplay()}loadFromStorage(){try{const e=localStorage.getItem(this.options.storageKey);if(e){const t=JSON.parse(e);this.favorites=new Set(t),t.forEach(e=>{document.querySelectorAll(`[data-item-id="${e}"], [data-case-id="${e}"]`).forEach(e=>{void 0!==e.dataset.favorited&&(e.dataset.favorited="true")})})}}catch(e){console.error("Failed to load favorites from storage:",e)}}saveToStorage(){try{localStorage.setItem(this.options.storageKey,JSON.stringify([...this.favorites]))}catch(e){console.error("Failed to save favorites to storage:",e)}}loadUserInfo(){try{const e=localStorage.getItem(this.options.userInfoKey);e&&(this.userInfo=JSON.parse(e),this.hasShownDialog=!0)}catch(e){console.error("Failed to load user info from storage:",e)}}saveUserInfo(){try{localStorage.setItem(this.options.userInfoKey,JSON.stringify(this.userInfo))}catch(e){console.error("Failed to save user info to storage:",e)}}getFavorites(){return this.favorites}clear(){this.favorites.clear(),this.options.persistToStorage&&this.saveToStorage(),this.updateUI()}},s=class{constructor(e={}){this.options={shareMenuId:e.shareMenuId||"shareMenu",animateWithGsap:"undefined"!=typeof gsap,onShare:e.onShare||(()=>{}),...e},this.shareMenu=document.getElementById(this.options.shareMenuId),this.activeButton=null,this.activeItem=null,this.init()}init(){this.setupEventListeners(),this.createShareMenu()}createShareMenu(){if(!this.shareMenu){const e=`\n                <div id="${this.options.shareMenuId}" class="brag-book-gallery-share-dropdown" role="menu">\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="link" role="menuitem">Copy Link</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="email" role="menuitem">Email</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="facebook" role="menuitem">Facebook</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="twitter" role="menuitem">Twitter</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="pinterest" role="menuitem">Pinterest</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="whatsapp" role="menuitem">WhatsApp</button>\n                </div>\n            `;document.body.insertAdjacentHTML("beforeend",e),this.shareMenu=document.getElementById(this.options.shareMenuId)}}setupEventListeners(){document.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-share-button");t&&(e.preventDefault(),e.stopPropagation(),this.toggleShareDropdown(t));const o=e.target.closest(".brag-book-gallery-share-dropdown-item");if(o){e.preventDefault();const t=o.dataset.shareType;t&&(this.handleShare(t),this.hideShareDropdown())}!this.shareMenu?.classList.contains("active")||this.shareMenu.contains(e.target)||e.target.closest(".brag-book-gallery-share-button")||this.hideShareDropdown()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.shareMenu?.classList.contains("active")&&this.hideShareDropdown()})}toggleShareDropdown(e){this.activeButton===e&&this.shareMenu?.classList.contains("active")?this.hideShareDropdown():this.showShareDropdown(e)}showShareDropdown(e){if(!this.shareMenu)return;this.activeItem=e.closest(".brag-book-gallery-carousel-item"),this.activeButton=e,e.classList.add("active");const t=e.getBoundingClientRect(),o=this.activeItem.getBoundingClientRect();let a=t.right-120,r=t.bottom+8;a<o.left&&(a=o.left+8),a+120>o.right&&(a=o.right-120-8),r+240>window.innerHeight-10&&(r=t.top-240-8),this.shareMenu.style.left=`${a}px`,this.shareMenu.style.top=`${r}px`,this.shareMenu.classList.add("active"),this.options.animateWithGsap&&"undefined"!=typeof gsap&&gsap.fromTo(this.shareMenu,{y:-10,opacity:0},{y:0,opacity:1,duration:.2,ease:"power2.out"})}hideShareDropdown(){this.shareMenu&&(this.activeButton&&this.activeButton.classList.remove("active"),this.options.animateWithGsap&&"undefined"!=typeof gsap?gsap.to(this.shareMenu,{y:-10,opacity:0,duration:.15,ease:"power2.in",onComplete:()=>{this.shareMenu.classList.remove("active"),this.activeButton=null,this.activeItem=null}}):(this.shareMenu.classList.remove("active"),this.activeButton=null,this.activeItem=null))}handleShare(e){if(!this.activeItem)return;const t=this.activeItem.querySelector("img"),o=t?.src||"",a=t?.alt||"Medical procedure result",r=this.activeItem.dataset.slide||"",s=`${window.location.origin+window.location.pathname}#${r}`,i=`Check out this ${a}`;switch(e){case"link":this.copyToClipboard(s);break;case"email":this.shareViaEmail(s,i);break;case"facebook":this.shareViaFacebook(s);break;case"twitter":this.shareViaTwitter(s,i);break;case"pinterest":this.shareViaPinterest(s,o,i);break;case"whatsapp":this.shareViaWhatsApp(s,i)}this.options.onShare({type:e,url:s,text:i})}copyToClipboard(e){navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{this.showNotification("Link copied to clipboard!")}).catch(()=>{this.fallbackCopyToClipboard(e)}):this.fallbackCopyToClipboard(e)}fallbackCopyToClipboard(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-999999px",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),this.showNotification("Link copied to clipboard!")}catch(e){this.showNotification("Failed to copy link")}document.body.removeChild(t)}shareViaEmail(e,t){const o=encodeURIComponent("Check out this medical procedure result"),a=encodeURIComponent(`${t}\n\n${e}`);window.location.href=`mailto:?subject=${o}&body=${a}`}shareViaFacebook(e){const t=`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(e)}`;this.openShareWindow(t,"facebook")}shareViaTwitter(e,t){const o=`https://twitter.com/intent/tweet?url=${encodeURIComponent(e)}&text=${encodeURIComponent(t)}`;this.openShareWindow(o,"twitter")}shareViaPinterest(e,t,o){const a=`https://pinterest.com/pin/create/button/?url=${encodeURIComponent(e)}&media=${encodeURIComponent(t)}&description=${encodeURIComponent(o)}`;this.openShareWindow(a,"pinterest")}shareViaWhatsApp(e,t){const o=`https://wa.me/?text=${encodeURIComponent(`${t} ${e}`)}`;this.openShareWindow(o,"whatsapp")}openShareWindow(e,t){const o=(window.innerWidth-600)/2,a=(window.innerHeight-400)/2;window.open(e,`share-${t}`,`width=600,height=400,left=${o},top=${a},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`)}showNotification(e){let t=document.getElementById("shareNotification");t||(t=document.createElement("div"),t.id="shareNotification",t.className="brag-book-gallery-share-notification",document.body.appendChild(t)),t.textContent=e,t.classList.add("active"),this.options.animateWithGsap&&"undefined"!=typeof gsap&&gsap.fromTo(t,{y:-20,opacity:0},{y:0,opacity:1,duration:.3,ease:"back.out(1.7)"}),setTimeout(()=>{this.options.animateWithGsap&&"undefined"!=typeof gsap?gsap.to(t,{y:-20,opacity:0,duration:.2,ease:"power2.in",onComplete:()=>{t.classList.remove("active")}}):t.classList.remove("active")},3e3)}async shareNative(e){if(navigator.share)try{return await navigator.share({title:e.title||"Medical Procedure Result",text:e.text,url:e.url}),!0}catch(e){return"AbortError"!==e.name&&console.error("Share failed:",e),!1}return!1}},i=class{constructor(e,t={}){this.wrapper=e,this.input=e.querySelector(".brag-book-gallery-search-input"),this.dropdown=e.querySelector(".brag-book-gallery-search-dropdown"),this.searchIcon=e.querySelector(".brag-book-gallery-search-icon"),this.options={minChars:t.minChars||1,debounceDelay:t.debounceDelay||200,maxResults:t.maxResults||10,onSelect:t.onSelect||(()=>{}),...t},this.procedures=[],this.filteredResults=[],this.selectedIndex=-1,this.isOpen=!1,this.debounceTimer=null,this.input&&this.dropdown&&this.init()}init(){this.collectProcedures(),this.setupEventListeners()}collectProcedures(){const e=document.querySelectorAll(".brag-book-gallery-nav-link"),t=new Map;e.forEach(e=>{const o=e.dataset.procedure,a=e.dataset.category,r=e.querySelector(".brag-book-gallery-filter-option-label")?.textContent||o,s=parseInt(e.dataset.procedureCount||"0");if(o&&a){const e=`${a}:${o}`;t.has(e)||t.set(e,{id:o,name:r.trim(),category:a,count:s,searchText:r.toLowerCase(),fullName:`${r} (${s})`})}}),this.procedures=Array.from(t.values())}setupEventListeners(){this.input.addEventListener("input",e=>this.handleInput(e)),this.input.addEventListener("focus",()=>this.handleFocus()),this.input.addEventListener("blur",e=>this.handleBlur(e)),this.input.addEventListener("keydown",e=>this.handleKeydown(e)),document.addEventListener("click",e=>{this.wrapper.contains(e.target)||this.close()}),this.dropdown.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-search-item");t&&this.selectItem(t)})}handleInput(e){const t=e.target.value.trim();this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{t.length>=this.options.minChars?this.search(t):this.close()},this.options.debounceDelay)}handleFocus(){const e=this.input.value.trim();e.length>=this.options.minChars&&this.search(e)}handleBlur(e){setTimeout(()=>{this.wrapper.contains(document.activeElement)||this.close()},200)}handleKeydown(e){if(this.isOpen)switch(e.key){case"ArrowDown":e.preventDefault(),this.moveSelection(1);break;case"ArrowUp":e.preventDefault(),this.moveSelection(-1);break;case"Enter":if(e.preventDefault(),this.selectedIndex>=0){const e=this.dropdown.querySelector(`[data-index="${this.selectedIndex}"]`);e&&this.selectItem(e)}break;case"Escape":this.close(),this.input.blur()}else"ArrowDown"===e.key&&this.input.value.trim().length>=this.options.minChars&&(e.preventDefault(),this.search(this.input.value.trim()))}search(e){const t=e.toLowerCase();this.filteredResults=this.procedures.filter(e=>e.searchText.includes(t)||e.category.includes(t)).slice(0,this.options.maxResults),this.filteredResults.sort((e,o)=>{const a=e.searchText===t,r=o.searchText===t;if(a&&!r)return-1;if(!a&&r)return 1;const s=e.searchText.startsWith(t),i=o.searchText.startsWith(t);return s&&!i?-1:!s&&i?1:0}),this.renderResults(e),this.open()}renderResults(e){if(0===this.filteredResults.length)return void(this.dropdown.innerHTML=`\n                <div class="brag-book-gallery-search-no-results">\n                    No procedures found for "${this.escapeHtml(e)}"\n                </div>\n            `);const t=this.filteredResults.map((t,o)=>{const a=this.highlightMatch(t.name,e),r=1===t.count?"case":"cases";return`\n                <div class="brag-book-gallery-search-item"\n                     role="option"\n                     data-index="${o}"\n                     data-procedure="${t.id}"\n                     data-category="${t.category}"\n                     aria-selected="${o===this.selectedIndex}">\n                    <div class="brag-book-gallery-search-item-content">\n                        <span class="brag-book-gallery-search-item-name">${a}</span>\n                        <span class="brag-book-gallery-search-item-count">${t.count} ${r}</span>\n                    </div>\n                    <span class="brag-book-gallery-search-item-category">${t.category}</span>\n                </div>\n            `}).join("");this.dropdown.innerHTML=t,this.selectedIndex=-1}highlightMatch(e,t){const o=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=new RegExp(`(${o})`,"gi");return e.replace(a,"<mark>$1</mark>")}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}moveSelection(e){const t=this.dropdown.querySelectorAll(".brag-book-gallery-search-item");0!==t.length&&(this.selectedIndex+=e,this.selectedIndex<0?this.selectedIndex=t.length-1:this.selectedIndex>=t.length&&(this.selectedIndex=0),t.forEach((e,t)=>{const o=t===this.selectedIndex;e.setAttribute("aria-selected",o),o&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}))}selectItem(e){const t=e.dataset.procedure,o=e.dataset.category,a=e.querySelector(".brag-book-gallery-search-item-name"),r=a?a.textContent.replace(/<mark>/g,"").replace(/<\/mark>/g,""):"";this.input.value=r,this.close(),this.options.onSelect({procedure:t,category:o,name:r});const s=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${t}"]`);s&&s.click()}open(){this.isOpen||(this.isOpen=!0,this.dropdown.classList.add("active"),this.wrapper.classList.add("active"),this.input.setAttribute("aria-expanded","true"))}close(){this.isOpen&&(this.isOpen=!1,this.dropdown.classList.remove("active"),this.wrapper.classList.remove("active"),this.input.setAttribute("aria-expanded","false"),this.selectedIndex=-1)}},n=class{constructor(){this.components={},window.bragBookGalleryApp=this,this.init()}async init(){this.initializeCarousels(),this.initializeDialogs(),this.initializeFilters(),this.initializeMobileMenu(),this.initializeFavorites(),this.initializeSearch(),this.initializeShareManager(),this.initializeConsultationForm(),this.initializeCaseLinks();const e=document.getElementById("gallery-content");e&&"true"===e.dataset.favoritesPage&&setTimeout(()=>{this.showFavoritesOnly()},100),console.log("BRAG bookGallery initialized")}initializeCarousels(){const t=document.querySelectorAll(".brag-book-gallery-carousel-wrapper");let o;this.components.carousels=[],t.forEach((t,o)=>{const a=0===o?{infinite:!0,autoplay:!0,autoplayDelay:4e3,pauseOnHover:!0}:{infinite:!1,autoplay:!1};this.components.carousels.push(new e(t,a))}),window.addEventListener("resize",()=>{clearTimeout(o),o=setTimeout(()=>{this.components.carousels.forEach(e=>e.refresh())},250)})}initializeDialogs(){this.components.consultationDialog=new t("consultationDialog",{onOpen:()=>console.log("Consultation dialog opened"),onClose:()=>console.log("Consultation dialog closed")}),document.querySelectorAll('[data-action="request-consultation"]').forEach(e=>{e.addEventListener("click",()=>{this.components.consultationDialog.open()})})}initializeFilters(){const e=document.querySelector(".brag-book-gallery-nav"),t=e?.dataset.filterMode||"javascript";this.components.filterSystem=new o(e,{mode:t,baseUrl:"/gallery",onFilterChange:e=>{console.log("Active filters:",Array.from(e.entries())),this.applyFilters(e)},onNavigate:e=>{console.log("Navigating to:",e),window.location.href=e}}),this.initializeClearAllButton(),this.initializeDemographicFilterBadges()}initializeMobileMenu(){this.components.mobileMenu=new a}initializeFavorites(){if(this.components.favoritesManager=new r({onUpdate:e=>{console.log("Favorites updated:",e.size),this.updateFavoritesCount(e.size)}}),this.components.favoritesManager){const e=this.components.favoritesManager.getFavorites().size;this.updateFavoritesCount(e)}this.initializeFavoritesButton(),window.addEventListener("favoritesUpdated",e=>{const t=window.location.pathname;(t===`/${window.bragBookGalleryConfig?.gallerySlug||"before-after"}/myfavorites`||t.includes("myfavorites"))&&(console.log("Favorites updated while on My Favorites page, refreshing..."),setTimeout(()=>{this.showFavoritesOnly()},100))})}initializeSearch(){const e=document.querySelectorAll(".brag-book-gallery-search-wrapper");this.components.searchAutocompletes=[],e.forEach(e=>{const t=new i(e,{minChars:1,debounceDelay:200,maxResults:10,onSelect:e=>{console.log("Selected procedure:",e)}});this.components.searchAutocompletes.push(t)})}initializeShareManager(){"undefined"!=typeof bragBookGalleryConfig&&"yes"===bragBookGalleryConfig.enableSharing&&(this.components.shareManager=new s({onShare:e=>{console.log("Shared:",e)}}))}initializeConsultationForm(){const e=document.querySelector('[data-form="consultation"]');e&&e.addEventListener("submit",e=>{e.preventDefault(),this.handleFormSubmit(e.target)});const t=document.getElementById("consultationDialog");t&&new MutationObserver(e=>{e.forEach(e=>{"attributes"===e.type&&"open"===e.attributeName&&t.hasAttribute("open")&&this.hideModalMessage()})}).observe(t,{attributes:!0})}initializeCaseLinks(){document.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-case-card-link");if(t){e.preventDefault(),e.stopPropagation();const o=t.dataset.caseId,a=t.dataset.procedureIds;return void(o&&(console.log("Loading case:",o,"with procedure IDs:",a),this.loadCaseDetails(o,t.href,!0,a)))}const o=e.target.closest(".brag-book-gallery-case-card");if(o&&!e.target.closest("button")&&!e.target.closest("details")){const t=o.querySelector(".brag-book-gallery-case-card-link");if(t&&t.href){e.preventDefault();const a=t.dataset.caseId,r=t.dataset.procedureIds||o.dataset.procedureIds;a&&(console.log("Loading case from card:",a,"with procedure IDs:",r),this.loadCaseDetails(a,t.href,!0,r))}}}),this.initializeCaseDetailThumbnails(),window.addEventListener("popstate",e=>{e.state&&e.state.caseId?this.loadCaseDetails(e.state.caseId,window.location.href,!1):window.location.reload()})}async loadCaseDetails(e,t,o=!0,a=null){const r=document.getElementById("gallery-content");if(r){if(!a){const t=document.querySelector(`.brag-book-gallery-case-card[data-case-id="${e}"]`);t&&t.dataset.procedureIds&&(a=t.dataset.procedureIds,console.log("Got procedure IDs from case card:",a))}console.log("Loading case details for:",e,"with procedure IDs:",a),r.innerHTML='<div class="brag-book-gallery-loading">Loading case details...</div>',o&&window.history&&window.history.pushState&&window.history.pushState({caseId:e},"",t);try{if("undefined"==typeof bragBookGalleryConfig)throw console.error("bragBookGalleryConfig not defined"),new Error("Configuration not loaded");console.log("Making AJAX request to:",bragBookGalleryConfig.ajaxUrl);const o=t?new URL(t).pathname.split("/").filter(e=>e):window.location.pathname.split("/").filter(e=>e),s=o.length>2?o[o.length-2]:"";let i="";const n=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${s}"]`);if(n){const e=n.querySelector(".brag-book-gallery-filter-option-label");e&&(i=e.textContent.trim())}if(!i&&window.bragBookGalleryConfig&&window.bragBookGalleryConfig.sidebarData){const e=window.bragBookGalleryConfig.sidebarData;for(const t of Object.values(e)){if(t.procedures)for(const e of t.procedures)if(e.slug===s){i=e.name;break}if(i)break}}const l={action:"brag_book_load_case_details_html",case_id:e,procedure_slug:s,procedure_name:i,nonce:bragBookGalleryConfig.nonce||""};a&&(l.procedure_ids=a);const c=await fetch(bragBookGalleryConfig.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(l)});if(console.log("Response status:",c.status),!c.ok)throw new Error(`HTTP error! status: ${c.status}`);const d=await c.json();if(console.log("Response data:",d),!(d.success&&d.data&&d.data.html))throw console.error("API Error:",d),new Error(d.data?.message||d.data||d.message||"Failed to load case details");{r.innerHTML=d.data.html;const e=document.querySelector(".brag-book-gallery-wrapper");if(e?e.scrollIntoView({behavior:"smooth",block:"start"}):r.scrollIntoView({behavior:"smooth",block:"start"}),d.data.seo&&(d.data.seo.title&&(document.title=d.data.seo.title),d.data.seo.description)){let e=document.querySelector('meta[name="description"]');e||(e=document.createElement("meta"),e.name="description",document.head.appendChild(e)),e.content=d.data.seo.description}this.initializeCaseDetailThumbnails()}}catch(e){console.error("Error loading case details:",e);let t="Failed to load case details. Please try again.";e.message&&(t+="<br><small>"+e.message+"</small>"),r.innerHTML='<div class="brag-book-gallery-error">'+t+"</div>"}}else console.error("Gallery content container not found")}displayCaseDetails(e){const t=document.getElementById("gallery-content");if(!t)return;let o='<div class="brag-book-gallery-case-card-details">';o+='<button class="brag-book-gallery-back-button" onclick="history.back()">← Back to Gallery</button>',o+='<div class="brag-book-gallery-case-header">',o+=`<h2>${e.procedureName||"Case Details"}</h2>`,o+='<div class="case-metadata">',e.caseNumber&&(o+=`<span class="case-number">Case #${e.caseNumber}</span>`),e.technique&&(o+=`<span class="case-technique">Technique: ${e.technique}</span>`),e.age&&(o+=`<span class="case-age">Age: ${e.age}</span>`),e.gender&&(o+=`<span class="case-gender">Gender: ${e.gender}</span>`),o+="</div>",o+="</div>",e.photos&&e.photos.length>0?(o+='<div class="brag-book-gallery-case-images">',e.photos.forEach((e,t)=>{(e.beforeImage||e.afterImage)&&(o+='<div class="brag-book-gallery-case-image-pair">',e.isProcessed&&e.beforeImage?(o+='<div class="processed-image">',o+=`<img src="${e.beforeImage}" alt="Before and After" />`,e.caption&&(o+=`<p class="image-caption">${e.caption}</p>`),o+="</div>"):(e.beforeImage&&(o+='<div class="before-image">',o+="<h3>Before</h3>",o+=`<img src="${e.beforeImage}" alt="Before" loading="lazy" />`,o+="</div>"),e.afterImage&&(o+='<div class="after-image">',o+="<h3>After</h3>",o+=`<img src="${e.afterImage}" alt="After" loading="lazy" />`,o+="</div>"),e.caption&&(o+=`<p class="image-caption">${e.caption}</p>`)),o+="</div>")}),o+="</div>"):o+='<div class="brag-book-gallery-no-images">No images available for this case.</div>',e.description&&(o+='<div class="brag-book-gallery-case-description">',o+="<h3>Details</h3>",e.description.includes("<")?o+=e.description:o+=`<p>${e.description}</p>`,o+="</div>"),o+="</div>",t.innerHTML=o,t.scrollIntoView({behavior:"smooth",block:"start"})}handleSearch(e){const t=e.toLowerCase().trim();console.log("Searching for:",t)}applyFilters(e){console.log("Applying filters...")}async handleFormSubmit(e){const t=new FormData(e),o=Object.fromEntries(t.entries());console.log("Form submitted:",o);const a=e.querySelector('[data-action="form-submit"]'),r=a?a.textContent:"";a&&(a.disabled=!0,a.textContent="Sending...");try{if("undefined"==typeof bragBookGalleryConfig)throw new Error("Configuration not loaded. Please refresh the page.");const t=new URLSearchParams({action:"handle_form_submission",nonce:bragBookGalleryConfig.consultation_nonce||bragBookGalleryConfig.nonce,name:o.name||"",email:o.email||"",phone:o.phone||"",description:o.message||""}),a=await fetch(bragBookGalleryConfig.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t,credentials:"same-origin"}),r=await a.json();if(r.success)this.showModalMessage("Thank you for your consultation request! We will contact you soon.","success"),setTimeout(()=>{e.reset(),this.hideModalMessage(),this.components&&this.components.consultationDialog&&setTimeout(()=>{this.components.consultationDialog.close()},1e3)},3e3);else{const e=r.data||"Failed to send consultation request. Please try again.";this.showModalMessage(e,"error"),console.error("Form submission error:",e)}}catch(e){console.error("Error submitting form:",e),this.showModalMessage(e.message||"An error occurred. Please try again.","error")}finally{a&&(a.disabled=!1,a.textContent=r)}}showModalMessage(e,t="info"){const o=document.getElementById("consultationMessage"),a=o?.querySelector(".brag-book-gallery-form-message-content");if(!o||!a)return void this.showNotification(e,t);a.textContent=e,o.className="brag-book-gallery-form-message",o.classList.add(`brag-book-gallery-form-message-${t}`),o.style.display="block";const r=o.closest(".brag-book-gallery-dialog-content");r&&(r.scrollTop=0)}hideModalMessage(){const e=document.getElementById("consultationMessage");if(e){e.style.display="none";const t=e.querySelector(".brag-book-gallery-form-message-content");t&&(t.textContent="")}}initializeCaseDetailThumbnails(){document.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-thumbnail-item");if(!t)return;const o=document.querySelector(".brag-book-gallery-main-image-container");if(!o)return;const a=document.querySelectorAll(".brag-book-gallery-thumbnail-item");if(!a.length)return;a.forEach(e=>e.classList.remove("active")),t.classList.add("active");const r=t.dataset.processedUrl,s=t.dataset.imageIndex;o.dataset.imageIndex=s;let i="";if(r){const e=o.querySelector(".brag-book-gallery-favorite-button"),t=e?e.dataset.itemId.replace("_main",""):"";i=`\n\t\t\t\t\t<div class="brag-book-gallery-main-single">\n\t\t\t\t\t\t<img src="${r}" alt="Case Image" loading="eager">\n\t\t\t\t\t\t<div class="brag-book-gallery-item-actions">\n\t\t\t\t\t\t\t<button class="brag-book-gallery-favorite-button" data-favorited="false" data-item-id="${t}_main" aria-label="Add to favorites">\n\t\t\t\t\t\t\t\t<svg fill="rgba(255, 255, 255, 0.5)" stroke="white" stroke-width="2" viewBox="0 0 24 24">\n\t\t\t\t\t\t\t\t\t<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t`,"undefined"!=typeof bragBookGalleryConfig&&"yes"===bragBookGalleryConfig.enableSharing&&(i+=`\n\t\t\t\t\t\t\t<button class="brag-book-gallery-share-button" data-item-id="${t}_main" aria-label="Share this image">\n\t\t\t\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">\n\t\t\t\t\t\t\t\t\t<path d="M672.22-100q-44.91 0-76.26-31.41-31.34-31.41-31.34-76.28 0-6 4.15-29.16L284.31-404.31q-14.46 15-34.36 23.5t-42.64 8.5q-44.71 0-76.01-31.54Q100-435.39 100-480q0-44.61 31.3-76.15 31.3-31.54 76.01-31.54 22.74 0 42.64 8.5 19.9 8.5 34.36 23.5l284.46-167.08q-2.38-7.38-3.27-14.46-.88-7.08-.88-15.08 0-44.87 31.43-76.28Q627.49-860 672.4-860t76.25 31.44Q780-797.13 780-752.22q0 44.91-31.41 76.26-31.41 31.34-76.28 31.34-22.85 0-42.5-8.69Q610.15-662 595.69-677L311.23-509.54q2.38 7.39 3.27 14.46.88 7.08.88 15.08t-.88 15.08q-.89 7.07-3.27 14.46L595.69-283q14.46-15 34.12-23.69 19.65-8.69 42.5-8.69 44.87 0 76.28 31.43Q780-252.51 780-207.6t-31.44 76.25Q717.13-100 672.22-100Zm.09-60q20.27 0 33.98-13.71Q720-187.42 720-207.69q0-20.27-13.71-33.98-13.71-13.72-33.98-13.72-20.27 0-33.98 13.72-13.72 13.71-13.72 33.98 0 20.27 13.72 33.98Q652.04-160 672.31-160Zm-465-272.31q20.43 0 34.25-13.71 13.83-13.71 13.83-33.98 0-20.27-13.83-33.98-13.82-13.71-34.25-13.71-20.11 0-33.71 13.71Q160-500.27 160-480q0 20.27 13.6 33.98 13.6 13.71 33.71 13.71Zm465-272.3q20.27 0 33.98-13.72Q720-732.04 720-752.31q0-20.27-13.71-33.98Q692.58-800 672.31-800q-20.27 0-33.98 13.71-13.72 13.71-13.72 33.98 0 20.27 13.72 33.98 13.71 13.72 33.98 13.72Zm0 496.92ZM207.69-480Zm464.62-272.31Z"/>\n\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t`),i+="\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t"}o.innerHTML=i,window.bragBookGalleryApp&&window.bragBookGalleryApp.components&&(window.bragBookGalleryApp.components.favoritesManager&&window.bragBookGalleryApp.components.favoritesManager.initializeFavoriteButtons(),window.bragBookGalleryApp.components.shareManager&&window.bragBookGalleryApp.components.shareManager.initializeShareButtons())})}showNotification(e,t="info"){let o=document.querySelector(".brag-book-notification");o||(o=document.createElement("div"),o.className="brag-book-notification",o.style.cssText="\n\t\t\t\tposition: fixed;\n\t\t\t\ttop: 20px;\n\t\t\t\tright: 20px;\n\t\t\t\tpadding: 15px 20px;\n\t\t\t\tborder-radius: 4px;\n\t\t\t\tz-index: 10000;\n\t\t\t\ttransition: opacity 0.3s ease;\n\t\t\t\tmax-width: 350px;\n\t\t\t",document.body.appendChild(o));const a={success:"#4caf50",error:"#f44336",info:"#2196f3"};o.style.backgroundColor=a[t]||a.info,o.style.color="white",o.textContent=e,o.style.opacity="1",setTimeout(()=>{o.style.opacity="0",setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},300)},5e3)}initializeClearAllButton(){const e=()=>{const e=document.querySelector('[data-action="clear-filters"]');return console.log("Clear All button found:",e),e?(e.removeEventListener("click",this.handleClearAll),e.addEventListener("click",this.handleClearAll.bind(this)),console.log("Clear All button event listener attached"),!0):(console.log("Clear All button not found - data-action: clear-filters"),!1)};e()||setTimeout(()=>{console.log("Retrying Clear All button setup..."),e()},1e3),document.addEventListener("click",e=>{e.target&&"clear-filters"===e.target.dataset.action&&(console.log("Global click handler caught Clear All button"),e.preventDefault(),this.handleClearAll(e))})}handleClearAll(e){e.preventDefault(),console.log("Clear All button clicked - handling..."),console.log("Clearing demographic filter checkboxes"),this.clearDemographicFilters()}initializeDemographicFilterBadges(){window.updateDemographicFilterBadges=e=>{this.updateDemographicBadges(e)},window.applyProcedureFilters,this.monitorDemographicFilters(),document.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-badge-remove");if(t){console.log("Global handler: Badge remove button clicked!"),e.preventDefault(),e.stopPropagation();const o=t.closest(".brag-book-gallery-filter-badge");if(o){const e=o.getAttribute("data-filter-category"),t=o.getAttribute("data-filter-value");console.log("Global handler: Removing filter",{category:e,value:t}),e&&t&&this.removeDemographicFilter(e,t)}}})}monitorDemographicFilters(){const e=console.log;console.log=(...t)=>{e.apply(console,t),t.length>=2&&"Active filters:"===t[0]&&"object"==typeof t[1]&&this.updateDemographicBadges(t[1])},document.addEventListener("change",e=>{"checkbox"===e.target.type&&e.target.closest(".brag-book-gallery-filter-group")&&(console.log("Checkbox changed - target:",e.target),setTimeout(()=>{const e=this.buildActiveFiltersFromDOM();console.log("Built activeFilters from DOM:",e),this.updateDemographicBadges(e)},100))});let t="";setInterval(()=>{const e=this.buildActiveFiltersFromDOM(),o=JSON.stringify(e);o!==t&&(console.log("Detected filter change via periodic check:",e),this.updateDemographicBadges(e),t=o)},1e3)}buildActiveFiltersFromDOM(){const e={age:[],gender:[],ethnicity:[],height:[],weight:[]};return document.querySelectorAll('.brag-book-gallery-filter-group input[type="checkbox"]:checked').forEach(t=>{const o=t.closest(".brag-book-gallery-filter-group"),a=o?.querySelector("summary"),r=a?.textContent?.toLowerCase()||"",s=t.nextElementSibling,i=s?.textContent?.trim()||t.value||"";r.includes("age")||i.includes("-")?e.age.push(i):r.includes("gender")||["male","female"].some(e=>i.toLowerCase().includes(e))?e.gender.push(i):r.includes("ethnicity")?e.ethnicity.push(i):r.includes("height")||i.includes("ft")||i.includes("'")?e.height.push(i):(r.includes("weight")||i.includes("lbs")||i.includes("kg"))&&e.weight.push(i)}),e}updateDemographicBadges(e){const t=document.querySelector('[data-action="filter-badges"]'),o=document.querySelector('[data-action="clear-filters"]');if(!t||!o)return;t.innerHTML="";let a=!1;e&&Object.keys(e).forEach(o=>{const r=e[o];r&&r.length>0&&(a=!0,r.forEach(e=>{const a=this.createDemographicBadge(o,e);t.appendChild(a)}))});const r=t.querySelectorAll("[data-filter-key]"),s=a||r.length>0;o.style.display=s?"inline-block":"none"}createDemographicBadge(e,t){const o=document.createElement("div");o.className="brag-book-gallery-filter-badge",o.setAttribute("data-filter-category",e),o.setAttribute("data-filter-value",t);let a="",r=t;switch(e){case"age":a=`Age: ${t}`;break;case"gender":a=`Gender: ${t}`,r=t.replace(/^(Male|Female)$/i,e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase());break;case"ethnicity":a=`Ethnicity: ${t}`;break;case"height":a=`Height: ${t}`;break;case"weight":a=`Weight: ${t}`;break;default:a=`${e}: ${t}`}return o.innerHTML=`\n\t\t\t<span class="brag-book-gallery-badge-text">${a}</span>\n\t\t\t<button class="brag-book-gallery-badge-remove" aria-label="Remove ${a} filter">\n\t\t\t\t<svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">\n\t\t\t\t\t<path d="M13 1L1 13M1 1l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n\t\t\t\t</svg>\n\t\t\t</button>\n\t\t`,o.querySelector(".brag-book-gallery-badge-remove").addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),console.log("Badge remove button clicked!",{category:e,value:t}),this.removeDemographicFilter(e,t)}),o}createProcedureBadge(e,t,o){const a=document.createElement("div");a.className="brag-book-gallery-filter-badge",a.setAttribute("data-filter-key",o);let r=t;return a.innerHTML=`\n\t\t\t<span class="brag-book-gallery-badge-text">${r}</span>\n\t\t\t<button class="brag-book-gallery-badge-remove" aria-label="Remove ${r} filter">\n\t\t\t\t<svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">\n\t\t\t\t\t<path d="M13 1L1 13M1 1l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n\t\t\t\t</svg>\n\t\t\t</button>\n\t\t`,a.querySelector(".brag-book-gallery-badge-remove").addEventListener("click",e=>{e.preventDefault(),this.components.filterSystem&&this.components.filterSystem.removeFilterBadge(o)}),a}removeDemographicFilter(e,t){console.log(`Removing demographic filter: ${e} = ${t}`);let o=null;const a=`input[type="checkbox"][data-filter-type="${e}"][value="${t}"]`;if(console.log("Looking for checkbox with selector:",a),o=document.querySelector(a),!o){const a=document.querySelectorAll(`input[type="checkbox"][data-filter-type="${e}"]`);console.log(`Found ${a.length} checkboxes with data-filter-type="${e}"`),a.forEach(e=>{const a=e.value,r=e.nextElementSibling,s=r?.textContent?.trim()||"";console.log(`Checking: value="${a}", label="${s}", looking for="${t}"`),a!==t&&a.toLowerCase()!==t.toLowerCase()&&s!==t&&s.toLowerCase()!==t.toLowerCase()||(o=e,console.log("Found matching checkbox!"))})}if(!o){console.log("Trying broader search...");const a=`procedure-filter-${e}-${t}`.toLowerCase().replace(/\s+/g,"-");o=document.getElementById(a),o&&console.log("Found checkbox by ID pattern:",a)}if(o){console.log("Unchecking checkbox:",o),o.checked=!1;const a=new Event("change",{bubbles:!0});o.dispatchEvent(a);const r=new Event("input",{bubbles:!0});o.dispatchEvent(r),setTimeout(()=>{const e=this.buildActiveFiltersFromDOM();this.updateDemographicBadges(e),"function"==typeof window.applyDemographicFilters&&(console.log("Calling applyDemographicFilters"),window.applyDemographicFilters())},100);const s=document.querySelector(`.brag-book-gallery-filter-badge[data-filter-category="${e}"][data-filter-value="${t}"]`);s&&(console.log("Removing badge from DOM"),s.remove())}else console.warn(`Could not find checkbox for ${e}: ${t}`),console.log("Available checkboxes with data-filter-type:"),document.querySelectorAll('input[type="checkbox"][data-filter-type]').forEach(e=>{console.log(`  - Type: ${e.getAttribute("data-filter-type")}, Value: ${e.value}, ID: ${e.id}`)})}clearDemographicFilters(){console.log("Starting to clear demographic filters...");let e=0;['.brag-book-gallery-filter-group input[type="checkbox"]:checked','input[type="checkbox"][data-filter-category]:checked','.brag-book-gallery-filter-option input[type="checkbox"]:checked'].forEach(t=>{const o=document.querySelectorAll(t);console.log(`Found ${o.length} checked checkboxes with selector: ${t}`),o.forEach(t=>{console.log("Unchecking checkbox:",t),t.checked=!1,t.dispatchEvent(new Event("change",{bubbles:!0})),e++})}),console.log(`Total checkboxes cleared: ${e}`),window.clearProcedureFilters&&(console.log("Calling global clearProcedureFilters function"),window.clearProcedureFilters()),setTimeout(()=>{console.log("Updating badges to hide them"),this.updateDemographicBadges({age:[],gender:[],ethnicity:[],height:[],weight:[]})},100)}reloadGalleryContent(){const e=document.querySelector(".brag-book-gallery-filtered-results");if(e){const t=new FormData;t.append("action","brag_book_load_filtered_gallery"),t.append("nonce",window.bragBookGalleryAjax?.nonce||""),t.append("procedure_ids",""),t.append("has_nudity",document.body.classList.contains("nudity-accepted")?"1":"0"),fetch(window.bragBookGalleryAjax?.ajax_url||"/wp-admin/admin-ajax.php",{method:"POST",body:t}).then(e=>e.json()).then(t=>{t.success?e.innerHTML=t.data.html:console.error("Failed to reload gallery:",t.data?.message)}).catch(e=>{console.error("Error reloading gallery:",e)})}}updateFavoritesCount(e){document.querySelectorAll("[data-favorites-count]").forEach(t=>{t.textContent=`(${e})`})}initializeFavoritesButton(){const e=document.querySelectorAll('[data-action="show-favorites"]');e.length&&e.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),e.classList.contains("brag-book-gallery-favorites-link")?this.showFavoritesView():this.toggleFavoritesView()})})}showFavoritesView(){if(document.querySelectorAll('[data-action="show-favorites"]').forEach(e=>e.classList.add("active")),window.history&&window.history.pushState){const e=`/${window.bragBookGalleryConfig?.gallerySlug||"before-after"}/myfavorites`;window.history.pushState({view:"favorites"},"",e)}this.showFavoritesOnly()}toggleFavoritesView(){const e=document.querySelector('[data-action="show-favorites"]:not(.brag-book-gallery-favorites-link)'),t=e?.classList.contains("active");t?(this.showAllCases(),document.querySelectorAll('[data-action="show-favorites"]').forEach(e=>{e.classList.remove("active")})):(this.showFavoritesOnly(),document.querySelectorAll('[data-action="show-favorites"]').forEach(e=>{e.classList.add("active")}))}showFavoritesOnly(){const e=document.getElementById("gallery-content");if(!e)return;const t=e.querySelector("#gallery-sections");t&&(t.style.display="none");const o="brag-book-user-info";let a=null;try{const e=localStorage.getItem(o);e&&(a=JSON.parse(e))}catch(e){console.error("Failed to load user info:",e)}if(!a||!a.email){e.innerHTML='\n\t\t\t\t<div class="brag-book-gallery-favorites-wrapper">\n\t\t\t\t\t<div class="brag-book-gallery-favorites-container">\n\t\t\t\t\t\t<div class="brag-book-gallery-favorites-form-wrapper">\n\t\t\t\t\t\t\t<svg class="brag-book-gallery-favorites-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 180">\n\t\t\t\t\t\t\t\t<path fill="#ff595c" d="M85.5,124.6l40-84.7h16.2v104.9h-12.8V60.7l-39.8,84.1h-7.2L42.2,59.7v85.1h-12.8V39.9h16.8l39.3,84.7Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#ff595c" d="M186.2,131.1l25-62.4h12.9l-32.6,80.1c-2.6,6.3-5.2,11.4-7.9,15.3-2.7,3.8-5.7,6.6-9.1,8.3-3.3,1.7-7.4,2.6-12.2,2.6s-3.4,0-4.9-.4c-1.5-.2-2.9-.6-4.2-.9v-10.6c1.3.2,2.7.4,4.2.6,1.4.2,2.9.3,4.5.3,3.9,0,7.2-1.3,9.8-3.9,2.6-2.6,5.3-7.2,8.1-13.9l-32.4-77.3h13.4l25.4,62.4v-.2Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M303.1,39.9v11.2h-60.4v35.6h55.2v11.2h-55.2v46.9h-12.8V39.9h73.2,0Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M344.1,67.2c11.6,0,20.2,2.9,25.9,8.7,5.7,5.8,8.5,14.9,8.5,27.4v41.5h-7.9l-2.4-23.7c-2.7,7.8-7.2,13.9-13.7,18.4-6.4,4.5-14,6.8-22.8,6.8s-9.2-.9-12.8-2.8c-3.6-1.9-6.5-4.4-8.5-7.5s-3-6.5-3-10,1.3-8.7,3.9-12.5,6.7-7.1,12.4-9.9c5.7-2.8,13-4.7,22.1-5.8l20-2.5c-.8-6.2-2.9-10.7-6.4-13.4s-8.6-4-15.2-4-12.3,1.4-15.7,4.3c-3.3,2.9-5.6,6.8-6.8,11.8h-12.6c1.1-7.8,4.5-14.2,10.2-19.3,5.8-5.1,14-7.6,24.9-7.6h-.1ZM335,135.5c5.8,0,11.1-1.4,15.8-4.2,4.7-2.8,8.4-6.5,11.2-11.2,2.8-4.7,4.2-9.9,4.2-15.7l-15.4,1.9c-7.9,1-14,2.3-18.5,4.2-4.5,1.8-7.7,3.9-9.6,6.3-1.9,2.3-2.8,4.8-2.9,7.4,0,3.2,1.1,5.9,3.7,8.1s6.4,3.3,11.6,3.3h-.1Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M419.7,127l25-58.4h13.1l-33.4,76.2h-9.8l-33.2-76.2h13.2l25,58.4h.1Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M495.7,146.3c-7.9,0-14.7-1.6-20.4-4.7-5.8-3.1-10.2-7.5-13.3-13.3s-4.7-12.5-4.7-20.3v-2.6c0-7.8,1.6-14.6,4.7-20.3,3.1-5.7,7.6-10.1,13.3-13.2,5.8-3.1,12.6-4.7,20.4-4.7s14.6,1.6,20.4,4.7c5.8,3.1,10.2,7.5,13.3,13.2s4.7,12.5,4.7,20.3v2.6c0,7.8-1.6,14.5-4.7,20.3-3.1,5.8-7.5,10.2-13.3,13.3s-12.6,4.7-20.4,4.7ZM495.7,135.5c8.3,0,14.8-2.4,19.3-7.1,4.5-4.8,6.8-12,6.8-21.6s-2.3-16.9-6.8-21.6c-4.5-4.8-10.9-7.1-19.3-7.1s-14.8,2.4-19.3,7.1c-4.5,4.7-6.8,11.9-6.8,21.6s2.3,16.9,6.8,21.6,10.9,7.1,19.3,7.1Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M579.5,67.2c2.2,0,4,0,5.5.4,1.5.2,2.7.5,3.7.8v12.1c-1.4-.2-2.9-.3-4.5-.4-1.6,0-3.4,0-5.5,0-7.2,0-12.8,2.6-16.8,7.8s-6,13.9-6,26.1v31h-12.2v-76.2h7.9l2.3,22.1c2.1-8.3,5.4-14.4,10-18,4.6-3.7,9.8-5.5,15.6-5.5h0Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M607.6,144.8h-12.2v-76.2h12.2v76.2Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M670,68.7v10.8h-27.2v40.5c0,5.5,1.1,9.4,3.4,11.9,2.3,2.4,5.8,3.7,10.5,3.7s5.1,0,7.2-.4c2.1-.3,4.2-.6,6.2-1v10.6c-1.6.4-3.5.7-5.5,1-2.1.3-4.7.4-7.8.4-17.4,0-26.2-8.4-26.2-25.3v-41.5h-15.7v-10.8h16l4-22.6h7.9v22.6h27.2,0Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M749.7,102.9c0,2.8-.2,5.3-.6,7.5h-62.2c.7,8.5,3.2,14.9,7.6,19,4.4,4.1,10.5,6.2,18.3,6.2s8.8-.7,11.9-2.1c3-1.4,5.4-3.3,7.1-5.5,1.7-2.3,3.1-4.8,4-7.5h12.5c-.9,4.5-2.7,8.7-5.5,12.7s-6.6,7.2-11.6,9.6c-4.9,2.4-11.2,3.6-18.8,3.6s-14.5-1.6-20.2-4.7c-5.7-3.1-10.1-7.5-13.2-13.3-3.1-5.8-4.7-12.5-4.7-20.3v-2.6c0-7.8,1.6-14.6,4.7-20.3,3.1-5.7,7.6-10.1,13.4-13.2,5.8-3.1,12.6-4.7,20.5-4.7s14.1,1.5,19.5,4.5c5.5,3,9.7,7.1,12.7,12.4,3,5.3,4.5,11.6,4.5,18.8h0ZM712.9,78c-7.6,0-13.6,1.9-18,5.6-4.4,3.7-7,9.4-7.9,17h50.3c-.6-7.5-3-13.1-7.1-16.9-4.2-3.8-9.9-5.7-17.3-5.7h0Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M753.3,119.4h12.5c1.1,5,3.4,8.9,7,11.8,3.7,2.9,9.8,4.3,18.4,4.3s10.1-.5,13.4-1.6c3.3-1.1,5.7-2.5,7.1-4.3,1.4-1.7,2.2-3.5,2.2-5.3s-.6-4.2-1.7-5.8c-1.2-1.6-3.5-2.9-7-4s-8.9-2-16-2.8c-9-1.1-16-2.5-20.9-4.5-4.9-1.9-8.3-4.3-10.1-7.2s-2.8-6.2-2.8-9.9,1.2-7.8,3.7-11.2c2.4-3.4,6.1-6.2,11.1-8.4,4.9-2.2,11.2-3.3,18.8-3.3s14.3,1.2,19.3,3.5,8.9,5.5,11.6,9.6c2.7,4,4.3,8.6,4.8,13.8h-12.5c-.9-5.1-3-9-6.3-11.9s-9-4.3-16.8-4.3-13.4,1.2-16.5,3.5c-3.2,2.3-4.7,5-4.7,7.8s.6,3.9,1.8,5.5c1.2,1.5,3.6,2.9,7.3,4,3.7,1.2,9.2,2.2,16.7,3,8.8,1,15.6,2.4,20.3,4.5,4.8,2,8,4.5,9.9,7.3,1.8,2.9,2.7,6.1,2.7,9.8s-1.3,7.7-3.8,11.2-6.3,6.4-11.5,8.5c-5.2,2.2-11.8,3.2-19.8,3.2s-15.5-1.1-20.9-3.4c-5.4-2.3-9.4-5.5-12.1-9.5-2.7-4-4.4-8.7-5-13.9h-.2Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M849.8,22.7v2.4h-6.1v20.1h-2.9v-20.1h-6.1v-2.4h15.2-.1Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#121827" d="M876.2,22.8v22.3h-2.9v-16.6l-7.4,16.6h-2.1l-7.4-16.7v16.7h-2.9v-22.3h3.2l8.3,18.4,8.3-18.4h3.1-.2Z"></path>\n\t\t\t\t\t\t\t\t<path fill="#ff595c" d="M614.2,19c-2.4-.6-4.8-.3-6.9.9-2.2,1.2-4.1,3.1-5.6,5.2-.2.3-.4.6-.5.9-2.3-3.9-6.6-7.6-11.3-7.2-4.4.4-8.2,3.6-9.1,7.9-1.1,5,2.1,9.6,5.1,13.3,2.8,3.3,5.9,6.3,9,9.3,1.9,1.8,3.9,3.6,5.9,5.3h0c0,0,.2.1.3.1s.2,0,.3-.1c1.7-1.4,3.3-2.9,4.9-4.3,3.2-2.9,6.3-5.9,9.1-9.1,3.1-3.5,6.6-7.9,6.3-12.9-.3-4.3-3.4-8.1-7.6-9.2h0Z"></path>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t<p>Please enter your email to view your saved favorites:</p>\n\t\t\t\t\t\t\t<form class="brag-book-gallery-favorites-lookup-form" id="favorites-email-form">\n\t\t\t\t\t\t\t\t<div class="brag-book-gallery-form-group">\n\t\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\t\ttype="email"\n\t\t\t\t\t\t\t\t\t\tname="email"\n\t\t\t\t\t\t\t\t\t\tclass="brag-book-gallery-form-input"\n\t\t\t\t\t\t\t\t\t\tplaceholder="Enter your email address"\n\t\t\t\t\t\t\t\t\t\trequired\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<button type="submit" class="brag-book-gallery-button brag-book-gallery-button--full" data-action="form-submit">\n\t\t\t\t\t\t\t\t\t\tView Favorites\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</form>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t';const t=document.getElementById("favorites-email-form");return void(t&&t.addEventListener("submit",e=>{e.preventDefault();const a={email:new FormData(t).get("email")};localStorage.setItem(o,JSON.stringify(a)),this.showFavoritesOnly()}))}e.innerHTML='\n\t\t\t<div class="brag-book-gallery-loading">\n\t\t\t\t<div class="brag-book-gallery-spinner"></div>\n\t\t\t\t<p>Loading your favorites...</p>\n\t\t\t</div>\n\t\t';const r=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",s=window.bragBookGalleryConfig?.nonce||"";console.log("Loading favorites for email:",a.email),fetch(r,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"brag_book_get_favorites_list",email:a.email,nonce:s})}).then(e=>e.json()).then(t=>{if(console.log("AJAX Response:",t),t.success&&t.data){if(t.data.user_info||t.data.name&&t.data.phone){const e=t.data.user_info||{email:a.email,name:t.data.name||"",phone:t.data.phone||""};if(e.name||e.phone){const t={email:a.email,name:e.name||a.name||"",phone:e.phone||a.phone||""};localStorage.setItem(o,JSON.stringify(t)),console.log("Updated user info from API:",t),a=t}}if(t.data.cases&&Array.isArray(t.data.cases)){let e=[];const o=localStorage.getItem("brag-book-favorites");if(o)try{e=JSON.parse(o),console.log("Existing localStorage favorites:",e)}catch(t){console.error("Error parsing existing favorites:",t),e=[]}const a=new Set(e);t.data.cases.forEach(e=>{const t=e.id||e.caseId||"";t&&a.add(String(t))});const r=Array.from(a);localStorage.setItem("brag-book-favorites",JSON.stringify(r)),console.log("Updated localStorage favorites (merged):",r),this.favoritesManager&&(this.favoritesManager.favorites=new Set(r),this.favoritesManager.updateUI()),document.querySelectorAll("[data-favorites-count]").forEach(e=>{e.textContent=`(${r.length})`,e.style&&(e.style.opacity="1")})}else localStorage.getItem("brag-book-favorites")||(localStorage.setItem("brag-book-favorites",JSON.stringify([])),console.log("Initialized empty favorites in localStorage")),document.querySelectorAll("[data-favorites-count]").forEach(e=>{e.textContent="(0)",e.style&&(e.style.opacity="1")}),this.favoritesManager&&(this.favoritesManager.favorites=new Set,this.favoritesManager.updateUI());if(t.data.html){e.innerHTML=`\n\t\t\t\t\t\t<div class="brag-book-gallery-favorites-wrapper">\n\t\t\t\t\t\t\t<div class="brag-book-gallery-favorites-container">\n\t\t\t\t\t\t\t\t<div class="brag-book-gallery-favorites-view">\n\t\t\t\t\t\t\t\t\t${t.data.html}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`;const o=e.querySelector(".brag-book-gallery-favorites-user");o&&(o.textContent=`Showing favorites for: ${a.email}`),this.reinitializeGalleryComponents(),setTimeout(()=>{const e=localStorage.getItem("brag-book-favorites");if(e)try{const t=JSON.parse(e);console.log("Updating favorite button states for IDs:",t),t.forEach(e=>{[`[data-item-id="${e}"]`,`[data-case-id="${e}"]`,`[data-item-id="case-${e}"]`,`[data-item-id="${e}_main"]`].forEach(e=>{document.querySelectorAll(e).forEach(t=>{void 0!==t.dataset.favorited&&(t.dataset.favorited="true",console.log("Marked as favorite:",e))})})})}catch(e){console.error("Error updating favorite button states:",e)}},100)}else"string"==typeof t.data?e.innerHTML=t.data:(localStorage.getItem("brag-book-favorites")||(localStorage.setItem("brag-book-favorites",JSON.stringify([])),console.log("Initialized empty favorites in localStorage")),e.innerHTML=`\n\t\t\t\t\t\t<div class="brag-book-gallery-favorites-wrapper">\n\t\t\t\t\t\t\t<div class="brag-book-gallery-favorites-container">\n\t\t\t\t\t\t\t\t<div class="brag-book-filtered-results">\n\t\t\t\t\t\t\t\t\t<svg class="brag-book-gallery-favorites-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 180">\n\t\t\t\t\t\t\t\t\t\t<path fill="#ff595c" d="M85.5,124.6l40-84.7h16.2v104.9h-12.8V60.7l-39.8,84.1h-7.2L42.2,59.7v85.1h-12.8V39.9h16.8l39.3,84.7Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#ff595c" d="M186.2,131.1l25-62.4h12.9l-32.6,80.1c-2.6,6.3-5.2,11.4-7.9,15.3-2.7,3.8-5.7,6.6-9.1,8.3-3.3,1.7-7.4,2.6-12.2,2.6s-3.4,0-4.9-.4c-1.5-.2-2.9-.6-4.2-.9v-10.6c1.3.2,2.7.4,4.2.6,1.4.2,2.9.3,4.5.3,3.9,0,7.2-1.3,9.8-3.9,2.6-2.6,5.3-7.2,8.1-13.9l-32.4-77.3h13.4l25.4,62.4v-.2Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M303.1,39.9v11.2h-60.4v35.6h55.2v11.2h-55.2v46.9h-12.8V39.9h73.2,0Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M344.1,67.2c11.6,0,20.2,2.9,25.9,8.7,5.7,5.8,8.5,14.9,8.5,27.4v41.5h-7.9l-2.4-23.7c-2.7,7.8-7.2,13.9-13.7,18.4-6.4,4.5-14,6.8-22.8,6.8s-9.2-.9-12.8-2.8c-3.6-1.9-6.5-4.4-8.5-7.5s-3-6.5-3-10,1.3-8.7,3.9-12.5,6.7-7.1,12.4-9.9c5.7-2.8,13-4.7,22.1-5.8l20-2.5c-.8-6.2-2.9-10.7-6.4-13.4s-8.6-4-15.2-4-12.3,1.4-15.7,4.3c-3.3,2.9-5.6,6.8-6.8,11.8h-12.6c1.1-7.8,4.5-14.2,10.2-19.3,5.8-5.1,14-7.6,24.9-7.6h-.1ZM335,135.5c5.8,0,11.1-1.4,15.8-4.2,4.7-2.8,8.4-6.5,11.2-11.2,2.8-4.7,4.2-9.9,4.2-15.7l-15.4,1.9c-7.9,1-14,2.3-18.5,4.2-4.5,1.8-7.7,3.9-9.6,6.3-1.9,2.3-2.8,4.8-2.9,7.4,0,3.2,1.1,5.9,3.7,8.1s6.4,3.3,11.6,3.3h-.1Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M419.7,127l25-58.4h13.1l-33.4,76.2h-9.8l-33.2-76.2h13.2l25,58.4h.1Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M495.7,146.3c-7.9,0-14.7-1.6-20.4-4.7-5.8-3.1-10.2-7.5-13.3-13.3s-4.7-12.5-4.7-20.3v-2.6c0-7.8,1.6-14.6,4.7-20.3,3.1-5.7,7.6-10.1,13.3-13.2,5.8-3.1,12.6-4.7,20.4-4.7s14.6,1.6,20.4,4.7c5.8,3.1,10.2,7.5,13.3,13.2s4.7,12.5,4.7,20.3v2.6c0,7.8-1.6,14.5-4.7,20.3-3.1,5.8-7.5,10.2-13.3,13.3s-12.6,4.7-20.4,4.7ZM495.7,135.5c8.3,0,14.8-2.4,19.3-7.1,4.5-4.8,6.8-12,6.8-21.6s-2.3-16.9-6.8-21.6c-4.5-4.8-10.9-7.1-19.3-7.1s-14.8,2.4-19.3,7.1c-4.5,4.7-6.8,11.9-6.8,21.6s2.3,16.9,6.8,21.6,10.9,7.1,19.3,7.1Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M579.5,67.2c2.2,0,4,0,5.5.4,1.5.2,2.7.5,3.7.8v12.1c-1.4-.2-2.9-.3-4.5-.4-1.6,0-3.4,0-5.5,0-7.2,0-12.8,2.6-16.8,7.8s-6,13.9-6,26.1v31h-12.2v-76.2h7.9l2.3,22.1c2.1-8.3,5.4-14.4,10-18,4.6-3.7,9.8-5.5,15.6-5.5h0Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M607.6,144.8h-12.2v-76.2h12.2v76.2Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M670,68.7v10.8h-27.2v40.5c0,5.5,1.1,9.4,3.4,11.9,2.3,2.4,5.8,3.7,10.5,3.7s5.1,0,7.2-.4c2.1-.3,4.2-.6,6.2-1v10.6c-1.6.4-3.5.7-5.5,1-2.1.3-4.7.4-7.8.4-17.4,0-26.2-8.4-26.2-25.3v-41.5h-15.7v-10.8h16l4-22.6h7.9v22.6h27.2,0Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M749.7,102.9c0,2.8-.2,5.3-.6,7.5h-62.2c.7,8.5,3.2,14.9,7.6,19,4.4,4.1,10.5,6.2,18.3,6.2s8.8-.7,11.9-2.1c3-1.4,5.4-3.3,7.1-5.5,1.7-2.3,3.1-4.8,4-7.5h12.5c-.9,4.5-2.7,8.7-5.5,12.7s-6.6,7.2-11.6,9.6c-4.9,2.4-11.2,3.6-18.8,3.6s-14.5-1.6-20.2-4.7c-5.7-3.1-10.1-7.5-13.2-13.3-3.1-5.8-4.7-12.5-4.7-20.3v-2.6c0-7.8,1.6-14.6,4.7-20.3,3.1-5.7,7.6-10.1,13.4-13.2,5.8-3.1,12.6-4.7,20.5-4.7s14.1,1.5,19.5,4.5c5.5,3,9.7,7.1,12.7,12.4,3,5.3,4.5,11.6,4.5,18.8h0ZM712.9,78c-7.6,0-13.6,1.9-18,5.6-4.4,3.7-7,9.4-7.9,17h50.3c-.6-7.5-3-13.1-7.1-16.9-4.2-3.8-9.9-5.7-17.3-5.7h0Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M753.3,119.4h12.5c1.1,5,3.4,8.9,7,11.8,3.7,2.9,9.8,4.3,18.4,4.3s10.1-.5,13.4-1.6c3.3-1.1,5.7-2.5,7.1-4.3,1.4-1.7,2.2-3.5,2.2-5.3s-.6-4.2-1.7-5.8c-1.2-1.6-3.5-2.9-7-4s-8.9-2-16-2.8c-9-1.1-16-2.5-20.9-4.5-4.9-1.9-8.3-4.3-10.1-7.2s-2.8-6.2-2.8-9.9,1.2-7.8,3.7-11.2c2.4-3.4,6.1-6.2,11.1-8.4,4.9-2.2,11.2-3.3,18.8-3.3s14.3,1.2,19.3,3.5,8.9,5.5,11.6,9.6c2.7,4,4.3,8.6,4.8,13.8h-12.5c-.9-5.1-3-9-6.3-11.9s-9-4.3-16.8-4.3-13.4,1.2-16.5,3.5c-3.2,2.3-4.7,5-4.7,7.8s.6,3.9,1.8,5.5c1.2,1.5,3.6,2.9,7.3,4,3.7,1.2,9.2,2.2,16.7,3,8.8,1,15.6,2.4,20.3,4.5,4.8,2,8,4.5,9.9,7.3,1.8,2.9,2.7,6.1,2.7,9.8s-1.3,7.7-3.8,11.2-6.3,6.4-11.5,8.5c-5.2,2.2-11.8,3.2-19.8,3.2s-15.5-1.1-20.9-3.4c-5.4-2.3-9.4-5.5-12.1-9.5-2.7-4-4.4-8.7-5-13.9h-.2Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M849.8,22.7v2.4h-6.1v20.1h-2.9v-20.1h-6.1v-2.4h15.2-.1Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#121827" d="M876.2,22.8v22.3h-2.9v-16.6l-7.4,16.6h-2.1l-7.4-16.7v16.7h-2.9v-22.3h3.2l8.3,18.4,8.3-18.4h3.1-.2Z"></path>\n\t\t\t\t\t\t\t\t\t\t<path fill="#ff595c" d="M614.2,19c-2.4-.6-4.8-.3-6.9.9-2.2,1.2-4.1,3.1-5.6,5.2-.2.3-.4.6-.5.9-2.3-3.9-6.6-7.6-11.3-7.2-4.4.4-8.2,3.6-9.1,7.9-1.1,5,2.1,9.6,5.1,13.3,2.8,3.3,5.9,6.3,9,9.3,1.9,1.8,3.9,3.6,5.9,5.3h0c0,0,.2.1.3.1s.2,0,.3-.1c1.7-1.4,3.3-2.9,4.9-4.3,3.2-2.9,6.3-5.9,9.1-9.1,3.1-3.5,6.6-7.9,6.3-12.9-.3-4.3-3.4-8.1-7.6-9.2h0Z"></path>\n\t\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t\t\t<p class="brag-book-gallery-favorites-user">Showing favorites for: ${a.email}</p>\n\t\t\t\t\t\t\t\t\t<div class="brag-book-gallery-favorites-empty">\n\t\t\t\t\t\t\t\t\t\t<svg class="empty-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t\t\t\t\t\t\t\t\t\t\t<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n\t\t\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t\t\t\t<h3>No favorites yet</h3>\n\t\t\t\t\t\t\t\t\t\t<p>Start browsing the gallery and click the heart icon on cases you love to save them here.</p>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`)}else localStorage.getItem("brag-book-favorites")||(localStorage.setItem("brag-book-favorites",JSON.stringify([])),console.log("Initialized empty favorites in localStorage on error")),e.innerHTML=`\n\t\t\t\t\t<div class="brag-book-gallery-favorites-empty">\n\t\t\t\t\t\t<svg class="empty-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t\t\t\t\t\t\t<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t<h2>No favorites found</h2>\n\t\t\t\t\t\t<p>${t.data?.message||"Unable to load favorites. Please try again."}</p>\n\t\t\t\t\t</div>\n\t\t\t\t`}).catch(t=>{console.error("Error loading favorites:",t),e.innerHTML='\n\t\t\t\t<div class="brag-book-gallery-favorites-empty">\n\t\t\t\t\t<svg class="empty-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t\t\t\t\t\t<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n\t\t\t\t\t</svg>\n\t\t\t\t\t<h2>Error loading favorites</h2>\n\t\t\t\t\t<p>An error occurred while loading your favorites. Please try again.</p>\n\t\t\t\t</div>\n\t\t\t'}),this.components.filterSystem&&this.components.filterSystem.clearAllFilters()}showAllCases(){const e=document.getElementById("gallery-content"),t=e?.querySelector("#gallery-sections");t&&(t.style.display="");const o=e?.querySelector(".brag-book-gallery-favorites-header");o&&o.remove(),this.components.filterSystem&&(this.components.filterSystem.clearAllFilters(),this.components.filterSystem.loadInitialCases())}showFavoritesEmptyState(){const e=document.getElementById("gallery-content");if(!e)return;const t=e.querySelector("#gallery-sections");t&&(t.style.display="none");const o=e.querySelector(".brag-book-gallery-cases-grid");if(o){o.innerHTML="";const e=document.createElement("div");e.className="brag-book-gallery-favorites-empty-state",e.innerHTML='\n\t\t\t\t<svg class="empty-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n\t\t\t\t\t<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n\t\t\t\t</svg>\n\t\t\t\t<h2>No favorites yet</h2>\n\t\t\t\t<p>Start browsing the gallery and click the heart icon on cases you love to save them here.</p>\n\t\t\t\t<button class="brag-book-gallery-button" onclick="document.querySelector(\'[data-action=\\\'show-favorites\\\']\').click()">\n\t\t\t\t\tBrowse Gallery\n\t\t\t\t</button>\n\t\t\t',o.parentElement.insertBefore(e,o)}}createCaseCard(e){const t=e.id,o=window.bragBookGalleryConfig?.gallerySlug||"before-after";let a="case",r="Case";const s=window.location.pathname,i=new RegExp(`/${o}/([^/]+)`),n=s.match(i);n&&n[1]?(a=n[1],r=a.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")):e.technique&&(a=e.technique.toLowerCase().replace(/\s+/g,"-"),r=e.technique);const l="/"+o+"/"+a+"/"+t;let c="";e.photoSets&&e.photoSets.length>0&&(c=e.photoSets[0].postProcessedImageLocation||"");const d=this.components.favoritesManager.getFavorites().has(`case-${t}`);return`\n\t\t\t<article class="brag-book-gallery-case-card" data-case-id="${t}">\n\t\t\t\t<div class="brag-book-gallery-image-container brag-book-gallery-single-image">\n\t\t\t\t\t<div class="brag-book-gallery-skeleton-loader" style="display:none;"></div>\n\t\t\t\t\t<div class="brag-book-gallery-item-actions">\n\t\t\t\t\t\t<button class="brag-book-gallery-favorite-button" data-favorited="${d}" data-item-id="case-${t}" aria-label="${d?"Remove from":"Add to"} favorites">\n\t\t\t\t\t\t\t<svg fill="${d?"red":"rgba(255, 255, 255, 0.5)"}" stroke="white" stroke-width="2" viewBox="0 0 24 24">\n\t\t\t\t\t\t\t\t<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t<a href="${l}" class="brag-book-gallery-case-card-link" data-case-id="${t}">\n\t\t\t\t\t\t<picture class="brag-book-gallery-picture">\n\t\t\t\t\t\t\t<img src="${c}" alt="Case ${t}" loading="lazy" data-image-type="single">\n\t\t\t\t\t\t</picture>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t\t<div class="brag-book-gallery-case-card-summary">\n\t\t\t\t\t<div class="brag-book-gallery-case-card-summary-info">\n\t\t\t\t\t\t<span class="brag-book-gallery-case-card-summary-info__name">${r}</span>\n\t\t\t\t\t\t<span class="brag-book-gallery-case-card-summary-info__case-number">Case #${t}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="brag-book-gallery-case-card-summary-details">\n\t\t\t\t\t\t${e.age?`<span class="brag-book-gallery-age">${e.age} yrs</span>`:""}\n\t\t\t\t\t\t${e.gender?`<span class="brag-book-gallery-gender">${e.gender}</span>`:""}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</article>\n\t\t`}reinitializeGalleryComponents(){this.initializeCaseLinks(),this.components.favoritesManager&&document.querySelectorAll("[data-favorited]").forEach(e=>{const t=e.dataset.itemId,o=this.components.favoritesManager.getFavorites().has(t);e.dataset.favorited=o.toString()})}};class l{constructor(){this.nudityAccepted=!1,this.storageKey="brag-book-nudity-accepted",this.checkInitialAcceptance(),this.init()}checkInitialAcceptance(){try{const e=localStorage.getItem(this.storageKey);this.nudityAccepted="true"===e,this.nudityAccepted&&document.body.classList.add("nudity-accepted")}catch(e){console.warn("Could not load nudity acceptance status from localStorage:",e),this.nudityAccepted=!1}}init(){this.setupEventListeners(),console.log("%cTo reset nudity warnings, type: nudityManager.resetAcceptance()","background: #333; color: #fff; padding: 5px; border-radius: 3px;")}saveAcceptanceStatus(){try{localStorage.setItem(this.storageKey,"true")}catch(e){console.warn("Could not save nudity acceptance status to localStorage:",e)}}setupEventListeners(){document.addEventListener("click",e=>{e.target.matches(".brag-book-gallery-nudity-warning-button")&&this.handleProceedButtonClick(e.target)})}handleProceedButtonClick(e){this.nudityAccepted=!0,this.saveAcceptanceStatus(),document.body.classList.add("nudity-accepted"),this.animateRemoval()}animateRemoval(){const e=document.querySelectorAll(".brag-book-gallery-nudity-warning"),t=document.querySelectorAll(".brag-book-gallery-nudity-blur");e.forEach(e=>{"undefined"!=typeof gsap?gsap.to(e,{opacity:0,duration:.5,ease:"power2.out",onComplete:()=>{e.style.display="none"}}):(e.style.transition="opacity 0.5s ease-out",e.style.opacity="0",setTimeout(()=>{e.style.display="none"},500))}),t.forEach(e=>{"undefined"!=typeof gsap?gsap.to(e,{filter:"blur(0px)",duration:.5,ease:"power2.out"}):(e.style.transition="filter 0.5s ease-out",e.style.filter="blur(0px)")})}resetAcceptance(){this.nudityAccepted=!1;try{localStorage.removeItem(this.storageKey),document.body.classList.remove("nudity-accepted"),console.log("✅ Nudity warning acceptance has been reset. Refresh the page to see warnings again.")}catch(e){console.warn("Could not remove nudity acceptance status from localStorage:",e)}}}class c{constructor(){this.init()}init(){document.querySelectorAll('[data-phone-format="true"]').forEach(e=>{this.setupPhoneInput(e)})}setupPhoneInput(e){e.addEventListener("input",e=>{this.formatPhoneNumber(e.target)}),e.addEventListener("paste",e=>{setTimeout(()=>{this.formatPhoneNumber(e.target)},0)}),e.addEventListener("keypress",e=>{const t=String.fromCharCode(e.which);/[0-9]/.test(t)||8===e.which||46===e.which||e.preventDefault()})}formatPhoneNumber(e){let t=e.value.replace(/\D/g,"");t=t.substring(0,10);let o="";t.length>0&&(o=t.length<=3?`(${t}`:t.length<=6?`(${t.substring(0,3)}) ${t.substring(3)}`:`(${t.substring(0,3)}) ${t.substring(3,6)}-${t.substring(6,10)}`),e.value=o,10===t.length?e.setCustomValidity(""):e.hasAttribute("required")&&t.length>0&&e.setCustomValidity("Please enter a complete 10-digit phone number")}}let d,g;window.updateGridLayout=function(e){const t=document.querySelector(".brag-book-gallery-case-grid");t&&window.innerWidth>=1024&&(t.classList.add("grid-initialized"),t.setAttribute("data-columns",e),document.querySelectorAll(".brag-book-gallery-grid-btn").forEach(t=>{parseInt(t.dataset.columns)===e?t.classList.add("active"):t.classList.remove("active")}),localStorage.setItem("bragbook-grid-columns",e))},window.bragBookProcedureFilters={age:[],gender:[],ethnicity:[],height:[],weight:[]},window.initializeProcedureFilters=function(){const e=document.getElementById("procedure-filters-details");console.log("Initializing procedure filters, details element:",e),console.log("Complete dataset available:",window.bragBookGalleryConfig?.completeDataset?.length||0,"cases"),e&&!e.dataset.initialized&&(generateProcedureFilterOptions(),e.dataset.initialized="true")},window.generateProcedureFilterOptions=function(){const e=document.getElementById("brag-book-gallery-filters");if(!e)return void console.warn("Filter container not found");let t;if(!window.bragBookCompleteDataset&&window.bragBookGalleryConfig&&window.bragBookGalleryConfig.completeDataset?(window.bragBookCompleteDataset=window.bragBookGalleryConfig.completeDataset,console.log("Initialized complete dataset with",window.bragBookCompleteDataset.length,"cases")):window.bragBookCompleteDataset||(console.warn("Complete dataset not available from config"),console.log("Config object:",window.bragBookGalleryConfig)),window.bragBookCompleteDataset&&window.bragBookCompleteDataset.length>0){console.log("Using complete dataset for filters:",window.bragBookCompleteDataset.length,"cases");const t={age:new Set,gender:new Set,ethnicity:new Set,height:new Set,weight:new Set},o=[],a=[],r=[];return window.bragBookCompleteDataset.forEach(e=>{const s=e.age||e.patientAge,i=e.gender||e.patientGender,n=e.ethnicity||e.patientEthnicity,l=e.height||e.patientHeight,c=e.weight||e.patientWeight;s&&o.push(parseInt(s)),i&&t.gender.add(i),n&&t.ethnicity.add(n),l&&a.push(parseInt(l)),c&&r.push(parseInt(c))}),o.some(e=>e>=18&&e<25)&&t.age.add("18-24"),o.some(e=>e>=25&&e<35)&&t.age.add("25-34"),o.some(e=>e>=35&&e<45)&&t.age.add("35-44"),o.some(e=>e>=45&&e<55)&&t.age.add("45-54"),o.some(e=>e>=55&&e<65)&&t.age.add("55-64"),o.some(e=>e>=65)&&t.age.add("65+"),a.some(e=>e<60)&&t.height.add("Under 5'0\""),a.some(e=>e>=60&&e<64)&&t.height.add("5'0\" - 5'3\""),a.some(e=>e>=64&&e<68)&&t.height.add("5'4\" - 5'7\""),a.some(e=>e>=68&&e<72)&&t.height.add("5'8\" - 5'11\""),a.some(e=>e>=72)&&t.height.add("6'0\" and above"),r.some(e=>e<120)&&t.weight.add("Under 120 lbs"),r.some(e=>e>=120&&e<150)&&t.weight.add("120-149 lbs"),r.some(e=>e>=150&&e<180)&&t.weight.add("150-179 lbs"),r.some(e=>e>=180&&e<210)&&t.weight.add("180-209 lbs"),r.some(e=>e>=210)&&t.weight.add("210+ lbs"),void generateFilterHTML(e,t)}console.log("Falling back to DOM cards for filters"),t=document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]'),console.log("Found",t.length,"cards in DOM");const o={age:new Set,gender:new Set,ethnicity:new Set,height:new Set,weight:new Set},a=[],r=[],s=[];t.forEach(e=>{const t=e.dataset.age;t&&a.push(parseInt(t)),e.dataset.gender&&o.gender.add(e.dataset.gender),e.dataset.ethnicity&&o.ethnicity.add(e.dataset.ethnicity);const i=e.dataset.height;if(i){const t=parseInt(i);"cm"===(e.dataset.heightUnit||"in")?r.push(Math.round(t/2.54)):r.push(t)}const n=e.dataset.weight;if(n){const t=parseInt(n);"kg"===(e.dataset.weightUnit||"lbs")?s.push(Math.round(2.205*t)):s.push(t)}}),a.some(e=>e>=18&&e<25)&&o.age.add("18-24"),a.some(e=>e>=25&&e<35)&&o.age.add("25-34"),a.some(e=>e>=35&&e<45)&&o.age.add("35-44"),a.some(e=>e>=45&&e<55)&&o.age.add("45-54"),a.some(e=>e>=55&&e<65)&&o.age.add("55-64"),a.some(e=>e>=65)&&o.age.add("65+"),r.some(e=>e<60)&&o.height.add("Under 5'0\""),r.some(e=>e>=60&&e<64)&&o.height.add("5'0\" - 5'3\""),r.some(e=>e>=64&&e<68)&&o.height.add("5'4\" - 5'7\""),r.some(e=>e>=68&&e<72)&&o.height.add("5'8\" - 5'11\""),r.some(e=>e>=72)&&o.height.add("6'0\" and above"),s.some(e=>e<120)&&o.weight.add("Under 120 lbs"),s.some(e=>e>=120&&e<150)&&o.weight.add("120-149 lbs"),s.some(e=>e>=150&&e<180)&&o.weight.add("150-179 lbs"),s.some(e=>e>=180&&e<210)&&o.weight.add("180-209 lbs"),s.some(e=>e>=210)&&o.weight.add("210+ lbs"),generateFilterHTML(e,o)},window.generateFilterHTML=function(e,t){console.log("generateFilterHTML called with:",t);let o="";t.age.size>0&&(o+='<details class="brag-book-gallery-filter">',o+='<summary class="brag-book-gallery-filter-label">',o+='<span class="brag-book-gallery-filter-label__name">Age</span>',o+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="</summary>",o+='<ul class="brag-book-gallery-filter-options">',Array.from(t.age).sort().forEach(e=>{const t=`procedure-filter-age-${e.replace(/\s+/g,"-")}`;o+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${e}" data-filter-type="age">\n\t\t\t\t<label for="${t}">${e}</label>\n\t\t\t</li>`}),o+="</ul>",o+="</details>"),t.gender.size>0&&(o+='<details class="brag-book-gallery-filter">',o+='<summary class="brag-book-gallery-filter-label">',o+='<span class="brag-book-gallery-filter-label__name">Gender</span>',o+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="</summary>",o+='<ul class="brag-book-gallery-filter-options">',Array.from(t.gender).sort().forEach(e=>{const t=`procedure-filter-gender-${e}`,a=e.charAt(0).toUpperCase()+e.slice(1);o+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${e}" data-filter-type="gender">\n\t\t\t\t<label for="${t}">${a}</label>\n\t\t\t</li>`}),o+="</ul>",o+="</details>"),t.ethnicity.size>0&&(o+='<details class="brag-book-gallery-filter">',o+='<summary class="brag-book-gallery-filter-label">',o+='<span class="brag-book-gallery-filter-label__name">Ethnicity</span>',o+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="</summary>",o+='<ul class="brag-book-gallery-filter-options">',Array.from(t.ethnicity).sort().forEach(e=>{const t=`procedure-filter-ethnicity-${e.replace(/\s+/g,"-")}`,a=e.charAt(0).toUpperCase()+e.slice(1);o+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${e}" data-filter-type="ethnicity">\n\t\t\t\t<label for="${t}">${a}</label>\n\t\t\t</li>`}),o+="</ul>",o+="</details>"),t.height.size>0&&(o+='<details class="brag-book-gallery-filter">',o+='<summary class="brag-book-gallery-filter-label">',o+='<span class="brag-book-gallery-filter-label__name">Height</span>',o+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="</summary>",o+='<ul class="brag-book-gallery-filter-options">',Array.from(t.height).sort().forEach(e=>{const t=`procedure-filter-height-${e.replace(/\s+/g,"-")}`;o+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${e}" data-filter-type="height">\n\t\t\t\t<label for="${t}">${e}</label>\n\t\t\t</li>`}),o+="</ul>",o+="</details>"),t.weight.size>0&&(o+='<details class="brag-book-gallery-filter">',o+='<summary class="brag-book-gallery-filter-label">',o+='<span class="brag-book-gallery-filter-label__name">Weight</span>',o+='<svg class="brag-book-gallery-filter-label__arrow" width="16" height="16" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="</summary>",o+='<ul class="brag-book-gallery-filter-options">',Array.from(t.weight).sort().forEach(e=>{const t=`procedure-filter-weight-${e.replace(/\s+/g,"-")}`;o+=`<li class="brag-book-gallery-filter-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${e}" data-filter-type="weight">\n\t\t\t\t<label for="${t}">${e}</label>\n\t\t\t</li>`}),o+="</ul>",o+="</details>"),console.log("Generated HTML length:",o.length),console.log("HTML preview:",o.substring(0,200)+(o.length>200?"...":"")),e.innerHTML=o||"<p>No filters available</p>",e.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.addEventListener("change",function(){console.log("Filter changed:",this.dataset.filterType,"=",this.value,"checked:",this.checked),applyProcedureFilters()})});const a=document.getElementById("procedure-filters-details");if(a){const e=o&&"<p>No filters available</p>"!==o;console.log("Has filters:",e),a.style.display=e?"":"none"}},window.applyProcedureFilters=function(){console.log("Applying procedure filters...");const e=document.querySelectorAll(".brag-book-gallery-filter-option input:checked");if(console.log("Checked filters:",e.length),window.bragBookProcedureFilters={age:[],gender:[],ethnicity:[],height:[],weight:[]},e.forEach(e=>{const t=e.dataset.filterType,o=e.value;console.log("Filter:",t,"=",o),window.bragBookProcedureFilters[t]&&window.bragBookProcedureFilters[t].push(o)}),console.log("Active filters:",window.bragBookProcedureFilters),!Object.values(window.bragBookProcedureFilters).some(e=>e.length>0)){const e=document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]');e.forEach(e=>{e.style.display=""}),updateFilteredCount(e.length,e.length);const t=document.querySelector('[data-action="load-more"]'),o=t?t.closest(".brag-book-gallery-load-more-container")||t.parentElement:null;return void(o&&t.hasAttribute("data-start-page")&&(o.style.display=""))}if(window.bragBookCompleteDataset&&window.bragBookCompleteDataset.length>0){const e=[];window.bragBookCompleteDataset.forEach(t=>{let o=!0;const a=t.age||t.patientAge,r=t.gender||t.patientGender,s=t.ethnicity||t.patientEthnicity,i=t.height||t.patientHeight,n=t.weight||t.patientWeight;if(window.bragBookProcedureFilters.age.length>0){const e=parseInt(a);let t=!1;window.bragBookProcedureFilters.age.forEach(o=>{("18-24"===o&&e>=18&&e<=24||"25-34"===o&&e>=25&&e<=34||"35-44"===o&&e>=35&&e<=44||"45-54"===o&&e>=45&&e<=54||"55-64"===o&&e>=55&&e<=64||"65+"===o&&e>=65)&&(t=!0)}),t||(o=!1)}if(o&&window.bragBookProcedureFilters.gender.length>0&&(window.bragBookProcedureFilters.gender.includes(r)||(o=!1)),o&&window.bragBookProcedureFilters.ethnicity.length>0&&(window.bragBookProcedureFilters.ethnicity.includes(s)||(o=!1)),o&&window.bragBookProcedureFilters.height.length>0){const e=parseInt(i);let t=!1;window.bragBookProcedureFilters.height.forEach(o=>{("Under 5'0\""===o&&e<60||"5'0\" - 5'3\""===o&&e>=60&&e<64||"5'4\" - 5'7\""===o&&e>=64&&e<68||"5'8\" - 5'11\""===o&&e>=68&&e<72||"6'0\" and above"===o&&e>=72)&&(t=!0)}),t||(o=!1)}if(o&&window.bragBookProcedureFilters.weight.length>0){const e=parseInt(n);let t=!1;window.bragBookProcedureFilters.weight.forEach(o=>{("Under 120 lbs"===o&&e<120||"120-149 lbs"===o&&e>=120&&e<150||"150-179 lbs"===o&&e>=150&&e<180||"180-209 lbs"===o&&e>=180&&e<210||"210+ lbs"===o&&e>=210)&&(t=!0)}),t||(o=!1)}o&&e.push(t.id)}),loadFilteredCases(e)}else{let t=document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]');0===t.length&&(t=document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]')),0===t.length&&(t=document.querySelectorAll(".brag-book-gallery-case-card, .brag-book-gallery-case-card")),console.log("Found cards for filtering:",t.length);let o=0;t.forEach((e,t)=>{let a=!0;if(0===t&&console.log("First card data attributes:",{age:e.dataset.age,gender:e.dataset.gender,ethnicity:e.dataset.ethnicity,height:e.dataset.height,weight:e.dataset.weight,card:e.dataset.card}),window.bragBookProcedureFilters.age.length>0){const t=parseInt(e.dataset.age);let o=!1;console.log("Age check for card:",t,"against filters:",window.bragBookProcedureFilters.age),window.bragBookProcedureFilters.age.forEach(e=>{("18-24"===e&&t>=18&&t<25||"25-34"===e&&t>=25&&t<35||"35-44"===e&&t>=35&&t<45||"45-54"===e&&t>=45&&t<55||"55-64"===e&&t>=55&&t<65||"65+"===e&&t>=65)&&(o=!0)}),o||(a=!1,console.log("Age filter failed for card with age:",t))}if(a&&window.bragBookProcedureFilters.gender.length>0){const t=(e.dataset.gender||"").toLowerCase(),o=window.bragBookProcedureFilters.gender.map(e=>e.toLowerCase());console.log("Gender check:",{cardGender:t,filterGenders:o,matches:o.includes(t)}),o.includes(t)||(a=!1)}if(a&&window.bragBookProcedureFilters.ethnicity.length>0){const t=(e.dataset.ethnicity||"").toLowerCase(),o=window.bragBookProcedureFilters.ethnicity.map(e=>e.toLowerCase());console.log("Ethnicity check:",{cardEthnicity:t,filterEthnicities:o,matches:o.includes(t)}),o.includes(t)||(a=!1)}if(a&&window.bragBookProcedureFilters.height.length>0){const t=parseInt(e.dataset.height),o=e.dataset.heightUnit||"cm";let r=!1;window.bragBookProcedureFilters.height.forEach(a=>{"cm"===o?("Under 160cm"===a&&t<160||"160-169cm"===a&&t>=160&&t<170||"170-179cm"===a&&t>=170&&t<180||"180cm+"===a&&t>=180)&&(r=!0):a===e.dataset.heightFull&&(r=!0)}),r||(a=!1)}if(a&&window.bragBookProcedureFilters.weight.length>0){const t=parseInt(e.dataset.weight),o=e.dataset.weightUnit||"lbs";let r=!1;window.bragBookProcedureFilters.weight.forEach(a=>{"lbs"===o||"lb"===o?("Under 120 lbs"===a&&t<120||"120-149 lbs"===a&&t>=120&&t<150||"150-179 lbs"===a&&t>=150&&t<180||"180-209 lbs"===a&&t>=180&&t<210||"210+ lbs"===a&&t>=210)&&(r=!0):"kg"===o?("Under 55kg"===a&&t<55||"55-69kg"===a&&t>=55&&t<70||"70-84kg"===a&&t>=70&&t<85||"85kg+"===a&&t>=85)&&(r=!0):a===e.dataset.weightFull&&(r=!0)}),r||(a=!1)}e.style.display=a?"":"none",a&&o++});const a=e.length>0,r=0===o?"No procedures match the selected filters":`Showing ${o} of ${t.length} procedures`;let s=document.querySelector(".brag-book-gallery-filter-results");if(!s){s=document.createElement("div"),s.className="brag-book-gallery-filter-results";const e=document.querySelector(".brag-book-gallery-case-grid")||document.querySelector(".brag-book-gallery-case-grid");e&&e.parentNode&&e.parentNode.insertBefore(s,e)}s.textContent=r,s.style.display=a?"block":"none";const i=document.getElementById("procedure-filters-details");if(i){i.open=!1;const e=i.querySelector(".brag-book-gallery-filter-dropdown__toggle");e&&e.classList.toggle("has-active-filters",a)}const n=document.querySelector('[data-action="load-more"]'),l=n?n.closest(".brag-book-gallery-load-more-container")||n.parentElement:null;l&&(a||0===o?l.style.display="none":n.hasAttribute("data-start-page")&&(l.style.display=""))}},window.loadFilteredCases=function(e){const t=document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]');t.forEach(e=>{e.style.display="none"});let o=0,a=[];if(e.forEach(e=>{const t=document.querySelector(`.brag-book-gallery-case-card[data-case-id="${e}"]`);t?(t.style.display="",o++):a.push(e)}),a.length>0){const e=document.querySelector(".brag-book-gallery-case-grid")||document.querySelector(".brag-book-gallery-case-grid");if(e){const t=document.createElement("div");t.className="filter-loading-message",t.textContent=`Loading ${a.length} additional matching cases...`,t.style.cssText="padding: 20px; text-align: center; font-style: italic;",e.appendChild(t);const r=new FormData;r.append("action","brag_book_load_filtered_cases"),r.append("case_ids",a.join(",")),r.append("nonce","undefined"!=typeof bragBookAjax?bragBookAjax.nonce:""),fetch("undefined"!=typeof ajaxurl?ajaxurl:"/wp-admin/admin-ajax.php",{method:"POST",body:r}).then(e=>e.json()).then(t=>{const a=e.querySelector(".filter-loading-message");if(a&&a.remove(),t.success&&t.data.html){const a=document.createElement("div");a.innerHTML=t.data.html,a.querySelectorAll(".brag-book-gallery-case-card").forEach(t=>{e.appendChild(t),o++})}updateFilteredCount(o,window.bragBookCompleteDataset.length)}).catch(t=>{console.error("Error loading filtered cases:",t);const o=e.querySelector(".filter-loading-message");o&&(o.textContent="Failed to load additional cases. Showing only currently loaded matches.",setTimeout(()=>o.remove(),3e3))})}}else updateFilteredCount(o,window.bragBookCompleteDataset?window.bragBookCompleteDataset.length:t.length);const r=document.querySelector('[data-action="load-more"]'),s=r?r.closest(".brag-book-gallery-load-more-container")||r.parentElement:null;s&&(s.style.display="none")},window.updateFilteredCount=function(e,t){const o=document.querySelector(".brag-book-gallery-favorite-count-label")||document.querySelector(".cases-count");o&&(o.textContent=`Showing ${e} of ${t}`);let a=document.querySelector(".brag-book-gallery-filter-results");if(!a){a=document.createElement("div"),a.className="brag-book-gallery-filter-results";const e=document.querySelector(".brag-book-gallery-case-grid")||document.querySelector(".brag-book-gallery-case-grid");e&&e.parentNode&&e.parentNode.insertBefore(a,e)}0===e?(a.textContent="No procedures match the selected filters",a.style.display="block"):window.bragBookProcedureFilters&&Object.values(window.bragBookProcedureFilters).some(e=>e.length>0)?(a.textContent=`Filter applied: Showing ${e} matching procedures`,a.style.display="block"):a.style.display="none"},window.clearProcedureFilters=function(){console.log("Clearing all procedure filters"),document.querySelectorAll(".brag-book-gallery-filter-option input").forEach(e=>{e.checked=!1}),document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]').forEach(e=>{e.style.display=""});const e=document.querySelector(".brag-book-gallery-filter-results");e&&(e.style.display="none"),window.bragBookProcedureFilters={age:[],gender:[],ethnicity:[],height:[],weight:[]};const t=document.querySelector(".brag-book-gallery-filter-dropdown__toggle");t&&t.classList.remove("has-active-filters");const o=document.querySelector('[data-action="filter-badges"]');o&&(console.log("Clearing filter badges container"),o.innerHTML=""),document.querySelectorAll(".brag-book-gallery-filter-badge").forEach(e=>{console.log("Removing badge:",e),e.remove()});const a=document.querySelector('[data-action="clear-filters"]');a&&(a.style.display="none"),window.bragBookGalleryApp&&"function"==typeof window.bragBookGalleryApp.updateDemographicBadges&&(console.log("Calling app updateDemographicBadges with empty filters"),window.bragBookGalleryApp.updateDemographicBadges({age:[],gender:[],ethnicity:[],height:[],weight:[]})),"function"==typeof window.updateDemographicFilterBadges&&(console.log("Calling global updateDemographicFilterBadges with empty filters"),window.updateDemographicFilterBadges({age:[],gender:[],ethnicity:[],height:[],weight:[]}));const r=document.querySelector('[data-action="load-more"]'),s=r?r.closest(".brag-book-gallery-load-more-container")||r.parentElement:null;s&&r&&r.hasAttribute("data-start-page")&&(s.style.display="")},window.syncImageHeights=function(e){e.style.opacity="1";const t=e.closest(".brag-book-gallery-image-container");if(t){const e=t.querySelector(".brag-book-gallery-skeleton-loader");e&&(e.style.display="none")}const o=e.closest(".brag-book-gallery-case-images");if(!o)return;const a=o.querySelectorAll("img");let r=!0;if(a.forEach(e=>{e.complete&&e.naturalHeight||(r=!1)}),!r)return;let s=0;a.forEach(e=>{const t=e.naturalHeight/e.naturalWidth;t>s&&(s=t)}),o.querySelectorAll(".brag-book-gallery-image-container").forEach(e=>{e.style.paddingBottom=100*s+"%"})},window.loadCaseDetails=function(e,t,o,a){window.loadCaseDetailsWithName(e,t,o,"",a)},window.loadCaseDetailsWithName=function(e,t,o,a,r){const s=document.getElementById("gallery-content");if(!s)return void console.error("Gallery content container not found");if(!r){const t=document.querySelector(`.brag-book-gallery-case-card[data-case-id="${e}"]`);t&&t.dataset.procedureIds&&(r=t.dataset.procedureIds,console.log("Got procedure IDs from case card:",r))}if(s.innerHTML='<div class="brag-book-gallery-loading">Loading case details...</div>',o&&window.history&&window.history.pushState){const a=document.querySelector(".brag-book-gallery-wrapper");let r=a?.dataset.baseUrl||window.location.pathname;if(r=r.replace(/\/[^\/]+\/\d+\/?$/,""),r=r.replace(/\/[^\/]+\/?$/,""),r=r.replace(/\/$/,""),!r||""===r){const e=window.location.pathname.split("/").filter(e=>e);r=e.length>0?"/"+e[0]:""}const s=`${r}/${o}/${e}`;window.history.pushState({caseId:e,procedureId:t,procedureSlug:o},"",s)}const i={action:"load_case_details",case_id:e,nonce:bragBookGalleryConfig.nonce};t&&(i.procedure_id=t),o&&(i.procedure_slug=o),a&&(i.procedure_name=a),r&&(i.procedure_ids=r),fetch(bragBookGalleryConfig.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(i)}).then(e=>e.json()).then(e=>{if(e.success){s.innerHTML=e.data.html;const t=document.querySelector(".brag-book-gallery-wrapper");t?t.scrollIntoView({behavior:"smooth",block:"start"}):s.scrollIntoView({behavior:"smooth",block:"start"})}else s.innerHTML='<div class="brag-book-gallery-error">Failed to load case details: '+(e.data||"Unknown error")+"</div>"}).catch(e=>{console.error("Error loading case details:",e),s.innerHTML='<div class="brag-book-gallery-error">Error loading case details. Please try again.</div>'})},window.loadMoreCases=function(e){e.disabled=!0;const t=e.textContent;e.textContent="Loading...";const o=e.getAttribute("data-start-page"),a=e.getAttribute("data-procedure-ids"),r=e.getAttribute("data-procedure-name")||"";let s=!1;const i=document.querySelector(".brag-book-gallery-nav-link.brag-book-gallery-active");i&&"true"===i.dataset.nudity&&(s=!0);const n=document.querySelectorAll("[data-case-id]"),l=Array.from(n).map(e=>e.getAttribute("data-case-id")).filter(Boolean);console.log("Currently loaded case IDs:",l.length,"cases");const c=window.bragBookGalleryConfig?.nonce||"",d=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",g=new FormData;g.append("action","brag_book_load_more_cases"),g.append("nonce",c),g.append("start_page",o),g.append("procedure_ids",a),g.append("procedure_name",r),g.append("has_nudity",s?"1":"0"),g.append("loaded_ids",l.join(",")),fetch(d,{method:"POST",body:g}).then(e=>e.json()).then(a=>{if(console.log("Load More Response:",a),a.success){let r=document.querySelector(".brag-book-gallery-case-grid");if(r||(r=document.querySelector(".brag-book-gallery-cases-container")),r||(r=document.querySelector(".brag-book-gallery-case-grid .brag-book-gallery-cases-container")),r)if(console.log("Adding HTML to container. HTML length:",a.data.html?a.data.html.length:0),console.log("Debug info:",a.data.debug),a.data.html){const e=r.querySelector(".brag-book-gallery-case-card:last-child");e?e.insertAdjacentHTML("afterend",a.data.html):r.insertAdjacentHTML("beforeend",a.data.html),console.log("Cases in container after insert:",r.querySelectorAll("[data-case-id]").length)}else console.error("No HTML received from server");else console.error("Container not found (.brag-book-gallery-case-grid, .brag-book-gallery-cases-container, or .brag-book-gallery-case-grid .brag-book-gallery-cases-container)");const s=a.data.casesLoaded||0;if(a.data.hasMore&&s>0)e.setAttribute("data-start-page",parseInt(o)+1),e.disabled=!1,e.textContent=t;else{console.log("Hiding load more button - hasMore:",a.data.hasMore,"newCasesLoaded:",s);const t=e.closest(".brag-book-gallery-load-more-container")||e.parentElement;t&&(t.style.display="none")}if(r){const e=document.querySelector(".brag-book-gallery-favorite-count-label")||document.querySelector(".cases-count")||document.querySelector('[class*="count-label"]');if(e){const t=r.querySelectorAll(".brag-book-gallery-case-card").length,o=e.textContent.match(/(\d+) of (\d+)/);if(o){const a=o[2];e.textContent="Showing "+t+" of "+a}}}}else console.error("Failed to load more cases:",a.data?a.data.message:"Unknown error"),e.disabled=!1,e.textContent=t,alert("Failed to load more cases. Please try again.")}).catch(o=>{console.error("Error loading more cases:",o),e.disabled=!1,e.textContent=t,alert("Error loading more cases. Please check your connection and try again.")})},window.bragBookSetImageAspectRatio=function(e){const t=e.naturalWidth,o=e.naturalHeight;if(t&&o){const a=t+"/"+o,r=e.closest(".brag-book-gallery-image-container, .brag-book-gallery-thumb-image");r&&(r.style.aspectRatio=a,r.style.width="100%",r.style.height="auto",r.style.minHeight="auto",r.style.maxHeight="none",e.style.width="100%",e.style.height="100%",e.style.objectFit="contain",r.removeAttribute("data-image-loading"))}},window.initInfiniteScroll=function(){if("yes"!==window.bragBookGalleryConfig?.infiniteScroll)return;let e,t=!1;const o=()=>{clearTimeout(e),e=setTimeout(()=>{if(t)return;const e=document.querySelector('[data-action="load-more"]');if(!e||e.disabled||"none"===e.style.display)return;const o=e.closest(".brag-book-gallery-load-more-container");o&&"none"===o.style.display||window.innerHeight+window.scrollY>=document.documentElement.offsetHeight-800&&(t=!0,e.click(),setTimeout(()=>{t=!1},1e3))},100)};window.addEventListener("scroll",o,{passive:!0}),window.addEventListener("resize",o,{passive:!0}),window.infiniteScrollHandler=o},document.addEventListener("DOMContentLoaded",()=>{new n,d=new l,g=new c;const e=document.querySelector(".brag-book-gallery-case-grid");if(e&&(setTimeout(()=>{e.classList.add("grid-initialized")},1e3),window.innerWidth>=1024)){const t=localStorage.getItem("bragbook-grid-columns");if(t){const o=parseInt(t);e.setAttribute("data-columns",o),document.querySelectorAll(".brag-book-gallery-grid-btn").forEach(e=>{parseInt(e.dataset.columns)===o?e.classList.add("active"):e.classList.remove("active")})}else e.setAttribute("data-columns","3")}initInfiniteScroll()}),document.addEventListener("DOMContentLoaded",function(){setTimeout(function(){!window.bragBookCompleteDataset&&window.bragBookGalleryConfig&&window.bragBookGalleryConfig.completeDataset&&(window.bragBookCompleteDataset=window.bragBookGalleryConfig.completeDataset,console.log("Initialized bragBookCompleteDataset with",window.bragBookCompleteDataset.length,"cases")),initializeProcedureFilters();const e=document.querySelector(".brag-book-gallery-wrapper");if(e&&e.dataset.initialCaseId){const t=e.dataset.initialCaseId,o=window.location.pathname.split("/").filter(e=>e),a=o.length>2?o[o.length-2]:"";let r="";const s=document.querySelector(`.brag-book-gallery-nav-link[data-procedure="${a}"]`);if(s){const e=s.querySelector(".brag-book-gallery-filter-option-label");e&&(r=e.textContent.trim())}if(!r&&window.bragBookGalleryConfig&&window.bragBookGalleryConfig.sidebarData){const e=window.bragBookGalleryConfig.sidebarData;for(const t of Object.values(e)){if(t.procedures)for(const e of t.procedures)if(e.slug===a){r=e.name;break}if(r)break}}let i="";setTimeout(()=>{const e=document.querySelector(`.brag-book-gallery-case-card[data-case-id="${t}"]`);e&&e.dataset.procedureIds&&(i=e.dataset.procedureIds),console.log("Auto-loading case on page load:",t,"for procedure:",a,"with name:",r,"and IDs:",i),window.loadCaseDetailsWithName(t,"",a,r,i)},200)}},100)}),document.addEventListener("toggle",function(e){if("procedure-filters-details"===e.target.id){const t=e.target;t.open&&!t.dataset.initialized&&(generateProcedureFilterOptions(),t.dataset.initialized="true")}}),document.addEventListener("click",function(e){const t=document.getElementById("procedure-filters-details"),o=document.querySelector(".brag-book-gallery-filter-dropdown__panel");t&&t.open&&o&&(t.contains(e.target)||o.contains(e.target)||(t.open=!1))}),console.log("BRAG Book Gallery modules loaded successfully")}();