!function(){class e{constructor(e,t={}){this.wrapper=e,this.content=e.querySelector(".brag-book-gallery-carousel-content"),this.track=e.querySelector(".brag-book-gallery-carousel-track"),this.prevBtn=e.querySelector('[data-direction="prev"]'),this.nextBtn=e.querySelector('[data-direction="next"]'),this.paginationContainer=e.querySelector(".brag-book-gallery-carousel-pagination"),this.options={itemsPerView:t.itemsPerView||this.getItemsPerView(),gap:t.gap||16,animationDuration:t.animationDuration||.4,slideSelector:t.slideSelector||".brag-book-gallery-carousel-item",infinite:!1!==t.infinite,autoplay:t.autoplay||!1,autoplayDelay:t.autoplayDelay||3e3,pauseOnHover:!1!==t.pauseOnHover,...t},this.isDown=!1,this.startX=0,this.scrollLeft=0,this.currentSlide=0,this.autoplayTimer=null,this.isPaused=!1,this.track&&this.init()}init(){this.createLiveRegion(),this.addShareButtons(),this.setupEventListeners(),this.initializePagination(),this.updateCarouselButtons(),this.updateAriaLabels(),this.options.autoplay&&this.startAutoplay()}addShareButtons(){this.track.querySelectorAll(this.options.slideSelector).forEach((e,t)=>{if(!e.querySelector(".brag-book-gallery-carousel-image, img")){const t="https://bragbookgallery.com/nitropack_static/FCmixFCiYNkGgqjxyaUSblqHbCgLrqyJ/assets/images/optimized/rev-407fb37/ngnqwvuungodwrpnrczq.supabase.co/storage/v1/object/sign/brag-photos/org_2vm5nGWtoCYuaQBCP587ez6cYXF/c68b56b086f4f8eef8292f3f23320f1b.Blepharoplasty%20-%20aa239d58-badc-4ded-a26b-f89c2dd059b6.jpg",o=e.querySelector("span");o&&o.remove();const a=e.dataset.caseId;if(a&&""!==a){const o=e.dataset.procedureSlug||"procedure",s=`${window.location.pathname.replace(/\/[^\/]+\/[^\/]+\/?$/,"")}/${o}/${a}`.replace(/\/+/g,"/"),i=document.createElement("a");i.href=s,i.className="brag-book-gallery-case-link",i.dataset.caseId=a;const r=document.createElement("img");r.src=t,r.alt="Before and after result",r.className="brag-book-gallery-carousel-image",r.loading="lazy",i.appendChild(r),e.insertBefore(i,e.firstChild)}else{const o=document.createElement("img");o.src=t,o.alt="Before and after result",o.className="brag-book-gallery-carousel-image",o.loading="lazy",e.insertBefore(o,e.firstChild)}}let o=e.querySelector(".brag-book-gallery-item-actions");if(o||(o=document.createElement("div"),o.className="brag-book-gallery-item-actions",e.appendChild(o)),!o.querySelector(".brag-book-gallery-heart-btn")){const t=e.querySelector(".brag-book-gallery-heart-btn");if(t)o.appendChild(t);else{const t=document.createElement("button");t.className="brag-book-gallery-heart-btn",t.dataset.favorited="false",t.dataset.itemId=e.dataset.slide,t.setAttribute("aria-label","Add to favorites"),t.innerHTML='\n                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>\n                        </svg>\n                    ',o.appendChild(t)}}if(!o.querySelector(".brag-book-gallery-share-btn")&&"undefined"!=typeof bragBookGalleryConfig&&"yes"===bragBookGalleryConfig.enableSharing){const t=document.createElement("button");t.className="brag-book-gallery-share-btn",t.dataset.itemId=e.dataset.slide,t.setAttribute("aria-label","Share this image"),t.innerHTML='\n                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">\n                        <path d="M672.22-100q-44.91 0-76.26-31.41-31.34-31.41-31.34-76.28 0-6 4.15-29.16L284.31-404.31q-14.46 15-34.36 23.5t-42.64 8.5q-44.71 0-76.01-31.54Q100-435.39 100-480q0-44.61 31.3-76.15 31.3-31.54 76.01-31.54 22.74 0 42.64 8.5 19.9 8.5 34.36 23.5l284.46-167.08q-2.38-7.38-3.27-14.46-.88-7.08-.88-15.08 0-44.87 31.43-76.28Q627.49-860 672.4-860t76.25 31.44Q780-797.13 780-752.22q0 44.91-31.41 76.26-31.41 31.34-76.28 31.34-22.85 0-42.5-8.69Q610.15-662 595.69-677L311.23-509.54q2.38 7.39 3.27 14.46.88 7.08.88 15.08t-.88 15.08q-.89 7.07-3.27 14.46L595.69-283q14.46-15 34.12-23.69 19.65-8.69 42.5-8.69 44.87 0 76.28 31.43Q780-252.51 780-207.6t-31.44 76.25Q717.13-100 672.22-100Zm.09-60q20.27 0 33.98-13.71Q720-187.42 720-207.69q0-20.27-13.71-33.98-13.71-13.72-33.98-13.72-20.27 0-33.98 13.72-13.72 13.71-13.72 33.98 0 20.27 13.72 33.98Q652.04-160 672.31-160Zm-465-272.31q20.43 0 34.25-13.71 13.83-13.71 13.83-33.98 0-20.27-13.83-33.98-13.82-13.71-34.25-13.71-20.11 0-33.71 13.71Q160-500.27 160-480q0 20.27 13.6 33.98 13.6 13.71 33.71 13.71Zm465-272.3q20.27 0 33.98-13.72Q720-732.04 720-752.31q0-20.27-13.71-33.98Q692.58-800 672.31-800q-20.27 0-33.98 13.71-13.72 13.71-13.72 33.98 0 20.27 13.72 33.98 13.71 13.72 33.98 13.72Zm0 496.92ZM207.69-480Zm464.62-272.31Z"/>\n                    </svg>\n                ',o.appendChild(t)}})}createLiveRegion(){this.liveRegion=document.createElement("div"),this.liveRegion.setAttribute("aria-live","polite"),this.liveRegion.setAttribute("aria-atomic","true"),this.liveRegion.className="sr-only",this.liveRegion.style.position="absolute",this.liveRegion.style.width="1px",this.liveRegion.style.height="1px",this.liveRegion.style.padding="0",this.liveRegion.style.margin="-1px",this.liveRegion.style.overflow="hidden",this.liveRegion.style.clip="rect(0, 0, 0, 0)",this.liveRegion.style.whiteSpace="nowrap",this.liveRegion.style.border="0",this.wrapper.appendChild(this.liveRegion)}setupEventListeners(){this.track.addEventListener("scroll",()=>{this.updateCarouselButtons(),this.updatePagination()}),this.prevBtn&&this.prevBtn.addEventListener("click",()=>{this.navigate("prev"),this.options.autoplay&&(this.stopAutoplay(),this.startAutoplay())}),this.nextBtn&&this.nextBtn.addEventListener("click",()=>{this.navigate("next"),this.options.autoplay&&(this.stopAutoplay(),this.startAutoplay())}),this.track.addEventListener("mousedown",e=>this.handleMouseDown(e)),this.track.addEventListener("mouseleave",()=>this.handleMouseLeave()),this.track.addEventListener("mouseup",()=>this.handleMouseUp()),this.track.addEventListener("mousemove",e=>this.handleMouseMove(e)),this.options.autoplay&&this.options.pauseOnHover&&(this.wrapper.addEventListener("mouseenter",()=>this.pauseAutoplay()),this.wrapper.addEventListener("mouseleave",()=>this.resumeAutoplay())),this.track.addEventListener("wheel",e=>this.handleWheel(e),{passive:!1}),this.track.addEventListener("keydown",e=>this.handleKeydown(e)),this.wrapper.addEventListener("keydown",e=>this.handleKeydown(e)),document.addEventListener("keydown",e=>{this.wrapper.contains(document.activeElement)&&this.handleKeydown(e)}),this.track.tabIndex=0,this.track.setAttribute("aria-label","Use arrow keys to navigate through slides"),this.setupSlideFocusManagement()}handleMouseDown(e){this.isDown=!0,this.track.classList.add("brag-book-gallery-grabbing"),this.startX=e.pageX-this.track.offsetLeft,this.scrollLeft=this.track.scrollLeft}handleMouseLeave(){this.isDown=!1,this.track.classList.remove("brag-book-gallery-grabbing")}handleMouseUp(){this.isDown=!1,this.track.classList.remove("brag-book-gallery-grabbing")}handleMouseMove(e){if(!this.isDown)return;e.preventDefault();const t=2*(e.pageX-this.track.offsetLeft-this.startX);this.track.scrollLeft=this.scrollLeft-t}handleKeydown(e){if("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName)return;const t=this.track.querySelectorAll(this.options.slideSelector);if(0===t.length)return;const o=this.getCurrentSlideIndex();let a=!1;switch(e.key){case"ArrowLeft":e.preventDefault(),e.stopPropagation(),this.navigateToSlide(Math.max(0,o-1)),a=!0;break;case"ArrowRight":e.preventDefault(),e.stopPropagation(),this.navigateToSlide(Math.min(t.length-1,o+1)),a=!0;break;case"Home":e.preventDefault(),e.stopPropagation(),this.navigateToSlide(0),a=!0;break;case"End":e.preventDefault(),e.stopPropagation(),this.navigateToSlide(t.length-1),a=!0;break;case"PageUp":e.preventDefault(),e.stopPropagation();const s=this.getItemsPerView();this.navigateToSlide(Math.max(0,o-s)),a=!0;break;case"PageDown":e.preventDefault(),e.stopPropagation();const i=this.getItemsPerView();this.navigateToSlide(Math.min(t.length-1,o+i)),a=!0}a&&document.activeElement!==this.track&&!this.track.contains(document.activeElement)&&this.track.focus(),a&&this.options.autoplay&&(this.stopAutoplay(),this.startAutoplay())}handleWheel(e){e.preventDefault();const t=e.deltaY||e.deltaX,o=Math.abs(t)>50?t:3*t;this.wheelTimeout&&clearTimeout(this.wheelTimeout),this.track.scrollBy({left:o,behavior:"smooth"}),this.wheelTimeout=setTimeout(()=>{this.updateCarouselButtons(),this.updatePagination()},150)}getItemsPerView(){const e=window.innerWidth;return e<=480?1:e<=1024?2:3}navigate(e){const t=this.track.querySelectorAll(this.options.slideSelector);if(0===t.length)return;const o=this.getCurrentSlideIndex();let a;a=this.options.infinite?"next"===e?o>=t.length-1?0:o+1:o<=0?t.length-1:o-1:"next"===e?Math.min(t.length-1,o+1):Math.max(0,o-1),this.navigateToSlide(a)}navigateToSlide(e){const t=this.track.querySelectorAll(this.options.slideSelector);if(0===t.length||e<0||e>=t.length)return;const o=t[e],a=o.offsetWidth,s=this.track.offsetWidth;let i=o.offsetLeft-(s-a)/2;i=Math.max(0,Math.min(i,this.track.scrollWidth-s)),"undefined"!=typeof gsap?gsap.to(this.track,{scrollLeft:i,duration:this.options.animationDuration,ease:"power2.inOut",onComplete:()=>{this.updateAriaLabels(),this.focusSlide(e)}}):(this.track.scrollTo({left:i,behavior:"smooth"}),setTimeout(()=>{this.updateAriaLabels(),this.focusSlide(e)},300)),this.currentSlide=e}getCurrentSlideIndex(){const e=this.track.querySelectorAll(this.options.slideSelector),t=this.track.scrollLeft+this.track.offsetWidth/2;let o=0,a=1/0;return e.forEach((e,s)=>{const i=e.offsetLeft+e.offsetWidth/2,r=Math.abs(i-t);r<a&&(a=r,o=s)}),o}startAutoplay(){this.options.autoplay&&!this.autoplayTimer&&(this.autoplayTimer=setInterval(()=>{this.isPaused||this.isDown||this.navigate("next")},this.options.autoplayDelay))}stopAutoplay(){this.autoplayTimer&&(clearInterval(this.autoplayTimer),this.autoplayTimer=null)}pauseAutoplay(){this.isPaused=!0}resumeAutoplay(){this.isPaused=!1}setupSlideFocusManagement(){this.track.querySelectorAll(this.options.slideSelector).forEach((e,t)=>{e.tabIndex=-1,e.addEventListener("focus",()=>{this.currentSlide=t}),e.addEventListener("click",t=>{t.target.closest("button")||e.focus()})}),this.wrapper.tabIndex=-1,this.wrapper.style.outline="none",this.wrapper.addEventListener("click",e=>{e.target.closest("button")||e.target.closest("[tabindex]")||this.track.focus()})}focusSlide(e){const t=this.track.querySelectorAll(this.options.slideSelector);t[e]&&document.activeElement===this.track&&t[e].focus()}initializePagination(){if(!this.paginationContainer)return;this.paginationContainer.innerHTML="";const e=this.track.querySelectorAll(this.options.slideSelector),t=this.getItemsPerView(),o=Math.ceil(e.length/t);for(let e=0;e<o;e++){const t=document.createElement("button");t.className="brag-book-gallery-pagination-dot",t.role="tab",0===e?(t.classList.add("brag-book-gallery-active"),t.setAttribute("aria-selected","true")):t.setAttribute("aria-selected","false"),t.setAttribute("data-page",e),t.setAttribute("aria-label",`Go to slide group ${e+1}`),t.addEventListener("click",()=>this.goToPage(e)),this.paginationContainer.appendChild(t)}}goToPage(e){const t=this.track.querySelectorAll(this.options.slideSelector);if(0===t.length)return;const o=t[0].offsetWidth,a=this.getItemsPerView(),s=e*a*(o+this.options.gap);this.currentSlide=e*a,"undefined"!=typeof gsap?gsap.to(this.track,{scrollLeft:s,duration:.5,ease:"power2.inOut",onComplete:()=>this.updateAriaLabels()}):(this.track.scrollLeft=s,this.updateAriaLabels())}updatePagination(){if(!this.paginationContainer)return;const e=this.track.querySelectorAll(this.options.slideSelector);if(0===e.length)return;const t=e[0].offsetWidth,o=this.getItemsPerView(),a=this.track.scrollLeft,s=Math.round(a/((t+this.options.gap)*o));this.currentSlide=s*o,this.paginationContainer.querySelectorAll(".brag-book-gallery-pagination-dot").forEach((e,t)=>{t===s?(e.classList.add("brag-book-gallery-active"),e.setAttribute("aria-selected","true")):(e.classList.remove("brag-book-gallery-active"),e.setAttribute("aria-selected","false"))})}updateCarouselButtons(){if(this.options.infinite)return this.prevBtn&&(this.prevBtn.disabled=!1),void(this.nextBtn&&(this.nextBtn.disabled=!1));const e=this.track.scrollLeft,t=this.track.scrollWidth,o=this.track.clientWidth;this.prevBtn&&(this.prevBtn.disabled=e<=0),this.nextBtn&&(this.nextBtn.disabled=e>=t-o-1)}updateAriaLabels(){const e=this.track.querySelectorAll(this.options.slideSelector),t=e.length,o=this.getCurrentSlideIndex();e.forEach((e,a)=>{const s=a+1,i=a===o;e.setAttribute("aria-label",`Slide ${s} of ${t}${i?" (current)":""}`),e.setAttribute("aria-current",i?"true":"false")}),this.liveRegion&&(this.liveRegion.textContent=`Slide ${o+1} of ${t}`)}refresh(){this.options.itemsPerView=this.getItemsPerView(),this.initializePagination(),this.updatePagination(),this.updateAriaLabels()}goToSlide(e){const t=this.track.querySelectorAll(this.options.slideSelector),o=Array.from(t).find(t=>t.dataset.slide===e);if(o){const e=Array.from(t).indexOf(o),a=this.getItemsPerView(),s=Math.floor(e/a);this.goToPage(s)}}}class t{constructor(e,t={}){this.dialog=document.getElementById(e),this.backdrop=document.getElementById(t.backdropId||"dialogBackdrop"),this.closeButtons=this.dialog?.querySelectorAll('[data-action*="close"]'),this.options={closeOnBackdrop:!1!==t.closeOnBackdrop,closeOnEscape:!1!==t.closeOnEscape,animateWithGsap:"undefined"!=typeof gsap,onOpen:t.onOpen||(()=>{}),onClose:t.onClose||(()=>{}),...t},this.dialog&&this.init()}init(){this.checkDialogSupport(),this.setupEventListeners()}checkDialogSupport(){document.createElement("dialog").showModal||(console.log("Dialog element not fully supported, using polyfill"),HTMLDialogElement.prototype.showModal||(HTMLDialogElement.prototype.showModal=function(){this.setAttribute("open",""),this.style.display="block"}),HTMLDialogElement.prototype.close||(HTMLDialogElement.prototype.close=function(){this.removeAttribute("open"),this.style.display="none"}))}setupEventListeners(){this.closeButtons?.forEach(e=>{e.addEventListener("click",()=>this.close())}),this.options.closeOnBackdrop&&(this.dialog?.addEventListener("click",e=>{e.target===this.dialog&&this.close()}),this.backdrop?.addEventListener("click",()=>this.close())),this.options.closeOnEscape&&document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isOpen()&&this.close()})}open(){if(this.dialog){console.log("Opening dialog..."),this.backdrop&&this.backdrop.classList.add("active");try{"function"==typeof this.dialog.showModal?this.dialog.showModal():(this.dialog.setAttribute("open",""),this.dialog.style.display="block")}catch(e){this.dialog.setAttribute("open",""),this.dialog.style.display="block"}this.options.animateWithGsap&&"undefined"!=typeof gsap&&gsap.from(this.dialog,{scale:.9,opacity:0,duration:.3,ease:"back.out(1.7)"}),document.body.style.overflow="hidden",this.options.onOpen()}}close(){if(!this.dialog)return;console.log("Closing dialog...");const e=()=>{try{"function"==typeof this.dialog.close?this.dialog.close():(this.dialog.removeAttribute("open"),this.dialog.style.display="none")}catch(e){this.dialog.removeAttribute("open"),this.dialog.style.display="none"}this.backdrop&&this.backdrop.classList.remove("active"),document.body.style.overflow="",this.options.animateWithGsap&&"undefined"!=typeof gsap&&gsap.set(this.dialog,{scale:1,opacity:1}),this.options.onClose()};this.options.animateWithGsap&&"undefined"!=typeof gsap?gsap.to(this.dialog,{scale:.9,opacity:0,duration:.2,ease:"power2.in",onComplete:e}):e()}isOpen(){return this.dialog?.open||this.dialog?.hasAttribute("open")}}class o{constructor(e,t={}){this.container=e,this.filterHeaders=e?.querySelectorAll(".brag-book-gallery-filter-header"),this.activeFilters=new Map,this.categories=new Map,this.procedures=new Map,this.options={mode:t.mode||"javascript",baseUrl:t.baseUrl||"/gallery",animateWithGsap:"undefined"!=typeof gsap,closeOthersOnOpen:!1!==t.closeOthersOnOpen,onFilterChange:t.onFilterChange||(()=>{}),onNavigate:t.onNavigate||(e=>{window.location.href=e}),...t},this.container&&this.init()}init(){this.indexFilters(),this.setupEventListeners(),this.loadStateFromUrl(),this.options.animateWithGsap&&"undefined"!=typeof gsap&&gsap.set(".brag-book-gallery-filter-content",{height:0})}indexFilters(){const e=this.container?.querySelectorAll("[data-category]");e?.forEach(e=>{const t=e.dataset.category;this.categories.has(t)||this.categories.set(t,{name:t,procedures:new Set,element:e}),e.querySelectorAll(".brag-book-gallery-filter-link").forEach(e=>{const t=e.dataset.procedure,o=e.dataset.category;if(t&&o){const a={id:t,category:o,count:parseInt(e.dataset.procedureCount||"0"),element:e.parentElement,link:e};this.procedures.set(`${o}:${t}`,a),this.categories.get(o).procedures.add(t)}})})}setupEventListeners(){this.filterHeaders?.forEach(e=>{e.addEventListener("click",()=>this.toggleFilter(e))});const e=this.container?.querySelectorAll(".brag-book-gallery-filter-link");e?.forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),this.handleFilterClick(e.currentTarget)})}),window.addEventListener("popstate",e=>{e.state&&e.state.caseId?window.loadCaseDetails(e.state.caseId,e.state.procedureId,e.state.procedureSlug):e.state&&e.state.category&&e.state.procedure?(this.reactivateFilter(e.state.category,e.state.procedure),this.loadFilteredContent(e.state.category,e.state.procedure,e.state.procedureIds,e.state.hasNudity||!1)):(this.clearAll(),window.location.reload())})}toggleFilter(e){const t="true"===e.dataset.expanded,o=e.nextElementSibling,a=e.closest(".brag-book-gallery-filter-group");!t&&this.options.closeOthersOnOpen&&this.closeOtherFilters(e),e.dataset.expanded=!t,o.dataset.expanded=!t,a.dataset.expanded=!t,this.options.animateWithGsap&&"undefined"!=typeof gsap?t?gsap.to(o,{height:0,opacity:0,duration:.3,ease:"power2.in"}):gsap.to(o,{height:"auto",opacity:1,duration:.4,ease:"power2.out"}):(o.style.height=t?"0":"auto",o.style.opacity=t?"0":"1")}closeOtherFilters(e){this.filterHeaders?.forEach(t=>{if(t!==e&&"true"===t.dataset.expanded){const e=t.nextElementSibling,o=t.closest(".brag-book-gallery-filter-group");t.dataset.expanded="false",e.dataset.expanded="false",o.dataset.expanded="false",this.options.animateWithGsap&&"undefined"!=typeof gsap?gsap.to(e,{height:0,opacity:0,duration:.3,ease:"power2.in"}):(e.style.height="0",e.style.opacity="0")}})}closeAllFilters(){this.filterHeaders?.forEach(e=>{"true"===e.dataset.expanded&&this.toggleFilter(e)})}handleFilterClick(e){const t=e.dataset.category,o=e.dataset.procedure,a=e.dataset.procedureIds,s=parseInt(e.dataset.procedureCount||"0"),i="true"===e.dataset.nudity;this.activeFilters.clear(),this.container?.querySelectorAll(".brag-book-gallery-filter-link").forEach(e=>{e.classList.remove("brag-book-gallery-active")}),e.classList.add("brag-book-gallery-active");const r=e.closest(".brag-book-gallery-filter-item");r&&r.classList.add("brag-book-gallery-active"),this.activeFilters.set(`${t}:${o}`,{category:t,procedure:o,procedureIds:a,count:s,hasNudity:i});const n=document.querySelector(".brag-book-gallery-wrapper");let l=n?.dataset.baseUrl||window.location.pathname;!n?.dataset.baseUrl&&l.match(/\/[^\/]+\/?$/)&&(l=l.replace(/\/[^\/]+\/?$/,""));const c=`${l}/${o}`.replace(/\/+/g,"/");window.history.pushState({category:t,procedure:o,procedureIds:a,basePath:l,hasNudity:i},"",c),this.loadFilteredContent(t,o,a,i),this.options.animateWithGsap&&"undefined"!=typeof gsap&&gsap.to(e,{scale:1.02,duration:.1,yoyo:!0,repeat:1,ease:"power2.inOut"})}navigateToFilteredPage(){if(this.activeFilters.size>0){const e=`/${Array.from(this.activeFilters.values())[0].procedure}`;this.options.onNavigate(e)}else this.options.onNavigate(this.options.baseUrl)}updateUrlState(){if(window.history&&window.history.replaceState){const e=new URLSearchParams,t=new Map;this.activeFilters.forEach(e=>{t.has(e.category)||t.set(e.category,[]),t.get(e.category).push(e.procedure)}),t.forEach((t,o)=>{e.append(o,t.join(","))});const o=e.toString()?`?${e.toString()}`:window.location.pathname;window.history.replaceState({},"",o)}}reactivateFilter(e,t){this.activeFilters.clear(),this.container?.querySelectorAll(".brag-book-gallery-filter-link").forEach(e=>{e.classList.remove("brag-book-gallery-active")});const o=document.querySelector(`.brag-book-gallery-filter-link[data-procedure="${t}"]`);o&&(o.classList.add("brag-book-gallery-active"),this.activeFilters.set(`${e}:${t}`,{category:e,procedure:t,procedureIds:o.dataset.procedureIds,count:parseInt(o.dataset.procedureCount||"0")}))}loadStateFromUrl(){const e=document.querySelector(".brag-book-gallery-wrapper"),t=e?.dataset.baseUrl||"",o=e?.dataset.initialProcedure;if(o){const e=document.querySelector(`.brag-book-gallery-filter-link[data-procedure="${o}"]`);if(e){const t=e.dataset.category||"",a="true"===e.dataset.nudity;return this.reactivateFilter(t,o),void this.loadFilteredContent(t,o,e.dataset.procedureIds,a)}}const a=window.location.pathname;let s=a;t&&a.startsWith(t)&&(s=a.substring(t.length));const i=s.match(/^\/([^\/]+)\/(\d+)\/?$/);if(i){const[,e,t]=i;return}const r=s.match(/^\/([^\/]+)\/?$/);if(r){const[,e]=r,t=document.querySelector(`.brag-book-gallery-filter-link[data-procedure="${e}"]`);if(t){const o=t.dataset.category||"",a="true"===t.dataset.nudity;this.reactivateFilter(o,e),this.loadFilteredContent(o,e,t.dataset.procedureIds,a)}}}getActiveFilters(){return this.activeFilters}getFiltersByCategory(e){const t=[];return this.activeFilters.forEach(o=>{o.category===e&&t.push(o)}),t}getFiltersByProcedure(e){const t=[];return this.activeFilters.forEach(o=>{o.procedure===e&&t.push(o)}),t}clearCategory(e){const t=[];this.activeFilters.forEach((o,a)=>{o.category===e&&t.push(a)}),t.forEach(e=>{const t=this.procedures.get(e);t&&t.link&&t.link.classList.remove("brag-book-gallery-active")}),t.forEach(e=>this.activeFilters.delete(e))}clearAll(){const e=this.container?.querySelectorAll(".brag-book-gallery-filter-link");e?.forEach(e=>{e.classList.remove("brag-book-gallery-active")}),this.activeFilters.clear(),window.history.pushState({},"",window.location.pathname)}setMode(e){this.options.mode=e}loadFilteredContent(t,o,a,s=!1){const i=document.getElementById("gallery-content");if(!i)return;i.innerHTML='<div class="brag-book-gallery-loading">Loading filtered results...</div>';const r=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",n=window.bragBookGalleryConfig?.nonce||"",l=new FormData;l.append("action","brag_book_load_filtered_gallery"),l.append("nonce",n),l.append("category_name",t),l.append("procedure_name",o),l.append("procedure_ids",a||""),l.append("procedure_id",a?.split(",")[0]||""),l.append("has_nudity",s?"1":"0"),fetch(r,{method:"POST",body:l}).then(e=>e.json()).then(t=>{t.success&&t.data?.html?(i.innerHTML=t.data.html,i.querySelectorAll(".brag-book-gallery-carousel-wrapper").forEach(t=>{new e(t)}),setTimeout(function(){initializeProcedureFilters()},100)):i.innerHTML='<div class="brag-book-gallery-error">No results found for the selected filter.</div>'}).catch(e=>{console.error("Filter loading error:",e),i.innerHTML='<div class="brag-book-gallery-error">Failed to load filtered content. Please try again.</div>'})}}class a{constructor(e={}){this.sidebar=document.querySelector(".brag-book-gallery-sidebar"),this.overlay=document.querySelector(".brag-book-gallery-mobile-overlay"),this.menuToggle=document.querySelector(".brag-book-gallery-mobile-menu-toggle"),this.closeButton=document.querySelector('[data-action="close-menu"]'),this.options={breakpoint:e.breakpoint||1024,swipeToClose:!1!==e.swipeToClose,...e},this.touchStartX=0,this.touchEndX=0,this.sidebar&&this.menuToggle&&this.init()}init(){let e;this.setupEventListeners(),this.checkMobileView(),window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{this.checkMobileView()},250)})}setupEventListeners(){this.menuToggle?.addEventListener("click",()=>this.toggle()),this.overlay?.addEventListener("click",()=>this.close()),this.closeButton?.addEventListener("click",()=>this.close()),this.options.swipeToClose&&this.setupSwipeGestures(),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isOpen()&&this.close()})}setupSwipeGestures(){this.sidebar?.addEventListener("touchstart",e=>{this.touchStartX=e.changedTouches[0].screenX},{passive:!0}),this.sidebar?.addEventListener("touchend",e=>{this.touchEndX=e.changedTouches[0].screenX,this.handleSwipeGesture()},{passive:!0})}handleSwipeGesture(){this.touchStartX-this.touchEndX>50&&this.isOpen()&&this.close()}checkMobileView(){const e=window.innerWidth<=this.options.breakpoint,t=document.querySelector(".brag-book-gallery-sidebar-header");t&&(t.style.display=e?"flex":"none"),e||this.close()}toggle(){this.isOpen()?this.close():this.open()}open(){if(!this.sidebar||!this.menuToggle)return;this.menuToggle.dataset.menuOpen="true",this.menuToggle.setAttribute("aria-expanded","true"),this.menuToggle.setAttribute("aria-label","Close navigation menu"),this.sidebar.classList.add("brag-book-gallery-active"),this.overlay?.classList.add("brag-book-gallery-active");const e=this.menuToggle.querySelector("svg");e&&"undefined"!=typeof gsap?(gsap.to(e,{rotation:180,duration:.3,ease:"power2.inOut"}),setTimeout(()=>{e.innerHTML='<path d="M256-213.85 213.85-256l224-224-224-224L256-746.15l224 224 224-224L746.15-704l-224 224 224 224L704-213.85l-224-224-224 224Z"/>'},150)):e&&(e.innerHTML='<path d="M256-213.85 213.85-256l224-224-224-224L256-746.15l224 224 224-224L746.15-704l-224 224 224 224L704-213.85l-224-224-224 224Z"/>'),document.body.style.overflow="hidden"}close(){if(!this.sidebar||!this.menuToggle)return;this.menuToggle.dataset.menuOpen="false",this.menuToggle.setAttribute("aria-expanded","false"),this.menuToggle.setAttribute("aria-label","Open navigation menu"),this.sidebar.classList.remove("brag-book-gallery-active"),this.overlay?.classList.remove("brag-book-gallery-active");const e=this.menuToggle.querySelector("svg");e&&"undefined"!=typeof gsap?(gsap.to(e,{rotation:0,duration:.3,ease:"power2.inOut"}),setTimeout(()=>{e.innerHTML='<path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"/>'},150)):e&&(e.innerHTML='<path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"/>'),document.body.style.overflow=""}isOpen(){return"true"===this.menuToggle?.dataset.menuOpen}}class s{constructor(e={}){this.favorites=new Set,this.userInfo=null,this.hasShownDialog=!1,this.options={storageKey:e.storageKey||"brag-book-favorites",userInfoKey:e.userInfoKey||"brag-book-user-info",persistToStorage:!1!==e.persistToStorage,onUpdate:e.onUpdate||(()=>{}),...e},this.init()}init(){this.favoritesDialog=new t("favoritesDialog",{backdropId:"dialogBackdrop",onClose:()=>{!this.userInfo&&this.lastAddedFavorite&&(this.removeFavorite(this.lastAddedFavorite),this.lastAddedFavorite=null)}}),this.options.persistToStorage&&(this.loadFromStorage(),this.loadUserInfo()),this.setupEventListeners(),this.updateUI()}setupEventListeners(){document.addEventListener("click",e=>{const t=e.target.closest("[data-favorited]");t&&(e.preventDefault(),this.toggleFavorite(t)),e.target.closest('[data-action="close-favorites-dialog"]')&&this.favoritesDialog.close()});const e=document.querySelector('[data-form="favorites"]');e&&e.addEventListener("submit",e=>{e.preventDefault(),this.handleFavoritesFormSubmit(e.target)})}toggleFavorite(e){const t=e.dataset.itemId;if("true"!==e.dataset.favorited)return this.userInfo||this.hasShownDialog?void this.addFavorite(t,e):(this.lastAddedFavorite=t,this.lastAddedButton=e,this.addFavorite(t,e),this.favoritesDialog.open(),void(this.hasShownDialog=!0));this.removeFavorite(t,e)}addFavorite(e,t){t.dataset.favorited="true",this.favorites.add(e),this.options.persistToStorage&&this.saveToStorage(),this.updateUI(),this.options.onUpdate(this.favorites)}removeFavorite(e,t){t||(t=document.querySelector(`[data-item-id="${e}"][data-favorited="true"]`)),t&&(t.dataset.favorited="false"),this.favorites.delete(e),this.options.persistToStorage&&this.saveToStorage(),this.updateUI(),this.options.onUpdate(this.favorites)}handleFavoritesFormSubmit(e){const t=new FormData(e),o=Object.fromEntries(t.entries());this.userInfo=o,this.options.persistToStorage&&this.saveUserInfo(),this.lastAddedFavorite&&this.lastAddedButton&&(this.addFavorite(this.lastAddedFavorite,this.lastAddedButton),this.lastAddedFavorite=null,this.lastAddedButton=null),this.favoritesDialog.close(),this.showSuccessNotification("Your information has been saved. Keep adding favorites!"),console.log("User info saved:",o)}showSuccessNotification(e){let t=document.getElementById("favoritesNotification");t||(t=document.createElement("div"),t.id="favoritesNotification",t.className="brag-book-gallery-favorites-notification",document.body.appendChild(t)),t.textContent=e,t.classList.add("active"),"undefined"!=typeof gsap&&gsap.fromTo(t,{y:-20,opacity:0},{y:0,opacity:1,duration:.3,ease:"back.out(1.7)"}),setTimeout(()=>{"undefined"!=typeof gsap?gsap.to(t,{y:-20,opacity:0,duration:.2,ease:"power2.in",onComplete:()=>{t.classList.remove("active")}}):t.classList.remove("active")},3e3)}updateFavoritesDisplay(){const e=document.getElementById("favorites-grid"),t=document.getElementById("favorites-empty");e&&t&&(e.innerHTML="",0===this.favorites.size?(e.style.display="none",t.style.display="block"):(e.style.display="grid",t.style.display="none",this.favorites.forEach(t=>{const o=document.querySelector(`[data-item-id="${t}"]`);if(!o)return;const a=o.closest(".brag-book-gallery-carousel-item");if(!a)return;const s=a.querySelector("img");if(!s)return;const i=document.createElement("div");i.className="brag-book-gallery-favorites-item",i.dataset.itemId=t;const r=s.cloneNode(!0);i.appendChild(r);const n=document.createElement("button");n.className="brag-book-gallery-favorites-item-remove",n.innerHTML="×",n.title="Remove from favorites",n.onclick=e=>{e.stopPropagation(),this.removeFavorite(t)},i.appendChild(n),e.appendChild(i)})))}updateUI(){const e=document.querySelector("[data-favorites-count]"),t=this.favorites.size;e&&("undefined"!=typeof gsap?gsap.to(e,{opacity:0,duration:.1,onComplete:()=>{e.textContent=`(${t})`,gsap.to(e,{opacity:1,duration:.1})}}):e.textContent=`(${t})`),this.updateFavoritesDisplay()}loadFromStorage(){try{const e=localStorage.getItem(this.options.storageKey);if(e){const t=JSON.parse(e);this.favorites=new Set(t),t.forEach(e=>{const t=document.querySelector(`[data-item-id="${e}"]`);t&&(t.dataset.favorited="true")})}}catch(e){console.error("Failed to load favorites from storage:",e)}}saveToStorage(){try{localStorage.setItem(this.options.storageKey,JSON.stringify([...this.favorites]))}catch(e){console.error("Failed to save favorites to storage:",e)}}loadUserInfo(){try{const e=localStorage.getItem(this.options.userInfoKey);e&&(this.userInfo=JSON.parse(e),this.hasShownDialog=!0)}catch(e){console.error("Failed to load user info from storage:",e)}}saveUserInfo(){try{localStorage.setItem(this.options.userInfoKey,JSON.stringify(this.userInfo))}catch(e){console.error("Failed to save user info to storage:",e)}}getFavorites(){return this.favorites}clear(){this.favorites.clear(),this.options.persistToStorage&&this.saveToStorage(),this.updateUI()}}class i{constructor(e={}){this.options={shareMenuId:e.shareMenuId||"shareMenu",animateWithGsap:"undefined"!=typeof gsap,onShare:e.onShare||(()=>{}),...e},this.shareMenu=document.getElementById(this.options.shareMenuId),this.activeButton=null,this.activeItem=null,this.init()}init(){this.setupEventListeners(),this.createShareMenu()}createShareMenu(){if(!this.shareMenu){const e=`\n                <div id="${this.options.shareMenuId}" class="brag-book-gallery-share-dropdown" role="menu">\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="link" role="menuitem">Copy Link</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="email" role="menuitem">Email</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="facebook" role="menuitem">Facebook</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="twitter" role="menuitem">Twitter</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="pinterest" role="menuitem">Pinterest</button>\n                    <button class="brag-book-gallery-share-dropdown-item" data-share-type="whatsapp" role="menuitem">WhatsApp</button>\n                </div>\n            `;document.body.insertAdjacentHTML("beforeend",e),this.shareMenu=document.getElementById(this.options.shareMenuId)}}setupEventListeners(){document.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-share-btn");t&&(e.preventDefault(),e.stopPropagation(),this.toggleShareDropdown(t));const o=e.target.closest(".brag-book-gallery-share-dropdown-item");if(o){e.preventDefault();const t=o.dataset.shareType;t&&(this.handleShare(t),this.hideShareDropdown())}!this.shareMenu?.classList.contains("active")||this.shareMenu.contains(e.target)||e.target.closest(".brag-book-gallery-share-btn")||this.hideShareDropdown()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.shareMenu?.classList.contains("active")&&this.hideShareDropdown()})}toggleShareDropdown(e){this.activeButton===e&&this.shareMenu?.classList.contains("active")?this.hideShareDropdown():this.showShareDropdown(e)}showShareDropdown(e){if(!this.shareMenu)return;this.activeItem=e.closest(".brag-book-gallery-carousel-item"),this.activeButton=e,e.classList.add("active");const t=e.getBoundingClientRect(),o=this.activeItem.getBoundingClientRect();let a=t.right-120,s=t.bottom+8;a<o.left&&(a=o.left+8),a+120>o.right&&(a=o.right-120-8),s+240>window.innerHeight-10&&(s=t.top-240-8),this.shareMenu.style.left=`${a}px`,this.shareMenu.style.top=`${s}px`,this.shareMenu.classList.add("active"),this.options.animateWithGsap&&"undefined"!=typeof gsap&&gsap.fromTo(this.shareMenu,{y:-10,opacity:0},{y:0,opacity:1,duration:.2,ease:"power2.out"})}hideShareDropdown(){this.shareMenu&&(this.activeButton&&this.activeButton.classList.remove("active"),this.options.animateWithGsap&&"undefined"!=typeof gsap?gsap.to(this.shareMenu,{y:-10,opacity:0,duration:.15,ease:"power2.in",onComplete:()=>{this.shareMenu.classList.remove("active"),this.activeButton=null,this.activeItem=null}}):(this.shareMenu.classList.remove("active"),this.activeButton=null,this.activeItem=null))}handleShare(e){if(!this.activeItem)return;const t=this.activeItem.querySelector("img"),o=t?.src||"",a=t?.alt||"Medical procedure result",s=this.activeItem.dataset.slide||"",i=`${window.location.origin+window.location.pathname}#${s}`,r=`Check out this ${a}`;switch(e){case"link":this.copyToClipboard(i);break;case"email":this.shareViaEmail(i,r);break;case"facebook":this.shareViaFacebook(i);break;case"twitter":this.shareViaTwitter(i,r);break;case"pinterest":this.shareViaPinterest(i,o,r);break;case"whatsapp":this.shareViaWhatsApp(i,r)}this.options.onShare({type:e,url:i,text:r})}copyToClipboard(e){navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{this.showNotification("Link copied to clipboard!")}).catch(()=>{this.fallbackCopyToClipboard(e)}):this.fallbackCopyToClipboard(e)}fallbackCopyToClipboard(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-999999px",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),this.showNotification("Link copied to clipboard!")}catch(e){this.showNotification("Failed to copy link")}document.body.removeChild(t)}shareViaEmail(e,t){const o=encodeURIComponent("Check out this medical procedure result"),a=encodeURIComponent(`${t}\n\n${e}`);window.location.href=`mailto:?subject=${o}&body=${a}`}shareViaFacebook(e){const t=`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(e)}`;this.openShareWindow(t,"facebook")}shareViaTwitter(e,t){const o=`https://twitter.com/intent/tweet?url=${encodeURIComponent(e)}&text=${encodeURIComponent(t)}`;this.openShareWindow(o,"twitter")}shareViaPinterest(e,t,o){const a=`https://pinterest.com/pin/create/button/?url=${encodeURIComponent(e)}&media=${encodeURIComponent(t)}&description=${encodeURIComponent(o)}`;this.openShareWindow(a,"pinterest")}shareViaWhatsApp(e,t){const o=`https://wa.me/?text=${encodeURIComponent(`${t} ${e}`)}`;this.openShareWindow(o,"whatsapp")}openShareWindow(e,t){const o=(window.innerWidth-600)/2,a=(window.innerHeight-400)/2;window.open(e,`share-${t}`,`width=600,height=400,left=${o},top=${a},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`)}showNotification(e){let t=document.getElementById("shareNotification");t||(t=document.createElement("div"),t.id="shareNotification",t.className="brag-book-gallery-share-notification",document.body.appendChild(t)),t.textContent=e,t.classList.add("active"),this.options.animateWithGsap&&"undefined"!=typeof gsap&&gsap.fromTo(t,{y:-20,opacity:0},{y:0,opacity:1,duration:.3,ease:"back.out(1.7)"}),setTimeout(()=>{this.options.animateWithGsap&&"undefined"!=typeof gsap?gsap.to(t,{y:-20,opacity:0,duration:.2,ease:"power2.in",onComplete:()=>{t.classList.remove("active")}}):t.classList.remove("active")},3e3)}async shareNative(e){if(navigator.share)try{return await navigator.share({title:e.title||"Medical Procedure Result",text:e.text,url:e.url}),!0}catch(e){return"AbortError"!==e.name&&console.error("Share failed:",e),!1}return!1}}class r{constructor(e,t={}){this.wrapper=e,this.input=e.querySelector(".brag-book-gallery-search-input"),this.dropdown=e.querySelector(".brag-book-gallery-search-dropdown"),this.searchIcon=e.querySelector(".brag-book-gallery-search-icon"),this.options={minChars:t.minChars||1,debounceDelay:t.debounceDelay||200,maxResults:t.maxResults||10,onSelect:t.onSelect||(()=>{}),...t},this.procedures=[],this.filteredResults=[],this.selectedIndex=-1,this.isOpen=!1,this.debounceTimer=null,this.input&&this.dropdown&&this.init()}init(){this.collectProcedures(),this.setupEventListeners()}collectProcedures(){const e=document.querySelectorAll(".brag-book-gallery-filter-link"),t=new Map;e.forEach(e=>{const o=e.dataset.procedure,a=e.dataset.category,s=e.querySelector(".brag-book-gallery-filter-option-label")?.textContent||o,i=parseInt(e.dataset.procedureCount||"0");if(o&&a){const e=`${a}:${o}`;t.has(e)||t.set(e,{id:o,name:s.trim(),category:a,count:i,searchText:s.toLowerCase(),fullName:`${s} (${i})`})}}),this.procedures=Array.from(t.values())}setupEventListeners(){this.input.addEventListener("input",e=>this.handleInput(e)),this.input.addEventListener("focus",()=>this.handleFocus()),this.input.addEventListener("blur",e=>this.handleBlur(e)),this.input.addEventListener("keydown",e=>this.handleKeydown(e)),document.addEventListener("click",e=>{this.wrapper.contains(e.target)||this.close()}),this.dropdown.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-search-item");t&&this.selectItem(t)})}handleInput(e){const t=e.target.value.trim();this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{t.length>=this.options.minChars?this.search(t):this.close()},this.options.debounceDelay)}handleFocus(){const e=this.input.value.trim();e.length>=this.options.minChars&&this.search(e)}handleBlur(e){setTimeout(()=>{this.wrapper.contains(document.activeElement)||this.close()},200)}handleKeydown(e){if(this.isOpen)switch(e.key){case"ArrowDown":e.preventDefault(),this.moveSelection(1);break;case"ArrowUp":e.preventDefault(),this.moveSelection(-1);break;case"Enter":if(e.preventDefault(),this.selectedIndex>=0){const e=this.dropdown.querySelector(`[data-index="${this.selectedIndex}"]`);e&&this.selectItem(e)}break;case"Escape":this.close(),this.input.blur()}else"ArrowDown"===e.key&&this.input.value.trim().length>=this.options.minChars&&(e.preventDefault(),this.search(this.input.value.trim()))}search(e){const t=e.toLowerCase();this.filteredResults=this.procedures.filter(e=>e.searchText.includes(t)||e.category.includes(t)).slice(0,this.options.maxResults),this.filteredResults.sort((e,o)=>{const a=e.searchText===t,s=o.searchText===t;if(a&&!s)return-1;if(!a&&s)return 1;const i=e.searchText.startsWith(t),r=o.searchText.startsWith(t);return i&&!r?-1:!i&&r?1:0}),this.renderResults(e),this.open()}renderResults(e){if(0===this.filteredResults.length)return void(this.dropdown.innerHTML=`\n                <div class="brag-book-gallery-search-no-results">\n                    No procedures found for "${this.escapeHtml(e)}"\n                </div>\n            `);const t=this.filteredResults.map((t,o)=>{const a=this.highlightMatch(t.name,e),s=1===t.count?"case":"cases";return`\n                <div class="brag-book-gallery-search-item"\n                     role="option"\n                     data-index="${o}"\n                     data-procedure="${t.id}"\n                     data-category="${t.category}"\n                     aria-selected="${o===this.selectedIndex}">\n                    <div class="brag-book-gallery-search-item-content">\n                        <span class="brag-book-gallery-search-item-name">${a}</span>\n                        <span class="brag-book-gallery-search-item-count">${t.count} ${s}</span>\n                    </div>\n                    <span class="brag-book-gallery-search-item-category">${t.category}</span>\n                </div>\n            `}).join("");this.dropdown.innerHTML=t,this.selectedIndex=-1}highlightMatch(e,t){const o=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=new RegExp(`(${o})`,"gi");return e.replace(a,"<mark>$1</mark>")}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}moveSelection(e){const t=this.dropdown.querySelectorAll(".brag-book-gallery-search-item");0!==t.length&&(this.selectedIndex+=e,this.selectedIndex<0?this.selectedIndex=t.length-1:this.selectedIndex>=t.length&&(this.selectedIndex=0),t.forEach((e,t)=>{const o=t===this.selectedIndex;e.setAttribute("aria-selected",o),o&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}))}selectItem(e){const t=e.dataset.procedure,o=e.dataset.category,a=e.querySelector(".brag-book-gallery-search-item-name"),s=a?a.textContent.replace(/<mark>/g,"").replace(/<\/mark>/g,""):"";this.input.value=s,this.close(),this.options.onSelect({procedure:t,category:o,name:s});const i=document.querySelector(`.brag-book-gallery-filter-link[data-procedure="${t}"]`);i&&i.click()}open(){this.isOpen||(this.isOpen=!0,this.dropdown.classList.add("active"),this.wrapper.classList.add("active"),this.input.setAttribute("aria-expanded","true"))}close(){this.isOpen&&(this.isOpen=!1,this.dropdown.classList.remove("active"),this.wrapper.classList.remove("active"),this.input.setAttribute("aria-expanded","false"),this.selectedIndex=-1)}}class n{constructor(){this.components={},this.init()}async init(){this.initializeCarousels(),this.initializeDialogs(),this.initializeFilters(),this.initializeMobileMenu(),this.initializeFavorites(),this.initializeSearch(),this.initializeShareManager(),this.initializeConsultationForm(),this.initializeCaseLinks(),console.log("BRAG BookGallery initialized")}initializeCarousels(){const t=document.querySelectorAll(".brag-book-gallery-carousel-wrapper");let o;this.components.carousels=[],t.forEach((t,o)=>{const a=0===o?{infinite:!0,autoplay:!0,autoplayDelay:4e3,pauseOnHover:!0}:{infinite:!1,autoplay:!1};this.components.carousels.push(new e(t,a))}),window.addEventListener("resize",()=>{clearTimeout(o),o=setTimeout(()=>{this.components.carousels.forEach(e=>e.refresh())},250)})}initializeDialogs(){this.components.consultationDialog=new t("consultationDialog",{backdropId:"dialogBackdrop",onOpen:()=>console.log("Consultation dialog opened"),onClose:()=>console.log("Consultation dialog closed")}),document.querySelectorAll('[data-action="request-consultation"]').forEach(e=>{e.addEventListener("click",()=>{this.components.consultationDialog.open()})})}initializeFilters(){const e=document.querySelector(".brag-book-gallery-filters"),t=e?.dataset.filterMode||"javascript";this.components.filterSystem=new o(e,{mode:t,baseUrl:"/gallery",onFilterChange:e=>{console.log("Active filters:",Array.from(e.entries())),this.applyFilters(e)},onNavigate:e=>{console.log("Navigating to:",e),window.location.href=e}})}initializeMobileMenu(){this.components.mobileMenu=new a}initializeFavorites(){this.components.favoritesManager=new s({onUpdate:e=>{console.log("Favorites updated:",e.size)}})}initializeSearch(){const e=document.querySelector(".brag-book-gallery-search-wrapper");e&&(this.components.searchAutocomplete=new r(e,{minChars:1,debounceDelay:200,maxResults:10,onSelect:e=>{console.log("Selected procedure:",e)}}));const t=document.querySelector(".brag-book-gallery-mobile-search-wrapper");if(t){const e=t.querySelector(".brag-book-gallery-mobile-search-input"),o=t.querySelector(".brag-book-gallery-mobile-search-dropdown");e&&o&&(e.classList.add("brag-book-gallery-search-input"),o.classList.add("brag-book-gallery-search-dropdown"),this.components.mobileSearchAutocomplete=new r(t,{minChars:1,debounceDelay:200,maxResults:10,onSelect:e=>{console.log("Selected procedure (mobile):",e)}}))}}initializeShareManager(){"undefined"!=typeof bragBookGalleryConfig&&"yes"===bragBookGalleryConfig.enableSharing&&(this.components.shareManager=new i({onShare:e=>{console.log("Shared:",e)}}))}initializeConsultationForm(){const e=document.querySelector('[data-form="consultation"]');e&&e.addEventListener("submit",e=>{e.preventDefault(),this.handleFormSubmit(e.target)});const t=document.getElementById("consultationDialog");t&&new MutationObserver(e=>{e.forEach(e=>{"attributes"===e.type&&"open"===e.attributeName&&t.hasAttribute("open")&&this.hideModalMessage()})}).observe(t,{attributes:!0})}initializeCaseLinks(){document.addEventListener("click",e=>{const t=e.target.closest(".brag-book-gallery-case-link");if(t){e.preventDefault();const o=t.dataset.caseId,a=t.href;o&&this.loadCaseDetails(o,a)}}),window.addEventListener("popstate",e=>{e.state&&e.state.caseId?this.loadCaseDetails(e.state.caseId,window.location.href,!1):window.location.reload()})}async loadCaseDetails(e,t,o=!0){const a=document.getElementById("gallery-content");if(a){console.log("Loading case details for:",e),a.innerHTML='<div class="brag-book-gallery-loading">Loading case details...</div>',o&&window.history&&window.history.pushState&&window.history.pushState({caseId:e},"",t);try{if("undefined"==typeof bragBookGalleryConfig)throw console.error("bragBookGalleryConfig not defined"),new Error("Configuration not loaded");console.log("Making AJAX request to:",bragBookGalleryConfig.ajaxUrl);const t=await fetch(bragBookGalleryConfig.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"brag_book_gallery_load_case",case_id:e,nonce:bragBookGalleryConfig.nonce||""})});if(console.log("Response status:",t.status),!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const o=await t.json();if(console.log("Response data:",o),!o.success||!o.data)throw console.error("API Error:",o),new Error(o.data?.message||o.message||"Failed to load case details");this.displayCaseDetails(o.data)}catch(e){console.error("Error loading case details:",e);let t="Failed to load case details. Please try again.";e.message&&(t+="<br><small>"+e.message+"</small>"),a.innerHTML='<div class="brag-book-gallery-error">'+t+"</div>"}}else console.error("Gallery content container not found")}displayCaseDetails(e){const t=document.getElementById("gallery-content");if(!t)return;let o='<div class="brag-book-gallery-case-details">';o+='<button class="brag-book-gallery-back-button" onclick="history.back()">← Back to Gallery</button>',o+='<div class="brag-book-gallery-case-header">',o+=`<h2>${e.procedureName||"Case Details"}</h2>`,o+='<div class="case-metadata">',e.caseNumber&&(o+=`<span class="case-number">Case #${e.caseNumber}</span>`),e.technique&&(o+=`<span class="case-technique">Technique: ${e.technique}</span>`),e.age&&(o+=`<span class="case-age">Age: ${e.age}</span>`),e.gender&&(o+=`<span class="case-gender">Gender: ${e.gender}</span>`),o+="</div>",o+="</div>",e.photos&&e.photos.length>0?(o+='<div class="brag-book-gallery-case-images">',e.photos.forEach((e,t)=>{(e.beforeImage||e.afterImage)&&(o+='<div class="brag-book-gallery-case-image-pair">',e.isProcessed&&e.beforeImage?(o+='<div class="processed-image">',o+=`<img src="${e.beforeImage}" alt="Before and After" />`,e.caption&&(o+=`<p class="image-caption">${e.caption}</p>`),o+="</div>"):(e.beforeImage&&(o+='<div class="before-image">',o+="<h3>Before</h3>",o+=`<img src="${e.beforeImage}" alt="Before" loading="lazy" />`,o+="</div>"),e.afterImage&&(o+='<div class="after-image">',o+="<h3>After</h3>",o+=`<img src="${e.afterImage}" alt="After" loading="lazy" />`,o+="</div>"),e.caption&&(o+=`<p class="image-caption">${e.caption}</p>`)),o+="</div>")}),o+="</div>"):o+='<div class="no-images">No images available for this case.</div>',e.description&&(o+='<div class="brag-book-gallery-case-description">',o+="<h3>Details</h3>",e.description.includes("<")?o+=e.description:o+=`<p>${e.description}</p>`,o+="</div>"),o+="</div>",t.innerHTML=o,t.scrollIntoView({behavior:"smooth",block:"start"})}handleSearch(e){const t=e.toLowerCase().trim();console.log("Searching for:",t)}applyFilters(e){console.log("Applying filters...")}async handleFormSubmit(e){const t=new FormData(e),o=Object.fromEntries(t.entries());console.log("Form submitted:",o);const a=e.querySelector(".brag-book-gallery-form-submit"),s=a?a.textContent:"";a&&(a.disabled=!0,a.textContent="Sending...");try{if("undefined"==typeof bragBookGalleryConfig)throw new Error("Configuration not loaded. Please refresh the page.");const t=new URLSearchParams({action:"handle_form_submission",nonce:bragBookGalleryConfig.consultation_nonce||bragBookGalleryConfig.nonce,name:o.name||"",email:o.email||"",phone:o.phone||"",description:o.message||""}),a=await fetch(bragBookGalleryConfig.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t,credentials:"same-origin"}),s=await a.json();if(s.success)this.showModalMessage("Thank you for your consultation request! We will contact you soon.","success"),setTimeout(()=>{e.reset(),this.hideModalMessage(),this.components&&this.components.consultationDialog&&setTimeout(()=>{this.components.consultationDialog.close()},1e3)},3e3);else{const e=s.data||"Failed to send consultation request. Please try again.";this.showModalMessage(e,"error"),console.error("Form submission error:",e)}}catch(e){console.error("Error submitting form:",e),this.showModalMessage(e.message||"An error occurred. Please try again.","error")}finally{a&&(a.disabled=!1,a.textContent=s)}}showModalMessage(e,t="info"){const o=document.getElementById("consultationMessage"),a=o?.querySelector(".brag-book-gallery-form-message-content");if(!o||!a)return void this.showNotification(e,t);a.textContent=e,o.className="brag-book-gallery-form-message",o.classList.add(`brag-book-gallery-form-message-${t}`),o.style.display="block";const s=o.closest(".brag-book-gallery-dialog-content");s&&(s.scrollTop=0)}hideModalMessage(){const e=document.getElementById("consultationMessage");if(e){e.style.display="none";const t=e.querySelector(".brag-book-gallery-form-message-content");t&&(t.textContent="")}}showNotification(e,t="info"){let o=document.querySelector(".brag-book-notification");o||(o=document.createElement("div"),o.className="brag-book-notification",o.style.cssText="\n\t\t\t\tposition: fixed;\n\t\t\t\ttop: 20px;\n\t\t\t\tright: 20px;\n\t\t\t\tpadding: 15px 20px;\n\t\t\t\tborder-radius: 4px;\n\t\t\t\tz-index: 10000;\n\t\t\t\ttransition: opacity 0.3s ease;\n\t\t\t\tmax-width: 350px;\n\t\t\t",document.body.appendChild(o));const a={success:"#4caf50",error:"#f44336",info:"#2196f3"};o.style.backgroundColor=a[t]||a.info,o.style.color="white",o.textContent=e,o.style.opacity="1",setTimeout(()=>{o.style.opacity="0",setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},300)},5e3)}}class l{constructor(){this.nudityAccepted=!1,this.storageKey="brag-book-nudity-accepted",this.checkInitialAcceptance(),this.init()}checkInitialAcceptance(){try{const e=localStorage.getItem(this.storageKey);this.nudityAccepted="true"===e,this.nudityAccepted&&document.body.classList.add("nudity-accepted")}catch(e){console.warn("Could not load nudity acceptance status from localStorage:",e),this.nudityAccepted=!1}}init(){this.setupEventListeners(),console.log("%cTo reset nudity warnings, type: nudityManager.resetAcceptance()","background: #333; color: #fff; padding: 5px; border-radius: 3px;")}saveAcceptanceStatus(){try{localStorage.setItem(this.storageKey,"true")}catch(e){console.warn("Could not save nudity acceptance status to localStorage:",e)}}setupEventListeners(){document.addEventListener("click",e=>{e.target.matches(".brag-book-gallery-nudity-warning-button")&&this.handleProceedButtonClick(e.target)})}handleProceedButtonClick(e){this.nudityAccepted=!0,this.saveAcceptanceStatus(),document.body.classList.add("nudity-accepted"),this.animateRemoval()}animateRemoval(){const e=document.querySelectorAll(".brag-book-gallery-nudity-warning"),t=document.querySelectorAll(".brag-book-gallery-nudity-blur");e.forEach(e=>{"undefined"!=typeof gsap?gsap.to(e,{opacity:0,duration:.5,ease:"power2.out",onComplete:()=>{e.style.display="none"}}):(e.style.transition="opacity 0.5s ease-out",e.style.opacity="0",setTimeout(()=>{e.style.display="none"},500))}),t.forEach(e=>{"undefined"!=typeof gsap?gsap.to(e,{filter:"blur(0px)",duration:.5,ease:"power2.out"}):(e.style.transition="filter 0.5s ease-out",e.style.filter="blur(0px)")})}resetAcceptance(){this.nudityAccepted=!1;try{localStorage.removeItem(this.storageKey),document.body.classList.remove("nudity-accepted"),console.log("✅ Nudity warning acceptance has been reset. Refresh the page to see warnings again.")}catch(e){console.warn("Could not remove nudity acceptance status from localStorage:",e)}}}class c{constructor(){this.init()}init(){document.querySelectorAll('[data-phone-format="true"]').forEach(e=>{this.setupPhoneInput(e)})}setupPhoneInput(e){e.addEventListener("input",e=>{this.formatPhoneNumber(e.target)}),e.addEventListener("paste",e=>{setTimeout(()=>{this.formatPhoneNumber(e.target)},0)}),e.addEventListener("keypress",e=>{const t=String.fromCharCode(e.which);/[0-9]/.test(t)||8===e.which||46===e.which||e.preventDefault()})}formatPhoneNumber(e){let t=e.value.replace(/\D/g,"");t=t.substring(0,10);let o="";t.length>0&&(o=t.length<=3?`(${t}`:t.length<=6?`(${t.substring(0,3)}) ${t.substring(3)}`:`(${t.substring(0,3)}) ${t.substring(3,6)}-${t.substring(6,10)}`),e.value=o,10===t.length?e.setCustomValidity(""):e.hasAttribute("required")&&t.length>0&&e.setCustomValidity("Please enter a complete 10-digit phone number")}}let d,h;window.updateGridLayout=function(e){const t=document.querySelector(".brag-book-gallery-cases-grid");t&&(t.setAttribute("data-columns",e),t.style.gridTemplateColumns=`repeat(${e}, 1fr)`,document.querySelectorAll(".brag-book-gallery-grid-btn").forEach(t=>{parseInt(t.dataset.columns)===e?t.classList.add("active"):t.classList.remove("active")}),localStorage.setItem("bragbook-grid-columns",e))},window.bragBookProcedureFilters={age:[],gender:[],ethnicity:[],height:[],weight:[]},window.initializeProcedureFilters=function(){const e=document.getElementById("procedure-filters-details");console.log("Initializing procedure filters, details element:",e),console.log("Complete dataset available:",window.bragBookGalleryConfig?.completeDataset?.length||0,"cases"),e&&!e.dataset.initialized&&(generateProcedureFilterOptions(),e.dataset.initialized="true")},document.addEventListener("DOMContentLoaded",function(){setTimeout(function(){!window.bragBookCompleteDataset&&window.bragBookGalleryConfig&&window.bragBookGalleryConfig.completeDataset&&(window.bragBookCompleteDataset=window.bragBookGalleryConfig.completeDataset,console.log("Initialized bragBookCompleteDataset with",window.bragBookCompleteDataset.length,"cases")),initializeProcedureFilters();const e=document.querySelector(".brag-book-gallery-wrapper");if(e&&e.dataset.initialCaseId){const t=e.dataset.initialCaseId,o=window.location.pathname.split("/").filter(e=>e)[1]||"";console.log("Auto-loading case on page load:",t,"for procedure:",o),window.loadCaseDetails(t,"",o)}},100)}),document.addEventListener("toggle",function(e){if("procedure-filters-details"===e.target.id){const t=e.target;t.open&&!t.dataset.initialized&&(generateProcedureFilterOptions(),t.dataset.initialized="true")}}),document.addEventListener("click",function(e){const t=document.getElementById("procedure-filters-details"),o=document.querySelector(".brag-book-gallery-procedure-filters-panel");t&&t.open&&o&&(t.contains(e.target)||o.contains(e.target)||(t.open=!1))}),window.generateProcedureFilterOptions=function(){const e=document.getElementById("brag-book-gallery-procedure-filters-options");if(!e)return void console.warn("Filter container not found");let t;if(!window.bragBookCompleteDataset&&window.bragBookGalleryConfig&&window.bragBookGalleryConfig.completeDataset?(window.bragBookCompleteDataset=window.bragBookGalleryConfig.completeDataset,console.log("Initialized complete dataset with",window.bragBookCompleteDataset.length,"cases")):window.bragBookCompleteDataset||(console.warn("Complete dataset not available from config"),console.log("Config object:",window.bragBookGalleryConfig)),window.bragBookCompleteDataset&&window.bragBookCompleteDataset.length>0){console.log("Using complete dataset for filters:",window.bragBookCompleteDataset.length,"cases");const t={age:new Set,gender:new Set,ethnicity:new Set,height:new Set,weight:new Set};return window.bragBookCompleteDataset.forEach(e=>{const o=e.age||e.patientAge,a=e.gender||e.patientGender,s=e.ethnicity||e.patientEthnicity,i=e.height||e.patientHeight,r=e.weight||e.patientWeight;if(console&&console.log&&console.log("Processing case:",{id:e.id,age:o,gender:a,ethnicity:s,height:i,weight:r}),o){const e=parseInt(o);e<25?t.age.add("18-24"):e<35?t.age.add("25-34"):e<45?t.age.add("35-44"):e<55?t.age.add("45-54"):e<65?t.age.add("55-64"):t.age.add("65+")}if(a&&t.gender.add(a),s&&t.ethnicity.add(s),i){const e=parseInt(i);e<60?t.height.add("Under 5'0\""):e<64?t.height.add("5'0\" - 5'3\""):e<68?t.height.add("5'4\" - 5'7\""):e<72?t.height.add("5'8\" - 5'11\""):t.height.add("6'0\" and above")}if(r){const e=parseInt(r);e<120?t.weight.add("Under 120 lbs"):e<150?t.weight.add("120-149 lbs"):e<180?t.weight.add("150-179 lbs"):e<210?t.weight.add("180-209 lbs"):t.weight.add("210+ lbs")}}),console.log("Filter data generated:",{age:Array.from(t.age),gender:Array.from(t.gender),ethnicity:Array.from(t.ethnicity),height:Array.from(t.height),weight:Array.from(t.weight)}),void generateFilterHTML(e,t)}console.log("Falling back to DOM cards for filters"),t=document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]'),console.log("Found",t.length,"cards in DOM");const o={age:new Set,gender:new Set,ethnicity:new Set,height:new Set,weight:new Set};t.forEach(e=>{const t=e.dataset.age;if(t){const e=parseInt(t);e<30?o.age.add("Under 30"):e<40?o.age.add("30-39"):e<50?o.age.add("40-49"):e<60?o.age.add("50-59"):o.age.add("60+")}e.dataset.gender&&o.gender.add(e.dataset.gender),e.dataset.ethnicity&&o.ethnicity.add(e.dataset.ethnicity);const a=e.dataset.height;if(a){const t=parseInt(a);"cm"===(e.dataset.heightUnit||"cm")?t<160?o.height.add("Under 160cm"):t<170?o.height.add("160-169cm"):t<180?o.height.add("170-179cm"):o.height.add("180cm+"):o.height.add(e.dataset.heightFull)}const s=e.dataset.weight;if(s){const t=parseInt(s),a=e.dataset.weightUnit||"lbs";"lbs"===a||"lb"===a?t<120?o.weight.add("Under 120 lbs"):t<150?o.weight.add("120-149 lbs"):t<180?o.weight.add("150-179 lbs"):t<210?o.weight.add("180-209 lbs"):o.weight.add("210+ lbs"):"kg"===a?t<55?o.weight.add("Under 55kg"):t<70?o.weight.add("55-69kg"):t<85?o.weight.add("70-84kg"):o.weight.add("85kg+"):o.weight.add(e.dataset.weightFull)}}),generateFilterHTML(e,o)},window.generateFilterHTML=function(e,t){console.log("generateFilterHTML called with:",t);let o="";t.age.size>0&&(o+='<details class="brag-book-gallery-procedure-filters-group" open>',o+='<summary class="brag-book-gallery-procedure-filters-group-label">',o+='<svg class="brag-book-gallery-procedure-filters-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="<span>Age</span>",o+="</summary>",o+='<ul class="brag-book-gallery-procedure-filters-group-content">',Array.from(t.age).sort().forEach(e=>{const t=`procedure-filter-age-${e.replace(/\s+/g,"-")}`;o+=`<li class="brag-book-gallery-procedure-filters-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${e}" data-filter-type="age">\n\t\t\t\t<label for="${t}">${e}</label>\n\t\t\t</li>`}),o+="</ul>",o+="</details>"),t.gender.size>0&&(o+='<details class="brag-book-gallery-procedure-filters-group" open>',o+='<summary class="brag-book-gallery-procedure-filters-group-label">',o+='<svg class="brag-book-gallery-procedure-filters-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="<span>Gender</span>",o+="</summary>",o+='<ul class="brag-book-gallery-procedure-filters-group-content">',Array.from(t.gender).sort().forEach(e=>{const t=`procedure-filter-gender-${e}`,a=e.charAt(0).toUpperCase()+e.slice(1);o+=`<li class="brag-book-gallery-procedure-filters-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${e}" data-filter-type="gender">\n\t\t\t\t<label for="${t}">${a}</label>\n\t\t\t</li>`}),o+="</ul>",o+="</details>"),t.ethnicity.size>0&&(o+='<details class="brag-book-gallery-procedure-filters-group" open>',o+='<summary class="brag-book-gallery-procedure-filters-group-label">',o+='<svg class="brag-book-gallery-procedure-filters-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="<span>Ethnicity</span>",o+="</summary>",o+='<ul class="brag-book-gallery-procedure-filters-group-content">',Array.from(t.ethnicity).sort().forEach(e=>{const t=`procedure-filter-ethnicity-${e.replace(/\s+/g,"-")}`,a=e.charAt(0).toUpperCase()+e.slice(1);o+=`<li class="brag-book-gallery-procedure-filters-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${e}" data-filter-type="ethnicity">\n\t\t\t\t<label for="${t}">${a}</label>\n\t\t\t</li>`}),o+="</ul>",o+="</details>"),t.height.size>0&&(o+='<details class="brag-book-gallery-procedure-filters-group" open>',o+='<summary class="brag-book-gallery-procedure-filters-group-label">',o+='<svg class="brag-book-gallery-procedure-filters-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="<span>Height</span>",o+="</summary>",o+='<ul class="brag-book-gallery-procedure-filters-group-content">',Array.from(t.height).sort().forEach(e=>{const t=`procedure-filter-height-${e.replace(/\s+/g,"-")}`;o+=`<li class="brag-book-gallery-procedure-filters-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${e}" data-filter-type="height">\n\t\t\t\t<label for="${t}">${e}</label>\n\t\t\t</li>`}),o+="</ul>",o+="</details>"),t.weight.size>0&&(o+='<details class="brag-book-gallery-procedure-filters-group" open>',o+='<summary class="brag-book-gallery-procedure-filters-group-label">',o+='<svg class="brag-book-gallery-procedure-filters-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">',o+='<path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>',o+="</svg>",o+="<span>Weight</span>",o+="</summary>",o+='<ul class="brag-book-gallery-procedure-filters-group-content">',Array.from(t.weight).sort().forEach(e=>{const t=`procedure-filter-weight-${e.replace(/\s+/g,"-")}`;o+=`<li class="brag-book-gallery-procedure-filters-option">\n\t\t\t\t<input type="checkbox" id="${t}" value="${e}" data-filter-type="weight">\n\t\t\t\t<label for="${t}">${e}</label>\n\t\t\t</li>`}),o+="</ul>",o+="</details>"),console.log("Generated HTML length:",o.length),console.log("HTML preview:",o.substring(0,200)+(o.length>200?"...":"")),e.innerHTML=o||"<p>No filters available</p>",e.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.addEventListener("change",function(){console.log("Filter changed:",this.dataset.filterType,"=",this.value,"checked:",this.checked),applyProcedureFilters()})});const a=document.getElementById("procedure-filters-details");if(a){const e=o&&"<p>No filters available</p>"!==o;console.log("Has filters:",e),a.style.display=e?"":"none"}},window.applyProcedureFilters=function(){console.log("Applying procedure filters...");const e=document.querySelectorAll(".brag-book-gallery-procedure-filters-option input:checked");if(console.log("Checked filters:",e.length),window.bragBookProcedureFilters={age:[],gender:[],ethnicity:[],height:[],weight:[]},e.forEach(e=>{const t=e.dataset.filterType,o=e.value;console.log("Filter:",t,"=",o),window.bragBookProcedureFilters[t]&&window.bragBookProcedureFilters[t].push(o)}),console.log("Active filters:",window.bragBookProcedureFilters),!Object.values(window.bragBookProcedureFilters).some(e=>e.length>0)){const e=document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]');return e.forEach(e=>{e.style.display=""}),void updateFilteredCount(e.length,e.length)}if(window.bragBookCompleteDataset&&window.bragBookCompleteDataset.length>0){const e=[];window.bragBookCompleteDataset.forEach(t=>{let o=!0;const a=t.age||t.patientAge,s=t.gender||t.patientGender,i=t.ethnicity||t.patientEthnicity,r=t.height||t.patientHeight,n=t.weight||t.patientWeight;if(window.bragBookProcedureFilters.age.length>0){const e=parseInt(a);let t=!1;window.bragBookProcedureFilters.age.forEach(o=>{("18-24"===o&&e>=18&&e<=24||"25-34"===o&&e>=25&&e<=34||"35-44"===o&&e>=35&&e<=44||"45-54"===o&&e>=45&&e<=54||"55-64"===o&&e>=55&&e<=64||"65+"===o&&e>=65)&&(t=!0)}),t||(o=!1)}if(o&&window.bragBookProcedureFilters.gender.length>0&&(window.bragBookProcedureFilters.gender.includes(s)||(o=!1)),o&&window.bragBookProcedureFilters.ethnicity.length>0&&(window.bragBookProcedureFilters.ethnicity.includes(i)||(o=!1)),o&&window.bragBookProcedureFilters.height.length>0){const e=parseInt(r);let t=!1;window.bragBookProcedureFilters.height.forEach(o=>{("Under 5'0\""===o&&e<60||"5'0\" - 5'3\""===o&&e>=60&&e<64||"5'4\" - 5'7\""===o&&e>=64&&e<68||"5'8\" - 5'11\""===o&&e>=68&&e<72||"6'0\" and above"===o&&e>=72)&&(t=!0)}),t||(o=!1)}if(o&&window.bragBookProcedureFilters.weight.length>0){const e=parseInt(n);let t=!1;window.bragBookProcedureFilters.weight.forEach(o=>{("Under 120 lbs"===o&&e<120||"120-149 lbs"===o&&e>=120&&e<150||"150-179 lbs"===o&&e>=150&&e<180||"180-209 lbs"===o&&e>=180&&e<210||"210+ lbs"===o&&e>=210)&&(t=!0)}),t||(o=!1)}o&&e.push(t.id)}),loadFilteredCases(e)}else{let t=document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]');0===t.length&&(t=document.querySelectorAll('.brag-book-case-card[data-card="true"]')),0===t.length&&(t=document.querySelectorAll(".brag-book-gallery-case-card, .brag-book-case-card")),console.log("Found cards for filtering:",t.length);let o=0;t.forEach((e,t)=>{let a=!0;if(0===t&&console.log("First card data attributes:",{age:e.dataset.age,gender:e.dataset.gender,ethnicity:e.dataset.ethnicity,height:e.dataset.height,weight:e.dataset.weight,card:e.dataset.card}),window.bragBookProcedureFilters.age.length>0){const t=parseInt(e.dataset.age);let o=!1;console.log("Age check for card:",t,"against filters:",window.bragBookProcedureFilters.age),window.bragBookProcedureFilters.age.forEach(e=>{("18-24"===e&&t>=18&&t<25||"25-34"===e&&t>=25&&t<35||"35-44"===e&&t>=35&&t<45||"45-54"===e&&t>=45&&t<55||"55-64"===e&&t>=55&&t<65||"65+"===e&&t>=65)&&(o=!0)}),o||(a=!1,console.log("Age filter failed for card with age:",t))}if(a&&window.bragBookProcedureFilters.gender.length>0){const t=(e.dataset.gender||"").toLowerCase(),o=window.bragBookProcedureFilters.gender.map(e=>e.toLowerCase());console.log("Gender check:",{cardGender:t,filterGenders:o,matches:o.includes(t)}),o.includes(t)||(a=!1)}if(a&&window.bragBookProcedureFilters.ethnicity.length>0){const t=(e.dataset.ethnicity||"").toLowerCase(),o=window.bragBookProcedureFilters.ethnicity.map(e=>e.toLowerCase());console.log("Ethnicity check:",{cardEthnicity:t,filterEthnicities:o,matches:o.includes(t)}),o.includes(t)||(a=!1)}if(a&&window.bragBookProcedureFilters.height.length>0){const t=parseInt(e.dataset.height),o=e.dataset.heightUnit||"cm";let s=!1;window.bragBookProcedureFilters.height.forEach(a=>{"cm"===o?("Under 160cm"===a&&t<160||"160-169cm"===a&&t>=160&&t<170||"170-179cm"===a&&t>=170&&t<180||"180cm+"===a&&t>=180)&&(s=!0):a===e.dataset.heightFull&&(s=!0)}),s||(a=!1)}if(a&&window.bragBookProcedureFilters.weight.length>0){const t=parseInt(e.dataset.weight),o=e.dataset.weightUnit||"lbs";let s=!1;window.bragBookProcedureFilters.weight.forEach(a=>{"lbs"===o||"lb"===o?("Under 120 lbs"===a&&t<120||"120-149 lbs"===a&&t>=120&&t<150||"150-179 lbs"===a&&t>=150&&t<180||"180-209 lbs"===a&&t>=180&&t<210||"210+ lbs"===a&&t>=210)&&(s=!0):"kg"===o?("Under 55kg"===a&&t<55||"55-69kg"===a&&t>=55&&t<70||"70-84kg"===a&&t>=70&&t<85||"85kg+"===a&&t>=85)&&(s=!0):a===e.dataset.weightFull&&(s=!0)}),s||(a=!1)}e.style.display=a?"":"none",a&&o++});const a=e.length>0,s=0===o?"No procedures match the selected filters":`Showing ${o} of ${t.length} procedures`;let i=document.querySelector(".brag-book-gallery-procedure-filters-results");if(!i){i=document.createElement("div"),i.className="brag-book-gallery-procedure-filters-results";const e=document.querySelector(".brag-book-gallery-cases-grid")||document.querySelector(".brag-book-cases-grid");e&&e.parentNode&&e.parentNode.insertBefore(i,e)}i.textContent=s,i.style.display=a?"block":"none";const r=document.getElementById("procedure-filters-details");if(r){r.open=!1;const e=r.querySelector(".brag-book-gallery-procedure-filters-toggle");e&&e.classList.toggle("has-active-filters",a)}}},window.loadFilteredCases=function(e){const t=document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]');t.forEach(e=>{e.style.display="none"});let o=0,a=[];if(e.forEach(e=>{const t=document.querySelector(`.brag-book-gallery-case-card[data-case-id="${e}"]`);t?(t.style.display="",o++):a.push(e)}),a.length>0){const e=document.querySelector(".brag-book-gallery-cases-grid")||document.querySelector(".brag-book-cases-grid");if(e){const t=document.createElement("div");t.className="filter-loading-message",t.textContent=`Loading ${a.length} additional matching cases...`,t.style.cssText="padding: 20px; text-align: center; font-style: italic;",e.appendChild(t);const s=new FormData;s.append("action","brag_book_load_filtered_cases"),s.append("case_ids",a.join(",")),s.append("nonce","undefined"!=typeof bragBookAjax?bragBookAjax.nonce:""),fetch("undefined"!=typeof ajaxurl?ajaxurl:"/wp-admin/admin-ajax.php",{method:"POST",body:s}).then(e=>e.json()).then(t=>{const a=e.querySelector(".filter-loading-message");if(a&&a.remove(),t.success&&t.data.html){const a=document.createElement("div");a.innerHTML=t.data.html,a.querySelectorAll(".brag-book-gallery-case-card").forEach(t=>{e.appendChild(t),o++})}updateFilteredCount(o,window.bragBookCompleteDataset.length)}).catch(t=>{console.error("Error loading filtered cases:",t);const o=e.querySelector(".filter-loading-message");o&&(o.textContent="Failed to load additional cases. Showing only currently loaded matches.",setTimeout(()=>o.remove(),3e3))})}}else updateFilteredCount(o,window.bragBookCompleteDataset?window.bragBookCompleteDataset.length:t.length)},window.updateFilteredCount=function(e,t){const o=document.querySelector(".brag-book-gallery-count-label")||document.querySelector(".cases-count");o&&(o.textContent=`Showing ${e} of ${t}`);let a=document.querySelector(".brag-book-gallery-procedure-filters-results");if(!a){a=document.createElement("div"),a.className="brag-book-gallery-procedure-filters-results",a.style.cssText="padding: 10px; background: #f0f0f0; margin: 10px 0; border-radius: 4px;";const e=document.querySelector(".brag-book-gallery-cases-grid")||document.querySelector(".brag-book-cases-grid");e&&e.parentNode&&e.parentNode.insertBefore(a,e)}0===e?(a.textContent="No procedures match the selected filters",a.style.display="block"):window.bragBookProcedureFilters&&Object.values(window.bragBookProcedureFilters).some(e=>e.length>0)?(a.textContent=`Filter applied: Showing ${e} matching procedures`,a.style.display="block"):a.style.display="none"},window.clearProcedureFilters=function(){document.querySelectorAll(".brag-book-gallery-procedure-filters-option input").forEach(e=>{e.checked=!1}),document.querySelectorAll('.brag-book-gallery-case-card[data-card="true"]').forEach(e=>{e.style.display=""});const e=document.querySelector(".brag-book-gallery-procedure-filters-results");e&&(e.style.display="none"),window.bragBookProcedureFilters={age:[],gender:[],ethnicity:[],height:[],weight:[]};const t=document.querySelector(".brag-book-gallery-procedure-filters-toggle");t&&t.classList.remove("has-active-filters")},window.syncImageHeights=function(e){e.style.opacity="1";const t=e.parentElement.querySelector(".brag-book-gallery-skeleton-loader");t&&(t.style.display="none");const o=e.closest(".brag-book-gallery-case-images");if(!o)return;const a=o.querySelectorAll("img");let s=!0;if(a.forEach(e=>{e.complete&&e.naturalHeight||(s=!1)}),!s)return;let i=0;a.forEach(e=>{const t=e.naturalHeight/e.naturalWidth;t>i&&(i=t)}),o.querySelectorAll(".brag-book-gallery-image-container").forEach(e=>{e.style.paddingBottom=100*i+"%"})},window.loadCaseDetails=function(e,t,o){const a=document.getElementById("gallery-content");if(!a)return void console.error("Gallery content container not found");if(a.innerHTML='<div class="brag-book-gallery-loading">Loading case details...</div>',o&&window.history&&window.history.pushState){const a=document.querySelector(".brag-book-gallery-wrapper");let s=a?.dataset.baseUrl||window.location.pathname;if(s=s.replace(/\/[^\/]+\/\d+\/?$/,""),s=s.replace(/\/[^\/]+\/?$/,""),s=s.replace(/\/$/,""),!s||""===s){const e=window.location.pathname.split("/").filter(e=>e);s=e.length>0?"/"+e[0]:""}const i=`${s}/${o}/${e}`;window.history.pushState({caseId:e,procedureId:t,procedureSlug:o},"",i)}a.scrollIntoView({behavior:"smooth"});const s={action:"load_case_details",case_id:e,nonce:bragBookGalleryConfig.nonce};t&&(s.procedure_id=t),fetch(bragBookGalleryConfig.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(s)}).then(e=>e.json()).then(e=>{e.success?a.innerHTML=e.data.html:a.innerHTML='<div class="brag-book-gallery-error">Failed to load case details: '+(e.data||"Unknown error")+"</div>"}).catch(e=>{console.error("Error loading case details:",e),a.innerHTML='<div class="brag-book-gallery-error">Error loading case details. Please try again.</div>'})},window.loadMoreCases=function(e){e.disabled=!0;const t=e.textContent;e.textContent="Loading...";const o=e.getAttribute("data-start-page"),a=e.getAttribute("data-procedure-ids");let s=!1;const i=document.querySelector(".brag-book-gallery-filter-link.brag-book-gallery-active");i&&"true"===i.dataset.nudity&&(s=!0);const r=window.bragBookGalleryConfig?.nonce||"",n=window.bragBookGalleryConfig?.ajaxUrl||"/wp-admin/admin-ajax.php",l=new FormData;l.append("action","brag_book_load_more_cases"),l.append("nonce",r),l.append("start_page",o),l.append("procedure_ids",a),l.append("has_nudity",s?"1":"0"),fetch(n,{method:"POST",body:l}).then(e=>e.json()).then(a=>{if(console.log("Load More Response:",a),a.success){let s=document.querySelector(".brag-book-gallery-cases-grid");if(s||(s=document.querySelector(".brag-book-cases-container")),s||(s=document.querySelector(".brag-book-cases-grid .brag-book-cases-container")),s)if(console.log("Adding HTML to container. HTML length:",a.data.html?a.data.html.length:0),console.log("Debug info:",a.data.debug),a.data.html){const e=s.querySelector(".brag-book-gallery-case-card:last-child");e?e.insertAdjacentHTML("afterend",a.data.html):s.insertAdjacentHTML("beforeend",a.data.html),console.log("Cases in container after insert:",s.querySelectorAll("[data-case-id]").length)}else console.error("No HTML received from server");else console.error("Container not found (.brag-book-gallery-cases-grid, .brag-book-cases-container, or .brag-book-cases-grid .brag-book-cases-container)");if(a.data.hasMore?(e.setAttribute("data-start-page",parseInt(o)+1),e.disabled=!1,e.textContent=t):e.parentElement.style.display="none",s){const e=document.querySelector(".brag-book-gallery-count-label")||document.querySelector(".cases-count")||document.querySelector('[class*="count-label"]');if(e){const t=s.querySelectorAll(".brag-book-gallery-case-card").length,o=e.textContent.match(/(\d+) of (\d+)/);if(o){const a=o[2];e.textContent="Showing "+t+" of "+a}}}}else console.error("Failed to load more cases:",a.data?a.data.message:"Unknown error"),e.disabled=!1,e.textContent=t,alert("Failed to load more cases. Please try again.")}).catch(o=>{console.error("Error loading more cases:",o),e.disabled=!1,e.textContent=t,alert("Error loading more cases. Please check your connection and try again.")})},document.addEventListener("DOMContentLoaded",()=>{new n,d=new l,h=new c;const e=localStorage.getItem("bragbook-grid-columns");e&&window.updateGridLayout(parseInt(e))})}();
