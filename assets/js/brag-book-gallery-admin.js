!function(){"use strict";void 0===window.BRAGbookAdmin&&(window.BRAGbookAdmin=class{constructor(){this.ajaxUrl="undefined"!=typeof brag_book_gallery_ajax?brag_book_gallery_ajax.ajaxurl:"/wp-admin/admin-ajax.php",this.nonce="undefined"!=typeof brag_book_gallery_ajax?brag_book_gallery_ajax.nonce:"",this.dialog=null,this.init()}init(){this.createDialog(),this.initDynamicTable(),this.initCombineGallery(),this.initDebugPage()}createDialog(){if(document.getElementById("brag-book-gallery-dialog"))return void(this.dialog=document.getElementById("brag-book-gallery-dialog"));this.dialog=document.createElement("dialog"),this.dialog.id="brag-book-gallery-dialog",this.dialog.className="brag-book-gallery-dialog",this.dialog.innerHTML='\n            <div class="brag-book-gallery-dialog-content">\n                <div class="brag-book-gallery-dialog-header">\n                    <h3 class="brag-book-gallery-dialog-title"></h3>\n                    <button type="button" class="brag-book-gallery-dialog-close" aria-label="Close">\n                        <span class="dashicons dashicons-no-alt"></span>\n                    </button>\n                </div>\n                <div class="brag-book-gallery-dialog-body">\n                    <div class="brag-book-gallery-dialog-icon"></div>\n                    <div class="brag-book-gallery-dialog-message"></div>\n                </div>\n                <div class="brag-book-gallery-dialog-footer">\n                    <button type="button" class="button button-primary brag-book-gallery-dialog-ok">OK</button>\n                </div>\n            </div>\n        ',document.body.appendChild(this.dialog);const e=this.dialog.querySelector(".brag-book-gallery-dialog-close"),o=this.dialog.querySelector(".brag-book-gallery-dialog-ok");e.addEventListener("click",()=>this.closeDialog()),o.addEventListener("click",()=>this.closeDialog()),this.dialog.addEventListener("click",e=>{e.target===this.dialog&&this.closeDialog()}),this.dialog.addEventListener("cancel",e=>{e.preventDefault(),this.closeDialog()})}showDialog(e,o="info",t=""){this.dialog||this.createDialog();const a=this.dialog.querySelector(".brag-book-gallery-dialog-title"),n=this.dialog.querySelector(".brag-book-gallery-dialog-icon"),l=this.dialog.querySelector(".brag-book-gallery-dialog-message"),s=this.dialog.querySelector(".brag-book-gallery-dialog-content");if(!t)switch(o){case"success":t="Success";break;case"error":t="Error";break;case"warning":t="Warning";break;default:t="Information"}switch(a.textContent=t,s.className=`brag-book-gallery-dialog-content brag-book-gallery-dialog-${o}`,o){case"success":n.innerHTML='<span class="dashicons dashicons-yes-alt"></span>';break;case"error":n.innerHTML='<span class="dashicons dashicons-dismiss"></span>';break;case"warning":n.innerHTML='<span class="dashicons dashicons-warning"></span>';break;default:n.innerHTML='<span class="dashicons dashicons-info"></span>'}l.innerHTML=e,this.dialog.showModal()}closeDialog(){this.dialog&&this.dialog.close()}initDynamicTable(){const e=document.querySelector("#dynamicTable tbody");if(!e)return;const o=(e,o)=>{const t=document.createElement("td"),a=document.createElement("input");return a.type="text",a.setAttribute("data-key",`page_${o}`),a.setAttribute("name",`${e}[page_${o}]`),a.required=!0,t.appendChild(a),t},t=o=>{if(e.rows.length<=1)return;const t=o.querySelector('input[data-key^="page_"]'),n=t?t.dataset.key:"";n&&this.ajaxPost({action:"brag_book_gallery_setting_remove_row",remove_id:n}),o.remove(),a()},a=()=>{const o=e.querySelectorAll("tr");o.forEach((e,t)=>{const a=e.querySelector(".addRow"),n=e.querySelector(".removeRow");a&&(a.style.display=t===o.length-1?"inline-block":"none"),n&&(n.style.display=o.length>1?"inline-block":"none")})};e.addEventListener("click",n=>{const l=n.target.closest("tr");n.target.classList.contains("addRow")&&(()=>{const t=[...e.querySelectorAll("tr")].reduce((e,o)=>{const t=o.querySelector('input[data-key^="page_"]');if(t){const o=parseInt(t.dataset.key.split("_")[1],10);return Math.max(e,o)}return e},0)+1,n=document.createElement("tr");n.appendChild(o("brag_book_gallery_api_token",t)),n.appendChild(o("brag_book_gallery_website_property_id",t)),n.appendChild(o("brag_book_gallery_page_slug",t)),n.appendChild(o("brag_book_gallery_seo_page_title",t)),n.appendChild(o("brag_book_gallery_seo_page_description",t)),n.appendChild((()=>{const e=document.createElement("td"),o=document.createElement("button");o.type="button",o.className="button removeRow",o.textContent="Remove Row";const t=document.createElement("button");return t.type="button",t.className="button addRow",t.textContent="Add Row",e.appendChild(o),e.appendChild(t),e})()),e.appendChild(n),a()})(),n.target.classList.contains("removeRow")&&l&&t(l)}),a()}initCombineGallery(){const e=document.getElementById("createCombineGallery"),o=document.getElementById("slugFieldContainer"),t=document.querySelector(".combineGallerySlug");e&&o&&t&&(""===t.value?(e.style.display="block",o.style.display="none",e.addEventListener("click",()=>{o.style.display="none"===o.style.display?"block":"none"})):(e.style.display="none",o.style.display="block"))}initDebugPage(){this.initDebugTabs(),this.initErrorLog(),this.initApiLog(),this.initSystemInfo(),this.initDebugSettings()}initDebugTabs(){const e=document.querySelectorAll(".brag-book-gallery-log-tab-nav a"),o=document.querySelectorAll(".brag-book-gallery-log-tab-content");0!==e.length&&e.forEach(t=>{t.addEventListener("click",a=>{a.preventDefault();const n=t.getAttribute("data-tab");e.forEach(e=>e.classList.remove("active")),o.forEach(e=>e.classList.remove("active")),t.classList.add("active");const l=document.getElementById(n+"-tab");l&&l.classList.add("active")})})}initErrorLog(){const e=document.getElementById("brag-book-gallery-refresh-error-log"),o=document.getElementById("brag-book-gallery-clear-error-log"),t=document.getElementById("brag-book-gallery-download-error-log"),a=document.getElementById("brag-book-gallery-error-log");e&&a&&e.addEventListener("click",async()=>{e.disabled=!0;const o=a.textContent;a.innerHTML='<span style="color: #666;">Loading...</span>';try{const e=await this.ajaxPost({action:"brag_book_gallery_get_error_log",nonce:this.nonce});e.success?(a.textContent=e.data.log||"No errors logged yet.",this.showDialog("Error log refreshed successfully.","success")):(a.textContent=o,this.showDialog(`Failed to load error log: ${e.data||"Unknown error"}`,"error"))}catch(e){a.textContent=o,this.showDialog(`Error loading log: ${e.message}`,"error")}finally{e.disabled=!1}}),o&&a&&o.addEventListener("click",async()=>{const e=document.createElement("dialog");e.className="brag-book-gallery-dialog",e.innerHTML='\n                    <div class="brag-book-gallery-dialog-content brag-book-gallery-dialog-warning">\n                        <div class="brag-book-gallery-dialog-header">\n                            <h3 class="brag-book-gallery-dialog-title">Confirm Clear Log</h3>\n                        </div>\n                        <div class="brag-book-gallery-dialog-body">\n                            <div class="brag-book-gallery-dialog-icon">\n                                <span class="dashicons dashicons-warning"></span>\n                            </div>\n                            <div class="brag-book-gallery-dialog-message">\n                                Are you sure you want to clear the error log? This action cannot be undone.\n                            </div>\n                        </div>\n                        <div class="brag-book-gallery-dialog-footer">\n                            <button type="button" class="button button-secondary brag-book-gallery-dialog-cancel">Cancel</button>\n                            <button type="button" class="button button-primary brag-book-gallery-dialog-confirm">Clear Log</button>\n                        </div>\n                    </div>\n                ',document.body.appendChild(e),e.showModal();const o=e.querySelector(".brag-book-gallery-dialog-confirm"),t=e.querySelector(".brag-book-gallery-dialog-cancel");o.addEventListener("click",async()=>{e.close(),e.remove();try{const e=await this.ajaxPost({action:"brag_book_gallery_clear_error_log",nonce:this.nonce});e.success?(a.textContent="No errors logged yet.",this.showDialog("Error log cleared successfully.","success")):this.showDialog(`Failed to clear log: ${e.data||"Unknown error"}`,"error")}catch(e){this.showDialog(`Error clearing log: ${e.message}`,"error")}}),t.addEventListener("click",()=>{e.close(),e.remove()}),e.addEventListener("click",o=>{o.target===e&&(e.close(),e.remove())})}),t&&a&&t.addEventListener("click",()=>{const e=a.textContent,o=new Blob([e],{type:"text/plain"}),t=window.URL.createObjectURL(o),n=document.createElement("a");n.href=t,n.download=`brag-book-gallery-error-log-${(new Date).toISOString().split("T")[0]}.txt`,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(t)})}initApiLog(){const e=document.getElementById("brag-book-gallery-refresh-api-log"),o=document.getElementById("brag-book-gallery-clear-api-log"),t=document.getElementById("brag-book-gallery-download-api-log"),a=document.getElementById("brag-book-gallery-api-log");e&&a&&e.addEventListener("click",async()=>{e.disabled=!0;const o=a.textContent;a.innerHTML='<span style="color: #666;">Loading...</span>';try{const e=await this.ajaxPost({action:"brag_book_gallery_get_api_log",nonce:this.nonce});e.success?(a.textContent=e.data.log||"No API requests logged yet.",this.showDialog("API log refreshed successfully.","success")):(a.textContent=o,this.showDialog(`Failed to load API log: ${e.data||"Unknown error"}`,"error"))}catch(e){a.textContent=o,this.showDialog(`Error loading log: ${e.message}`,"error")}finally{e.disabled=!1}}),o&&a&&o.addEventListener("click",async()=>{const e=document.createElement("dialog");e.className="brag-book-gallery-dialog",e.innerHTML='\n                    <div class="brag-book-gallery-dialog-content brag-book-gallery-dialog-warning">\n                        <div class="brag-book-gallery-dialog-header">\n                            <h3 class="brag-book-gallery-dialog-title">Confirm Clear API Log</h3>\n                            <button type="button" class="brag-book-gallery-dialog-close" aria-label="Close">\n                                <span class="dashicons dashicons-no-alt"></span>\n                            </button>\n                        </div>\n                        <div class="brag-book-gallery-dialog-body">\n                            <div class="brag-book-gallery-dialog-icon">\n                                <span class="dashicons dashicons-warning"></span>\n                            </div>\n                            <div class="brag-book-gallery-dialog-message">\n                                Are you sure you want to clear the API log? This action cannot be undone.\n                            </div>\n                        </div>\n                        <div class="brag-book-gallery-dialog-footer">\n                            <button type="button" class="button button-secondary brag-book-gallery-dialog-cancel">Cancel</button>\n                            <button type="button" class="button button-primary brag-book-gallery-dialog-confirm">Clear Log</button>\n                        </div>\n                    </div>\n                ',document.body.appendChild(e),e.showModal();const t=e.querySelector(".brag-book-gallery-dialog-confirm"),n=e.querySelector(".brag-book-gallery-dialog-cancel"),l=e.querySelector(".brag-book-gallery-dialog-close"),s=()=>{e.close(),e.remove()};t.addEventListener("click",async()=>{s(),o.disabled=!0;try{const e=await this.ajaxPost({action:"brag_book_gallery_clear_api_log",nonce:this.nonce});e.success?(a.textContent="No API requests logged yet.",this.showDialog("API log cleared successfully.","success")):this.showDialog(`Failed to clear API log: ${e.data||"Unknown error"}`,"error")}catch(e){this.showDialog(`Error clearing log: ${e.message}`,"error")}finally{o.disabled=!1}}),n.addEventListener("click",s),l.addEventListener("click",s)}),t&&a&&t.addEventListener("click",()=>{const e=a.textContent,o=new Blob([e],{type:"text/plain"}),t=window.URL.createObjectURL(o),n=document.createElement("a");n.href=t,n.download=`brag-book-gallery-api-log-${(new Date).toISOString().split("T")[0]}.txt`,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(t)})}initSystemInfo(){const e=document.getElementById("brag-book-gallery-copy-system-info"),o=document.getElementById("brag-book-gallery-export-system-info"),t=document.getElementById("brag-book-gallery-system-info");e&&t&&e.addEventListener("click",async()=>{const e=t.textContent;try{await navigator.clipboard.writeText(e);const o=document.getElementById("brag-book-gallery-copy-feedback");o&&(o.classList.add("show"),setTimeout(()=>o.classList.remove("show"),2e3)),this.showDialog("System information copied to clipboard.","success")}catch(o){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-999999px",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy");const e=document.getElementById("brag-book-gallery-copy-feedback");e&&(e.classList.add("show"),setTimeout(()=>e.classList.remove("show"),2e3)),this.showDialog("System information copied to clipboard.","success")}catch(e){this.showDialog("Failed to copy to clipboard. Please try again.","error")}document.body.removeChild(t)}}),o&&t&&o.addEventListener("click",()=>{const e=t.textContent,o=new Blob([e],{type:"text/plain"}),a=window.URL.createObjectURL(o),n=document.createElement("a");n.href=a,n.download=`brag-book-gallery-system-info-${(new Date).toISOString().split("T")[0]}.txt`,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(a)})}initDebugSettings(){const e=document.getElementById("brag-book-gallery-save-debug-settings"),o=document.getElementById("brag-book-gallery-debug-mode"),t=document.getElementById("brag-book-gallery-api-logging"),a=document.getElementById("wp-debug-mode"),n=document.getElementById("brag-book-gallery-log-level");e&&e.addEventListener("click",async()=>{const e=o&&o.checked?"1":"0",l=t&&t.checked?"1":"0",s=a&&a.checked?"1":"0",i=n?n.value:"error";try{const o=await this.ajaxPost({action:"brag_book_gallery_save_debug_settings",nonce:this.nonce,debug_mode:e,api_logging:l,wp_debug:s,log_level:i});if(o.success){this.showDialog(o.data.message||"Settings saved successfully.","success");const t=document.querySelector(".brag-book-gallery-debug-status");t&&("1"===e?(t.classList.add("active"),t.innerHTML='<span class="dashicons dashicons-yes-alt"></span> Active'):(t.classList.remove("active"),t.innerHTML='<span class="dashicons dashicons-no-alt"></span> Inactive'))}else this.showDialog(`Failed to save debug settings: ${o.data||"Unknown error"}`,"error")}catch(e){this.showDialog(`Error saving settings: ${e.message}`,"error")}})}initApiValidation(){document.querySelectorAll(".bb-validate-api").forEach(e=>{e.addEventListener("click",async e=>{const o=e.target.closest(".bb-api-row");if(!o)return;const t=o.querySelector('input[name*="api_token"]'),a=o.querySelector('input[name*="website_property_id"]'),n=o.querySelector(".bb-api-status");if(!t||!a)return;const l=t.value.trim(),s=a.value.trim();if(l&&s){n&&(n.innerHTML='<span class="spinner is-active"></span> Validating...');try{const e=await this.ajaxPost({action:"brag_book_gallery_validate_api",nonce:this.nonce,api_token:l,website_property_id:s});if(n)if(e.success&&e.data.valid)n.innerHTML='<span class="dashicons dashicons-yes" style="color: #46b450;"></span> <span style="color: #46b450;">Connected</span>',this.showDialog("API credentials validated successfully!","success");else{const o=e.data?.message||"Invalid credentials";n.innerHTML=`<span class="dashicons dashicons-no" style="color: #dc3232;"></span> <span style="color: #dc3232;">${o}</span>`,this.showDialog(`API validation failed: ${o}`,"error")}}catch(e){n&&(n.innerHTML='<span class="dashicons dashicons-warning" style="color: #ffb900;"></span> <span style="color: #ffb900;">Connection error</span>'),this.showDialog(`Connection error: ${e.message}`,"error")}}else this.showDialog("Please enter both API Token and Website Property ID","warning")})})}async ajaxPost(e){const o=new FormData;for(const t in e)o.append(t,e[t]);const t=await fetch(this.ajaxUrl,{method:"POST",credentials:"same-origin",body:o});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.json()}}),void 0===window.bragBookAdminInstance&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.bragBookAdminInstance=new window.BRAGbookAdmin}):window.bragBookAdminInstance=new window.BRAGbookAdmin)}();