!function(){"use strict";void 0===window.BRAGbookAdmin&&(window.BRAGbookAdmin=class{constructor(){this.ajaxUrl="undefined"!=typeof brag_book_gallery_admin&&brag_book_gallery_admin.ajaxurl?brag_book_gallery_admin.ajaxurl:"undefined"!=typeof brag_book_gallery_ajax?brag_book_gallery_ajax.ajaxurl:"/wp-admin/admin-ajax.php",this.nonce="undefined"!=typeof brag_book_gallery_admin&&brag_book_gallery_admin.nonce?brag_book_gallery_admin.nonce:"undefined"!=typeof brag_book_gallery_ajax?brag_book_gallery_ajax.nonce:"",this.dialog=null,this.init()}init(){this.createDialog(),this.initDynamicTable(),this.initCombineGallery(),this.initDebugPage()}createDialog(){if(document.getElementById("brag-book-gallery-dialog"))return void(this.dialog=document.getElementById("brag-book-gallery-dialog"));this.dialog=document.createElement("dialog"),this.dialog.id="brag-book-gallery-dialog",this.dialog.className="brag-book-gallery-dialog",this.dialog.innerHTML='\n            <div class="brag-book-gallery-dialog-content">\n                <div class="brag-book-gallery-dialog-header">\n                    <h3 class="brag-book-gallery-dialog-title"></h3>\n                    <button type="button" class="brag-book-gallery-dialog-close" aria-label="Close">\n                        <span class="dashicons dashicons-no-alt"></span>\n                    </button>\n                </div>\n                <div class="brag-book-gallery-dialog-body">\n                    <div class="brag-book-gallery-dialog-icon"></div>\n                    <div class="brag-book-gallery-dialog-message"></div>\n                </div>\n                <div class="brag-book-gallery-dialog-footer">\n                    <button type="button" class="button button-primary brag-book-gallery-dialog-ok">OK</button>\n                </div>\n            </div>\n        ',document.body.appendChild(this.dialog);const t=this.dialog.querySelector(".brag-book-gallery-dialog-close"),e=this.dialog.querySelector(".brag-book-gallery-dialog-ok");t.addEventListener("click",()=>this.closeDialog()),e.addEventListener("click",()=>this.closeDialog()),this.dialog.addEventListener("click",t=>{t.target===this.dialog&&this.closeDialog()}),this.dialog.addEventListener("cancel",t=>{t.preventDefault(),this.closeDialog()})}showDialog(t,e="info",o=""){this.dialog||this.createDialog();const a=this.dialog.querySelector(".brag-book-gallery-dialog-title"),n=this.dialog.querySelector(".brag-book-gallery-dialog-icon"),l=this.dialog.querySelector(".brag-book-gallery-dialog-message"),r=this.dialog.querySelector(".brag-book-gallery-dialog-content");if(!o)switch(e){case"success":o="Success";break;case"error":o="Error";break;case"warning":o="Warning";break;default:o="Information"}switch(a.textContent=o,r.className=`brag-book-gallery-dialog-content brag-book-gallery-dialog-${e}`,e){case"success":n.innerHTML='<span class="dashicons dashicons-yes-alt"></span>';break;case"error":n.innerHTML='<span class="dashicons dashicons-dismiss"></span>';break;case"warning":n.innerHTML='<span class="dashicons dashicons-warning"></span>';break;default:n.innerHTML='<span class="dashicons dashicons-info"></span>'}l.innerHTML=t,this.dialog.showModal()}closeDialog(){this.dialog&&this.dialog.close()}initDynamicTable(){const t=document.querySelector("#dynamicTable tbody");if(!t)return;const e=(t,e)=>{const o=document.createElement("td"),a=document.createElement("input");return a.type="text",a.setAttribute("data-key",`page_${e}`),a.setAttribute("name",`${t}[page_${e}]`),a.required=!0,o.appendChild(a),o},o=e=>{if(t.rows.length<=1)return;const o=e.querySelector('input[data-key^="page_"]'),n=o?o.dataset.key:"";n&&this.ajaxPost({action:"brag_book_gallery_setting_remove_row",remove_id:n}),e.remove(),a()},a=()=>{const e=t.querySelectorAll("tr");e.forEach((t,o)=>{const a=t.querySelector(".addRow"),n=t.querySelector(".removeRow");a&&(a.style.display=o===e.length-1?"inline-block":"none"),n&&(n.style.display=e.length>1?"inline-block":"none")})};t.addEventListener("click",n=>{const l=n.target.closest("tr");n.target.classList.contains("addRow")&&(()=>{const o=[...t.querySelectorAll("tr")].reduce((t,e)=>{const o=e.querySelector('input[data-key^="page_"]');if(o){const e=parseInt(o.dataset.key.split("_")[1],10);return Math.max(t,e)}return t},0)+1,n=document.createElement("tr");n.appendChild(e("brag_book_gallery_api_token",o)),n.appendChild(e("brag_book_gallery_website_property_id",o)),n.appendChild(e("brag_book_gallery_page_slug",o)),n.appendChild(e("brag_book_gallery_seo_page_title",o)),n.appendChild(e("brag_book_gallery_seo_page_description",o)),n.appendChild((()=>{const t=document.createElement("td"),e=document.createElement("button");e.type="button",e.className="button removeRow",e.textContent="Remove Row";const o=document.createElement("button");return o.type="button",o.className="button addRow",o.textContent="Add Row",t.appendChild(e),t.appendChild(o),t})()),t.appendChild(n),a()})(),n.target.classList.contains("removeRow")&&l&&o(l)}),a()}initCombineGallery(){const t=document.getElementById("createCombineGallery"),e=document.getElementById("slugFieldContainer"),o=document.querySelector(".combineGallerySlug");t&&e&&o&&(""===o.value?(t.style.display="block",e.style.display="none",t.addEventListener("click",()=>{e.style.display="none"===e.style.display?"block":"none"})):(t.style.display="none",e.style.display="block"))}initDebugPage(){this.initDebugTabs(),this.initErrorLog(),this.initApiLog(),this.initSystemInfo(),this.initDebugSettings(),this.initFactoryReset()}initDebugTabs(){const t=document.querySelectorAll(".brag-book-gallery-log-tab-nav a"),e=document.querySelectorAll(".brag-book-gallery-log-tab-content");0!==t.length&&t.forEach(o=>{o.addEventListener("click",a=>{a.preventDefault();const n=o.getAttribute("data-tab");t.forEach(t=>t.classList.remove("active")),e.forEach(t=>t.classList.remove("active")),o.classList.add("active");const l=document.getElementById(n+"-tab");l&&l.classList.add("active")})})}initErrorLog(){const t=document.getElementById("brag-book-gallery-refresh-error-log"),e=document.getElementById("brag-book-gallery-clear-error-log"),o=document.getElementById("brag-book-gallery-download-error-log"),a=document.getElementById("brag-book-gallery-error-log");t&&a&&t.addEventListener("click",async()=>{t.disabled=!0;const e=a.textContent;a.innerHTML='<span style="color: #666;">Loading...</span>';try{const t=await this.ajaxPost({action:"brag_book_gallery_get_error_log",nonce:this.nonce});t.success?(a.textContent=t.data.log||"No errors logged yet.",this.showDialog("Error log refreshed successfully.","success")):(a.textContent=e,this.showDialog(`Failed to load error log: ${t.data||"Unknown error"}`,"error"))}catch(t){a.textContent=e,this.showDialog(`Error loading log: ${t.message}`,"error")}finally{t.disabled=!1}}),e&&a&&e.addEventListener("click",async()=>{const t=document.createElement("dialog");t.className="brag-book-gallery-dialog",t.innerHTML='\n                    <div class="brag-book-gallery-dialog-content brag-book-gallery-dialog-warning">\n                        <div class="brag-book-gallery-dialog-header">\n                            <h3 class="brag-book-gallery-dialog-title">Confirm Clear Log</h3>\n                        </div>\n                        <div class="brag-book-gallery-dialog-body">\n                            <div class="brag-book-gallery-dialog-icon">\n                                <span class="dashicons dashicons-warning"></span>\n                            </div>\n                            <div class="brag-book-gallery-dialog-message">\n                                Are you sure you want to clear the error log? This action cannot be undone.\n                            </div>\n                        </div>\n                        <div class="brag-book-gallery-dialog-footer">\n                            <button type="button" class="button button-secondary brag-book-gallery-dialog-cancel">Cancel</button>\n                            <button type="button" class="button button-primary brag-book-gallery-dialog-confirm">Clear Log</button>\n                        </div>\n                    </div>\n                ',document.body.appendChild(t),t.showModal();const e=t.querySelector(".brag-book-gallery-dialog-confirm"),o=t.querySelector(".brag-book-gallery-dialog-cancel");e.addEventListener("click",async()=>{t.close(),t.remove();try{const t=await this.ajaxPost({action:"brag_book_gallery_clear_error_log",nonce:this.nonce});t.success?(a.textContent="No errors logged yet.",this.showDialog("Error log cleared successfully.","success")):this.showDialog(`Failed to clear log: ${t.data||"Unknown error"}`,"error")}catch(t){this.showDialog(`Error clearing log: ${t.message}`,"error")}}),o.addEventListener("click",()=>{t.close(),t.remove()}),t.addEventListener("click",e=>{e.target===t&&(t.close(),t.remove())})}),o&&a&&o.addEventListener("click",()=>{const t=a.textContent,e=new Blob([t],{type:"text/plain"}),o=window.URL.createObjectURL(e),n=document.createElement("a");n.href=o,n.download=`brag-book-gallery-error-log-${(new Date).toISOString().split("T")[0]}.txt`,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(o)})}initApiLog(){const t=document.getElementById("brag-book-gallery-refresh-api-log"),e=document.getElementById("brag-book-gallery-clear-api-log"),o=document.getElementById("brag-book-gallery-download-api-log"),a=document.getElementById("brag-book-gallery-api-log");t&&a&&t.addEventListener("click",async()=>{t.disabled=!0;const e=a.textContent;a.innerHTML='<span style="color: #666;">Loading...</span>';try{const t=await this.ajaxPost({action:"brag_book_gallery_get_api_log",nonce:this.nonce});t.success?(a.textContent=t.data.log||"No API requests logged yet.",this.showDialog("API log refreshed successfully.","success")):(a.textContent=e,this.showDialog(`Failed to load API log: ${t.data||"Unknown error"}`,"error"))}catch(t){a.textContent=e,this.showDialog(`Error loading log: ${t.message}`,"error")}finally{t.disabled=!1}}),e&&a&&e.addEventListener("click",async()=>{const t=document.createElement("dialog");t.className="brag-book-gallery-dialog",t.innerHTML='\n                    <div class="brag-book-gallery-dialog-content brag-book-gallery-dialog-warning">\n                        <div class="brag-book-gallery-dialog-header">\n                            <h3 class="brag-book-gallery-dialog-title">Confirm Clear API Log</h3>\n                            <button type="button" class="brag-book-gallery-dialog-close" aria-label="Close">\n                                <span class="dashicons dashicons-no-alt"></span>\n                            </button>\n                        </div>\n                        <div class="brag-book-gallery-dialog-body">\n                            <div class="brag-book-gallery-dialog-icon">\n                                <span class="dashicons dashicons-warning"></span>\n                            </div>\n                            <div class="brag-book-gallery-dialog-message">\n                                Are you sure you want to clear the API log? This action cannot be undone.\n                            </div>\n                        </div>\n                        <div class="brag-book-gallery-dialog-footer">\n                            <button type="button" class="button button-secondary brag-book-gallery-dialog-cancel">Cancel</button>\n                            <button type="button" class="button button-primary brag-book-gallery-dialog-confirm">Clear Log</button>\n                        </div>\n                    </div>\n                ',document.body.appendChild(t),t.showModal();const o=t.querySelector(".brag-book-gallery-dialog-confirm"),n=t.querySelector(".brag-book-gallery-dialog-cancel"),l=t.querySelector(".brag-book-gallery-dialog-close"),r=()=>{t.close(),t.remove()};o.addEventListener("click",async()=>{r(),e.disabled=!0;try{const t=await this.ajaxPost({action:"brag_book_gallery_clear_api_log",nonce:this.nonce});t.success?(a.textContent="No API requests logged yet.",this.showDialog("API log cleared successfully.","success")):this.showDialog(`Failed to clear API log: ${t.data||"Unknown error"}`,"error")}catch(t){this.showDialog(`Error clearing log: ${t.message}`,"error")}finally{e.disabled=!1}}),n.addEventListener("click",r),l.addEventListener("click",r)}),o&&a&&o.addEventListener("click",()=>{const t=a.textContent,e=new Blob([t],{type:"text/plain"}),o=window.URL.createObjectURL(e),n=document.createElement("a");n.href=o,n.download=`brag-book-gallery-api-log-${(new Date).toISOString().split("T")[0]}.txt`,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(o)})}initSystemInfo(){const t=document.getElementById("brag-book-gallery-copy-system-info"),e=document.getElementById("brag-book-gallery-export-system-info"),o=document.getElementById("brag-book-gallery-system-info");t&&o&&t.addEventListener("click",async()=>{const t=o.textContent;try{await navigator.clipboard.writeText(t);const e=document.getElementById("brag-book-gallery-copy-feedback");e&&(e.classList.add("show"),setTimeout(()=>e.classList.remove("show"),2e3)),this.showDialog("System information copied to clipboard.","success")}catch(e){const o=document.createElement("textarea");o.value=t,o.style.position="fixed",o.style.left="-999999px",document.body.appendChild(o),o.focus(),o.select();try{document.execCommand("copy");const t=document.getElementById("brag-book-gallery-copy-feedback");t&&(t.classList.add("show"),setTimeout(()=>t.classList.remove("show"),2e3)),this.showDialog("System information copied to clipboard.","success")}catch(t){this.showDialog("Failed to copy to clipboard. Please try again.","error")}document.body.removeChild(o)}}),e&&o&&e.addEventListener("click",()=>{const t=o.textContent,e=new Blob([t],{type:"text/plain"}),a=window.URL.createObjectURL(e),n=document.createElement("a");n.href=a,n.download=`brag-book-gallery-system-info-${(new Date).toISOString().split("T")[0]}.txt`,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(a)})}initDebugSettings(){const t=document.getElementById("brag-book-gallery-save-debug-settings"),e=document.getElementById("brag-book-gallery-debug-mode"),o=document.getElementById("brag-book-gallery-api-logging"),a=document.getElementById("wp-debug-mode"),n=document.getElementById("brag-book-gallery-log-level");t&&t.addEventListener("click",async()=>{const t=e&&e.checked?"1":"0",l=o&&o.checked?"1":"0",r=a&&a.checked?"1":"0",s=n?n.value:"error";try{const e=await this.ajaxPost({action:"brag_book_gallery_save_debug_settings",nonce:this.nonce,debug_mode:t,api_logging:l,wp_debug:r,log_level:s});if(e.success){this.showDialog(e.data.message||"Settings saved successfully.","success");const o=document.querySelector(".brag-book-gallery-debug-status");o&&("1"===t?(o.classList.add("active"),o.innerHTML='<span class="dashicons dashicons-yes-alt"></span> Active'):(o.classList.remove("active"),o.innerHTML='<span class="dashicons dashicons-no-alt"></span> Inactive'))}else this.showDialog(`Failed to save debug settings: ${e.data||"Unknown error"}`,"error")}catch(t){this.showDialog(`Error saving settings: ${t.message}`,"error")}})}initApiValidation(){document.querySelectorAll(".brag-book-gallery-validate-api").forEach(t=>{t.addEventListener("click",async t=>{const e=t.target.closest(".brag-book-gallery-api-row");if(!e)return;const o=e.querySelector('input[name*="api_token"]'),a=e.querySelector('input[name*="website_property_id"]'),n=e.querySelector(".brag-book-gallery-api-status");if(!o||!a)return;const l=o.value.trim(),r=a.value.trim();if(l&&r){n&&(n.innerHTML='<span class="spinner is-active"></span> Validating...');try{const t=await this.ajaxPost({action:"brag_book_gallery_validate_api",nonce:this.nonce,api_token:l,website_property_id:r});if(n)if(t.success&&t.data.valid)n.innerHTML='<span class="dashicons dashicons-yes" style="color: #46b450;"></span> <span style="color: #46b450;">Connected</span>',this.showDialog("API credentials validated successfully!","success");else{const e=t.data?.message||"Invalid credentials";n.innerHTML=`<span class="dashicons dashicons-no" style="color: #dc3232;"></span> <span style="color: #dc3232;">${e}</span>`,this.showDialog(`API validation failed: ${e}`,"error")}}catch(t){n&&(n.innerHTML='<span class="dashicons dashicons-warning" style="color: #ffb900;"></span> <span style="color: #ffb900;">Connection error</span>'),this.showDialog(`Connection error: ${t.message}`,"error")}}else this.showDialog("Please enter both API Token and Website Property ID","warning")})})}async ajaxPost(t){const e=new FormData;for(const o in t)e.append(o,t[o]);const o=await fetch(this.ajaxUrl,{method:"POST",credentials:"same-origin",body:e});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const a=o.headers.get("content-type");if(a&&a.includes("application/json"))return await o.json();{const t=await o.text();try{return JSON.parse(t)}catch(e){if(t.includes("<div")||t.includes("<!DOCTYPE"))throw console.error("Server returned HTML instead of JSON:",t),new Error("Server returned an HTML error page. Please check PHP error logs.");throw console.error("Invalid JSON response:",t),new Error("Invalid server response format")}}}initFactoryReset(){const t=document.getElementById("brag-book-gallery-factory-reset");t&&t.addEventListener("click",async e=>{e.preventDefault();const o=document.createElement("dialog");o.className="brag-book-gallery-dialog brag-book-gallery-factory-reset-dialog",o.innerHTML='\n\t\t\t\t\t<div class="brag-book-gallery-dialog-content brag-book-gallery-dialog-danger">\n\t\t\t\t\t\t<div class="brag-book-gallery-dialog-header">\n\t\t\t\t\t\t\t<h3 class="brag-book-gallery-dialog-title">⚠️ Factory Reset Warning</h3>\n\t\t\t\t\t\t\t<button type="button" class="brag-book-gallery-dialog-close" aria-label="Close">\n\t\t\t\t\t\t\t\t<span class="dashicons dashicons-no-alt"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="brag-book-gallery-dialog-body">\n\t\t\t\t\t\t\t<div class="brag-book-gallery-dialog-icon">\n\t\t\t\t\t\t\t\t<span class="dashicons dashicons-warning"></span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="brag-book-gallery-dialog-message">\n\t\t\t\t\t\t\t\t<p><strong>This will PERMANENTLY delete:</strong></p>\n\t\t\t\t\t\t\t\t<ul style="text-align: left; margin: 10px 0;">\n\t\t\t\t\t\t\t\t\t<li>All plugin settings and configurations</li>\n\t\t\t\t\t\t\t\t\t<li>All pages containing the [brag_book_gallery] shortcode</li>\n\t\t\t\t\t\t\t\t\t<li>All cached data and transients</li>\n\t\t\t\t\t\t\t\t\t<li>All API tokens and credentials</li>\n\t\t\t\t\t\t\t\t\t<li>Custom database tables</li>\n\t\t\t\t\t\t\t\t\t<li>All log files</li>\n\t\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t\t\t<p><strong style="color: #dc3232;">This action CANNOT be undone!</strong></p>\n\t\t\t\t\t\t\t\t<p>Are you absolutely sure you want to continue?</p>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="brag-book-gallery-dialog-footer">\n\t\t\t\t\t\t\t<button type="button" class="button button-secondary brag-book-gallery-dialog-cancel">Cancel</button>\n\t\t\t\t\t\t\t<button type="button" class="button button-danger brag-book-gallery-dialog-confirm">Continue to Final Warning</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t',document.body.appendChild(o),o.showModal();const a=o.querySelector(".brag-book-gallery-dialog-confirm"),n=o.querySelector(".brag-book-gallery-dialog-cancel"),l=o.querySelector(".brag-book-gallery-dialog-close"),r=()=>{o.close(),o.remove()};n.addEventListener("click",r),l.addEventListener("click",r),o.addEventListener("click",t=>{t.target===o&&r()}),a.addEventListener("click",()=>{r();const e=document.createElement("dialog");e.className="brag-book-gallery-dialog brag-book-gallery-factory-reset-dialog",e.innerHTML='\n\t\t\t\t\t\t<div class="brag-book-gallery-dialog-content brag-book-gallery-dialog-danger">\n\t\t\t\t\t\t\t<div class="brag-book-gallery-dialog-header">\n\t\t\t\t\t\t\t\t<h3 class="brag-book-gallery-dialog-title">🛑 FINAL WARNING</h3>\n\t\t\t\t\t\t\t\t<button type="button" class="brag-book-gallery-dialog-close" aria-label="Close">\n\t\t\t\t\t\t\t\t\t<span class="dashicons dashicons-no-alt"></span>\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="brag-book-gallery-dialog-body">\n\t\t\t\t\t\t\t\t<div class="brag-book-gallery-dialog-icon">\n\t\t\t\t\t\t\t\t\t<span class="dashicons dashicons-dismiss"></span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div class="brag-book-gallery-dialog-message">\n\t\t\t\t\t\t\t\t\t<p>You are about to <strong>completely reset</strong> the BRAG Book Gallery plugin.</p>\n\t\t\t\t\t\t\t\t\t<p>Please confirm one more time that you want to proceed with the factory reset.</p>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="brag-book-gallery-dialog-footer">\n\t\t\t\t\t\t\t\t<button type="button" class="button button-secondary brag-book-gallery-dialog-cancel">Cancel</button>\n\t\t\t\t\t\t\t\t<button type="button" class="button button-danger brag-book-gallery-dialog-reset">Yes, Factory Reset</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t',document.body.appendChild(e),e.showModal();const o=e.querySelector(".brag-book-gallery-dialog-reset"),a=e.querySelector(".brag-book-gallery-dialog-cancel"),n=e.querySelector(".brag-book-gallery-dialog-close"),l=()=>{e.close(),e.remove()};a.addEventListener("click",l),n.addEventListener("click",l),e.addEventListener("click",t=>{t.target===e&&l()}),o.addEventListener("click",async()=>{l(),t.disabled=!0;const e=t.textContent;t.textContent="Resetting... Please wait...";try{const e=t.getAttribute("data-nonce"),o=this.nonce||e||"";if(!o)throw new Error("Security nonce not found. Please refresh the page and try again.");const a=await this.ajaxPost({action:"brag_book_gallery_factory_reset",nonce:o,confirm:!0});if(!a||"object"!=typeof a)throw new Error("Invalid server response. Please check error logs.");if(!a.success)throw new Error(a.data?.message||a.data||"Factory reset failed");this.showDialog(a.data.message||"Plugin has been successfully reset to factory defaults.","success","Factory Reset Complete"),setTimeout(()=>{a.data.redirect?window.location.href=a.data.redirect:window.location.reload()},2e3)}catch(o){console.error("Factory reset error:",o),this.showDialog(`Failed to reset plugin: ${o.message}`,"error","Factory Reset Failed"),t.disabled=!1,t.textContent=e}})})})}}),void 0===window.bragBookAdminInstance&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.bragBookAdminInstance=new window.BRAGbookAdmin}):window.bragBookAdminInstance=new window.BRAGbookAdmin)}();