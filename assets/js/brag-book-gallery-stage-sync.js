!function(){"use strict";var t=class{constructor(t,e={}){this.dialog=document.getElementById(t),this.closeButtons=this.dialog?.querySelectorAll('[data-action*="close"]'),this.options={closeOnBackdrop:!1!==e.closeOnBackdrop,closeOnEscape:!1!==e.closeOnEscape,onOpen:e.onOpen||(()=>{}),onClose:e.onClose||(()=>{}),...e},this.dialog&&this.init()}init(){this.setupEventListeners()}setupEventListeners(){this.closeButtons?.forEach(t=>{t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.close()})}),this.options.closeOnBackdrop&&this.dialog&&this.dialog.addEventListener("click",t=>{t.target===this.dialog&&this.close()}),this.options.closeOnEscape&&this.dialog&&this.dialog.addEventListener("cancel",t=>{t.preventDefault(),this.close()})}open(){if(this.dialog)try{this.dialog.showModal(),document.body.style.overflow="hidden",this.options.onOpen()}catch(t){console.error("Error opening dialog:",t),this.dialog.setAttribute("open",""),this.dialog.style.display="block",document.body.style.overflow="hidden",this.options.onOpen()}}close(){if(this.dialog)try{this.dialog.close(),document.body.style.overflow="",this.dialog.style.display="",this.options.onClose()}catch(t){console.error("Error closing dialog:",t),this.dialog.removeAttribute("open"),this.dialog.style.display="none",document.body.style.overflow="",this.options.onClose()}}isOpen(){return this.dialog?.open||this.dialog?.hasAttribute("open")}};const e=new class{constructor(){this.activeDialogs=new Map,this.dialogCounter=0}show(e,s,a,n={}){const o="sync-dialog-"+ ++this.dialogCounter,i={autoClose:"success"===e,delay:5e3,onClose:null,...n},r=this.createDialogElement(o,e,s,a);document.body.appendChild(r);const c=new t(o,{closeOnBackdrop:!0,closeOnEscape:!0,onClose:()=>{setTimeout(()=>{r.remove(),this.activeDialogs.delete(o)},300),i.onClose&&i.onClose()}});return this.activeDialogs.set(o,c),c.open(),i.autoClose&&setTimeout(()=>{c.isOpen()&&c.close()},i.delay),o}showSuccess(t,e,s={}){return this.show("success",t,e,s)}showError(t,e,s={}){return this.show("error",t,e,{autoClose:!1,...s})}showWarning(t,e,s={}){return this.show("warning",t,e,{autoClose:!1,...s})}showInfo(t,e,s={}){return this.show("info",t,e,s)}showConfirm(e,s,a={}){const n="sync-confirm-dialog-"+ ++this.dialogCounter,o={onConfirm:null,onCancel:null,confirmText:"Confirm",cancelText:"Cancel",confirmButtonClass:"button-danger",...a},i=this.createConfirmDialogElement(n,e,s,o);document.body.appendChild(i);const r=new t(n,{closeOnBackdrop:!0,closeOnEscape:!0,onClose:()=>{setTimeout(()=>{i.remove(),this.activeDialogs.delete(n)},300)}});this.activeDialogs.set(n,r);const c=i.querySelector('[data-action="confirm"]'),l=i.querySelector('[data-action="cancel"]');return c&&c.addEventListener("click",()=>{o.onConfirm&&o.onConfirm(),r.close()}),l&&l.addEventListener("click",()=>{o.onCancel&&o.onCancel(),r.close()}),r.open(),n}close(t){const e=this.activeDialogs.get(t);e&&e.close()}closeAll(){this.activeDialogs.forEach(t=>{t.close()})}createDialogElement(t,e,s,a){const n=document.createElement("dialog");n.id=t,n.className=`brag-book-gallery-dialog brag-book-gallery-dialog-${e}`;const o=this.getDialogIcon(e);return n.innerHTML=`\n\t\t\t<div class="brag-book-gallery-dialog-content">\n\t\t\t\t<div class="brag-book-gallery-dialog-header">\n\t\t\t\t\t<h3 class="brag-book-gallery-dialog-title">${this.escapeHtml(s)}</h3>\n\t\t\t\t\t<button type="button" class="brag-book-gallery-dialog-close" data-action="close" aria-label="Close dialog">\n\t\t\t\t\t\t<span class="dashicons dashicons-no-alt"></span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t\t<div class="brag-book-gallery-dialog-body">\n\t\t\t\t\t<div class="brag-book-gallery-dialog-icon">\n\t\t\t\t\t\t<span class="dashicons dashicons-${o}"></span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="brag-book-gallery-dialog-message">\n\t\t\t\t\t\t${this.escapeHtml(a)}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="brag-book-gallery-dialog-footer">\n\t\t\t\t\t<button type="button" class="button button-primary" data-action="close">OK</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`,n}createConfirmDialogElement(t,e,s,a){const n=document.createElement("dialog");return n.id=t,n.className="brag-book-gallery-dialog brag-book-gallery-dialog-danger",n.innerHTML=`\n\t\t\t<div class="brag-book-gallery-dialog-content">\n\t\t\t\t<div class="brag-book-gallery-dialog-header">\n\t\t\t\t\t<h3 class="brag-book-gallery-dialog-title">${this.escapeHtml(e)}</h3>\n\t\t\t\t\t<button type="button" class="brag-book-gallery-dialog-close" data-action="close" aria-label="Close dialog">\n\t\t\t\t\t\t<span class="dashicons dashicons-no-alt"></span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t\t<div class="brag-book-gallery-dialog-body">\n\t\t\t\t\t<div class="brag-book-gallery-dialog-icon">\n\t\t\t\t\t\t<span class="dashicons dashicons-warning"></span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="brag-book-gallery-dialog-message">\n\t\t\t\t\t\t${this.escapeHtml(s)}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="brag-book-gallery-dialog-footer">\n\t\t\t\t\t<button type="button" class="button button-secondary" data-action="cancel">\n\t\t\t\t\t\t${this.escapeHtml(a.cancelText)}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="button ${a.confirmButtonClass}" data-action="confirm">\n\t\t\t\t\t\t${this.escapeHtml(a.confirmText)}\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`,n}getDialogIcon(t){return{success:"yes-alt",error:"dismiss",warning:"warning",info:"info"}[t]||"info"}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}};class s{constructor(){this.stage1Btn=document.getElementById("stage-1-btn"),this.stage2Btn=document.getElementById("stage-2-btn"),this.stage3Btn=document.getElementById("stage-3-btn"),this.fullSyncBtn=document.getElementById("full-sync-btn"),this.stopSyncBtn=document.getElementById("stop-sync-btn"),this.deleteSyncDataBtn=document.getElementById("delete-sync-data-btn"),this.deleteManifestBtn=document.getElementById("delete-manifest-btn"),this.clearStage3StatusBtn=document.getElementById("clear-stage3-status-btn"),this.syncDataStatus=document.getElementById("sync-data-status"),this.syncDataDate=document.getElementById("sync-data-date"),this.manifestStatus=document.getElementById("manifest-status"),this.manifestDate=document.getElementById("manifest-date"),this.stageProgress=document.getElementById("stage-progress"),this.stageProgressFill=document.getElementById("stage-progress-fill"),this.stageProgressText=document.getElementById("stage-progress-text"),this.stageProgress||console.error("Stage progress element not found"),this.stageProgressFill||console.error("Stage progress fill element not found"),this.stageProgressText||console.error("Stage progress text element not found"),this.manifestPreview=document.getElementById("manifest-preview"),this.manifestPreviewContent=document.getElementById("manifest-preview-content"),this.stage1Status=document.getElementById("stage1-status"),this.stage1StatusContent=document.getElementById("stage1-status-content"),this.stage3Status=document.getElementById("stage3-status"),this.stage3StatusContent=document.getElementById("stage3-status-content"),this.isRunning=!1,this.shouldStop=!1,this.currentProgressInterval=null,this.init()}init(){this.checkFileStatus(),this.stage1Btn&&this.stage1Btn.addEventListener("click",()=>this.executeStage1()),this.stage2Btn&&this.stage2Btn.addEventListener("click",()=>this.executeStage2()),this.stage3Btn&&this.stage3Btn.addEventListener("click",()=>this.executeStage3()),this.fullSyncBtn&&this.fullSyncBtn.addEventListener("click",()=>this.executeFullSync()),this.stopSyncBtn&&this.stopSyncBtn.addEventListener("click",()=>this.stopSync()),this.deleteSyncDataBtn&&this.deleteSyncDataBtn.addEventListener("click",()=>this.deleteSyncData()),this.deleteManifestBtn&&this.deleteManifestBtn.addEventListener("click",()=>this.deleteManifest()),this.clearStage3StatusBtn&&this.clearStage3StatusBtn.addEventListener("click",()=>this.clearStage3Status()),setInterval(()=>{this.isRunning||this.checkFileStatus(!0)},3e4)}async checkFileStatus(t=!1){try{const t=await this.makeAjaxRequest("brag_book_sync_check_files");if(t.success){const e=t.data,s='<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#46b450"><path d="m424-296 282-282-56-56-226 226-114-114-56 56 170 170Zm56 216q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/></svg>',a='<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#ccc"><path d="m336-280 144-144 144 144 56-56-144-144 144-144-56-56-144 144-144-144-56 56 144 144-144 144 56 56ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/></svg>';if(e.sync_data.exists){const t=this.syncDataStatus?.querySelector(".status-icon");t&&(t.innerHTML=s),this.syncDataDate&&(this.syncDataDate.textContent=`(${e.sync_data.date})`);const a=document.getElementById("sync-data-link");a&&(e.sync_data.url?(a.href=e.sync_data.url,a.style.display="inline"):a.style.display="none"),e.stage1_info?this.displayStage1Status(e.stage1_info):this.stage1Status&&(this.stage1StatusContent.innerHTML="<div>Sync data file exists</div>",this.stage1Status.style.display="block")}else{const t=this.syncDataStatus?.querySelector(".status-icon");t&&(t.innerHTML=a),this.syncDataDate&&(this.syncDataDate.textContent="");const e=document.getElementById("sync-data-link");e&&(e.style.display="none"),this.stage1Status&&(this.stage1Status.style.display="none")}if(e.manifest.exists){const t=this.manifestStatus?.querySelector(".status-icon");t&&(t.innerHTML=s),this.manifestDate&&(this.manifestDate.textContent=`(${e.manifest.date})`);const a=document.getElementById("manifest-link");a&&(e.manifest.url?(a.href=e.manifest.url,a.style.display="inline"):a.style.display="none"),this.loadManifestPreview()}else{const t=this.manifestStatus?.querySelector(".status-icon");t&&(t.innerHTML=a),this.manifestDate&&(this.manifestDate.textContent="");const e=document.getElementById("manifest-link");e&&(e.style.display="none"),this.manifestPreview&&(this.manifestPreview.style.display="none")}e.stage3_status&&e.stage3_status.completed_at?this.displayStage3Status(e.stage3_status):this.stage3Status&&(this.stage3Status.style.display="none"),this.updateButtonStates(e)}}catch(e){t||console.error("Failed to check file status:",e)}}updateButtonStates(t){this.stage1Btn&&(this.stage1Btn.classList.remove("button-primary"),this.stage1Btn.classList.add("button")),this.stage2Btn&&(this.stage2Btn.classList.remove("button-primary"),this.stage2Btn.classList.add("button")),this.stage3Btn&&(this.stage3Btn.classList.remove("button-primary"),this.stage3Btn.classList.add("button")),t.sync_data.exists?t.manifest.exists?(this.stage2Btn&&(this.stage2Btn.disabled=!1,this.stage2Btn.title="Build case ID manifest"),this.stage3Btn&&(this.stage3Btn.classList.remove("button"),this.stage3Btn.classList.add("button-primary"),this.stage3Btn.disabled=!1,this.stage3Btn.title="Process cases from manifest")):(this.stage2Btn&&(this.stage2Btn.classList.remove("button"),this.stage2Btn.classList.add("button-primary"),this.stage2Btn.disabled=!1,this.stage2Btn.title="Build case ID manifest"),this.stage3Btn&&(this.stage3Btn.disabled=!0,this.stage3Btn.title="Stage 2 must be completed first")):(this.stage1Btn&&(this.stage1Btn.classList.remove("button"),this.stage1Btn.classList.add("button-primary")),this.stage2Btn&&(this.stage2Btn.disabled=!0,this.stage2Btn.title="Stage 1 must be completed first"),this.stage3Btn&&(this.stage3Btn.disabled=!0,this.stage3Btn.title="Stage 1 and Stage 2 must be completed first"))}async executeStage1(){this.isRunning||e.showConfirm("Execute Stage 1","Fetch sidebar data and process procedures?",{confirmText:"Execute",cancelText:"Cancel",confirmButtonClass:"button-primary",onConfirm:()=>this.executeStage1Confirmed()})}async executeStage1Confirmed(){this.isRunning=!0,this.stage1Btn&&(this.stage1Btn.disabled=!0),this.showProgress("Stage 1: Fetching sidebar data...");try{const t=await this.makeAjaxRequest("brag_book_sync_stage_1");if(!t.success)throw new Error(t.data?.message||"Stage 1 failed");{const e=t.data;this.showProgress("Stage 1 completed",100),this.displayStage1Status(e),this.showNotice("success",`Stage 1 completed: ${e.procedures_created} procedures created, ${e.procedures_updated} updated`),await this.checkFileStatus(),setTimeout(()=>{this.fadeOut(this.stageProgress)},2e3)}}catch(t){console.error("Stage 1 error:",t),this.showNotice("error",`Stage 1 failed: ${t.message}`),this.stageProgress&&(this.stageProgress.style.display="none")}finally{this.isRunning=!1,this.stage1Btn&&(this.stage1Btn.disabled=!1)}}async executeStage2(){this.isRunning||e.showConfirm("Execute Stage 2","Build case ID manifest? This may take several minutes.",{confirmText:"Execute",cancelText:"Cancel",confirmButtonClass:"button-primary",onConfirm:()=>this.executeStage2Confirmed()})}async executeStage2Confirmed(){this.isRunning=!0,this.stage2Btn&&(this.stage2Btn.disabled=!0),this.showProgress("Stage 2: Starting manifest creation...");const t=setInterval(async()=>{try{const t=await this.makeAjaxRequest("brag_book_sync_get_progress");if(t.success&&t.data.active){const e=t.data,s=e.percentage||0,a=e.message||"Processing...";this.showProgress(`Stage 2: ${a}`,s)}}catch(t){console.error("Progress polling error:",t)}},2e3);try{const e=await this.makeAjaxRequest("brag_book_sync_stage_2",{},3e5);if(clearInterval(t),!e.success)throw new Error(e.data?.message||"Stage 2 failed");{const t=e.data;this.showProgress("Stage 2 completed",100);const s=t.file_exists?`Manifest already exists: ${t.procedure_count} procedures, ${t.case_count} cases`:`Stage 2 completed: ${t.procedure_count} procedures, ${t.case_count} cases mapped`;this.showNotice("success",s),await this.checkFileStatus(),setTimeout(()=>{this.fadeOut(this.stageProgress)},2e3)}}catch(e){clearInterval(t),console.error("Stage 2 error:",e),this.showNotice("error",`Stage 2 failed: ${e.message}`),this.stageProgress&&(this.stageProgress.style.display="none")}finally{this.isRunning=!1,this.stage2Btn&&(this.stage2Btn.disabled=!1)}}async executeStage3(){this.isRunning||e.showConfirm("Execute Stage 3","Process cases from manifest? This will process cases in batches.",{confirmText:"Execute",cancelText:"Cancel",confirmButtonClass:"button-primary",onConfirm:()=>this.executeStage3Confirmed()})}async executeStage3Confirmed(){this.isRunning=!0,this.stage3Btn&&(this.stage3Btn.disabled=!0),this.showProgress("Stage 3: Starting case processing...");const t=setInterval(async()=>{try{const t=await this.makeAjaxRequest("brag_book_sync_get_progress");if(t.success&&t.data.active){const e=t.data,s=e.percentage||0,a=e.message||"Processing...";this.showProgress(`Stage 3: ${a}`,s)}}catch(t){console.error("Progress polling error:",t)}},2e3);try{await this.processStage3Batches(t),clearInterval(t)}catch(e){clearInterval(t),console.error("Stage 3 error:",e),this.showNotice("error",`Stage 3 failed: ${e.message}`),this.stageProgress&&(this.stageProgress.style.display="none")}finally{this.isRunning=!1,this.stage3Btn&&(this.stage3Btn.disabled=!1),await this.checkFileStatus()}}async processStage3Batches(t){let e=!0,s=0,a=0,n=0,o=0,i=0,r=-1,c=0;for(;e;){const t=await this.makeAjaxRequest("brag_book_sync_stage_3",{},18e4);if(!t.success)throw new Error(t.data?.message||t.data?.error||"Stage 3 batch failed");const l=t.data;if(s=l.processed_cases||0,a=l.created_posts||0,n=l.updated_posts||0,o=l.failed_cases||0,i=l.total_cases||0,e=l.needs_continue||!1,s===r){if(c++,console.warn(`Stage 3: No progress detected (attempt ${c}/3)`),c>=3){this.showNotice("warning",`Processing stopped at ${s}/${i} cases - no further progress possible`),e=!1;break}}else c=0;r=s;const d=l.progress||s/i*100;this.showProgress(`Stage 3: Processing cases... ${s}/${i}`,d),e&&await new Promise(t=>setTimeout(t,500))}this.showProgress("Stage 3 completed",100);const l=`Stage 3 completed: ${a} created, ${n} updated${o>0?`, ${o} failed`:""} (${s}/${i} processed)`;this.showNotice("success",l),await this.checkFileStatus(),setTimeout(()=>{this.fadeOut(this.stageProgress)},2e3)}async executeFullSync(){this.isRunning||e.showConfirm("Execute Full Sync","This will run all three stages sequentially and may take a considerable amount of time. Continue?",{confirmText:"Execute",cancelText:"Cancel",confirmButtonClass:"button-primary",onConfirm:()=>this.executeFullSyncConfirmed()})}async executeFullSyncConfirmed(){this.isRunning=!0,this.shouldStop=!1,this.setAllButtonsDisabled(!0),this.showStopButton(!0);try{this.showProgress("Full Sync - Stage 1: Fetching procedures...",0);const t=await this.makeAjaxRequest("brag_book_sync_stage_1");if(!t.success)throw new Error(t.data?.message||"Stage 1 failed");if(t.data,this.showProgress("Full Sync - Stage 1 completed",33),await this.checkFileStatus(!0),this.shouldStop)throw new Error("Sync stopped by user");this.showProgress("Full Sync - Stage 2: Building manifest...",33),this.currentProgressInterval=setInterval(async()=>{try{const t=await this.makeAjaxRequest("brag_book_sync_get_progress");if(t.success&&t.data.active){const e=t.data,s=33+.33*(e.percentage||0),a=e.message||"Processing...";this.showProgress(`Full Sync - Stage 2: ${a}`,s)}}catch(t){console.error("Progress polling error:",t)}},2e3);const e=await this.makeAjaxRequest("brag_book_sync_stage_2",{},3e5);if(clearInterval(this.currentProgressInterval),this.currentProgressInterval=null,!e.success)throw new Error(e.data?.message||"Stage 2 failed");if(e.data,this.showProgress("Full Sync - Stage 2 completed",66),await this.checkFileStatus(!0),this.shouldStop)throw new Error("Sync stopped by user");this.showProgress("Full Sync - Stage 3: Processing cases...",66),this.currentProgressInterval=setInterval(async()=>{try{const t=await this.makeAjaxRequest("brag_book_sync_get_progress");if(t.success&&t.data.active){const e=t.data,s=66+.34*(e.percentage||0),a=e.message||"Processing...";this.showProgress(`Full Sync - Stage 3: ${a}`,s)}}catch(t){console.error("Progress polling error:",t)}},2e3);let s=!0,a=0,n=0,o=0,i=0,r=0,c=-1,l=0;for(;s;){if(this.shouldStop)throw new Error("Sync stopped by user");const t=await this.makeAjaxRequest("brag_book_sync_stage_3",{},18e4);if(!t.success)throw new Error(t.data?.message||t.data?.error||"Stage 3 failed");const e=t.data;if(a=e.created_posts||0,n=e.updated_posts||0,o=e.failed_cases||0,i=e.processed_cases||0,r=e.total_cases||0,s=e.needs_continue||!1,i===c){if(l++,console.warn(`Full Sync Stage 3: No progress detected (attempt ${l}/3)`),l>=3){this.showNotice("warning",`Stage 3 processing stopped at ${i}/${r} cases - no further progress possible`),s=!1;break}}else l=0;c=i;const d=66+34*(r>0?i/r:1);this.showProgress(`Full Sync - Stage 3: ${i}/${r} cases`,d),s&&await new Promise(t=>setTimeout(t,500))}clearInterval(this.currentProgressInterval),this.currentProgressInterval=null,this.showProgress("Full Sync completed successfully!",100);const d=`Full Sync completed successfully! ${a} cases created, ${n} updated${o>0?`, ${o} failed`:""} (${i}/${r} total)`;this.showNotice("success",d),await this.checkFileStatus(),setTimeout(()=>{this.fadeOut(this.stageProgress)},3e3)}catch(t){this.currentProgressInterval&&(clearInterval(this.currentProgressInterval),this.currentProgressInterval=null),this.shouldStop?(this.showNotice("warning","Full Sync stopped by user"),this.showProgress("Sync stopped",0)):(console.error("Full Sync error:",t),this.showNotice("error",`Full Sync failed: ${t.message}`)),setTimeout(()=>{this.stageProgress&&(this.stageProgress.style.display="none")},3e3)}finally{this.isRunning=!1,this.shouldStop=!1,this.setAllButtonsDisabled(!1),this.showStopButton(!1),await this.checkFileStatus()}}stopSync(){this.isRunning&&e.showConfirm("Stop Sync","Are you sure you want to stop the sync process?",{confirmText:"Stop",cancelText:"Cancel",confirmButtonClass:"button-danger",onConfirm:()=>{this.shouldStop=!0,this.showNotice("info","Stopping sync process..."),this.currentProgressInterval&&(clearInterval(this.currentProgressInterval),this.currentProgressInterval=null)}})}showStopButton(t){this.stopSyncBtn&&(this.stopSyncBtn.style.display=t?"inline-flex":"none")}setAllButtonsDisabled(t){this.stage1Btn&&(this.stage1Btn.disabled=t),this.stage2Btn&&(this.stage2Btn.disabled=t),this.stage3Btn&&(this.stage3Btn.disabled=t),this.fullSyncBtn&&(this.fullSyncBtn.disabled=t)}async deleteSyncData(){this.isRunning?this.showNotice("error","Cannot delete files while sync is running"):e.showConfirm("Delete Sync Data","Are you sure you want to delete the sync data file? This will require running Stage 1 again.",{confirmText:"Delete",cancelText:"Cancel",confirmButtonClass:"button-danger",onConfirm:()=>this.deleteSyncDataConfirmed()})}async deleteSyncDataConfirmed(){try{const t=await this.makeAjaxRequest("brag_book_sync_delete_file",{file:"sync_data"});t.success?(this.showNotice("success","Sync data file deleted successfully"),await this.checkFileStatus()):this.showNotice("error",t.data?.message||"Failed to delete sync data file")}catch(t){this.showNotice("error",`Error deleting sync data: ${t.message}`)}}async deleteManifest(){this.isRunning?this.showNotice("error","Cannot delete files while sync is running"):e.showConfirm("Delete Manifest","Are you sure you want to delete the manifest file? This will require running Stage 2 again.",{confirmText:"Delete",cancelText:"Cancel",confirmButtonClass:"button-danger",onConfirm:()=>this.deleteManifestConfirmed()})}async deleteManifestConfirmed(){try{const t=await this.makeAjaxRequest("brag_book_sync_delete_file",{file:"manifest"});t.success?(this.showNotice("success","Manifest file deleted successfully"),await this.checkFileStatus()):this.showNotice("error",t.data?.message||"Failed to delete manifest file")}catch(t){this.showNotice("error",`Error deleting manifest: ${t.message}`)}}async loadManifestPreview(){try{const t=await this.makeAjaxRequest("brag_book_sync_get_manifest_preview");if(t.success&&t.data.exists){const e=t.data;let s='<div style="margin-bottom: 10px;">';if(s+=`<strong>Date:</strong> ${e.date}<br>`,s+=`<strong>Total Procedures:</strong> ${e.total_procedures}<br>`,s+=`<strong>Total Cases:</strong> ${e.total_cases}<br>`,s+="</div>",e.preview){s+='<div style="border-top: 1px solid #ddd; padding-top: 10px;">',s+="<strong>Preview (first 5):</strong><br>";for(const[t,a]of Object.entries(e.preview))s+='<div style="margin: 5px 0;">',s+=`Procedure ${t}: ${a.case_count} cases`,a.sample_ids&&a.sample_ids.length>0&&(s+=` (${a.sample_ids.join(", ")}...)`),s+="</div>";s+="</div>"}this.manifestPreviewContent&&(this.manifestPreviewContent.innerHTML=s),this.manifestPreview&&(this.manifestPreview.style.display="block")}}catch(t){console.error("Failed to load manifest preview:",t)}}displayStage1Status(t){if(!t||!this.stage1Status||!this.stage1StatusContent)return void(this.stage1Status&&(this.stage1Status.style.display="none"));let e='<div style="margin-bottom: 10px;">';e+="<strong>Sync data file created successfully</strong><br>",e+="</div>",e+='<div style="border-top: 1px solid #ddd; padding-top: 10px;">',e+="<strong>Results:</strong><br>",e+='<div style="margin: 5px 0;">',e+=`Created: ${t.procedures_created||0} procedures<br>`,e+=`Updated: ${t.procedures_updated||0} procedures<br>`,e+=`Total: ${t.total_procedures||t.procedures_created+t.procedures_updated||0} procedures`,e+="</div>",e+="</div>",this.stage1StatusContent.innerHTML=e,this.stage1Status.style.display="block"}displayStage3Status(t){if(!t||!this.stage3Status||!this.stage3StatusContent)return void(this.stage3Status&&(this.stage3Status.style.display="none"));let e='<div style="margin-bottom: 10px;">';e+=`<strong>Last Run:</strong> ${t.completed_at}<br>`,t.completed_at_human&&(e+=`<span style="color: #666; font-size: 12px;">(${t.completed_at_human})</span><br>`),e+="</div>",e+='<div style="border-top: 1px solid #ddd; padding-top: 10px;">',e+="<strong>Results:</strong><br>",e+='<div style="margin: 5px 0;">',e+=`Created: ${t.created_posts||0} cases<br>`,e+=`Updated: ${t.updated_posts||0} cases<br>`,t.failed_cases>0&&(e+=`Failed: ${t.failed_cases} cases<br>`),e+=`Total Processed: ${t.processed_cases||0} / ${t.total_cases||0} cases`,e+="</div>",e+="</div>",e+='<button type="button" id="clear-stage3-status-btn" class="button button-link-delete" style="margin-top: 10px; font-size: 12px;" title="Clear Stage 3 status">',e+='<svg xmlns="http://www.w3.org/2000/svg" height="16px" viewBox="0 -960 960 960" width="16px" fill="currentColor" style="vertical-align: middle; margin-right: 4px;"><path d="m336-293.85 144-144 144 144L666.15-336l-144-144 144-144L624-666.15l-144 144-144-144L293.85-624l144 144-144 144L336-293.85ZM480.07-100q-78.84 0-148.21-29.92t-120.68-81.21q-51.31-51.29-81.25-120.63Q100-401.1 100-479.93q0-78.84 29.92-148.21t81.21-120.68q51.29-51.31 120.63-81.25Q401.1-860 479.93-860q78.84 0 148.21 29.92t120.68 81.21q51.31 51.29 81.25 120.63Q860-558.9 860-480.07q0 78.84-29.92 148.21t-81.21 120.68q-51.29 51.31-120.63 81.25Q558.9-100 480.07-100Z"/></svg>',e+="Clear Status",e+="</button>",this.stage3StatusContent.innerHTML=e,this.stage3Status.style.display="block";const s=document.getElementById("clear-stage3-status-btn");s&&s.addEventListener("click",()=>this.clearStage3Status())}async clearStage3Status(){e.showConfirm("Clear Stage 3 Status","Are you sure you want to clear the Stage 3 status? This will not delete the synced posts.",{confirmText:"Clear",cancelText:"Cancel",confirmButtonClass:"button-danger",onConfirm:()=>this.clearStage3StatusConfirmed()})}async clearStage3StatusConfirmed(){try{const t=await this.makeAjaxRequest("brag_book_sync_clear_stage3_status");t.success?(this.showNotice("success","Stage 3 status cleared successfully"),this.stage3Status&&(this.stage3Status.style.display="none")):this.showNotice("error",t.data?.message||"Failed to clear Stage 3 status")}catch(t){this.showNotice("error",`Error clearing Stage 3 status: ${t.message}`)}}showProgress(t,e=0){this.stageProgress&&(this.stageProgress.style.display="block",this.stageProgress.style.opacity="1",this.stageProgress.style.transition="opacity 0.3s ease-in"),this.stageProgressFill&&(this.stageProgressFill.style.width=`${e}%`),this.stageProgressText&&(this.stageProgressText.textContent=t)}showNotice(t,s){const a={success:"Success",error:"Error",warning:"Warning",info:"Information"}[t]||"Notification";switch(t){case"success":e.showSuccess(a,s);break;case"error":e.showError(a,s);break;case"warning":e.showWarning(a,s);break;default:e.showInfo(a,s)}}fadeOut(t,e){t&&(t.style.transition="opacity 0.3s ease-out",t.style.opacity="0",setTimeout(()=>{t.style.display="none",t.style.opacity="1",e&&e()},300))}async makeAjaxRequest(t,e={},s=3e4){const a=new FormData;a.append("action",t),a.append("nonce",window.bragBookSync?.sync_nonce||"");for(const[t,s]of Object.entries(e))a.append(t,s);const n=new AbortController,o=setTimeout(()=>n.abort(),s);try{const t=await fetch(window.ajaxurl||window.bragBookSync?.ajax_url||"/wp-admin/admin-ajax.php",{method:"POST",body:a,signal:n.signal});if(clearTimeout(o),!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.json()}catch(t){if(clearTimeout(o),"AbortError"===t.name)throw new Error("Request timeout");throw t}}}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("stage-1-btn")&&((()=>{const t=document.createElement("style");t.textContent="\n\t\t.spin {\n\t\t\tanimation: spin 1s linear infinite;\n\t\t}\n\t\t@keyframes spin {\n\t\t\t0% { transform: rotate(0deg); }\n\t\t\t100% { transform: rotate(360deg); }\n\t\t}\n\t\t.stage-sync-section .dashicons-yes {\n\t\t\tfont-size: 16px;\n\t\t\tline-height: 20px;\n\t\t\theight: 20px;\n\t\t\twidth: 16px;\n\t\t}\n\t\t.stage-sync-section .dashicons-no {\n\t\t\tfont-size: 16px;\n\t\t\tline-height: 20px;\n\t\t\theight: 20px;\n\t\t\twidth: 16px;\n\t\t}\n\t\t/* Stage buttons - non-active buttons are white */\n\t\t.stage-sync-buttons .stage-button.button {\n\t\t\tbackground: white !important;\n\t\t\tborder-color: #ddd !important;\n\t\t\tcolor: #333 !important;\n\t\t}\n\t\t.stage-sync-buttons .stage-button.button:hover:not(:disabled) {\n\t\t\tbackground: #f0f0f0 !important;\n\t\t\tborder-color: #ccc !important;\n\t\t\tcolor: #000 !important;\n\t\t}\n\t\t/* Stage buttons - active button (button-primary) is black */\n\t\t.stage-sync-buttons .stage-button.button-primary {\n\t\t\tbackground: #0f172a !important;\n\t\t\tborder-color: #0f172a !important;\n\t\t\tcolor: white !important;\n\t\t}\n\t\t.stage-sync-buttons .stage-button.button-primary:hover:not(:disabled) {\n\t\t\tbackground: #1e293b !important;\n\t\t\tborder-color: #1e293b !important;\n\t\t}\n\t\t/* Full sync button hover state */\n\t\t#full-sync-btn:hover:not(:disabled) {\n\t\t\tbackground: #1e293b !important;\n\t\t\tborder-color: #1e293b !important;\n\t\t}\n\t\t/* Disabled button styles */\n\t\t.stage-sync-buttons .stage-button:disabled {\n\t\t\topacity: 0.5;\n\t\t\tcursor: not-allowed;\n\t\t\tbackground: #f5f5f5 !important;\n\t\t\tcolor: #999 !important;\n\t\t\tborder-color: #ddd !important;\n\t\t}\n\t",document.head.appendChild(t)})(),new s)})}();